var map,cartoVoyager,cartoVoyagerLabels,navMap=((i=>{function a(e){i(e).on("click",t,this.close)}var t='[data-dismiss="alert"]',e=(a.prototype.close=function(e){function t(){r.trigger("closed.bs.alert").remove()}var n=i(this),a=n.attr("data-target"),r=(a||(a=(a=n.attr("href"))&&a.replace(/.*(?=#[^\s]*$)/,"")),i(a));e&&e.preventDefault(),(r=r.length?r:n.hasClass("alert")?n:n.parent()).trigger(e=i.Event("close.bs.alert")),e.isDefaultPrevented()||(r.removeClass("in"),i.support.transition&&r.hasClass("fade")?r.one(i.support.transition.end,t).emulateTransitionEnd(150):t())},i.fn.alert);i.fn.alert=function(n){return this.each(function(){var e=i(this),t=e.data("bs.alert");t||e.data("bs.alert",t=new a(this)),"string"==typeof n&&t[n].call(e)})},i.fn.alert.Constructor=a,i.fn.alert.noConflict=function(){return i.fn.alert=e,this},i(document).on("click.bs.alert.data-api",t,a.prototype.close)})(jQuery),(r=>{function i(n){r(".dropdown-backdrop").remove(),r(o).each(function(){var e=s(r(this)),t={relatedTarget:this};e.hasClass("open")&&(e.trigger(n=r.Event("hide.bs.dropdown",t)),n.isDefaultPrevented()||e.removeClass("open").trigger("hidden.bs.dropdown",t))})}function s(e){var t=e.attr("data-target"),t=(t=t?t:(t=e.attr("href"))&&/#[A-Za-z]/.test(t)&&t.replace(/.*(?=#[^\s]*$)/,""))&&r(t);return t&&t.length?t:e.parent()}function a(e){r(e).on("click.bs.dropdown",this.toggle)}var o="[data-toggle=dropdown]",e=(a.prototype.toggle=function(e){var t=r(this);if(!t.is(".disabled, :disabled")){var n=s(t),a=n.hasClass("open");if(i(),!a){"ontouchstart"in document.documentElement&&!n.closest(".navbar-nav").length&&r('<div class="dropdown-backdrop"/>').insertAfter(r(this)).on("click",i);a={relatedTarget:this};if(n.trigger(e=r.Event("show.bs.dropdown",a)),e.isDefaultPrevented())return;n.toggleClass("open").trigger("shown.bs.dropdown",a),t.focus()}return!1}},a.prototype.keydown=function(e){if(/(38|40|27)/.test(e.keyCode)){var t=r(this);if(e.preventDefault(),e.stopPropagation(),!t.is(".disabled, :disabled")){var n=s(t),a=n.hasClass("open");if(!a||27==e.keyCode)return 27==e.which&&n.find(o).focus(),t.click();a=" li:not(.divider):visible a",t=n.find("[role=menu]"+a+", [role=listbox]"+a);t.length&&(n=t.index(t.filter(":focus")),38==e.keyCode&&0<n&&n--,40==e.keyCode&&n<t.length-1&&n++,t.eq(n=~n?n:0).focus())}}},r.fn.dropdown);r.fn.dropdown=function(n){return this.each(function(){var e=r(this),t=e.data("bs.dropdown");t||e.data("bs.dropdown",t=new a(this)),"string"==typeof n&&t[n].call(e)})},r.fn.dropdown.Constructor=a,r.fn.dropdown.noConflict=function(){return r.fn.dropdown=e,this},r(document).on("click.bs.dropdown.data-api",i).on("click.bs.dropdown.data-api",".dropdown form",function(e){e.stopPropagation()}).on("click.bs.dropdown.data-api",o,a.prototype.toggle).on("keydown.bs.dropdown.data-api",o+", [role=menu], [role=listbox]",a.prototype.keydown)})(jQuery),(i=>{function s(e,t){this.options=t,this.$element=i(e),this.$backdrop=this.isShown=null,this.options.remote&&this.$element.find(".modal-content").load(this.options.remote,i.proxy(function(){this.$element.trigger("loaded.bs.modal")},this))}s.DEFAULTS={backdrop:!0,keyboard:!0,show:!0},s.prototype.toggle=function(e){return this[this.isShown?"hide":"show"](e)},s.prototype.show=function(n){var a=this,e=i.Event("show.bs.modal",{relatedTarget:n});this.$element.trigger(e),this.isShown||e.isDefaultPrevented()||(this.isShown=!0,this.escape(),this.$element.on("click.dismiss.bs.modal",'[data-dismiss="modal"]',i.proxy(this.hide,this)),this.backdrop(function(){var e=i.support.transition&&a.$element.hasClass("fade"),t=(a.$element.parent().length||a.$element.appendTo(document.body),a.$element.show().scrollTop(0),e&&a.$element[0].offsetWidth,a.$element.addClass("in").attr("aria-hidden",!1),a.enforceFocus(),i.Event("shown.bs.modal",{relatedTarget:n}));e?a.$element.find(".modal-dialog").one(i.support.transition.end,function(){a.$element.focus().trigger(t)}).emulateTransitionEnd(300):a.$element.focus().trigger(t)}))},s.prototype.hide=function(e){e&&e.preventDefault(),e=i.Event("hide.bs.modal"),this.$element.trigger(e),this.isShown&&!e.isDefaultPrevented()&&(this.isShown=!1,this.escape(),i(document).off("focusin.bs.modal"),this.$element.removeClass("in").attr("aria-hidden",!0).off("click.dismiss.bs.modal"),i.support.transition&&this.$element.hasClass("fade")?this.$element.one(i.support.transition.end,i.proxy(this.hideModal,this)).emulateTransitionEnd(300):this.hideModal())},s.prototype.enforceFocus=function(){i(document).off("focusin.bs.modal").on("focusin.bs.modal",i.proxy(function(e){this.$element[0]===e.target||this.$element.has(e.target).length||this.$element.focus()},this))},s.prototype.escape=function(){this.isShown&&this.options.keyboard?this.$element.on("keyup.dismiss.bs.modal",i.proxy(function(e){27==e.which&&this.hide()},this)):this.isShown||this.$element.off("keyup.dismiss.bs.modal")},s.prototype.hideModal=function(){var e=this;this.$element.hide(),this.backdrop(function(){e.removeBackdrop(),e.$element.trigger("hidden.bs.modal")})},s.prototype.removeBackdrop=function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},s.prototype.backdrop=function(e){var t,n=this.$element.hasClass("fade")?"fade":"";this.isShown&&this.options.backdrop?(t=i.support.transition&&n,this.$backdrop=i('<div class="modal-backdrop '+n+'" />').appendTo(document.body),this.$element.on("click.dismiss.bs.modal",i.proxy(function(e){e.target===e.currentTarget&&("static"==this.options.backdrop?this.$element[0].focus.call(this.$element[0]):this.hide.call(this))},this)),t&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),e&&(t?this.$backdrop.one(i.support.transition.end,e).emulateTransitionEnd(150):e())):!this.isShown&&this.$backdrop?(this.$backdrop.removeClass("in"),i.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one(i.support.transition.end,e).emulateTransitionEnd(150):e()):e&&e()};var e=i.fn.modal;i.fn.modal=function(a,r){return this.each(function(){var e=i(this),t=e.data("bs.modal"),n=i.extend({},s.DEFAULTS,e.data(),"object"==typeof a&&a);t||e.data("bs.modal",t=new s(this,n)),"string"==typeof a?t[a](r):n.show&&t.show(r)})},i.fn.modal.Constructor=s,i.fn.modal.noConflict=function(){return i.fn.modal=e,this},i(document).on("click.bs.modal.data-api",'[data-toggle="modal"]',function(e){var t=i(this),n=t.attr("href"),a=i(t.attr("data-target")||n&&n.replace(/.*(?=#[^\s]+$)/,"")),n=a.data("bs.modal")?"toggle":i.extend({remote:!/#/.test(n)&&n},a.data(),t.data());t.is("a")&&e.preventDefault(),a.modal(n,this).one("hide",function(){t.is(":visible")&&t.focus()})}),i(document).on("show.bs.modal",".modal",function(){i(document.body).addClass("modal-open")}).on("hidden.bs.modal",".modal",function(){i(document.body).removeClass("modal-open")})})(jQuery),(s=>{function a(e){this.element=s(e)}a.prototype.show=function(){var e,t,n=this.element,a=n.closest("ul:not(.dropdown-menu)"),r=n.data("target");r||(r=(r=n.attr("href"))&&r.replace(/.*(?=#[^\s]*$)/,"")),n.parent("li").hasClass("active")||(e=a.find(".active:last a")[0],t=s.Event("show.bs.tab",{relatedTarget:e}),n.trigger(t),t.isDefaultPrevented())||(t=s(r),this.activate(n.parent("li"),a),this.activate(t,t.parent(),function(){n.trigger({type:"shown.bs.tab",relatedTarget:e})}))},a.prototype.activate=function(e,t,n){function a(){r.removeClass("active").find("> .dropdown-menu > .active").removeClass("active"),e.addClass("active"),i?(e[0].offsetWidth,e.addClass("in")):e.removeClass("fade"),e.parent(".dropdown-menu")&&e.closest("li.dropdown").addClass("active"),n&&n()}var r=t.find("> .active"),i=n&&s.support.transition&&r.hasClass("fade");i?r.one(s.support.transition.end,a).emulateTransitionEnd(150):a(),r.removeClass("in")};var e=s.fn.tab;s.fn.tab=function(n){return this.each(function(){var e=s(this),t=e.data("bs.tab");t||e.data("bs.tab",t=new a(this)),"string"==typeof n&&t[n]()})},s.fn.tab.Constructor=a,s.fn.tab.noConflict=function(){return s.fn.tab=e,this},s(document).on("click.bs.tab.data-api",'[data-toggle="tab"], [data-toggle="pill"]',function(e){e.preventDefault(),s(this).tab("show")})})(jQuery),(s=>{function r(e,t){this.$element=s(e),this.options=s.extend({},r.DEFAULTS,t),this.transitioning=null,this.options.parent&&(this.$parent=s(this.options.parent)),this.options.toggle&&this.toggle()}r.DEFAULTS={toggle:!0},r.prototype.dimension=function(){return this.$element.hasClass("width")?"width":"height"},r.prototype.show=function(){if(!this.transitioning&&!this.$element.hasClass("in")){var e=s.Event("show.bs.collapse");if(this.$element.trigger(e),!e.isDefaultPrevented()){e=this.$parent&&this.$parent.find("> .panel > .in");if(e&&e.length){var t=e.data("bs.collapse");if(t&&t.transitioning)return;e.collapse("hide"),t||e.data("bs.collapse",null)}var n=this.dimension(),t=(this.$element.removeClass("collapse").addClass("collapsing")[n](0),this.transitioning=1,function(){this.$element.removeClass("collapsing").addClass("collapse in")[n]("auto"),this.transitioning=0,this.$element.trigger("shown.bs.collapse")});if(!s.support.transition)return t.call(this);e=s.camelCase(["scroll",n].join("-"));this.$element.one(s.support.transition.end,s.proxy(t,this)).emulateTransitionEnd(350)[n](this.$element[0][e])}}},r.prototype.hide=function(){if(!this.transitioning&&this.$element.hasClass("in")){var e=s.Event("hide.bs.collapse");if(this.$element.trigger(e),!e.isDefaultPrevented()){var e=this.dimension(),t=(this.$element[e](this.$element[e]())[0].offsetHeight,this.$element.addClass("collapsing").removeClass("collapse").removeClass("in"),this.transitioning=1,function(){this.transitioning=0,this.$element.trigger("hidden.bs.collapse").removeClass("collapsing").addClass("collapse")});if(!s.support.transition)return t.call(this);this.$element[e](0).one(s.support.transition.end,s.proxy(t,this)).emulateTransitionEnd(350)}}},r.prototype.toggle=function(){this[this.$element.hasClass("in")?"hide":"show"]()};var e=s.fn.collapse;s.fn.collapse=function(a){return this.each(function(){var e=s(this),t=e.data("bs.collapse"),n=s.extend({},r.DEFAULTS,e.data(),"object"==typeof a&&a);!t&&n.toggle&&"show"==a&&(a=!a),t||e.data("bs.collapse",t=new r(this,n)),"string"==typeof a&&t[a]()})},s.fn.collapse.Constructor=r,s.fn.collapse.noConflict=function(){return s.fn.collapse=e,this},s(document).on("click.bs.collapse.data-api","[data-toggle=collapse]",function(e){var t=s(this),e=t.attr("data-target")||e.preventDefault()||(e=t.attr("href"))&&e.replace(/.*(?=#[^\s]+$)/,""),e=s(e),n=e.data("bs.collapse"),a=n?"toggle":t.data(),r=t.attr("data-parent"),i=r&&s(r);n&&n.transitioning||(i&&i.find('[data-toggle=collapse][data-parent="'+r+'"]').not(t).addClass("collapsed"),t[e.hasClass("in")?"addClass":"removeClass"]("collapsed")),e.collapse(a)})})(jQuery),(a=>{a.fn.emulateTransitionEnd=function(e){var t=!1,n=this;a(this).one(a.support.transition.end,function(){t=!0});return setTimeout(function(){t||a(n).trigger(a.support.transition.end)},e),this},a(function(){a.support.transition=(()=>{var e,t=document.createElement("bootstrap"),n={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(e in n)if(void 0!==t.style[e])return{end:n[e]};return!1})()})})(jQuery),(l=>{var e,i,c={isMsie:function(){var e=/(msie) ([\w.]+)/i.exec(navigator.userAgent);return!!e&&parseInt(e[2],10)},isBlankString:function(e){return!e||/^\s*$/.test(e)},escapeRegExChars:function(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isArray:l.isArray,isFunction:l.isFunction,isObject:l.isPlainObject,isUndefined:function(e){return void 0===e},bind:l.proxy,bindAll:function(e){var t,n;for(n in e)l.isFunction(t=e[n])&&(e[n]=l.proxy(t,e))},indexOf:function(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return n;return-1},each:l.each,map:l.map,filter:l.grep,every:function(n,a){var r=!0;return n?(l.each(n,function(e,t){if(!(r=a.call(null,t,e,n)))return!1}),!!r):r},some:function(n,a){var r=!1;return n?(l.each(n,function(e,t){if(r=a.call(null,t,e,n))return!1}),!!r):r},mixin:l.extend,getUniqueId:(e=0,function(){return e++}),defer:function(e){setTimeout(e,0)},debounce:function(r,i,s){var o,l;return function(){var e=this,t=arguments,n=function(){o=null,s||(l=r.apply(e,t))},a=s&&!o;return clearTimeout(o),o=setTimeout(n,i),l=a?r.apply(e,t):l}},throttle:function(n,a){var r,i,s,o,l=0,c=function(){l=new Date,s=null,o=n.apply(r,i)};return function(){var e=new Date,t=a-(e-l);return r=this,i=arguments,t<=0?(clearTimeout(s),s=null,l=e,o=n.apply(r,i)):s=s||setTimeout(c,t),o}},tokenizeQuery:function(e){return l.trim(e).toLowerCase().split(/[\s]+/)},tokenizeText:function(e){return l.trim(e).toLowerCase().split(/[\s\-_]+/)},getProtocol:function(){return location.protocol},noop:function(){}},t=(i=/\s+/,{on:function(e,t){var n;if(t)for(this._callbacks=this._callbacks||{},e=e.split(i);n=e.shift();)this._callbacks[n]=this._callbacks[n]||[],this._callbacks[n].push(t);return this},trigger:function(e,t){var n,a;if(this._callbacks)for(e=e.split(i);n=e.shift();)if(a=this._callbacks[n])for(var r=0;r<a.length;r+=1)a[r].call(this,{type:n,data:t});return this}}),r=(c.mixin(n.prototype,{trigger:function(e){var t=[].slice.call(arguments,1);this.$el.trigger("typeahead:"+e,t)}}),n);function n(e){e&&e.el||l.error("EventBus initialized without el"),this.$el=l(e.el)}var a=(()=>{var r,e;try{(r=window.localStorage).setItem("~~~","!"),r.removeItem("~~~")}catch(e){r=null}function t(e){this.prefix=["__",e,"__"].join(""),this.ttlKey="__ttl__",this.keyMatcher=new RegExp("^"+this.prefix)}return e=r&&window.JSON?{_prefix:function(e){return this.prefix+e},_ttlKey:function(e){return this._prefix(e)+this.ttlKey},get:function(e){return this.isExpired(e)&&this.remove(e),n(r.getItem(this._prefix(e)))},set:function(e,t,n){return c.isNumber(n)?r.setItem(this._ttlKey(e),i(a()+n)):r.removeItem(this._ttlKey(e)),r.setItem(this._prefix(e),i(t))},remove:function(e){return r.removeItem(this._ttlKey(e)),r.removeItem(this._prefix(e)),this},clear:function(){for(var e,t=[],n=r.length,a=0;a<n;a++)(e=r.key(a)).match(this.keyMatcher)&&t.push(e.replace(this.keyMatcher,""));for(a=t.length;a--;)this.remove(t[a]);return this},isExpired:function(e){e=n(r.getItem(this._ttlKey(e)));return!!(c.isNumber(e)&&a()>e)}}:{get:c.noop,set:c.noop,remove:c.noop,clear:c.noop,isExpired:c.noop},c.mixin(t.prototype,e),t;function a(){return(new Date).getTime()}function i(e){return JSON.stringify(c.isUndefined(e)?null:e)}function n(e){return JSON.parse(e)}})(),s=(c.mixin(o.prototype,{get:function(e){return this.cache[e]},set:function(e,t){var n;this.cachedKeysByAge.length===this.sizeLimit&&(n=this.cachedKeysByAge.shift(),delete this.cache[n]),this.cache[e]=t,this.cachedKeysByAge.push(e)}}),o);function o(e){c.bindAll(this),this.sizeLimit=(e=e||{}).sizeLimit||10,this.cache={},this.cachedKeysByAge=[]}p=0,h={},c.mixin(m.prototype,{_get:function(n,a){var r=this;p<d?this._sendRequest(n).done(function(e){var t=r.filter?r.filter(e):e;a&&a(t),u.set(n,e)}):this.onDeckRequestArgs=[].slice.call(arguments,0)},_sendRequest:function(e){var t=this,n=h[e];return n||(p++,n=h[e]=l.ajax(e,this.ajaxSettings).always(function(){p--,h[e]=null,t.onDeckRequestArgs&&(t._get.apply(t,t.onDeckRequestArgs),t.onDeckRequestArgs=null)})),n},get:function(e,t){var n,a=this,e=encodeURIComponent(e||"");return t=t||c.noop,e=this.replace?this.replace(this.url,e):this.url.replace(this.wildcard,e),(n=u.get(e))?c.defer(function(){t(a.filter?a.filter(n):n)}):this._get(e,t),!!n}});var d,u,p,h,f=m;function m(e){c.bindAll(this),e=c.isString(e)?{url:e}:e,u=u||new s,d=c.isNumber(e.maxParallelRequests)?e.maxParallelRequests:d||6,this.url=e.url,this.wildcard=e.wildcard||"%QUERY",this.filter=e.filter,this.replace=e.replace,this.ajaxSettings={type:"get",cache:e.cache,timeout:e.timeout,dataType:e.dataType||"json",beforeSend:e.beforeSend},this._get=(/^throttle$/i.test(e.rateLimitFn)?c.throttle:c.debounce)(this._get,e.rateLimitWait||300)}g="thumbprint",v="protocol",y="itemHash",x="adjacencyList",c.mixin(w.prototype,{_processLocalData:function(e){this._mergeProcessedData(this._processData(e))},_loadPrefetchData:function(a){var e,t,n,r,i=this,s="0.9.3"+(a.thumbprint||"");return this.storage&&(r=this.storage.get(g),e=this.storage.get(v),t=this.storage.get(y),n=this.storage.get(x)),r=r!==s||e!==c.getProtocol(),(a=c.isString(a)?{url:a}:a).ttl=c.isNumber(a.ttl)?a.ttl:864e5,t&&n&&!r?(this._mergeProcessedData({itemHash:t,adjacencyList:n}),l.Deferred().resolve()):l.getJSON(a.url).done(function(e){var e=a.filter?a.filter(e):e,e=i._processData(e),t=e.itemHash,n=e.adjacencyList;i.storage&&(i.storage.set(y,t,a.ttl),i.storage.set(x,n,a.ttl),i.storage.set(g,s,a.ttl),i.storage.set(v,c.getProtocol(),a.ttl));i._mergeProcessedData(e)})},_transformDatum:function(e){var t=c.isString(e)?e:e[this.valueKey],t={value:t,tokens:e.tokens||c.tokenizeText(t)};return c.isString(e)?(t.datum={},t.datum[this.valueKey]=e):t.datum=e,t.tokens=c.filter(t.tokens,function(e){return!c.isBlankString(e)}),t.tokens=c.map(t.tokens,function(e){return e.toLowerCase()}),t},_processData:function(e){var a=this,r={},i={};return c.each(e,function(e,t){var t=a._transformDatum(t),n=c.getUniqueId(t.value);c.each((r[n]=t).tokens,function(e,t){t=t.charAt(0),t=i[t]||(i[t]=[n]);~c.indexOf(t,n)||t.push(n)})}),{itemHash:r,adjacencyList:i}},_mergeProcessedData:function(e){var a=this;c.mixin(this.itemHash,e.itemHash),c.each(e.adjacencyList,function(e,t){var n=a.adjacencyList[e];a.adjacencyList[e]=n?n.concat(t):t})},_getLocalSuggestions:function(a){var n,r=this,i=[],s=[],o=[];return c.each(a,function(e,t){t=t.charAt(0);~c.indexOf(i,t)||i.push(t)}),c.each(i,function(e,t){t=r.adjacencyList[t];if(!t)return!1;s.push(t),(!n||t.length<n.length)&&(n=t)}),s.length<i.length?[]:(c.each(n,function(e,t){var n=r.itemHash[t];c.every(s,function(e){return~c.indexOf(e,t)})&&c.every(a,function(t){return c.some(n.tokens,function(e){return 0===e.indexOf(t)})})&&o.push(n)}),o)},initialize:function(){var e;return this.local&&this._processLocalData(this.local),this.transport=this.remote?new f(this.remote):null,e=this.prefetch?this._loadPrefetchData(this.prefetch):l.Deferred().resolve(),this.local=this.prefetch=this.remote=null,this.initialize=function(){return e},e},getSuggestions:function(e,t){var n,a,r=this,i=!1;e.length<this.minLength||(n=c.tokenizeQuery(e),!(i=(a=this._getLocalSuggestions(n).slice(0,this.limit)).length<this.limit&&this.transport?this.transport.get(e,function(e){a=a.slice(0),c.each(e,function(e,t){var n=r._transformDatum(t);return c.some(a,function(e){return n.value===e.value})||a.push(n),a.length<r.limit}),t&&t(a)}):i)&&t&&t(a))}});var g,v,y,x,b=w;function w(e){c.bindAll(this),c.isString(e.template)&&!e.engine&&l.error("no template engine specified"),e.local||e.prefetch||e.remote||l.error("one of local, prefetch, or remote is required"),this.name=e.name||c.getUniqueId(),this.limit=e.limit||5,this.minLength=e.minLength||1,this.header=e.header,this.footer=e.footer,this.valueKey=e.valueKey||"value",this.template=((e,t,n)=>e=c.isFunction(e)?e:c.isString(e)?(t=t.compile(e),c.bind(t.render,t)):function(e){return"<p>"+e[n]+"</p>"})(e.template,e.engine,this.valueKey),this.local=e.local,this.prefetch=e.prefetch,this.remote=e.remote,this.itemHash={},this.adjacencyList={},this.storage=e.name?new a(e.name):null}c.mixin(M.prototype,t,{_handleFocus:function(){this.trigger("focused")},_handleBlur:function(){this.trigger("blured")},_handleSpecialKeyEvent:function(e){var t=this.specialKeyCodeMap[e.which||e.keyCode];t&&this.trigger(t+"Keyed",e)},_compareQueryToInputValue:function(){var e,t=this.getInputValue(),n=(n=this.query,e=t,n=(n||"").replace(/^\s*/g,"").replace(/\s{2,}/g," "),e=(e||"").replace(/^\s*/g,"").replace(/\s{2,}/g," "),n===e);n&&this.query.length!==t.length?this.trigger("whitespaceChanged",{value:this.query}):n||this.trigger("queryChanged",{value:this.query=t})},destroy:function(){this.$hint.off(".tt"),this.$input.off(".tt"),this.$hint=this.$input=this.$overflowHelper=null},focus:function(){this.$input.focus()},blur:function(){this.$input.blur()},getQuery:function(){return this.query},setQuery:function(e){this.query=e},getInputValue:function(){return this.$input.val()},setInputValue:function(e,t){this.$input.val(e),t||this._compareQueryToInputValue()},getHintValue:function(){return this.$hint.val()},setHintValue:function(e){this.$hint.val(e)},getLanguageDirection:function(){return(this.$input.css("direction")||"ltr").toLowerCase()},isOverflow:function(){return this.$overflowHelper.text(this.getInputValue()),this.$overflowHelper.width()>this.$input.width()},isCursorAtEnd:function(){var e=this.$input.val().length,t=this.$input[0].selectionStart;return c.isNumber(t)?t===e:!document.selection||((t=document.selection.createRange()).moveStart("character",-e),e===t.text.length)}});var k=M;function M(e){var t=this;c.bindAll(this),this.specialKeyCodeMap={9:"tab",27:"esc",37:"left",39:"right",13:"enter",38:"up",40:"down"},this.$hint=l(e.hint),this.$input=l(e.input).on("blur.tt",this._handleBlur).on("focus.tt",this._handleFocus).on("keydown.tt",this._handleSpecialKeyEvent),c.isMsie()?this.$input.on("keydown.tt keypress.tt cut.tt paste.tt",function(e){t.specialKeyCodeMap[e.which||e.keyCode]||c.defer(t._compareQueryToInputValue)}):this.$input.on("input.tt",this._compareQueryToInputValue),this.query=this.$input.val(),this.$overflowHelper=(e=this.$input,l("<span></span>").css({position:"absolute",left:"-9999px",visibility:"hidden",whiteSpace:"nowrap",fontFamily:e.css("font-family"),fontSize:e.css("font-size"),fontStyle:e.css("font-style"),fontVariant:e.css("font-variant"),fontWeight:e.css("font-weight"),wordSpacing:e.css("word-spacing"),letterSpacing:e.css("letter-spacing"),textIndent:e.css("text-indent"),textRendering:e.css("text-rendering"),textTransform:e.css("text-transform")}).insertAfter(e))}_='<span class="tt-suggestions"></span>',$={display:"block"},S={whiteSpace:"nowrap",cursor:"pointer"},F={whiteSpace:"normal"},c.mixin(T.prototype,t,{_handleMouseenter:function(){this.isMouseOverDropdown=!0},_handleMouseleave:function(){this.isMouseOverDropdown=!1},_handleMouseover:function(e){e=l(e.currentTarget);this._getSuggestions().removeClass("tt-is-under-cursor"),e.addClass("tt-is-under-cursor")},_handleSelection:function(e){e=l(e.currentTarget);this.trigger("suggestionSelected",C(e))},_show:function(){this.$menu.css("display","block")},_hide:function(){this.$menu.hide()},_moveCursor:function(e){var t,n;this.isVisible()&&((n=(t=this._getSuggestions()).filter(".tt-is-under-cursor")).removeClass("tt-is-under-cursor"),-1===(n=((n=t.index(n)+e)+1)%(t.length+1)-1)?this.trigger("cursorRemoved"):(n<-1&&(n=t.length-1),e=t.eq(n).addClass("tt-is-under-cursor"),this._ensureVisibility(e),this.trigger("cursorMoved",C(e))))},_getSuggestions:function(){return this.$menu.find(".tt-suggestions > .tt-suggestion")},_ensureVisibility:function(e){var t=this.$menu.height()+parseInt(this.$menu.css("paddingTop"),10)+parseInt(this.$menu.css("paddingBottom"),10),n=this.$menu.scrollTop(),a=e.position().top,e=a+e.outerHeight(!0);a<0?this.$menu.scrollTop(n+a):t<e&&this.$menu.scrollTop(n+(e-t))},destroy:function(){this.$menu.off(".tt"),this.$menu=null},isVisible:function(){return this.isOpen&&!this.isEmpty},closeUnlessMouseIsOverDropdown:function(){this.isMouseOverDropdown||this.close()},close:function(){this.isOpen&&(this.isOpen=!1,this.isMouseOverDropdown=!1,this._hide(),this.$menu.find(".tt-suggestions > .tt-suggestion").removeClass("tt-is-under-cursor"),this.trigger("closed"))},open:function(){this.isOpen||(this.isOpen=!0,this.isEmpty||this._show(),this.trigger("opened"))},setLanguageDirection:function(e){"ltr"===e?this.$menu.css({left:"0",right:"auto"}):this.$menu.css({left:"auto",right:" 0"})},moveCursorUp:function(){this._moveCursor(-1)},moveCursorDown:function(){this._moveCursor(1)},getSuggestionUnderCursor:function(){var e=this._getSuggestions().filter(".tt-is-under-cursor").first();return 0<e.length?C(e):null},getFirstSuggestion:function(){var e=this._getSuggestions().first();return 0<e.length?C(e):null},renderSuggestions:function(n,e){var t,a,r,i,s="tt-dataset-"+n.name,o=this.$menu.find("."+s);0===o.length&&(t=l(_).css($),o=l("<div></div>").addClass(s).append(n.header).append(t).append(n.footer).appendTo(this.$menu)),0<e.length?(this.isEmpty=!1,this.isOpen&&this._show(),a=document.createElement("div"),r=document.createDocumentFragment(),c.each(e,function(e,t){t.dataset=n.name,i=n.template(t.datum),a.innerHTML='<div class="tt-suggestion">%body</div>'.replace("%body",i),(i=l(a.firstChild).css(S).data("suggestion",t)).children().each(function(){l(this).css(F)}),r.appendChild(i[0])}),o.show().find(".tt-suggestions").html(r)):this.clearSuggestions(n.name),this.trigger("suggestionsRendered")},clearSuggestions:function(e){var e=e?this.$menu.find(".tt-dataset-"+e):this.$menu.find('[class^="tt-dataset-"]'),t=e.find(".tt-suggestions");e.hide(),t.empty(),0===this._getSuggestions().length&&(this.isEmpty=!0,this._hide())}});var _,$,S,F,E=T;function T(e){c.bindAll(this),this.isOpen=!1,this.isEmpty=!0,this.isMouseOverDropdown=!1,this.$menu=l(e.menu).on("mouseenter.tt",this._handleMouseenter).on("mouseleave.tt",this._handleMouseleave).on("click.tt",".tt-suggestion",this._handleSelection).on("mouseover.tt",".tt-suggestion",this._handleMouseover)}function C(e){return e.data("suggestion")}L={wrapper:'<span class="twitter-typeahead"></span>',hint:'<input class="tt-hint" type="text" autocomplete="off" spellcheck="off" disabled>',dropdown:'<span class="tt-dropdown-menu"></span>'},I={wrapper:{position:"relative"},hint:{position:"absolute",top:"0",left:"0",borderColor:"transparent",boxShadow:"none"},query:{position:"relative",verticalAlign:"top","border-radius":"4px 0 0 4px","-moz-border-radius":"4px 0 0 4px","-webkit-border-radius":"4px 0 0 4px"},dropdown:{position:"absolute",top:"100%",left:"0",zIndex:"100",display:"none"}},c.isMsie()&&c.mixin(I.query,{backgroundImage:"url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)"}),c.isMsie()&&c.isMsie()<=7&&(c.mixin(I.wrapper,{display:"inline",zoom:"1"}),c.mixin(I.query,{marginTop:"-1px"})),c.mixin(B.prototype,t,{_managePreventDefault:function(e){var t,n,a=e.data,r=!1;switch(e.type){case"tabKeyed":t=this.inputView.getHintValue(),n=this.inputView.getInputValue(),r=t&&t!==n;break;case"upKeyed":case"downKeyed":r=!a.shiftKey&&!a.ctrlKey&&!a.metaKey}r&&a.preventDefault()},_setLanguageDirection:function(){var e=this.inputView.getLanguageDirection();e!==this.dir&&(this.dir=e,this.$node.css("direction",e),this.dropdownView.setLanguageDirection(e))},_updateHint:function(){var e=this.dropdownView.getFirstSuggestion(),e=e?e.value:null,t=this.dropdownView.isVisible(),n=this.inputView.isOverflow();e&&t&&!n&&(n=(t=this.inputView.getInputValue()).replace(/\s{2,}/g," ").replace(/^\s+/g,""),n=c.escapeRegExChars(n),n=new RegExp("^(?:"+n+")(.*$)","i").exec(e),this.inputView.setHintValue(t+(n?n[1]:"")))},_clearHint:function(){this.inputView.setHintValue("")},_clearSuggestions:function(){this.dropdownView.clearSuggestions()},_setInputValueToQuery:function(){this.inputView.setInputValue(this.inputView.getQuery())},_setInputValueToSuggestionUnderCursor:function(e){e=e.data;this.inputView.setInputValue(e.value,!0)},_openDropdown:function(){this.dropdownView.open()},_closeDropdown:function(e){this.dropdownView["blured"===e.type?"closeUnlessMouseIsOverDropdown":"close"]()},_moveDropdownCursor:function(e){var t=e.data;t.shiftKey||t.ctrlKey||t.metaKey||this.dropdownView["upKeyed"===e.type?"moveCursorUp":"moveCursorDown"]()},_handleSelection:function(e){var t="suggestionSelected"===e.type,n=t?e.data:this.dropdownView.getSuggestionUnderCursor();n&&(this.inputView.setInputValue(n.value),t?this.inputView.focus():e.data.preventDefault(),t&&c.isMsie()?c.defer(this.dropdownView.close):this.dropdownView.close(),this.eventBus.trigger("selected",n.datum,n.dataset))},_getSuggestions:function(){var n=this,a=this.inputView.getQuery();c.isBlankString(a)||c.each(this.datasets,function(e,t){t.getSuggestions(a,function(e){a===n.inputView.getQuery()&&n.dropdownView.renderSuggestions(t,e)})})},_autocomplete:function(e){var t;("rightKeyed"!==e.type&&"leftKeyed"!==e.type||(t=this.inputView.isCursorAtEnd(),e="ltr"===this.inputView.getLanguageDirection()?"leftKeyed"===e.type:"rightKeyed"===e.type,t&&!e))&&(t=this.inputView.getQuery(),""!==(e=this.inputView.getHintValue()))&&t!==e&&(t=this.dropdownView.getFirstSuggestion(),this.inputView.setInputValue(t.value),this.eventBus.trigger("autocompleted",t.datum,t.dataset))},_propagateEvent:function(e){this.eventBus.trigger(e.type)},destroy:function(){var e,n;this.inputView.destroy(),this.dropdownView.destroy(),e=this.$node,n=e.find(".tt-query"),c.each(n.data("ttAttrs"),function(e,t){c.isUndefined(t)?n.removeAttr(e):n.attr(e,t)}),n.detach().removeData("ttAttrs").removeClass("tt-query").insertAfter(e),e.remove(),this.$node=null},setQuery:function(e){this.inputView.setQuery(e),this.inputView.setInputValue(e),this._clearHint(),this._clearSuggestions(),this._getSuggestions()}});var L,I,A,j,z,R=B;function B(e){var t,n;c.bindAll(this),this.$node=(e=>{var t=l(L.wrapper),n=l(L.dropdown),e=l(e),a=l(L.hint);t=t.css(I.wrapper),n=n.css(I.dropdown),a.css(I.hint).css({backgroundAttachment:e.css("background-attachment"),backgroundClip:e.css("background-clip"),backgroundColor:e.css("background-color"),backgroundImage:e.css("background-image"),backgroundOrigin:e.css("background-origin"),backgroundPosition:e.css("background-position"),backgroundRepeat:e.css("background-repeat"),backgroundSize:e.css("background-size")}),e.data("ttAttrs",{dir:e.attr("dir"),autocomplete:e.attr("autocomplete"),spellcheck:e.attr("spellcheck"),style:e.attr("style")}),e.addClass("tt-query").attr({autocomplete:"off",spellcheck:!1}).css(I.query);try{e.attr("dir")||e.attr("dir","auto")}catch(e){}return e.wrap(t).parent().prepend(a).append(n)})(e.input),this.datasets=e.datasets,this.dir=null,this.eventBus=e.eventBus,e=this.$node.find(".tt-dropdown-menu"),t=this.$node.find(".tt-query"),n=this.$node.find(".tt-hint"),this.dropdownView=new E({menu:e}).on("suggestionSelected",this._handleSelection).on("cursorMoved",this._clearHint).on("cursorMoved",this._setInputValueToSuggestionUnderCursor).on("cursorRemoved",this._setInputValueToQuery).on("cursorRemoved",this._updateHint).on("suggestionsRendered",this._updateHint).on("opened",this._updateHint).on("closed",this._clearHint).on("opened closed",this._propagateEvent),this.inputView=new k({input:t,hint:n}).on("focused",this._openDropdown).on("blured",this._closeDropdown).on("blured",this._setInputValueToQuery).on("enterKeyed tabKeyed",this._handleSelection).on("queryChanged",this._clearHint).on("queryChanged",this._clearSuggestions).on("queryChanged",this._getSuggestions).on("whitespaceChanged",this._updateHint).on("queryChanged whitespaceChanged",this._openDropdown).on("queryChanged whitespaceChanged",this._setLanguageDirection).on("escKeyed",this._closeDropdown).on("escKeyed",this._setInputValueToQuery).on("tabKeyed upKeyed downKeyed",this._managePreventDefault).on("upKeyed downKeyed",this._moveDropdownCursor).on("upKeyed downKeyed",this._openDropdown).on("tabKeyed leftKeyed rightKeyed",this._autocomplete)}A={},j="ttView",z={initialize:function(e){var a;return 0===(e=c.isArray(e)?e:[e]).length&&l.error("no datasets provided"),a=c.map(e,function(e){var t=A[e.name]||new b(e);return e.name&&(A[e.name]=t),t}),this.each(function(){var e,t=l(this),n=new r({el:t});e=c.map(a,function(e){return e.initialize()}),t.data(j,new R({input:t,eventBus:n=new r({el:t}),datasets:a})),l.when.apply(l,e).always(function(){c.defer(function(){n.trigger("initialized")})})})},destroy:function(){return this.each(function(){var e=l(this),t=e.data(j);t&&(t.destroy(),e.removeData(j))})},setQuery:function(t){return this.each(function(){var e=l(this).data(j);e&&e.setQuery(t)})}},jQuery.fn.typeahead=function(e){return z[e]?z[e].apply(this,[].slice.call(arguments,1)):z.initialize.apply(this,arguments)}})(window.jQuery),((e,t)=>{"object"==typeof exports&&exports?t(exports):(t(t={}),"function"==typeof define&&define.amd?define(t):e.Mustache=t)})(this,function(_){var $=/\s*/,S=/\s+/,t=/\S/,F=/\s*=/,T=/\s*\}/,C=/#|\^|\/|>|\{|&|=|!/,n=RegExp.prototype.test;function L(e){return!n.call(t,e)}var a=Object.prototype.toString,f=Array.isArray||function(e){return"[object Array]"===a.call(e)};function I(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var r={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function A(e){this.string=e,this.tail=e,this.pos=0}function s(e,t){this.view=e||{},this.parent=t,this._cache={}}function e(){this.clearCache()}function j(e){return[new RegExp(I(e[0])+"\\s*"),new RegExp("\\s*"+I(e[1]))]}A.prototype.eos=function(){return""===this.tail},A.prototype.scan=function(e){e=this.tail.match(e);return e&&0===e.index?(this.tail=this.tail.substring(e[0].length),this.pos+=e[0].length,e[0]):""},A.prototype.scanUntil=function(e){var t,n=this.tail.search(e);switch(n){case-1:t=this.tail,this.pos+=this.tail.length,this.tail="";break;case 0:t="";break;default:t=this.tail.substring(0,n),this.tail=this.tail.substring(n),this.pos+=n}return t},s.make=function(e){return e instanceof s?e:new s(e)},s.prototype.push=function(e){return new s(e,this)},s.prototype.lookup=function(e){if(!(n=this._cache[e])){if("."==e)n=this.view;else for(var t=this;t;){if(0<e.indexOf("."))for(var n=t.view,a=e.split("."),r=0;n&&r<a.length;)n=n[a[r++]];else n=t.view[e];if(null!=n)break;t=t.parent}this._cache[e]=n}return n="function"==typeof n?n.call(this.view):n},e.prototype.clearCache=function(){this._cache={},this._partialCache={}},e.prototype.compile=function(e,t){var n=this._cache[e];return n||(t=_.parse(e,t),n=this._cache[e]=this.compileTokens(t,e)),n},e.prototype.compilePartial=function(e,t,n){t=this.compile(t,n);return this._partialCache[e]=t},e.prototype.getPartial=function(e){return e in this._partialCache||!this._loadPartial||this.compilePartial(e,this._loadPartial(e)),this._partialCache[e]},e.prototype.compileTokens=function(a,r){var i=this;return function(e,t){if(t)if("function"==typeof t)i._loadPartial=t;else for(var n in t)i.compilePartial(n,t[n]);return function e(t,n,a,r){var i="";var s,o,l;for(var c=0,d=t.length;c<d;++c)switch(s=t[c],o=s[1],s[0]){case"#":var u;if("object"==typeof(l=a.lookup(o)))if(f(l))for(var p=0,h=l.length;p<h;++p)i+=e(s[4],n,a.push(l[p]),r);else l&&(i+=e(s[4],n,a.push(l),r));else"function"==typeof l?(u=null==r?null:r.slice(s[3],s[5]),null!=(l=l.call(a.view,u,function(e){return n.render(e,a)}))&&(i+=l)):l&&(i+=e(s[4],n,a,r));break;case"^":(!(l=a.lookup(o))||f(l)&&0===l.length)&&(i+=e(s[4],n,a,r));break;case">":"function"==typeof(l=n.getPartial(o))&&(i+=l(a));break;case"&":null!=(l=a.lookup(o))&&(i+=l);break;case"name":null!=(l=a.lookup(o))&&(i+=_.escape(l));break;case"text":i+=o}return i}(a,i,s.make(e),r)}},e.prototype.render=function(e,t,n){return this.compile(e)(t,n)},_.name="mustache.js",_.version="0.7.2",_.tags=["{{","}}"],_.Scanner=A,_.Context=s,_.Writer=e,_.parse=function(e,t){if(e=e||"",2!==(t="string"==typeof(t=t||_.tags)?t.split(S):t).length)throw new Error("Invalid tags: "+t.join(", "));for(var n,a,r,i,s,o,l=j(t),c=new A(e),d=[],u=[],p=[],h=!1,f=!1;!c.eos();){if(n=c.pos,r=c.scanUntil(l[0]))for(var m=0,g=r.length;m<g;++m)if(L(i=r.charAt(m))?p.push(u.length):f=!0,u.push(["text",i,n,n+1]),n+=1,"\n"==i){if(h&&!f)for(;p.length;)delete u[p.pop()];else p=[];f=h=!1}if(!c.scan(l[0]))break;if(h=!0,a=c.scan(C)||"name",c.scan($),"="===a?(r=c.scanUntil(F),c.scan(F),c.scanUntil(l[1])):"{"===a?(r=c.scanUntil(new RegExp("\\s*"+I("}"+t[1]))),c.scan(T),c.scanUntil(l[1]),a="&"):r=c.scanUntil(l[1]),!c.scan(l[1]))throw new Error("Unclosed tag at "+c.pos);if(s=[a,r,n,c.pos],u.push(s),"#"===a||"^"===a)d.push(s);else if("/"===a){if(0===d.length)throw new Error('Unopened section "'+r+'" at '+n);if((o=d.pop())[1]!==r)throw new Error('Unclosed section "'+o[1]+'" at '+n)}else if("name"===a||"{"===a||"&"===a)f=!0;else if("="===a){if(2!==(t=r.split(S)).length)throw new Error("Invalid tags at "+n+": "+t.join(", "));l=j(t)}}if(o=d.pop())throw new Error('Unclosed section "'+o[1]+'" at '+c.pos);for(var v,y=u=(e=>{for(var t,n,a=[],r=0,i=e.length;r<i;++r)(t=e[r])&&("text"===t[0]&&n&&"text"===n[0]?(n[1]+=t[1],n[3]=t[3]):a.push(n=t));return a})(u),x=[],b=x,w=[],k=0,M=y.length;k<M;++k)switch((v=y[k])[0]){case"#":case"^":w.push(v),b.push(v),b=v[4]=[];break;case"/":w.pop()[5]=v[2],b=0<w.length?w[w.length-1][4]:x;break;default:b.push(v)}return x},_.escape=function(e){return String(e).replace(/[&<>"'\/]/g,function(e){return r[e]})};var i=new e;_.clearCache=function(){return i.clearCache()},_.compile=function(e,t){return i.compile(e,t)},_.compilePartial=function(e,t,n){return i.compilePartial(e,t,n)},_.compileTokens=function(e,t){return i.compileTokens(e,t)},_.render=function(e,t,n){return i.render(e,t,n)},_.to_html=function(e,t,n,a){e=_.render(e,t,n);if("function"!=typeof a)return e;a(e)}}),(()=>{var d,r,i,s,u={lng:0,lat:0},p={lng:0,lat:0},h=3,f={selectedInterval:{nam:"",mid:"",oid:""},personFilter:{id:"",name:""},taxa:[],stratigraphy:{name:"",rank:""},researchGroup:{name:""},country:{name:"",cc2:""},exist:{selectedInterval:!1,personFilter:!1,taxon:!1,stratigraphy:!1,researchGroup:!1,country:!1}},a=d3.geo.hammer().scale(165).translate([480,250]).rotate([1e-6,0]).precision(.1),o=d3.geo.path().projection(a);function t(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}return{init:function(n){map=new L.Map("map",{center:new L.LatLng(7,0),zoom:2,maxZoom:11,minZoom:2,zoomControl:!1,inertiaDeceleration:6e3,inertiaMaxSpeed:1e3,zoomAnimationThreshold:1});var e="© OpenStreetMap contributors, © CARTO";new L.TileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png",{attribution:e}).addTo(map),new L.TileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels/{z}/{x}/{y}.png",{attribution:e});function t(e){for(var t,n=map.getBounds();180<n._northEast.lng;)n._northEast.lng=n._northEast.lng-180;for(;180<n._southWest.lng;)n._southWest.lng=n._southWest.lng-180;for(;n._northEast.lng<-180;)n._northEast.lng=n._northEast.lng+180;for(;n._southWest.lng<-180;)n._southWest.lng=n._southWest.lng+180;360<Math.abs(n._northEast.lng)+Math.abs(n._southWest.lng)&&(t=!0),(e<3||3<e&&t||4===h&&3===e&&t)&&700<window.innerWidth&&(h=2,d3.select("#map").style("height",0),d3.select("#svgMap").style("display","block"),$("#latdisplay").text(""),$("#lngdisplay").text("")),navMap.refresh()}map.on("moveend",function(e){e.hard||parseInt(d3.select("#map").style("height"))<2||(t(map.getZoom()),paleo_nav.getPrevalence())}),map.on("zoomend",function(){d3.select(".leaflet-zoom-hide").style("visibility","hidden"),navMap.selectBaseMap(map.getZoom()),t(map.getZoom())}),map._initPathRoot(),d3.select("#map").select("svg").append("g").attr("class","leaflet-zoom-hide").attr("id","binHolder"),d3.select("#map").style("height",0);var e=d3.behavior.zoom().on("zoom",function(){0<d3.event.sourceEvent.wheelDelta?navMap.changeMaps(d3.mouse(this)):"touchmove"===d3.event.sourceEvent.type&&navMap.changeMaps([d3.event.sourceEvent.pageX,d3.event.sourceEvent.pageY])}),a=d3.select("#svgMap").append("svg").attr("width",960).attr("height",500).call(e).on("click",function(){navMap.changeMaps(d3.mouse(this))}).append("g");a.append("defs").append("path").datum({type:"Sphere"}).attr("id","sphere").attr("d",o),a.append("use").attr("class","fill").attr("xlink:href","#sphere"),d3.json("build/js/countries_1e5.json",function(e,t){a.append("path").datum(topojson.feature(t,t.objects.countries)).attr("class","countries").attr("d",o),reconstructMap.resize(),timeScale.resize(),setTimeout(navMap.resize,1e3),n()}),d3.text("build/partials/binModal.html",function(e,t){0}),d3.text("build/partials/collectionModal.html",function(e,t){r=t}),d3.text("build/partials/occurrences.html",function(e,t){i=t}),d3.text("build/partials/stackedCollectionModal.html",function(e,t){s=t})},changeMaps:function(e){paleo_nav.getPrevalence();var t=15<$("#time").height()?$("#time").height():window.innerHeight/5.6,t=[window.innerWidth/2,(window.innerHeight-t-70)/2],t=d3.geo.mercator().scale(165).precision(.1).translate(t).invert(e),e=(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){var e;return"hidden"===d3.select(".timeScale").style("visibility")?window.innerHeight-70+"px":(e=15<$("#time").height()?$("#time").height():window.innerHeight/5.6,window.innerHeight-e-56+"px")}),map.setView([parseInt(t[1]),parseInt(t[0])],3,{animate:!1}),map.getBounds());360<Math.abs(e._northEast.lng)+Math.abs(e._southWest.lng)&&map.setZoom(4,{animate:!1}),navMap.refresh("reset"),map.invalidateSize()},goTo:function(e,t){t<3||(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){return.7*window.innerHeight+"px"}),map._resetView(e,t))},selectBaseMap:function(e){e<5||4<e&&e<7?map.hasLayer(cartoVoyagerLabels)&&(map.removeLayer(cartoVoyagerLabels),map.addLayer(cartoVoyager)):map.hasLayer(cartoVoyager)?map.removeLayer(cartoVoyager):map.hasLayer(cartoVoyagerLabels)&&(map.addLayer(cartoVoyagerLabels),map.removeLayer(cartoVoyager))},refresh:function(e){paleo_nav.showLoading(),h-map.getZoom()!=0&&d3.select(".leaflet-zoom-hide").style("visibility","hidden");var t=navMap.checkFilters();if(parseInt(d3.select("#map").style("height"))<1){void 0!==d&&0<Object.keys(d).length&&(d.abort(),d={});var n=paleo_nav.dataUrl+paleo_nav.dataService+"/colls/summary.json?lngmin=-180&lngmax=180&latmin=-90&latmax=90&show=time";if(t){if(!0!==f.exist.selectedInterval||f.exist.personFilter||f.exist.taxon||f.exist.stratigraphy||f.exist.researchGroup)n=navMap.parseURL(n+="&level=1");else if(n=navMap.parseURL(n+="&level=1"),void 0!==timeScale.interval_hash[f.selectedInterval.oid]){if(void 0!==timeScale.interval_hash[f.selectedInterval.oid].data)return navMap.refreshHammer(timeScale.interval_hash[f.selectedInterval.oid].data);d=d3.json(n,function(e,t){return e?paleo_nav.hideLoading():(timeScale.interval_hash[f.selectedInterval.oid].data=t,navMap.refreshHammer(t))})}}else n=navMap.parseURL(n+="&level=1");d=d3.json(n,function(e,t){if(e)return paleo_nav.hideLoading();navMap.refreshHammer(t)})}else{var a,r,i=map.getBounds(),s=i._southWest,i=i._northEast,o=map.getZoom(),l=(i.lat+s.lat)/2,c=(i.lng+s.lng)/2,l=(180<c?c-=360:c<-180&&(c+=360),Math.abs(l).toFixed(2)+(l<0?"º S":"º N")),c=Math.abs(c).toFixed(2)+(c<0?"º W":"º E");if($("#latdisplay").text(l),$("#lngdisplay").text(c),s.lat=s.lat.toFixed(4),s.lng=s.lng.toFixed(4),i.lat=i.lat.toFixed(4),i.lng=i.lng.toFixed(4),!e)if(p.lat>i.lat&&p.lng>i.lng&&u.lat<s.lat&&u.lng<s.lng){if(!(h<3&&2<o||h<5&&4<o))if(!(h<7&&6<o))return h===o?(h=o,void paleo_nav.hideLoading()):(a=d3.selectAll(".bins"),6<o?(r=d3.selectAll(".clusters"),h=o,navMap.redrawPoints(a,r)):(h=o,navMap.redrawPoints(a)))}else if(2<h&&o<7)if(t)if(!(!0!==f.exist.selectedInterval||f.exist.personFilter||f.exist.taxon||f.exist.stratigraphy||f.exist.researchGroup))if(!(d3.select("#binHolder").selectAll("circle")[0].length<1))if(!(h<7&&6<o||6<h&&o<7))return a=d3.selectAll(".bins"),6<o?(r=d3.selectAll(".clusters"),h=o,navMap.redrawPoints(a,r)):(h=o,navMap.redrawPoints(a));if(p=i,h=o,(u=s).lat=s.lat<-90?-90:s.lat,i.lat=90<i.lat?90:i.lat,void 0!==d&&0<Object.keys(d).length&&(d.abort(),d={}),o<5&&!1===t){n=paleo_nav.dataUrl+paleo_nav.dataService+"/colls/summary.json?lngmin="+s.lng+"&lngmax="+i.lng+"&latmin="+s.lat+"&latmax="+i.lat+"&level=2&show=time";d=d3.json(navMap.parseURL(n),function(e,t){if(e)return paleo_nav.hideLoading();navMap.drawBins(t,1,o)})}else if(4<o&&o<7||o<5&&!0===t)if(!0!==f.exist.selectedInterval||f.exist.personFilter||f.exist.taxon||f.exist.stratigraphy||f.exist.researchGroup){n=paleo_nav.dataUrl+paleo_nav.dataService+"/colls/summary.json?lngmin="+s.lng+"&lngmax="+i.lng+"&latmin="+s.lat+"&latmax="+i.lat+"&level=3&show=time";n=navMap.parseURL(n),d=d3.json(n,function(e,t){if(e)return paleo_nav.hideLoading();navMap.drawBins(t,2,o)})}else{var n=paleo_nav.dataUrl+paleo_nav.dataService+"/colls/summary.json?lngmin=-180&lngmax=180&latmin=-90&latmax=90&show=time&level=3";if(n=navMap.parseURL(n),void 0!==timeScale.interval_hash[f.selectedInterval.oid]){if(void 0!==timeScale.interval_hash[f.selectedInterval.oid].data)return navMap.drawBins(timeScale.interval_hash[f.selectedInterval.oid].data,2,o);d=d3.json(n,function(e,t){return e?paleo_nav.hideLoading():(timeScale.interval_hash[f.selectedInterval.oid].data=t,navMap.drawBins(t,2,o))})}}else{n=paleo_nav.dataUrl+paleo_nav.dataService+"/colls/list.json?lngmin="+s.lng+"&lngmax="+i.lng+"&latmin="+s.lat+"&latmax="+i.lat+"&show=ref,time,strat,geo,lith,entname,prot&markrefs";n=navMap.parseURL(n),d=d3.json(n,function(e,t){if(e)return paleo_nav.hideLoading();navMap.drawCollections(t,3,o)})}}},redrawPoints:function(e,t){d3.select(".leaflet-zoom-hide").style("visibility","hidden");var n,a=map.getZoom();n=a<5?(navMap.checkFilters()?d3.scale.log().domain([1,400]):d3.scale.linear().domain([1,3140])).range([4,20]):4<a&&a<7?d3.scale.log().domain([1,1e3]).range([4,30]):d3.scale.linear().domain([1,400]).range([12,30]),e.attr("cx",function(e){return map.latLngToLayerPoint([e.lat,e.lng]).x}),e.attr("cy",function(e){return map.latLngToLayerPoint([e.lat,e.lng]).y}),t?(t.attr("cx",function(e){return map.latLngToLayerPoint([e.lat,e.lng]).x}),t.attr("cy",function(e){return map.latLngToLayerPoint([e.lat,e.lng]).y}),t.attr("r",function(e){return n(e.members.length)}),e.attr("r",12)):d3.select("#binHolder").selectAll(".bins")[0].length<30?e.attr("r",8):e.attr("r",function(e){return n(e.nco)*navMap.multiplier(a)<4?4:n(e.nco)*navMap.multiplier(a)}),paleo_nav.hideLoading(),d3.select(".leaflet-zoom-hide").style("visibility","visible")},refreshHammer:function(e){navMap.summarize(e);var t=d3.scale.linear().domain([1,4240]).range([4,15]),n=d3.select("#svgMap").select("svg").select("g"),n=n.selectAll("circle").data(e.records);n.enter().append("circle").attr("id",function(e){return"p"+e.cxi}).attr("class","binsHammer").on("mouseout",function(){navMap.setInfoSummary(),timeScale.unhighlight()}),n.style("fill",function(e){return timeScale.interval_hash[e.cxi]?timeScale.interval_hash[e.cxi].color:"#000"}).attr("id",function(e){return"p"+e.cxi}).attr("r",function(e){return t(e.nco)*navMap.multiplier(2)}).attr("cx",function(e){return a([e.lng,e.lat])[0]}).attr("cy",function(e){return a([e.lng,e.lat])[1]}).on("mouseover",function(e){d3.select(".info").html("<strong>"+e.nco+" collections</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(e){navMap.changeMaps(d3.mouse(this))}),n.exit().remove(),reconstructMap.reconstructing||paleo_nav.hideLoading()},drawBins:function(e,t,n){navMap.summarize(e),d3.selectAll(".clusters").remove();e=d3.select("#binHolder").selectAll(".bins").data(e.records);e.attr("id",function(e){return"p"+e.cxi}).style("fill",function(e){return timeScale.interval_hash[e.cxi]?timeScale.interval_hash[e.cxi].color:"#000"}).on("mouseover",function(e){d3.select(".info").html("<strong>"+e.nco+" collections</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(e){2===t?(d3.select(".info").html("<strong>"+e.nco+" collections</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openBinModal(e)):1===t&&map.setView([e.lat,e.lng],5)}),e.enter().append("circle").attr("class","bins").attr("id",function(e){return"p"+e.cxi}).style("fill",function(e){return timeScale.interval_hash[e.cxi]?timeScale.interval_hash[e.cxi].color:"#000"}).on("mouseover",function(e){d3.select(".info").html("<strong>"+e.nco+" collections</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(e){2===t?(d3.select(".info").html("<strong>"+e.nco+" collections</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openBinModal(e)):1===t&&map.setView([e.lat,e.lng],5)}).on("mouseout",function(){navMap.setInfoSummary(),timeScale.unhighlight()}),e.exit().remove(),navMap.redrawPoints(e)},drawCollections:function(e,t,n){navMap.summarize(e);for(var a=d3.select("#binHolder"),r=[],i=0;i<e.records.length;i++)for(var s=0;s<e.records.length;s++)if(e.records[i].lat===e.records[s].lat&&e.records[i].lng===e.records[s].lng&&e.records[i].oid!=e.records[s].oid){for(var o={lat:e.records[i].lat,lng:e.records[i].lng,members:[]},l=0,c=0;c<r.length;c++)o.lat===r[c].lat&&o.lng===r[c].lng&&(l+=1);if(l<1){r.push(o);break}break}for(var d=[],i=0;i<r.length;i++)for(s=0;s<e.records.length;s++)r[i].lat===e.records[s].lat&&r[i].lng===e.records[s].lng&&(r[i].members.push(e.records[s]),d.push(e.records[s].oid));for(i=0;i<d.length;i++){var u=navMap.getIndex(e.records,d[i],"oid");e.records.splice(u,1)}r.forEach(function(e){var t=[];e.members.forEach(function(e){t.push(e.noc)}),e.cxi=e.members[0].cxi,e.noc=d3.sum(t),e.nam=e.members.length+" Collections"});(r=a.selectAll(".clusters").data(r)).attr("id",function(e){return"p"+e.members[0].cxi}).style("fill",function(e){return(e.cxi&&timeScale.interval_hash[e.cxi]?timeScale.interval_hash[e.cxi]:timeScale.interval_hash[0]).color}).on("mouseover",function(e){d3.select(".info").html("<strong>"+e.nam+"</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(e){d3.select(".info").html("<strong>"+e.nam+"</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openStackedCollectionModal(e)}).on("mouseout",function(e){navMap.setInfoSummary(),timeScale.unhighlight()}),r.enter().append("circle").attr("class","clusters").attr("id",function(e){return"p"+e.members[0].cxi}).style("fill",function(e){return timeScale.interval_hash[e.members[0].cxi]?timeScale.interval_hash[e.members[0].cxi].color:"#000"}).on("mouseover",function(e){d3.select(".info").html("<strong>"+e.members.length+" collections</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("mouseout",function(e){navMap.setInfoSummary(),timeScale.unhighlight()}).on("click",function(e){d3.select(".info").html("<strong>"+e.nam+"</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openStackedCollectionModal(e)}),r.exit().remove();a=a.selectAll(".bins").data(e.records);a.attr("id",function(e){return"p"+e.cxi}).style("fill",function(e){return timeScale.interval_hash[e.cxi]?timeScale.interval_hash[e.cxi].color:"#000"}).on("mouseover",function(e){d3.select(".info").html("<strong>"+e.nam+"</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(e){d3.select(".info").html("<strong>"+e.nam+"</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openCollectionModal(e)}).on("mouseout",function(e){navMap.setInfoSummary(),timeScale.unhighlight()});a.enter().append("circle").attr("id",function(e){return"p"+e.cxi}).attr("class","bins").style("fill",function(e){return timeScale.interval_hash[e.cxi]?timeScale.interval_hash[e.cxi].color:"#000"}).on("mouseover",function(e){d3.select(".info").html("<strong>"+e.nam+"</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(e){d3.select(".info").html("<strong>"+e.nam+"</strong><br>"+e.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openCollectionModal(e)}).on("mouseout",function(e){navMap.setInfoSummary(),timeScale.unhighlight()}),a.exit().remove(),navMap.redrawPoints(a,r)},getOffsetCollections:function(e,n){d3.json(paleo_nav.dataUrl+paleo_nav.dataService+"/colls/list.json?clust_id="+e+"&show=ref,loc,time,strat,geo,lith,entname,prot&markrefs&limit=20&offset="+n,function(e,t){if(e)return paleo_nav.hideLoading();t.records.forEach(function(e){e.intervals=e.oli?e.oei+" - "+e.oli:e.oei,e.strat=!!(e.sfm||e.sgr||e.smb),e.lat=Math.round(1e4*e.lat)/1e4,e.lng=Math.round(1e4*e.lng)/1e4,e.oid=e.oid.replace("col:","")});e=Mustache.render(s,{members:t.records});$("#collectionCount").html("Showing "+n+" of "+t.records_found+" collections"),$("#collectionAccordion").append(e),($(".show-more-collections").data()["shown-collections"]=n)>=$(".show-more-collections").data("total-collections")&&$(".show-more-collections").hide(),$(".filterByStrat").click(function(e){e.preventDefault(),navMap.filterByStratigraphy({nam:$(this).attr("data-name"),type:$(this).attr("data-rank")}),$("#collectionModal").modal("hide")}),$(".occurrenceTab").on("show.bs.tab",function(e){var a=(a=e.target.id).replace("occToggle",""),e=navMap.parseURL(paleo_nav.dataUrl+paleo_nav.dataService+"/occs/list.json?coll_id="+a+"&show=phylo,ident");d3.json(e,function(e,t){if(e)return paleo_nav.hideLoading();var n;0<t.records.length?(e=navMap.buildTaxonHierarchy(t),n=Mustache.render(i,e),$("#occurrences"+a).html(n),$(".filterByOccurrence").click(function(e){e.preventDefault(),navMap.filterByTaxon($(this).attr("data-name")),$("#collectionModal").modal("hide")})):(n=Mustache.render(i,{error:"No occurrences found for this collection"}),$("#occurrences"+a).html(n))})}),$("#collectionLoading").hide()})},openBinModal:function(e,t,n,a){$("#loading").show();var r=(e.properties||e).oid,e=paleo_nav.dataUrl+paleo_nav.dataService+"/colls/list.json?clust_id="+r,e=navMap.parseURL(e);e+="&show=ref,loc,time,strat,geo,lith,entname,prot&markrefs&limit=20&rowcount",d3.json(e,function(e,t){if(e)return paleo_nav.hideLoading();t.records.forEach(function(e){e.intervals=e.oli?e.oei+" - "+e.oli:e.oei,e.strat=!!(e.sfm||e.sgr||e.smb),e.lat=Math.round(1e4*e.lat)/1e4,e.lng=Math.round(1e4*e.lng)/1e4,e.oid=e.oid.replace("col:","")});e=Mustache.render(s,{members:t.records});d3.select("#collectionCount").html("Showing "+t.records.length+" of "+t.records_found+" collections"),d3.select("#collectionAccordion").html(e),$(".show-more-collections").data("total-collections",t.records_found).data("shown-collections",t.records_returned),$(".collectionCollapse").on("show.bs.collapse",function(e){var n=(n=e.target.id).replace("collapse","");d3.json(paleo_nav.dataUrl+paleo_nav.dataService+"/colls/single.json?id="+n+"&show=ref,time,strat,geo,lith,entname,prot&markrefs",function(e,t){if(e)return paleo_nav.hideLoading();$("#ref"+n).html(t.records[0].ref)})}),$(".occurrenceTab").on("show.bs.tab",function(e){var a=(a=e.target.id).replace("occToggle",""),e=navMap.parseURL(paleo_nav.dataUrl+paleo_nav.dataService+"/occs/list.json?coll_id="+a+"&show=phylo,ident");d3.json(e,function(e,t){if(e)return paleo_nav.hideLoading();var n;0<t.records.length?(e=navMap.buildTaxonHierarchy(t),n=Mustache.render(i,e),$("#occurrences"+a).html(n),$(".filterByOccurrence").click(function(e){e.preventDefault(),navMap.filterByTaxon($(this).attr("data-name")),$("#collectionModal").modal("hide")})):(n=Mustache.render(i,{error:"No occurrences found for this collection"}),$("#occurrences"+a).html(n))})}),t.records_found<=t.records_returned?($(".show-more-collections").hide(),$("#collectionCount").hide()):$(".show-more-collections").show().off("click").on("click",function(){$("#collectionLoading").show(),$(".show-more-collections").data().offset+=20,navMap.getOffsetCollections(r,$(".show-more-collections").data().offset)}),$(".filterByStrat").click(function(e){e.preventDefault(),navMap.filterByStratigraphy({nam:$(this).attr("data-name"),type:$(this).attr("data-rank")}),$("#binModal").modal("hide")}),$("#binModal").modal(),$("#loading").hide()})},buildTaxonHierarchy:function(e){var u={phyla:[]};e.records.forEach(function(e){e.rank=e.rnk?taxaBrowser.rankMap(e.rnk):e.idr?taxaBrowser.rankMap(e.idr):"Unknown",e.italics=e.rnk<6?"italics":"",void 0===e.tna&&(e.tna=e.idn),e.old_name=e.tna.split(" ")[0]!=e.idg?e.tna:"",e.url="species"===e.rank?e.idg+" "+e.ids:e.tid&&0<e.tid.split(":")[1]?e.idg:"",e.idg?(i=e.rsg?e.rsg+" ":"",d=e.rss?" "+e.rss+" ":" ",e.genusRes=i,"species"===e.rank?(e.display_name1=e.tna,e.display_name2=e.tna!=e.idg+" "+e.ids?"("+e.tna+")":"",e.display_name3=""):(e.display_name1=e.idg,e.display_name2=d,e.display_name3=e.ids)):(e.display_name1=e.tna,e.display_name2="");for(var t=[],n=0;n<u.phyla.length;n++)t.push(u.phyla[n].phylum);t.indexOf(e.phl)<0&&(i={phylum:e.phl,classes:[]},u.phyla.push(i));for(var a=[],n=0;n<u.phyla.length;n++)for(var r=0;r<u.phyla[n].classes.length;r++)a.push(u.phyla[n].phylum+"-"+u.phyla[n].classes[r].nameClass);a.indexOf(e.phl+"-"+e.cll)<0&&(d={nameClass:e.cll,families:[]},l=navMap.getIndex(u.phyla,e.phl,"phylum"),u.phyla[l].classes.push(d));for(var i,s=[],n=0;n<u.phyla.length;n++)for(r=0;r<u.phyla[n].classes.length;r++)for(var o=0;o<u.phyla[n].classes[r].families.length;o++)s.push(u.phyla[n].phylum+"-"+u.phyla[n].classes[r].nameClass+"-"+u.phyla[n].classes[r].families[o].family);s.indexOf(e.phl+"-"+e.cll+"-"+e.fml)<0&&(i={family:e.fml,genera:[]},l=navMap.getIndex(u.phyla,e.phl,"phylum"),c=navMap.getIndex(u.phyla[l].classes,e.cll,"nameClass"),u.phyla[l].classes[c].families.push(i));var l=navMap.getIndex(u.phyla,e.phl,"phylum"),c=navMap.getIndex(u.phyla[l].classes,e.cll,"nameClass"),d=navMap.getIndex(u.phyla[l].classes[c].families,e.fml,"family");u.phyla[l].classes[c].families[d].genera.push(e)});for(var t=0;t<u.phyla.length;t++){for(var n=0;n<u.phyla[t].classes.length;n++){for(var a,r=0;r<u.phyla[t].classes[n].families.length;r++)void 0===u.phyla[t].classes[n].families[r].family&&(a=r,u.phyla[t].classes[n].families[r].family=(u.phyla[t].classes[n].nameClass,"Miscellaneous unranked taxa"),u.phyla[t].classes[n].families[r].noFamily=!0);void 0!==a&&u.phyla[t].classes[n].families.push(u.phyla[t].classes[n].families.splice(a,1)[0]),void 0===u.phyla[t].classes[n].nameClass&&(a=n,u.phyla[t].classes[n].nameClass=(u.phyla[t].phylum,"Miscellaneous unranked taxa"),u.phyla[t].classes[n].noClass=!0)}void 0===u.phyla[t].phylum&&(u.phyla[t].phylum="Unranked taxa",u.phyla[t].unranked=!0)}return u},openCollectionModal:function(e){$("#loading").show(),d3.json(paleo_nav.dataUrl+paleo_nav.dataService+"/colls/single.json?id="+e.oid+"&show=ref,time,strat,geo,lith,entname,prot&markrefs",function(e,t){if(e)return paleo_nav.hideLoading();t.records.forEach(function(e){e.intervals=e.oli?e.oei+" - "+e.oli:e.oei,e.strat=!!(e.sfm||e.sgr||e.smb),e.lat=Math.round(1e4*e.lat)/1e4,e.lng=Math.round(1e4*e.lng)/1e4,e.oid=e.oid.replace("col:","")});e=Mustache.render(r,t);switch($("#collectionName").html(t.records[0].nam),$("#collectionModalBody").html(e),t.records[0].ptd){case"NPS":$(".nationalParks").css("display","block"),$(".general, .federalLands").css("display","none");break;case"FED":$(".federalLands").css("display","block"),$(".general, .nationalParks").css("display","none");break;default:$(".general").css("display","block"),$(".nationalParks, .federalLands").css("display","none")}$(".filterByStrat").click(function(e){e.preventDefault(),navMap.filterByStratigraphy({nam:$(this).attr("data-name"),type:$(this).attr("data-rank")}),$("#collectionBox").modal("hide")}),$("#collectionBox").modal(),$(".occurrenceTab").on("show.bs.tab",function(e){var a=(a=e.target.id).replace("occToggle",""),e=navMap.parseURL(paleo_nav.dataUrl+paleo_nav.dataService+"/occs/list.json?coll_id="+a+"&show=phylo,ident");d3.json(e,function(e,t){if(e)return paleo_nav.hideLoading();var n;0<t.records.length?(e=navMap.buildTaxonHierarchy(t),n=Mustache.render(i,e),$("#occurrences"+a).html(n),$(".filterByOccurrence").click(function(e){e.preventDefault(),navMap.filterByTaxon($(this).attr("data-name")),$("#collectionBox").modal("hide")})):(n=Mustache.render(i,{error:"No occurrences found for this collection"}),$("#occurrences"+a).html(n))})}),$("#loading").hide()})},openStackedCollectionModal:function(e){var t=e.members[0].ptd,n=(e.members.forEach(function(e){e.intervals=e.oli?e.oei+" - "+e.oli:e.oei,e.strat=!!(e.sfm||e.sgr||e.smb),e.lat=Math.round(1e4*e.lat)/1e4,e.lng=Math.round(1e4*e.lng)/1e4,e.oid=e.oid.replace("col:","")}),Mustache.render(s,e));switch(d3.select("#binID").html("Fossil Collections at ["+Math.round(1e4*e.lat)/1e4+", "+Math.round(1e4*e.lng)/1e4+"]"),d3.select("#accordion").html(n),$(".collectionCollapse").on("show.bs.collapse",function(e){var n=(n=e.target.id).replace("collapse","");d3.json(paleo_nav.dataUrl+paleo_nav.dataService+"/colls/single.json?id="+n+"&show=ref,time,strat,geo,lith,entname,prot&markrefs",function(e,t){if(e)return paleo_nav.hideLoading();$("#ref"+n).html(t.records[0].ref)})}),$(".occurrenceTab").on("show.bs.tab",function(e){var a=(a=e.target.id).replace("occToggle",""),e=navMap.parseURL(paleo_nav.dataUrl+paleo_nav.dataService+"/occs/list.json?coll_id="+a+"&show=phylo,ident");d3.json(e,function(e,t){if(e)return paleo_nav.hideLoading();var n;0<t.records.length?(e=navMap.buildTaxonHierarchy(t),n=Mustache.render(i,e),$("#occurrences"+a).html(n),$(".filterByOccurrence").click(function(e){e.preventDefault(),navMap.filterByTaxon($(this).attr("data-name")),$("#collectionModal").modal("hide")})):(n=Mustache.render(i,{error:"No occurrences found for this collection"}),$("#occurrences"+a).html(n))})}),t){case"NPS":$(".nationalParks").css("display","block"),$(".general, .federalLands").css("display","none");break;case"FED":$(".federalLands").css("display","block"),$(".general, .nationalParks").css("display","none");break;default:$(".general").css("display","block"),$(".nationalParks, .federalLands").css("display","none")}$(".filterByStrat").click(function(e){e.preventDefault(),navMap.filterByStratigraphy({nam:$(this).attr("data-name"),type:$(this).attr("data-rank")}),$("#collectionModal").modal("hide")}),$("#collectionModal").modal()},buildWKT:function(e){for(var t="",n=0;n<e.length;n++)t+="POINT("+e[n].lat+" "+e[n].lng+" "+e[n].oid+"),";return t=t.slice(0,-1),t=encodeURI(t)},parseURL:function(t){var e,n=0;for(e in f.exist)if(f.exist.hasOwnProperty(e)&&!0===f.exist[e]){switch(e){case"selectedInterval":t+="&interval_id="+f.selectedInterval.oid;break;case"personFilter":t+="&occs_authent_by="+f.personFilter.id;break;case"researchGroup":t+="&research_group="+f.researchGroup.name;break;case"country":t+="&cc="+f.country.cc2;break;case"taxon":t+="&base_id=",f.taxa.forEach(function(e){t+=e.id+","}),t=t.slice(0,-1);break;case"stratigraphy":t+="&strat="+f.stratigraphy.name+" "+f.stratigraphy.rank}n+=1}return"undefined"!=typeof rgFilter&&rgFilter&&(t+="&research_group="+rgFilter),0<n&&"none"===d3.select("#reconstructMap").style("display")&&d3.select(".filters").style("display","block"),t},checkFilters:function(){var e,t=0;for(e in f.exist)f.exist.hasOwnProperty(e)&&!0===f.exist[e]&&(t+=1);return 0<t?(d3.select(".filters").style("display","block"),d3.select("#filterTitle").html("Filters"),!0):(d3.select(".filters").style("display","none"),d3.select("#filterTitle").html("No filters selected"),!1)},getIndex:function(e,t,n){for(var a=0,r=e.length;a<r;a++)if(e[a][n]===t)return a;return-1},multiplier:function(e){switch(e){case 2:return navMap.checkFilters()?.8:.7;case 3:return navMap.checkFilters()?.2:1;case 4:return navMap.checkFilters()?.48:2;case 5:return navMap.checkFilters()?.68:.6;case 6:return navMap.checkFilters()?.88:.8;case 7:return 1.5;default:return 1}},resizeSvgMap:function(){var n=parseInt(d3.select("#graphics").style("width")),a=d3.select("#svgMap").select("svg");d3.select("#svgMap").select("svg").select("g").attr("transform",function(){try{t=a.node().getBBox()}catch(e){t={x:a.node().clientLeft,y:a.node().clientTop,width:a.node().clientWidth,height:a.node().clientHeight}}var t,e;window.innerHeight;return n>t.width+70?"scale("+window.innerHeight/680+")translate("+(n-t.width)/3+",0)":(t=.7*window.innerHeight-70,"scale("+n/970+")translate(0,"+(0<(t-(e=n/970*500))/2?(t-e)/2:40)+")")}),d3.select("#svgMap").select("svg").style("height",function(e){var t;return"hidden"===d3.select(".timeScale").style("visibility")?window.innerHeight-60+"px":(t=15<$("#time").height()?$("#time").height():window.innerHeight/5.6,window.innerHeight-t-60+"px")}).style("width",function(e){return n-15+"px"})},resize:function(){window.innerWidth<700?(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){return window.innerHeight-55+"px"}),map.invalidateSize(),$("#downloadDataTab").removeClass("active"),$("#downloadData").removeClass("active"),$("#urlTab").addClass("active"),$("#getURL").addClass("active")):1<parseInt(d3.select("#map").style("height"))?(d3.select("#map").style("height",function(e){var t;return"hidden"===d3.select(".timeScale").style("visibility")?window.innerHeight-70+"px":(t=15<$("#time").height()?$("#time").height():window.innerHeight/5.6,window.innerHeight-t-54+"px")}),map.invalidateSize()):navMap.resizeSvgMap(),d3.select("#infoContainer").style("bottom",function(){return window.innerWidth<468?"91px":parseInt(d3.select("#time").select("svg").style("height"))+15+"px"}),d3.select(".prevalence-summary, .prevalence-row").style("height",function(){return window.innerHeight-parseInt(d3.select("#time").select("svg").style("height"))-121+"px"}),600<window.innerHeight?d3.select(".filters").style("left",0).style("top","inherit").style("bottom",function(){return parseInt(d3.select("#time").select("svg").style("height"))+4+"px"}):d3.select(".filters").style("left","49px").style("top",0).style("bottom","inherit"),d3.selectAll(".helpModalTimescaleLabel").style("top",function(){var e=15<$("#time").height()?$("#time").height():window.innerHeight/5.6;return window.innerHeight-e-78+"px"}),$(".universalSearchForm > div > .twitter-typeahead > .tt-dropdown-menu").width($(".universalSearchForm > div > .twitter-typeahead").width()-21)},refreshFilterHandlers:function(){d3.selectAll(".removeFilter").on("click",function(){var e=d3.select(this).node().parentNode,t=(e=d3.select(e)).attr("id"),n=parseInt(e.attr("data-id"));switch(t){case"selectedInterval":e.style("display","none").html(""),f.exist.selectedInterval=!1,d3.select(".time").style("box-shadow",""),timeScale.unhighlight();for(var a=Object.keys(f[t]),r=0;r<a.length;r++)f[t][a[r]]="";break;case"personFilter":e.style("display","none").html(""),f.exist.personFilter=!1,d3.select(".userFilter").style("box-shadow","");for(a=Object.keys(f[t]),r=0;r<a.length;r++)f[t][a[r]]="";break;case"researchGroup":e.style("display","none").html(""),f.exist.researchGroup=!1;for(a=Object.keys(f[t]),r=0;r<a.length;r++)f[t][a[r]]="";break;case"countryFilter":e.style("display","none").html(""),f.exist.country=!1;for(a=Object.keys(f.country),r=0;r<a.length;r++)f.country[a[r]]="";break;case"taxon":e.remove(),navMap.removeTaxonFilters([n]);break;case"stratFilter":e.style("display","none").html(""),f.exist.stratigraphy=!1;for(a=Object.keys(f.stratigraphy),r=0;r<a.length;r++)f.stratigraphy[a[r]]=""}paleo_nav.getPrevalence(),"block"===d3.select("#reconstructMap").style("display")?reconstructMap.rotate(f.selectedInterval):navMap.refresh("reset")})},updateFilterList:function(e,n){switch(paleo_nav.getPrevalence(),e){case"selectedInterval":d3.select("#selectedInterval").style("display","block").html(f.selectedInterval.nam+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),d3.select(".time").style("box-shadow","inset 3px 0 0 #ff992c"),navMap.refreshFilterHandlers();break;case"personFilter":d3.select("#personFilter").style("display","block").html(f.personFilter.name+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),d3.select(".userFilter").style("box-shadow","inset 3px 0 0 #ff992c"),navMap.refreshFilterHandlers();break;case"researchGroup":d3.select("#researchGroup").style("display","block").html(f.researchGroup.name+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),d3.select(".rgFilter").style("box-shadow","inset 3px 0 0 #ff992c"),navMap.refreshFilterHandlers();break;case"country":d3.select("#countryFilter").style("display","block").html(f.country.name+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),navMap.refreshFilterHandlers();break;case"taxon":var a;f.taxa.forEach(function(e,t){e.id===n&&(a=t)}),d3.select(".filters").append("div").attr("id","taxon").attr("class","filter").attr("data-id",n).style("display","block").html(f.taxa[a].name+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),d3.select(".taxa").style("box-shadow","inset 3px 0 0 #ff992c"),navMap.refreshFilterHandlers();break;case"stratigraphy":d3.select("#stratFilter").style("display","block").html(f.stratigraphy.name+" "+f.stratigraphy.rank+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),navMap.refreshFilterHandlers()}600<window.innerHeight?d3.select(".filters").style("left",0).style("top","inherit").style("bottom",function(){return parseInt(d3.select("#time").select("svg").style("height"))+4+"px"}):d3.select(".filters").style("left","49px").style("top",0).style("bottom","inherit")},filterByTime:function(t){var e=d3.selectAll("rect").filter(function(e){return e.name===t})[0][0].__data__;f.selectedInterval.nam=e.name,f.selectedInterval.mid=e.mid,f.selectedInterval.col=e.color,f.selectedInterval.oid=e.id,f.exist.selectedInterval=!0,navMap.updateFilterList("selectedInterval")},removeTaxonFilters:function(n){d3.selectAll(".filters > .filter").each(function(e){var t=parseInt(d3.select(this).attr("data-id"));-1<n.indexOf(t)&&d3.select(this).remove()}),navMap.filters.taxa=navMap.filters.taxa.filter(function(e){if(n.indexOf(e.id)<0)return e}),navMap.filters.taxa.length<1&&(navMap.filters.exist.taxon=!1),d3.select(".taxa").style("box-shadow","")},filterByTaxon:function(i,s){var e=(i=i||$("#taxonInput").val()).match(/^txn:|^var:/)?"id="+i:"name="+i;d3.json(paleo_nav.dataUrl+paleo_nav.dataService+"/taxa/list.json?"+e+"&show=seq",function(e,t){if(e)return alert("Error retrieving from list.json - ",e),paleo_nav.hideLoading();if(0<t.records.length){for(var n={id:parseInt(t.records[0].oid.replace("txn:","")),name:t.records[0].nam,lsq:t.records[0].lsq,rsq:t.records[0].rsq},a=0;a<navMap.filters.taxa.length;a++)if(navMap.filters.taxa[a].id===n.name)return;for(var r=[],a=0;a<navMap.filters.taxa.length;a++)n.lsq>=navMap.filters.taxa[a].lsq&&n.rsq<=navMap.filters.taxa[a].rsq&&r.push(navMap.filters.taxa[a].id),n.lsq<=navMap.filters.taxa[a].lsq&&n.rsq>=navMap.filters.taxa[a].rsq&&r.push(navMap.filters.taxa[a].id);navMap.removeTaxonFilters(r),s||taxaBrowser.goToTaxon(i),navMap.filters.taxa.push(n),navMap.filters.exist.taxon=!0,navMap.updateFilterList("taxon",n.id),"block"===d3.select("#reconstructMap").style("display")?reconstructMap.rotate(navMap.filters.selectedInterval):navMap.refresh("reset")}else alert("No taxa with this name found")})},filterByPerson:function(e,t){e&&(f.exist.personFilter=!0,f.personFilter.id=e.oid||e.id,f.personFilter.name=e.name||e.nam,navMap.updateFilterList("personFilter"),"block"===d3.select("#reconstructMap").style("display")?reconstructMap.rotate(f.selectedInterval):navMap.refresh("reset"))},filterByResearchGroup:function(e){e&&(f.exist.researchGroup=!0,f.researchGroup.name=e,navMap.updateFilterList("researchGroup"),"block"===d3.select("#reconstructMap").style("display")?reconstructMap.rotate(f.selectedInterval):navMap.refresh("reset"))},filterByCountry:function(e,t){t&&(f.exist.country=!0,f.country.name=e,f.country.cc2=t,navMap.updateFilterList("country"),"block"===d3.select("#reconstructMap").style("display")?reconstructMap.rotate(f.selectedInterval):navMap.refresh("reset"))},filterByStratigraphy:function(e){e&&(f.exist.stratigraphy=!0,f.stratigraphy.name=e.nam,f.stratigraphy.rank=e.type||e.rank,navMap.updateFilterList("stratigraphy"),navMap.refresh("reset"))},download:function(){0<$("#occs:checked").length?navMap.downloadOccs():0<$("#refs:checked").length?navMap.downloadRefs():0<$("#diver:checked").length?navMap.downloadDiversity():navMap.downloadFullDiversity()},downloadRefs:function(){var e=map.getBounds(),t=e._southWest,e=e._northEast,n=paleo_nav.dataUrl+paleo_nav.dataService+"/occs/refs.";0<$("#tsv:checked").length?n+="txt":0<$("#csv:checked").length?n+="csv":0<$("#json:checked").length?n+="json":n+="ris","block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?n+="?":(t.lat=t.lat.toFixed(4),t.lng=t.lng.toFixed(4),e.lat=e.lat.toFixed(4),e.lng=e.lng.toFixed(4),n+="?lngmin="+t.lng+"&lngmax="+e.lng+"&latmin="+t.lat+"&latmax="+e.lat),n=navMap.parseURL(n),n+="&show=comments,ent,entname,crmod&datainfo",window.open(n)},downloadOccs:function(){var e=map.getBounds(),t=e._southWest,e=e._northEast,n=paleo_nav.dataUrl+paleo_nav.dataService+"/occs/list.";if(0<$("#tsv:checked").length)n+="txt";else if(0<$("#csv:checked").length)n+="csv";else{if(!(0<$("#json:checked").length))return alert("RIS format not available for occurrences. Please select a different format.");n+="json"}"block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?n+="?":(t.lat=t.lat.toFixed(4),t.lng=t.lng.toFixed(4),e.lat=e.lat.toFixed(4),e.lng=e.lng.toFixed(4),n+="?lngmin="+t.lng+"&lngmax="+e.lng+"&latmin="+t.lat+"&latmax="+e.lat),(n=navMap.parseURL(n))==paleo_nav.dataUrl+paleo_nav.dataService+"/occs/list.csv?"&&(n+="&all_records"),n+="&show=coords,attr,loc,prot,time,strat,stratext,lith,lithext,geo,rem,ent,entname,crmod,paleoloc&datainfo",window.open(n)},downloadDiversity:function(){var e=map.getBounds(),t=e._southWest,e=e._northEast,n=paleo_nav.dataUrl+paleo_nav.dataService+"/occs/quickdiv.";if(0<$("#tsv:checked").length)n+="txt";else if(0<$("#csv:checked").length)n+="csv";else{if(!(0<$("#json:checked").length))return alert("RIS format not available for occurrences. Please select a different format.");n+="json"}"block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?n+="?lngmin=-180&lngmax=180&latmin=-90&latmax=90":(t.lat=t.lat.toFixed(4),t.lng=t.lng.toFixed(4),e.lat=e.lat.toFixed(4),e.lng=e.lng.toFixed(4),n+="?lngmin="+t.lng+"&lngmax="+e.lng+"&latmin="+t.lat+"&latmax="+e.lat),n=navMap.parseURL(n),n+="&count="+$('[name="taxonLevel"]').val()+"&reso="+$('[name="timeLevel"]').val(),window.open(n)},downloadFullDiversity:function(){var e=map.getBounds(),t=e._southWest,e=e._northEast,n=paleo_nav.dataUrl+paleo_nav.dataService+"/occs/diversity.";if(0<$("#tsv:checked").length)n+="txt";else if(0<$("#csv:checked").length)n+="csv";else{if(!(0<$("#json:checked").length))return alert("RIS format not available for occurrences. Please select a different format.");n+="json"}"block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?n+="?lngmin=-180&lngmax=180&latmin=-90&latmax=90":(t.lat=t.lat.toFixed(4),t.lng=t.lng.toFixed(4),e.lat=e.lat.toFixed(4),e.lng=e.lng.toFixed(4),n+="?lngmin="+t.lng+"&lngmax="+e.lng+"&latmin="+t.lat+"&latmax="+e.lat),n=navMap.parseURL(n),n+="&count="+$('[name="taxonLevel"]').val()+"&reso="+$('[name="timeLevel"]').val()+"&recent="+$('[name="extant"]').is(":checked"),window.open(n)},getApiUrl:function(){var e=map.getBounds(),t=e._southWest,e=e._northEast,n=paleo_nav.dataUrl+paleo_nav.dataService+"/occs/list.json";return"block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?n+="?":(t.lat=t.lat.toFixed(4),t.lng=t.lng.toFixed(4),e.lat=e.lat.toFixed(4),e.lng=e.lng.toFixed(4),n+="?lngmin="+t.lng+"&lngmax="+e.lng+"&latmin="+t.lat+"&latmax="+e.lat),n=navMap.parseURL(n),n+="&show=coords,attr,loc,prot,time,strat,stratext,lith,lithext,geo,rem,ent,entname,crmod&datainfo"},restoreState:function(e){var t;"object"==typeof e?((t=e).zoom&&2<t.zoom&&navMap.goTo(t.center,t.zoom),t.timeScale&&"Phanerozoic"!=t.timeScale&&timeScale.goTo(t.timeScale),0<t.taxaFilter.length&&t.taxaFilter.forEach(function(e){navMap.filterByTaxon(e.name||e.nam)}),"object"==typeof t.stratFilter&&""!=t.stratFilter.name&&navMap.filterByStratigraphy(t.stratFilter),"object"==typeof t.timeFilter&&""!=t.timeFilter.nam&&navMap.filterByTime(t.timeFilter.nam),0<t.authFilter.id&&navMap.filterByPerson(t.authFilter),"block"===t.reconstruct&&(reconstructMap.rotate(t.currentReconstruction),paleo_nav.toggleReconstructMap(),navMap.checkFilters()),navMap.resize(),window.scrollTo(0,0)):1<(e=window.location.hash.substr(2)).length&&d3.json("/larkin/app-state?id="+e,function(e,t){if(e)return paleo_nav.launch();e=t[0].data;e.zoom=parseInt(e.zoom),e.center[0]=parseFloat(e.center[0]),e.center[1]=parseFloat(e.center[1]),e.taxaFilter&&0<e.taxaFilter.length&&e.taxaFilter.forEach(function(e){e.id=parseInt(e.id)}),e.timeFilter.mid=parseInt(e.timeFilter.mid),e.timeFilter.oid=parseInt(e.timeFilter.oid),e.currentReconstruction.mid=parseInt(e.currentReconstruction.mid),e.currentReconstruction.id=parseInt(e.currentReconstruction.id),e.authFilter.id=parseInt(e.authFilter.id),e.zoom&&2<e.zoom&&navMap.goTo(e.center,e.zoom),e.taxaFilter&&0<e.taxaFilter.length&&e.taxaFilter.forEach(function(e){navMap.filterByTaxon(e.name)}),"object"==typeof e.stratFilter&&""!=e.stratFilter.name&&navMap.filterByStratigraphy(e.stratFilter),"object"==typeof e.timeFilter&&""!=e.timeFilter.nam&&(navMap.filterByTime(e.timeFilter.nam),navMap.refresh("redraw")),0<e.authFilter.id&&navMap.filterByPerson(e.authFilter),"block"===e.reconstruct&&(reconstructMap.rotate(e.currentReconstruction),paleo_nav.toggleReconstructMap(),navMap.checkFilters()),"Phanerozoic"!=e.timeScale&&timeScale.goTo(e.timeScale),paleo_nav.launch()})},getUrl:function(){var e=map.getCenter(),t=map.getZoom(),n=d3.select("#reconstructMap").style("display"),a={timeScale:timeScale.currentInterval.name,taxaFilter:[],timeFilter:f.selectedInterval,stratFilter:{name:f.stratigraphy.name,rank:f.stratigraphy.rank},authFilter:f.personFilter,zoom:t,center:[e.lat,e.lng],reconstruct:n,currentReconstruction:reconstructMap.currentReconstruction};return 0<f.taxa.length&&f.taxa.forEach(function(e){a.taxaFilter.push(e)}),a},summarize:function(e){0<e.records.length?("string"==typeof e.records[0].oid&&"col"===e.records[0].oid.substr(0,3)?navMap.totalCollections=t(e.records.length):navMap.totalCollections=t(d3.sum(e.records,function(e){return e.nco})),navMap.totalOccurrences=t(d3.sum(e.records,function(e){return e.noc}))):(navMap.totalCollections=0,navMap.totalOccurrences=0),navMap.setInfoSummary()},setInfoSummary:function(){d3.select(".info").style("display","block").html("<strong>"+navMap.totalCollections+" total collections</strong><br>"+navMap.totalOccurrences+" total occurrences")},filters:f,totalOccurrences:void 0}})()),paleo_nav=(()=>{var i,s,a=window.location.origin,n="https://paleobiodb.org",o="/data1.2";return-1<window.location.search.indexOf("local")?(a=window.location.origin+":3000",n=window.location.origin+":3000"):-1<window.location.search.indexOf("test")?a="https://training.paleobiodb.org":"localhost"===window.location.hostname&&(a="https://paleobiodb.org"),d3.text("build/partials/prevalent.html",function(e,t){i=t}),d3.text("build/partials/prevalent_summary.html",function(e,t){s=t}),{init:function(){var e=1800<window.innerWidth?60:1500<window.innerWidth?75:1e3<window.innerWidth?95:110;timeScale.init("time",e,function(){navMap.init(function(){navMap.resizeSvgMap(),navMap.resize(),navMap.refresh("reset")}),reconstructMap.init(),taxaBrowser.init()}),$(".zoom-in").hammer().on("tap",function(e){e.preventDefault(),parseInt(d3.select("#map").style("height"))<1?(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){return.7*window.innerHeight-70+"px"}),map.setView([7,0],3,{animate:!1}),navMap.refresh("reset"),map.invalidateSize()):map.zoomIn()}),$(".zoom-out").hammer().on("tap",function(e){e.preventDefault(),map.zoomOut()}),$(".rotate").hammer().on("tap",function(e){e.preventDefault(),reconstructMap.visible?paleo_nav.closeReconstructMap():paleo_nav.toggleReconstructMap()}),$(".taxa").hammer().on("tap",function(e){e.preventDefault(),e.stopPropagation(),"block"==d3.select("#taxaBrowser").style("display")?(paleo_nav.closeTaxaBrowser(),d3.select(".taxa").style("color","#000")):(paleo_nav.openTaxaBrowser(),d3.select(".taxa").style("color","#ff992c"))}),$("#taxaBrowserNavbar").hammer().on("tap",function(e){e.preventDefault(),$(".navbar-collapse").collapse("hide"),"block"===d3.select("#taxaBrowser").style("display")?paleo_nav.closeTaxaBrowser():paleo_nav.openTaxaBrowser(),$});$(".taxaBrowserToggle").hammer().on("tap",function(e){e.preventDefault(),e.stopPropagation(),"block"===d3.select("#taxaBrowser").style("display")?paleo_nav.closeTaxaBrowser():paleo_nav.openTaxaBrowser()});var e=Mustache.compile('<p>{{nam}}{{#msp}}<small class="misspelling">  missp.</small>{{/msp}}      <small class="taxaRank">{{rank}}</small></p>'),i=($("#taxonInput").typeahead({name:"taxaBrowser",remote:{url:a+o+"/taxa/auto.json?name=%QUERY&limit=10",filter:function(e){return e.records.forEach(function(e){e.rank=taxaBrowser.rankMap(e.rnk)}),e.records}},valueKey:"nam",minLength:3,limit:10,template:e}).on("typeahead:selected",function(e,t){taxaBrowser.goToTaxon(t.nam)}),$("input#taxonInput").keypress(function(e){13===e.which&&(e=$("input#taxonInput").data().ttView.dropdownView.getFirstSuggestion(),taxaBrowser.goToTaxon(e.datum.nam),document.activeElement.blur(),$("input#taxonInput").blur(),$("input#taxonInput").typeahead("setQuery",""))}),{member:"Mbr",formation:"Fm",group:"Gp"});$("#universalAutocompleteInput").on("keyup",function(e){var r=$("#universalAutocompleteInput").val();r.length<3?($("#universalSearchResult").html(""),$("#universalSearchResult").css("display","none")):d3.json(a+o+"/combined/auto.json?type=nav&name="+r,function(e,t){var n,a="";e?a+="<div class='autocompleteError'>Error: server did not respond</div>":0==t.records.length?a+="<div class='autocompleteError'>No matching results for \""+r+'"</div>':(n="",t.records.map(function(e){var t=e.oid.substr(0,3);switch(t){case"int":"int"!=n&&(a+="<h4 class='autocompleteTitle'>Time Intervals</h4>",n="int"),a=(a+="<div class='suggestion' data-nam='"+e.nam+"' data-rtype='"+t+"'>")+("<p class='tt-suggestion'>"+e.nam+" <small class=taxaRank>"+Math.round(e.eag)+"-"+Math.round(e.lag)+" ma</small></p></div>");break;case"str":"str"!=n&&(a+="<h4 class='autocompleteTitle'>Stratigraphic Units</h4>",n="str"),a=(a+="<div class='suggestion' data-nam='"+e.nam+"' data-rnk='"+e.rnk+"' data-rtype='"+t+"'>")+("<p class='tt-suggestion'>"+e.nam+" "+i[e.rnk]+" <small class=taxaRank>in "+e.cc2+"</small></p></div>");break;case"prs":"prs"!=n&&(a+="<h4 class='autocompleteTitle'>Authorizers</h4>",n="prs"),a=(a+="<div class='suggestion' data-nam='"+e.nam+"' data-oid='"+e.oid+"' data-rtype='"+t+"'>")+("<p class='tt-suggestion'>"+e.nam+" <small class=taxaRank>"+e.ist+"</small></p></div>");break;case"txn":"txn"!=n&&(a+="<h4 class='autocompleteTitle'>Taxa</h4>",n="txn"),a=(a+="<div class='suggestion' data-oid='"+e.oid+"' data-rtype='"+t+"'>")+(e.tdf?"<p class='tt-suggestion'>"+e.nam+" <small class=taxaRank>"+e.rnk+" in "+e.htn+"</small><br><small class=misspelling>"+e.tdf+" "+e.acn+"</small></p></div>":"<p class='tt-suggestion'>"+e.nam+" <small class=taxaRank>"+e.rnk+" in "+e.htn+"</small></p></div>");break;case"cou":"cou"!=n&&(a+="<h4 class='autocompleteTitle'>Country or Ocean</h4>",n="cou"),a=(a+="<div class='suggestion' data-nam='"+e.nam+"' data-cc2='"+e.cc2+"' data-rtype='cou'>")+("<p class='tt-suggestion'>"+e.nam+"</p></div>");break;case"rgp":"rgp"!=n&&(a+="<h4 class='autocompleteTitle'>Research Groups</h4>",n="rgp"),a=(a=(a=(a+="<div class='suggestion' data-nam='"+e.nam+"' data-rtype='rgp'>")+("<p class='tt-suggestion'>Only "+e.nam+"</p></div>"))+("<div class='suggestion' data-nam='!"+e.nam+"' data-rtype='rgp'>"))+("<p class='tt-suggestion'>Exclude "+e.nam+"</p></div>")}})),$("#universalSearchResult").html(a),$("#universalSearchResult").css("display","block"),$(".suggestion").on("click",function(e){switch(e.preventDefault(),$("#universalSearchResult").css("display","none"),$(this).attr("data-rtype")){case"int":timeScale.goTo($(this).attr("data-nam")),navMap.filterByTime($(this).attr("data-nam")),navMap.refresh("reset");break;case"str":var t={nam:$(this).attr("data-nam"),type:i[$(this).attr("data-rnk")]};navMap.filterByStratigraphy(t);break;case"prs":t={id:$(this).attr("data-oid"),nam:$(this).attr("data-nam")};navMap.filterByPerson(t),document.activeElement.blur();break;case"txn":navMap.filterByTaxon($(this).attr("data-oid"));break;case"rgp":navMap.filterByResearchGroup($(this).attr("data-nam"));break;case"cou":navMap.filterByCountry($(this).attr("data-nam"),$(this).attr("data-cc2"))}$("#universalAutocompleteInput").val("")})})});$("#universalAutocompleteInput").on("focus",function(){window.innerWidth<700&&($(".navbar-collapse").css("height",window.innerHeight-50+"px"),$(".navbar-collapse").css("max-height",window.innerHeight-50+"px"),$(".tt-dropdown-menu").css("width",$("#universalAutocompleteInput").width()+"px"))}),$("#universalAutocompleteInput").on("blur",function(){window.scrollTo(0,0),window.innerWidth<700&&($(".navbar-collapse").css("height","auto"),$(".navbar-collapse").css("max-height","340px"))}),$("#universalSearchButton").click(function(e){e.preventDefault()}),d3.select(window).on("resize",function(){timeScale.resize(),navMap.resize(),reconstructMap.resize()}),$("#binModal").on("hide.bs.modal",function(){$("#collectionLoading").hide(),$("#collectionCount").show(),$(".show-more-collections").data("offset",0),$(".show-more-collections").data("shown-collections",0),$(".show-more-collections").data("total-collections",0)}),$("#statsBox").on("show.bs.modal",function(){$(".statsContent").height(window.innerHeight-70),$(".diversityContainer").height(window.innerHeight-140),$("#diversityWait").css("display","block"),d3.select("#diversity").select("svg").remove(),$("#prevalence-container").html("");var e=map.getBounds(),t=e._southWest,e=e._northEast,n=(parseInt(d3.select("#map").style("height"))<1&&(t.lng=-180,e.lng=180,t.lat=-90,e.lat=90),navMap.parseURL(a+o+"/occs/quickdiv.json?lngmin="+t.lng.toFixed(1)+"&lngmax="+e.lng.toFixed(1)+"&latmin="+t.lat.toFixed(1)+"&latmax="+e.lat.toFixed(1)+"&count=genera&reso=stage"));$(".diversityDownload").attr("href",n),$(".divMapBounds").html(t.lng.toFixed(1)+"° to "+e.lng.toFixed(1)+"° N, "+t.lat.toFixed(1)+"° to "+e.lat.toFixed(1)+"° E"),diversityPlot.plot(n,!1)}),$("#statsBox").on("hide.bs.modal",function(){void 0!==diversityPlot.currentRequest&&0<Object.keys(diversityPlot.currentRequest).length&&(diversityPlot.currentRequest.abort(),diversityPlot.currentRequest={})}),$("#advstatsBox").on("show.bs.modal",function(){$(".advstatsContent").height(window.innerHeight-70),$(".advdiversityContainer").height(window.innerHeight-140),$("#advdiversityWait").css("display","block"),d3.select("#advdiversity").select("svg").remove();var e=map.getBounds(),t=e._southWest,e=e._northEast,t=(parseInt(d3.select("#map").style("height"))<1&&(t.lng=-180,e.lng=180,t.lat=-90,e.lat=90),navMap.parseURL(n+o+"/occs/diversity.json?lngmin="+t.lng.toFixed(1)+"&lngmax="+e.lng.toFixed(1)+"&latmin="+t.lat.toFixed(1)+"&latmax="+e.lat.toFixed(1)+"&count="+$('[name="taxonLevel"]').val()+"&reso="+$('[name="timeLevel"]').val()+"&recent="+$('[name="extant"]').is(":checked")));$(".diversityDownload").attr("href",t),diversityPlot.plot(t,!0)}),$("#advstatsBox").on("hide.bs.modal",function(){void 0!==diversityPlot.currentRequest&&0<Object.keys(diversityPlot.currentRequest).length&&(diversityPlot.currentRequest.abort(),diversityPlot.currentRequest={})}),$("#saveBox").on("show.bs.modal",function(){$("#urlTab").hasClass("active")&&$.ajax({url:"/larkin/app-state",async:!1,type:"POST",data:{state:navMap.getUrl()},ContentType:"application/x-www-form-urlencoded",dataType:"json"}).success(function(e){$("#url").val(window.location.origin+"/navigator/#/"+e.id),setTimeout(function(){$("#url").focus(),$("#url").select()},100)});var e,t=map.getBounds(),n=t._southWest,t=t._northEast;parseInt(d3.select("#map").style("height"))<1&&(n.lng=-180,t.lng=180,n.lat=-90,t.lat=90),$("#filterList").append("<li>Map extent - <small>(["+n.lat.toFixed(0)+", "+n.lng.toFixed(0)+"], ["+t.lat.toFixed(0)+", "+t.lng.toFixed(0)+"])</small></li>");for(e in navMap.filters.exist)if(navMap.filters.exist.hasOwnProperty(e)&&1==navMap.filters.exist[e]){switch(e){case"selectedInterval":$("#filterList").append("<li>Interval - "+navMap.filters.selectedInterval.nam+"</li>");break;case"personFilter":$("#filterList").append("<li>Contributor - "+navMap.filters.personFilter.name+"</li>");break;case"taxon":navMap.filters.taxa.forEach(function(e){$("#filterList").append("<li>Taxon - "+e.name+"</li>")})}0}n=a+o+"/occs/list.json?lngmin="+n.lng+"&lngmax="+t.lng+"&latmin="+n.lat+"&latmax="+t.lat+"&limit=0&rowcount",n=navMap.parseURL(n);d3.json(n,function(e,t){t=(t=.67*t.records_found)<1024?t.toFixed(0)+"KB":t<1024e3?(t/1024).toFixed(0)+"MB":(t/1024e3).toFixed(0)+"GB";d3.select("#occsLabel").html("Occurrences <small><i>(About "+t+")</i></small>")})}),$("#saveBox").on("hide.bs.modal",function(){$("#filterList").html(""),d3.select("#occsLabel").html("Occurrences "),$("#appUrl").val(""),$("#apiUrl").val(""),d3.select("#downloadCount").style("display","none"),d3.select("#diversity").select("svg").remove()}),$("#getAppUrl").on("click",function(){$.ajax({url:"/larkin/app-state",async:!1,type:"POST",data:{state:navMap.getUrl()},ContentType:"application/x-www-form-urlencoded",dataType:"json"}).success(function(e){$("#appUrl").val(window.location.origin+"/navigator/#/"+e.id),setTimeout(function(){$("#appUrl").focus(),$("#appUrl").select()},100)})}),$("#getApiUrl").on("click",function(){var e=navMap.getApiUrl();$("#apiUrl").val(e),setTimeout(function(){$("#apiUrl").focus(),$("#apiUrl").select()},100)}),$("#taxaForm").submit(function(){return navMap.filterByTaxon(),!1}),$(".helpModalClose").on("click",function(){$("#helpModal").modal("hide")}),$("#goToApp").on("click",function(){$("#helpModal").modal("hide")}),$("#trilobita").on("click",function(e){e.preventDefault(),paleo_nav.closeReconstructMap();navMap.restoreState({authFilter:{id:"",name:""},center:[30.3539163,113.24707],currentReconstruction:"",reconstruct:"none",taxaFilter:[{id:19100,nam:"Trilobita"}],timeFilter:{nam:"Cambrian",oid:22,mid:513},timeScale:"Cambrian",zoom:5}),$("#helpModal").modal("hide")}),$("#dinosauria").on("click",function(e){e.preventDefault(),paleo_nav.closeReconstructMap();navMap.restoreState({authFilter:{id:"",name:""},center:[40.5305,-109.5117],currentReconstruction:"",reconstruct:"none",taxaFilter:[{id:19968,nam:"Dinosauria"}],timeFilter:{nam:"Jurassic",oid:15,mid:173},timeScale:"Jurassic",zoom:5}),$("#helpModal").modal("hide")}),$("#plantae").on("click",function(e){e.preventDefault();navMap.restoreState({authFilter:{id:"",name:""},center:"",currentReconstruction:{nam:"Permian",col:"#F04028",mid:275,oid:17,taxon:"Plantae",person:""},taxaFilter:[],taxaFilter:[{id:151418,nam:"Plantae"}],reconstruct:"block",timeFilter:{nam:"Permian",oid:17,mid:275},timeScale:"Permian",zoom:""}),$("#helpModal").modal("hide")})},getPrevalence:function(e){$(".prevalence-summary").html(""),"undefined"!=typeof currentPrevRequest&&0<Object.keys(currentPrevRequest).length&&(currentPrevRequest.abort(),currentPrevRequest={});var t=map.getBounds(),n=t._southWest,t=t._northEast,n=(parseInt(d3.select("#map").style("height"))<1&&(n.lng=-180,t.lng=180,n.lat=-90,t.lat=90),navMap.parseURL(a+o+"/occs/prevalence.json?limit=10&lngmin="+n.lng.toFixed(1)+"&lngmax="+t.lng.toFixed(1)+"&latmin="+n.lat.toFixed(1)+"&latmax="+t.lat.toFixed(1)));currentPrevRequest=d3.json(n,function(e,t){var n=d3.scale.linear().domain([d3.min(t.records,function(e){return e.noc}),d3.max(t.records,function(e){return e.noc})]).range([40,80]),a=t.records.map(function(e){return e.noc}).reduce(function(e,t){return e+t},0),r=(t.records.forEach(function(e){var t=e.nam.split(" "),t=(e.display_name=t[0]+(1<t.length?"*":""),e.data_url=paleo_nav.dataUrl,e.height=n(e.noc),parseInt(e.noc/a*100));e.percentage=t<1?"< 1":t}),t.records.filter(function(e,t){if(t<11)return e})),t=t.records.filter(function(e,t){if(700<window.innerWidth){var n=window.innerHeight-parseInt(d3.select("#time").select("svg").style("height"));if(t<Math.floor(n/80))return e}else if(t<Math.floor(window.innerHeight/80))return e}),t=(t.forEach(function(e){e.display_text=e.display_name+(17<e.display_name.length?"":" "+e.percentage+"%")}),Mustache.render(s,{records:t})),t=($(".prevalence-summary").html(t),Mustache.render(i,{records:r}));$(".prevalence-container").html(t),$(".prevalent-summary-taxon").click(function(e){var t=$(this).data("name").replace(" (other)","").replace(" (unclassified)","").replace("*","");navMap.filterByTaxon(t)})})},prelaunch:function(){1<window.location.hash.substr(2).length?navMap.restoreState():paleo_nav.launch()},launch:function(){d3.select("#graphicRow").style("visibility","visible"),d3.select("#waiting").style("display","none"),navMap.resizeSvgMap(),setTimeout(navMap.resize,500),this.getPrevalence(),localStorage.pbdb||700<window.innerWidth&&($("#helpModal").modal("show"),localStorage.pbdb=!0)},showLoading:function(){d3.select("#loading").style("display","block")},hideLoading:function(){d3.select("#loading").style("display","none")},untoggleTaxa:function(){d3.select(".taxaToggler").style("display","none"),d3.select(".taxa").style("color","")},untoggleUser:function(){d3.select(".userToggler").style("display","none"),d3.select(".userFilter").style("color","")},openTaxaBrowser:function(){d3.select("#graphics").attr("class","col-sm-9"),d3.select("#taxaBrowser").style("display","block"),d3.select("#taxaBrowserToggle").html('<i class="fa fa-angle-double-left" style="margin-right:5px;"></i>Collapse taxa browser'),d3.select(".taxaToggler").style("display","none"),timeScale.resize(),reconstructMap.resize(),navMap.resize()},closeTaxaBrowser:function(){d3.select("#graphics").attr("class","col-sm-12"),d3.select("#taxaBrowser").style("display","none"),d3.select("#taxaBrowserToggle").html('Expand taxa browser<i class="fa fa-angle-double-right" style="margin-left:5px;"></i>'),d3.select(".taxa").style("color","#000"),timeScale.resize(),reconstructMap.resize(),navMap.resize(),navMap.resize()},toggleReconstructMap:function(){paleo_nav.untoggleTaxa(),paleo_nav.untoggleUser(),paleo_nav.closeTaxaBrowser(),reconstructMap.visible=!0,d3.select(".rotate").style("box-shadow","inset 3px 0 0 #ff992c").style("color","#ff992c"),1<parseInt(d3.select("#map").style("height"))&&d3.select("#map").style("display","none"),d3.select("#svgMap").style("display","none"),d3.select("#reconstructMap").style("display","block"),reconstructMap.resize(),$(".zoom-in").hammer().off("tap").css("color","#ccc"),$(".zoom-out").hammer().off("tap").css("color","#ccc"),navMap.filters.exist.selectedInterval?reconstructMap.rotate(navMap.filters.selectedInterval):interval.nam===reconstructMap.currentReconstruction.name&&navMap.filters.personFilter.name===reconstructMap.currentReconstruction.person&&navMap.filters.stratigraphy.name===reconstructMap.currentReconstruction.stratigraphy?navMap.filters.taxa.length===reconstructMap.currentReconstruction.taxa.length&&navMap.filters.taxa.forEach(function(t){var n=!1;reconstructMap.currentReconstruction.taxa.forEach(function(e){t.name===e.name&&(n=!0)}),n||0}):(reconstructMap.currentReconstruction.name.length,alert("Please click a time interval below to build a reconstruction map"),d3.select(".info").html("Click a time interval to reconstruct collections and plates").style("display","block"))},closeReconstructMap:function(){navMap.refresh("reset"),reconstructMap.visible=!1,d3.select("#reconstructMap").style("display","none"),timeScale.unhighlight(),$(".zoom-in").hammer().on("tap",function(e){e.preventDefault(),parseInt(d3.select("#map").style("height"))<1?(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){return.7*window.innerHeight-70+"px"}),map.setView([7,0],3,{animate:!1}),navMap.refresh("reset"),map.invalidateSize()):map.zoomIn()}).css("color","#000"),$(".zoom-out").hammer().on("tap",function(e){e.preventDefault(),map.zoomOut()}).css("color","#000"),d3.select(".prevalence-row").style("display","block"),paleo_nav.getPrevalence(),d3.select("#selectedInterval").select("button").style("display","block"),d3.select(".rotate").style("box-shadow","").style("color","#000"),d3.select(".time").style("color","#000"),(parseInt(d3.select("#map").style("height"))<1?d3.select("#svgMap"):d3.select("#map")).style("display","block"),navMap.resize(),map.invalidateSize()},dataUrl:a,testUrl:n,dataService:o}})(),timeScale=($(document).ready(function(){paleo_nav.init()}),d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},d3.selection.prototype.dblTap=function(t){var n=0;return this.each(function(){d3.select(this).on("touchstart",function(e){if(d3.event.timeStamp-n<2e3)return t(e);n=d3.event.timeStamp})})},function(){var data={id:0,color:"#000000",name:"Geologic Time",children:[]},interval_hash={0:data},currentInterval,dragStart,transformStart;function clickcancel(){var s=d3.dispatch("click","dblclick");return d3.rebind(function(e){var r,i=null;e.on("mousedown",function(e){r=d3.mouse(document.body),new Date}),e.on("mouseup",function(e){var t,n,a;null!=r&&(n=r,a=d3.mouse(document.body),5<Math.sqrt(Math.pow(n[0]-a[0],2),Math.pow(n[1]-a[1],2)))||(i?(window.clearTimeout(i),i=null,s.dblclick(d3.event)):i=window.setTimeout((t=d3.event,function(){s.click(t),i=null}),300))})},s,"on")}function num_level(e){return"eon"==e?1:"era"==e?2:"period"==e?3:"epoch"==e?4:"age"==e?5:0}function init(e,l,c){var d=d3.scale.linear().range([0,955]),u=d3.scale.linear().range([0,l]),t=.01,p=d3.behavior.drag().origin(function(){d3.select(".timeScale g");return{x:-t,y:0}}).on("dragstart",function(){dragStart=[d3.event.sourceEvent.pageX,d3.event.sourceEvent.pageY],transformStart=d3.transform(d3.select(".timeScale").select("g").attr("transform")).translate,d3.event.sourceEvent.stopPropagation()}).on("drag",function(){var e=[d3.event.sourceEvent.pageX,d3.event.sourceEvent.pageY];t=dragStart[0]-e[0],d3.select(".timeScale").select("g").attr("transform",function(){return"translate("+[parseInt(transformStart[0]+-t),0]+")scale("+parseInt(d3.select(".timeScale").style("width"))/961+")"})}),h=(d3.select("#"+e).attr("class","timeScale"),d3.select("#"+e).append("svg:svg").attr("width",960).attr("height",l).append("g")),f=h.append("g").attr("id","tickBar").attr("transform","translate(0,"+(l+15)+")");d3.json(paleo_nav.dataUrl+paleo_nav.dataService+"/intervals/list.json?scale=1&order=age.desc&max_ma=4000",function(e,t){for(var n=0;n<t.records.length;n++){var a=t.records[n].oid.replace("int:",""),a={id:a,pid:t.records[n].pid?t.records[n].pid.replace("int:",""):0,level:num_level(t.records[n].itp),color:t.records[n].col,name:t.records[n].nam,abbr:t.records[n].abr||t.records[n].nam.charAt(0),early_age:t.records[n].eag,late_age:t.records[n].lag,mid:parseInt((t.records[n].eag+t.records[n].lag)/2),total:t.records[n].eag-t.records[n].lag,children:interval_hash[a]?interval_hash[a].children:[]};interval_hash[a.id]=a,void 0===interval_hash[a.pid]&&(interval_hash[a.pid]={children:[]}),interval_hash[a.pid].children.push(a)}var r=d3.layout.partition().sort(function(e){d3.ascending(e)}).value(function(e){return e.total}),i=clickcancel();h.append("g").attr("id","rectGroup").selectAll("rect").data(r.nodes(data)).enter().append("svg:rect").attr("x",function(e){return d(e.x)}).attr("y",function(e){return u(e.y)}).attr("width",function(e){return d(e.dx)}).attr("height",function(e){return u(e.dy)}).attr("fill",function(e){return e.color||"#000000"}).attr("id",function(e){return"t"+e.id}).style("opacity",.83).call(p).call(i).dblTap(function(e){setTimeout(goTo(e),500)}).append("svg:title").text(function(e){return e.name}),i.on("dblclick",function(e){goTo(e.target.__data__)}),i.on("click",function(e){mapFilter(e.target.__data__)});var i=f.selectAll("rect").data(r.nodes(data)).enter().append("g").attr("class",function(e){return"tickGroup s"+(void 0===e.level?0:e.level)}).attr("transform",function(e){return"translate("+d(e.x)+", -20)"}),i=(i.append("line").attr("x1",0).attr("y1",7.5).attr("x2",0).attr("y2",12).style("stroke-width","0.05em"),i.append("text").attr("x",0).attr("y",function(){return 1.05*(l/6*.55+12)}).style("text-anchor",function(e){return.0117===e.early_age?"end":"middle"}).style("font-size",function(){return l/6*.55}).style("fill","#777").text(function(e){return e.early_age}),f.append("g").data([{x:1,y:0}]).attr("class","tickGroup s1 s2 s3 s4 s5").attr("transform","translate(955, -20)")),i=(i.append("line").attr("x1",0).attr("y1",7.5).attr("x2",0).attr("y2",12).style("stroke-width","0.05em"),i.append("text").attr("x",0).attr("y",function(){return 1.05*(l/6*.55+12)}).attr("id","now").style("text-anchor","end").style("font-size",function(){return l/6*.55}).style("fill","#777").text("0"),h.append("g").attr("id","textGroup")),s={0:.61,1:.89,2:.72,3:.61,4:.55,5:.55},o=clickcancel(),o=(i.selectAll("fullName").data(r.nodes(data)).enter().append("svg:text").text(function(e){return e.name}).attr("x",1).attr("y",function(e){return u(e.y)+.127*l}).attr("width",function(){return this.getComputedTextLength()}).attr("height",function(e){return u(e.dy)}).attr("class",function(e){return"fullName level"+(void 0===e.level?0:e.level)}).attr("id",function(e){return"l"+e.id}).attr("x",function(e){return labelX(e)}).style("font-size",function(e){return void 0===e.level?l/6*s[0]+"px":l/6*s[e.level]+"px"}).call(p).call(o).dblTap(function(e){setTimeout(goTo(e),500)}).append("svg:title").text(function(e){return e.name}),o.on("dblclick",function(e){goTo(e.target.__data__)}),o.on("click",function(e){mapFilter(e.target.__data__)}),clickcancel());i.selectAll("abbrevs").data(r.nodes(data)).enter().append("svg:text").attr("x",1).attr("y",function(e){return u(e.y)+.127*l}).attr("width",30).attr("height",function(e){return u(e.dy)}).text(function(e){return e.abbr||e.name.charAt(0)}).attr("class",function(e){return"abbr level"+(void 0===e.level?0:e.level)}).attr("id",function(e){return"a"+e.id}).attr("x",function(e){return labelAbbrX(e)}).style("font-size",function(e){return void 0===e.level?l/6*s[0]+"px":l/6*s[e.level]+"px"}).call(o).dblTap(function(e){setTimeout(goTo(e),500)}).append("svg:title").text(function(e){return e.name}),o.on("dblclick",function(e){goTo(e.target.__data__)}),o.on("click",function(e){mapFilter(e.target.__data__)}),c(),goTo(interval_hash[0]),d3.select(".abbr.levelundefined").remove(),goTo(interval_hash[751])}),resize()}function labelLevels(d){if(d3.select("#l"+d.id).attr("x",430),void 0!==d.parent){for(var depth=d.depth,loc="d.parent",i=0;i<depth;i++){var parent=eval(loc).name;d3.selectAll(".abbr").filter(function(e){return e.name===parent}).attr("x",430),d3.selectAll(".fullName").filter(function(e){return e.name===parent}).attr("x",430),loc+=".parent"}d3.selectAll(".abbr").filter(function(e){return e.name===parent}).attr("x",430),d3.selectAll(".fullName").filter(function(e){return e.name===parent}).attr("x",430),"hidden"===d3.select("#graphicRow").style("visibility")&&paleo_nav.prelaunch()}}function labelAbbrX(e){var t,n=parseFloat(d3.select("rect#t"+e.id).attr("width")),a=parseFloat(d3.select("rect#t"+e.id).attr("x"));try{t=d3.select("#a"+e.id).node().getComputedTextLength()}catch(e){t=11}return n-8<t&&d3.select("#a"+e.id).style("display","none"),a+(n-t)/2}function labelX(e){var t,n=parseFloat(d3.select("rect#t"+e.id).attr("width")),a=parseFloat(d3.select("rect#t"+e.id).attr("x"));try{t=d3.select("#l"+e.id).node().getComputedTextLength()}catch(e){t=25}return(n-8<t?d3.select("#l"+e.id):d3.select("#a"+e.id)).style("display","none"),a+(n-t)/2}function labelY(e){parseFloat(d3.select("rect#t"+e.id).attr("height")),parseFloat(d3.select("rect#t"+e.id).attr("y")),d3.select("#l"+e.id).node().getBBox().height,parseInt(d3.select(".timeScale").style("width"))}function labelAbbrY(e){parseFloat(d3.select("rect#t"+e.id).attr("height")),parseFloat(d3.select("rect#t"+e.id).attr("y")),d3.select("#l"+e.id).node().getBBox().height,parseInt(d3.select(".timeScale").style("width"))}function mapFilter(e){var t;e.id!==navMap.filters.selectedInterval.oid&&(highlight(e.name),navMap.filters.selectedInterval.nam=e.name,navMap.filters.selectedInterval.mid=e.mid,navMap.filters.selectedInterval.col=e.color,navMap.filters.selectedInterval.oid=e.id,navMap.filters.exist.selectedInterval=!0,navMap.updateFilterList("selectedInterval"),reconstructMap.visible?(t=parseInt((e.early_age+e.late_age)/2),e.depth<3?alert("Please select a period or finer interval"):550<t?alert("Please select an interval younger than 600 MA"):(navMap.refresh("reset"),reconstructMap.rotate(e))):navMap.refresh("reset"))}function goTo(t,e){"string"==typeof t?t=(t=d3.selectAll("rect").filter(function(e){return e.name===t}))[0][0].__data__:t.children&&t.children.length<1&&(t=t.parent);var n="undefined"!=(timeScale.currentInterval=t).depth?parseInt(t.depth)+1:1,a=(d3.selectAll(".scale").style("display","none"),d3.selectAll(".tickGroup").style("display","none"),d3.selectAll(".s"+n).style("display","block"),d3.select(".timeScale g").attr("transform",function(){return"scale("+parseInt(d3.select(".timeScale").style("width"))/961+")"}),0),r=d3.scale.linear().range([5,955]);r.domain([t.x,t.x+t.dx]),d3.selectAll(".fullName").style("fill","rgba(0,0,0,0)").style("display","block"),d3.selectAll(".abbr").style("fill","rgba(0,0,0,0)").style("display","block"),d3.selectAll(".tickGroup").transition().duration(750).attr("transform",function(e){return d3.select(this).selectAll("text").style("text-anchor","middle"),5==r(e.x)?d3.select(this).select("text").style("text-anchor","start"):955==r(e.x)&&d3.select(this).select("text").style("text-anchor","end"),"translate("+r(e.x)+", -20)"}),d3.selectAll("rect").transition().duration(750).each(function(){++a}).attr("x",function(e){return r(e.x)}).attr("width",function(e){return r(e.x+e.dx)-r(e.x)}).each("end",function(){--a||labelTrans(t)})}function labelTrans(e){var t=0,n=d3.scale.linear().range([0,955]),a=d3.scale.linear().range([0,120]);n.domain([e.x,e.x+e.dx]),d3.selectAll(".fullName").transition().duration(10).each(function(){++t}).attr("x",function(e){return labelX(e)}).attr("height",function(e){return a(e.y+e.dy)-a(e.y)}).each("end",function(){--t||labelLevels(e)}),d3.selectAll(".abbr").transition().duration(300).each(function(){++t}).attr("x",function(e){return labelAbbrX(e)}).attr("height",function(e){return a(e.y+e.dy)-a(e.y)}).each("end",function(){--t?(d3.selectAll(".fullName").style("fill","#333"),d3.selectAll(".abbr").style("fill","#333")):(labelLevels(e),d3.select("#l0").style("fill","#fff"))}),resize()}function highlight(t){var e;unhighlight(),t.cxi?(e=t.cxi,d3.selectAll("rect#t"+t.cxi).style("stroke","#000").moveToFront(),d3.selectAll("#l"+t.cxi).moveToFront()):e="string"==typeof t?(e=d3.selectAll("rect").filter(function(e){return e.name===t}).attr("id")).replace("t",""):(e=d3.select(t).attr("id")).replace("p",""),d3.selectAll("rect#t"+e).style("stroke","#000").moveToFront(),d3.selectAll("#l"+e).moveToFront(),d3.selectAll(".abbr").moveToFront()}function unhighlight(e){d3.selectAll("rect").style("stroke","#fff")}function resize(){d3.select(".timeScale g").attr("transform",function(){return"scale("+parseInt(d3.select("#graphics").style("width"))/961+")"});var t,n=d3.select(".timeScale").select("svg");try{t=n.node().getBBox()}catch(e){t={x:n.node().clientLeft,y:n.node().clientTop,width:n.node().clientWidth,height:n.node().clientHeight}}d3.select(".timeScale svg").style("width",function(){return parseInt(d3.select("#graphics").style("width"))-1+"px"}),d3.select(".timeScale svg").style("height",function(){return t.height+5+"px"})}return{init:init,goTo:goTo,highlight:highlight,unhighlight:unhighlight,resize:resize,interval_hash:interval_hash,currentInterval:currentInterval}}()),reconstructMap=(()=>{var o,r=!1,i=d3.geo.hammer().scale(165).translate([480,250]).rotate([1e-6,0]).precision(.3),l=d3.geo.path().projection(i);return{init:function(){var e=d3.select("#reconstructMap").append("svg").attr("height",500).attr("width",960).append("g").attr("id","reconstructGroup");e.append("defs").append("path").datum({type:"Sphere"}).attr("id","sphere").attr("d",l),e.append("use").attr("class","stroke").attr("xlink:href","#sphere"),e.append("use").attr("class","fill").attr("xlink:href","#sphere"),$("#mapSwitch").on("click",function(e){e.preventDefault(),paleo_nav.closeReconstructMap()}),d3.json("build/js/plates/Holocene.json",function(e,t){var n=d3.select("#reconstructGroup").append("g").attr("id","reconstructContent");n.selectAll(".plateLines").data(topojson.feature(t,t.objects.Holocene).features).enter().append("path").attr("class","plates").attr("d",l),d3.json("build/js/coastlines/Holocene.json",function(e,t){n.selectAll(".coastlines").data(topojson.feature(t,t.objects.Holocene).features).enter().append("path").attr("class","coastlines").attr("d",l)})})},rotate:function(i){var n=i.nam||i.name;if(n===reconstructMap.currentReconstruction.name&&navMap.filters.personFilter.name===reconstructMap.currentReconstruction.person&&navMap.filters.stratigraphy.name===reconstructMap.currentReconstruction.stratigraphy){var e=0;if(navMap.filters.taxa.length===reconstructMap.currentReconstruction.taxa.length&&(navMap.filters.taxa.forEach(function(t){var n=!1;reconstructMap.currentReconstruction.taxa.forEach(function(e){t.name===e.name&&(n=!0)}),n||(e+=1)}),0===e))return void d3.select("#selectedInterval").select("button").style("display","none")}r=!0,reconstructMap.reset(),paleo_nav.showLoading(),d3.select("#interval").text(n),d3.select("#rotationInterval").html(n),d3.select("#age").text("("+i.mid+" Ma)"),d3.select("#rotationYear").html(i.mid+" Ma"),i.mid<201?d3.select("#rotationReference").html("<p>Seton, M., R.D. Müller, S. Zahirovic, C. Gaina, T.H. Torsvik, G. Shephard, A. Talsma, M. Gurnis, M. Turner, S. Maus, M. Chandler. 2012. Global continental and ocean basin reconstructions since 200 Ma. <i>Earth-Science Reviews </i>113:212-270.</p>"):d3.select("#rotationReference").html("<p>Wright, N. S. Zahirovic, R.D. Müller, M. Seton. 2013. Towards community-driven paleogeographic reconstructions: intergrating open-access paleogeographic and paleobiology data with plate tectonics. <i>Biogeosciences </i>10:1529-1541.</p>"),d3.select("#selectedInterval").select("button").style("display","none");var a=d3.select("#reconstructGroup").append("g").attr("id","reconstructContent"),s=n.split(" ").join("_");d3.json("build/js/collections/"+s+".json",function(e,r){d3.json("build/js/plates/"+s+".json",function(e,t){a.selectAll(".plateLines").data(topojson.feature(t,t.objects[s]).features).enter().append("path").attr("class","plates").attr("d",l),timeScale.highlight(n),d3.json("build/js/coastlines/"+s+".json",function(e,t){a.selectAll(".coastlines").data(topojson.feature(t,t.objects[s]).features).enter().append("path").attr("class","coastlines").attr("d",l)}),1<parseInt(d3.select("#map").style("height"))&&d3.select("#map").style("display","none"),d3.select("#svgMap").style("display","none"),d3.select("#reconstructMap").style("display","block"),reconstructMap.resize(),d3.select(".info").html("").style("display","none"),d3.json("build/js/rotatedIntervals/"+s+".json",function(e,t){var n=Object.keys(t.objects)[0];o=topojson.feature(t,t.objects[n]),navMap.filters.exist.taxon||navMap.filters.exist.personFilter||navMap.filters.exist.stratigraphy?(t=paleo_nav.dataUrl+paleo_nav.dataService+"/colls/summary.json?lngmin=-180&lngmax=180&latmin=-90&latmax=90&level=3&limit=99999",t=navMap.parseURL(t),d3.json(t,function(e,t){var n=t.records.map(function(e){return e.oid=e.oid.replace("clu:",""),e}),a=[];n.forEach(function(t){o.features.forEach(function(e){t.oid==e.properties.NAME&&a.push(e)})}),a.forEach(function(e){for(var t=0;t<r.records.length;t++)parseInt(e.properties.NAME)==r.records[t].oid&&(e.properties.nco=r.records[t].nco,e.properties.noc=r.records[t].noc,e.properties.oid=r.records[t].oid)}),reconstructMap.addToMap(a,i),navMap.summarize(t)})):(o.features.forEach(function(e){for(var t=0;t<r.records.length;t++)parseInt(e.properties.NAME)==r.records[t].oid&&(e.properties.nco=r.records[t].nco,e.properties.noc=r.records[t].noc,e.properties.oid=r.records[t].oid)}),reconstructMap.addToMap(o.features,i),navMap.summarize(r))})})})},addToMap:function(e,t){var n=d3.select("#reconstructContent"),a=d3.scale.linear().domain([1,4240]).range([4,15]);n.selectAll("circle").data(e).enter().append("circle").attr("class","collection").style("fill",function(){return t.col||t.color}).attr("r",function(e){return.7*a(e.properties.nco)}).attr("cx",function(e){return i(e.geometry.coordinates)[0]}).attr("cy",function(e){return i(e.geometry.coordinates)[1]}).on("mouseover",function(e){d3.select(".info").html("<strong>"+e.properties.nco+" collections</strong><br>"+e.properties.noc+" occurrences").style("display","block")}).on("click",function(e){d3.select(".info").html("<strong>"+e.properties.nco+" collections</strong><br>"+e.properties.noc+" occurrences").style("display","block"),navMap.openBinModal(e)}).on("mouseout",function(e){d3.select(".info").html("").style("display","none")}),r=!1,paleo_nav.hideLoading(),reconstructMap.currentReconstruction={name:t.nam||t.name,color:t.col,mid:t.mid,id:t.oid,taxa:[],person:"",stratigraphy:""},navMap.filters.exist.taxon&&navMap.filters.taxa.forEach(function(e){reconstructMap.currentReconstruction.taxa.push({name:e.name})}),navMap.filters.exist.personFilter&&(reconstructMap.currentReconstruction.person=navMap.filters.personFilter.name),navMap.filters.exist.stratigraphy&&(reconstructMap.currentReconstruction.stratigraphy=navMap.filters.stratigraphy.name)},addBBox:function(e){d3.selectAll(".rotatedBBox").remove();var t=map.getBounds(),n=t._southWest,a=t.getSouthEast(),r=t._northEast,t=t.getNorthWest(),n=(map.getZoom(),n.lng=n.lng<-180?-180:n.lng,n.lat=n.lat<-90?-90:n.lat,r.lng=180<r.lng?180:r.lng,r.lat=90<r.lat?90:r.lat,[{oid:"a",lat:n.lat,lng:n.lng},{oid:"b",lat:t.lat,lng:t.lng},{oid:"c",lat:r.lat,lng:r.lng},{oid:"d",lat:a.lat,lng:a.lng}]),n=navMap.buildWKT(n),t="&time="+e+'&points="'+encodeURI(n)+'"&output=geojson';d3.xhr("http://gplates.gps.caltech.edu:8080/recon_points/").header("Content-type","application/x-www-form-urlencoded").post(t,function(e,t){if(e)return console.log("Gplates error - ",e),alert("GPlates could not complete the request");e=JSON.parse(t.response);e.features.sort(function(e,t){return e.properties.NAME<t.properties.NAME?-1:e.properties.NAME>t.properties.NAME?1:0});t={type:"FeatureCollection",features:[{geometry:{type:"Polygon",coordinates:[[e.features[0].geometry.coordinates,e.features[1].geometry.coordinates,e.features[2].geometry.coordinates,e.features[3].geometry.coordinates,e.features[3].geometry.coordinates]]},type:"Feature",properties:{}}]};d3.select("#reconstructContent").selectAll(".bbox").data(t.features).enter().append("path").attr("class","rotatedBBox").attr("fill","none").attr("stroke","#ccc").attr("stroke-dasharray","5,5").attr("stroke-width",2).attr("opacity",1).attr("d",l)})},resize:function(){var n=parseInt(d3.select("#graphics").style("width")),a=d3.select("#reconstructMap").select("svg");d3.select("#reconstructGroup").attr("transform",function(){try{t=a.node().getBBox()}catch(e){t={x:a.node().clientLeft,y:a.node().clientTop,width:a.node().clientWidth,height:a.node().clientHeight}}var t,e;window.innerHeight;return n>t.width+50?"scale("+window.innerHeight/800+")translate("+(n-t.width)/2+",0)":(t=.7*window.innerHeight-70,"scale("+n/970+")translate(0,"+(0<(t-(e=n/970*500))/2?(t-e)/2:0)+")")}),d3.select("#reconstructMap").select("svg").style("height",function(e){var t;return"hidden"===d3.select(".timeScale").style("visibility")?window.innerHeight-70+"px":(t=15<$("#time").height()?$("#time").height():window.innerHeight/5.6,window.innerHeight-t-70+"px")}).style("width",function(e){return n-15+"px"}),d3.select("#reconstructMapRefContainer").style("height",function(){return d3.select("#svgMap").style("height")})},reset:function(){d3.select("#reconstructContent").remove(),d3.select("#interval").html(""),d3.select("#age").html("")},currentReconstruction:{name:"",taxa:[],person:""},reconstructing:r,visible:!1}})(),taxaBrowser=(()=>{var r=[];function n(e){var t=(e=e||$("#taxonInput").val()).match(/^txn:|^var:/)?"id="+e:"name="+e;0<e.length&&d3.json(paleo_nav.dataUrl+paleo_nav.dataService+"/taxa/list.json?status=all&"+t,function(e,t){if(e)alert("Error retrieving from list.json - ",e),paleo_nav.hideLoading();else{if(!(0<t.records.length))return alert("No taxa with this name found");paleo_nav.untoggleTaxa(),d3.select(".taxonTitle").html(t.records[0].nam+" ("+a(t.records[0].rnk)+")<i class='fa fa-plus-square'></i>").attr("id",function(){return t.records[0].nam}),$(".taxonTitle").off("click"),$(".taxonTitle").click(function(e){e.preventDefault(),navMap.filterByTaxon($(".taxonTitle").attr("id"),!0)}),e=t.records[0],d3.json(paleo_nav.dataUrl+paleo_nav.dataService+"/taxa/single.json?id="+e.oid+"&show=attr,nav,size",function(e,t){if(e)return paleo_nav.hideLoading(),alert("Error retrieving from single.json - ",e);if(!(0<t.records.length))return alert("No taxon details found - browser");d3.select(".taxonAttr").html(t.records[0].att);var e=t.records[0],n=[],a=0,a=(e.kgt&&e.kgn&&e.kgn!=e.oid&&(e.kgt.rnk="kingdom",n.push(e.kgt),a=e.kgn),e.phl&&e.phn&&e.phn!=e.oid&&(e.pht.rnk="phylum",n.push(e.pht),a=e.phn),e.cll&&e.cln&&e.cln!=e.oid&&(e.clt.rnk="class",n.push(e.clt),a=e.cln),e.odl&&e.odn&&e.odn!=e.oid&&(e.odt.rnk="order",n.push(e.odt),a=e.odn),e.fml&&e.fmn&&e.fmn!=e.oid&&(e.fmt.rnk="family",n.push(e.fmt),a=e.fmn),e.prt&&e.par!=a&&n.push(e.prt),(a=d3.select("#focalTaxonParents")).selectAll("tr").remove(),a.selectAll(".rows").data(n).enter().append("tr").append("td").append("a").attr("id",function(e){return e.nam}).attr("href","#").html(function(e){return e.nam+" ("+e.rnk+")"}).attr("class",function(e,t){return t===n.length-1?0===e.ext?"immediateParent extinct parents":"immediateParent parents":0===e.ext?"extinct parents":"parents"}),i(e),t.records[0]),e=(r=[],a.chl&&5<a.rnk&&(0===a.chl.length||!a.gns||a.chl.length!=a.gnc)&&r.push({section:"immediate subtaxa",size:a.chl.length,rank:"immediate",offset:0,order:"size.desc",taxa:a.chl}),a.phs&&r.push({section:"phyla",size:a.phs.length,rank:20,offset:0,max:10,order:"size.desc",taxa:a.phs}),a.cls&&r.push({section:"classes",size:a.cls.length,rank:17,offset:0,max:10,order:"size.desc",taxa:a.cls}),a.ods&&r.push({section:"orders",size:a.ods.length,rank:13,offset:0,max:10,order:"size.desc",taxa:a.ods}),a.fms&&r.push({section:"families",size:a.fms.length,rank:9,offset:0,max:10,order:"size.desc",taxa:a.fms}),a.gns&&r.push({section:"genera",size:a.gns.length,rank:5,offset:0,max:10,order:"size.desc",taxa:a.gns}),a.sgs&&0<a.sgs.length&&r.push({section:"subgenera",size:a.sgs.length,rank:4,offset:0,max:10,order:"size.desc",taxa:a.sgs}),a.sps&&0<a.sps.length&&r.push({section:"species",size:a.sps.length,rank:3,offset:0,max:10,order:"size.desc",taxa:a.sps}),a.sss&&0<a.sss.length&&r.push({section:"subspecies",size:a.sss.length,rank:2,offset:0,max:10,order:"size.desc",taxa:a.sss}),d3.select("#focal_taxon_children"));e.selectAll("tr").remove(),e.selectAll(".rows").data(r).enter().append("tr").append("td").append("a").attr("id",function(e){return"t"+e.rank}).attr("class","children").attr("href","#").html(function(e){return e.size+" "+e.section}),i(a)}),$("#taxonInput").val(""),$("#taxaInput").val("")}})}function a(e){return{25:"unranked",23:"kingdom",22:"subkingdom",21:"superphylum",20:"phylum",19:"subphylum",18:"superclass",17:"class",16:"subclass",15:"infraclass",14:"superorder",13:"order",12:"suborder",11:"infraorder",10:"superfamily",9:"family",8:"subfamily",7:"tribe",6:"subtribe",5:"genus",4:"subgenus",3:"species",2:"subspecies"}[e]}function i(t){$(".parents").off("click"),$(".parents").click(function(e){e.preventDefault(),n(e.target.id)}),$(".childTaxa").off("click"),$(".childTaxa").click(function(e){e.preventDefault(),$("#subtaxaModal").modal("hide"),$("#taxaFilterInput").val(""),n(e.target.id)}),$(".children").off("click"),$(".children").click(function(e){e.preventDefault(),"immediate"===e.target.id.substr(1)&&(d3.select("#subtaxa").selectAll("li").remove(),d3.select("#subtaxa").selectAll("br").remove(),e=navMap.getIndex(r,"immediate","rank"),r[e].taxa.sort(function(e,t){return e.siz>t.siz?-1:e.siz<t.siz?1:0}),r[e].taxa.forEach(function(e){var t=0===e.ext?"extinct childTaxa":"childTaxa";$("#subtaxa").append("<li><a href='#' class='"+t+"' id='"+e.nam+"'>"+e.nam+" ("+e.siz+") </a></li>")}),$("#subtaxa").append("<br>"),i(t),$("#subtaxaModal").modal())})}return{init:function(){$("#taxaSearch").submit(function(){return n(),!1})},goToTaxon:n,rankMap:a,filter:function(e){e=(e=$(e).val()).charAt(0).toUpperCase()+e.slice(1),$("#subtaxa > li:not(:contains("+e+"))").hide(),$("#subtaxa > li:contains("+e+")").show()}}})(),diversityPlot=(()=>{var m={top:0,right:20,bottom:80,left:80},g={top:0,right:0,bottom:0,left:80},v=960,y=800-m.top-m.bottom;function i(e,l){void 0!==diversityPlot.currentRequest&&0<Object.keys(diversityPlot.currentRequest).length&&(diversityPlot.currentRequest.abort(),diversityPlot.currentRequest={}),e.match("authent_by")&&(e=e.replace("/quickdiv.json","/diversity.json")),diversityPlot.currentRequest=d3.json(e,function(e,t){if(e)alert("Error retrieving diversity data"),console.log(e);else{for(var n,a,h=t.records.map(function(e){return e.total=e.dsb,e}),f=l,r=h[h.length-1].eag,i=h[0].lag,s=[{nam:"Neoproterozoic",lag:538.8,eag:1e3},{nam:"Paleozoic",lag:251.902,eag:538.8},{nam:"Mesozoic",lag:66,eag:251.902},{nam:"Cenozoic",lag:0,eag:66}],o=0;o<s.length;o++)r>=s[o].lag&&r<=s[o].eag&&(n=s[o].eag),i>=s[o].lag&&i<=s[o].eag&&(a=s[o].lag);$.ajax(paleo_nav.dataUrl+paleo_nav.dataService+"/intervals/list.json?scale=1&order=age.desc&max_ma="+n+"&min_ma="+a).fail(function(e){console.log(e)}).done(function(e){var t,n,a,e=e.records.filter(function(e){if(2===e.lvl||3===e.lvl||"era"==e.itp||"period"==e.itp)return e.totalTime=e.eag-e.lag,e}),r=h,i=f,s=i?"#advdiversity":"#diversity",o=(d3.select("#diversity","#advdiversity").select("svg").remove(),e.filter(function(e){if(3===e.lvl||"period"==e.itp)return e})),l=e.filter(function(e){if(2===e.lvl||"era"==e.itp)return e}),c=(i&&(r.map(function(e){.5<e.eag?e.origination=-Math.log(e.xbt/(e.xbt+e.xft))/(e.eag-e.lag):e.origination=NaN}),r.map(function(e){.5<e.eag?e.extinction=-Math.log(e.xbt/(e.xbt+e.xbl))/(e.eag-e.lag):e.origination=NaN}),r.map(function(e){e.rangethroughYes=e.xft+e.xbl+e.xfl+e.xbt,e.rangethroughNo=e.xbl+e.xfl+e.xbt}),$('[name="extant"]').is(":checked"),$('[name="extant"]').is(":checked"),$('[name="extant"]').is(":checked"),$('[name="extant"]').is(":checked")),d3.scale.linear().domain([d3.max(l,function(e){return e.eag}),d3.min(l,function(e){return e.lag})-1]).range([0,v-m.left-m.right])),c=(i?(n=d3.scale.linear().domain([0,d3.max(r,function(e){return e.rangethroughYes})]).range([y-m.top-m.bottom,0]),t=d3.scale.linear().domain([-1,1]).range([y-m.top-m.bottom,0])):n=d3.scale.linear().domain([0,d3.max(r,function(e){return e.total})]).range([y-m.top-m.bottom,0]),d3.svg.axis().scale(c).orient("bottom").ticks(5)),d=d3.svg.axis().scale(n).orient("left").ticks(5),u=(i&&(a=d3.svg.axis().scale(t).orient("right").tickValues([-1,0,1]).tickFormat(Math.abs)),d3.scale.linear().domain([0,d3.sum(e,function(e){if(2===e.lvl||"era"==e.itp)return e.totalTime})]).range([0,v-m.left-m.right])),p=d3.scale.linear().domain([d3.max(e,function(e){return e.eag}),d3.min(e,function(e){return e.lag})]).range([0,v-m.left-m.right]),e=d3.select(s).append("svg").attr("width",v).attr("height",y).attr("id",i?"advdiversityGraph":"diversityGraph").append("g").attr("id",i?"advdiversityGraphGroup":"diversityGraphGroup").attr("transform","translate("+m.left+","+m.top+")").style("font-family","Helvetica,sans-serif").style("fill","#333").style("font-weight","100").style("font-size","0.8em");(s=d3.select(s+"Graph").select("g").append("g").attr("id","timeScale").attr("transform","translate("+g.left+","+(y-m.top-m.bottom+3)+")")).selectAll(".periods").data(o).enter().append("rect").attr("height","40").attr("width",function(e){return u(e.totalTime)}).attr("x",function(e){return p(e.eag)}).attr("id",function(e){return"r"+e.oid.replace("int:","")}).style("fill",function(e){return e.col}).style("opacity",.83).append("svg:title").text(function(e){return e.nam}),s.selectAll(".periodNames").data(o).enter().append("text").attr("x",function(e){return(p(e.eag)+p(e.lag))/2}).attr("y","30").attr("id",function(e){return"l"+e.oid.replace("int:","")}).attr("class","timeLabel abbreviation").style("font-size","2.4em").text(function(e){return e.abr}),s.selectAll(".periodNames").data(o).enter().append("text").attr("x",function(e){return(p(e.eag)+p(e.lag))/2}).attr("y","30").attr("class","timeLabel dFullName").style("font-size","2.4em").attr("id",function(e){return"l"+e.oid.replace("int:","")}).text(function(e){return e.nam}),s.selectAll(".eras").data(l).enter().append("rect").attr("height","40").attr("width",function(e){return u(e.totalTime)}).attr("x",function(e){return p(e.eag)}).attr("y","40").attr("id",function(e){return"r"+e.oid.replace("int:","")}).style("fill",function(e){return e.col}).style("opacity",.83).append("svg:title").text(function(e){return e.nam}),s.selectAll(".eraNames").data(l).enter().append("text").attr("x",function(e){return(p(e.eag)+p(e.lag))/2}).attr("y","70").attr("class","timeLabel dFullName").style("font-size","2.4em").attr("id",function(e){return"l"+e.oid.replace("int:","")}).text(function(e){return e.nam}),e.append("g").attr("class","x axis").attr("transform","translate("+g.left+","+(y-m.top-m.bottom+85)+")").style("font-size","3em").style("fill","#777").call(c).select("path").style("display","none"),(o=e.append("g").attr("class","y axis").attr("transform","translate("+g.left+",0)").style("fill","none").style("font-size","3em").style("letter-spacing","normal").call(d)).append("text").attr("transform","rotate(-90)").attr("dy","1em").style("fill","#777").style("text-anchor","end").style("font-size","0.8em").style("font-weight",400).text($("[name=taxonLevel]").val()+" sampled in "+$("[name=timeLevel]").val()),o.append("text").attr("transform","rotate(-90)").attr("dy","3em").style("text-anchor","end").style("font-size","0.6em").style("font-weight",300).style("font-style","italics").style("fill","#777").text("(approximate)"),o.selectAll(".tick").style("letter-spacing","8px").style("fill","#777"),i&&((s=e.append("g").attr("class","y axis").attr("transform","translate("+(v-20)+",0)").style("fill","none").style("font-size","3em").style("letter-spacing","normal").call(a)).append("text").attr("transform","rotate(90)translate("+.28*y+",-35)").attr("dy","1em").style("fill","green").style("text-anchor","end").style("font-size","0.6em").style("font-weight",400).text("origination"),s.append("text").attr("transform","rotate(90)translate("+.7*y+",-35)").attr("dy","1em").style("fill","red").style("text-anchor","end").style("font-size","0.6em").style("font-weight",400).text("extinction"),s.append("text").attr("transform","rotate(90)translate("+.65*y+",-80)").attr("dy","1em").style("fill","#777").style("text-anchor","end").style("font-size","0.8em").style("font-weight",400).text("rates per "+$("[name=taxonLevel]").val()+" per Myr"),s.selectAll(".tick").style("letter-spacing","8px").style("fill","#777")),l=d3.svg.line().interpolate("linear").x(function(e){return p(e.eag)}).y(function(e){return n(e.total)}),e.append("path").datum(r).attr("class","line diversityLine sampledLine").attr("style","fill: none; stroke: #777; stroke-width: 4px;").attr("d",l).attr("transform","translate("+g.left+",0)"),i&&(b("sampledLine"),c=d3.svg.line().interpolate("linear").x(function(e){return p(e.eag)}).y(function(e){return n(e.rangethroughYes)}),e.append("path").attr("class","line diversityLine rangethroughLineYes").attr("style","fill: none; stroke: black; stroke-width: 4px; stroke-dasharray: 4,2; display:none;").attr("d",c(r)).attr("transform","translate("+g.left+",0)"),d=d3.svg.line().interpolate("linear").x(function(e){return p(e.eag)}).y(function(e){return n(e.rangethroughNo)}),e.append("path").attr("class","line diversityLine rangethroughLineNo").attr("style","fill: none; stroke: black; stroke-width: 4px; stroke-dasharray: 4,2; display:none;").attr("d",d(r)).attr("transform","translate("+g.left+",0)"),b("rangethroughLine"),o=d3.svg.line().interpolate("linear").defined(function(e){return!isNaN(e.origination)&isFinite(e.origination)}).x(function(e){return p(e.eag)}).y(function(e){return t(e.origination)}),e.append("path").datum(r).attr("class","line diversityLine originationLine").attr("style","fill: none; stroke: green; stroke-width: 2px; display:none;").attr("d",o(r)).attr("transform","translate("+g.left+",0)"),b("originationLine"),a=d3.svg.line().interpolate("linear").defined(function(e){return!isNaN(e.extinction)&isFinite(e.extinction)}).x(function(e){return p(e.eag)}).y(function(e){return t(-e.extinction)}),e.append("path").datum(r).attr("class","line diversityLine extinctionLine").attr("style","fill: none; stroke: red; stroke-width: 2px; display:none;").attr("d",a(r)).attr("transform","translate("+g.left+",0)"),b("extinctionLine")),x(!1,i),$("#diversityWait").css("display","none"),$("#advdiversityWait").css("display","none")})}})}function x(e,t){var n=d3.selectAll(".dFullName");d3.selectAll(".dFullName").style("display","block"),d3.selectAll(".abbreviation").style("display","block");for(var a=0;a<n[0].length;a++){var r,i,s=d3.select(n[0][a]).data()[0].oid.replace("int:",""),o=parseFloat(d3.select("rect#r"+s).attr("width")),l=parseFloat(d3.select("rect#r"+s).attr("x"));try{r=d3.select(".dFullName#l"+s).node().getComputedTextLength()}catch(e){r=25}if(o-8<r){d3.select(".dFullName#l"+s).style("display","none");try{i=d3.select(".abbreviation#l"+s).node().getComputedTextLength()}catch(e){i=10}o-8<i?d3.select(".abbreviation#l"+s).style("display","none"):d3.select(".abbreviation#l"+s).style("display","block").attr("x",l+(o-i)/2)}else d3.select(".abbreviation#l"+s).style("display","none"),d3.select(".dFullName#l"+s).attr("x",l+(o-r)/2)}e||setTimeout(function(){c(t)},100)}function c(e){var t,n=e?"adv":"",a=($("."+n+"statsContent").height("auto"),$("."+n+"diversityContainer").height()-50),r=$("."+n+"diversityContainer").width()-50,r=(r<a?a<(t=r/v)*y&&(t=a/y):r<(t=a/y)*v&&(t=r/v),e?d3.select("#"+n+"diversityGraphGroup").attr("transform","scale("+t+")translate("+(m.left-80)+","+m.top+")"):d3.select("#"+n+"diversityGraphGroup").attr("transform","scale("+t+")translate("+m.left+","+m.top+")"),d3.select("#"+n+"diversityGraphGroup").node().getBBox().width);d3.select("#"+n+"diversityGraph").attr("height",a+m.bottom).attr("width",r*t+m.left),x(!0)}function b(e){var t,n=$("[name="+e+"]").is(":checked");"rangethroughLine"===e?(t=$('[name="singletons"]').is(":checked")?["rangethroughLineYes","rangethroughLineNo"]:["rangethroughLineNo","rangethroughLineYes"],$("."+t[0]).css("display",n?"":"none"),$("."+t[1]).css("display","none")):$("."+e).css("display",n?"":"none")}function s(e){var e=d3.select(e?"#advdiversityGraph":"#diversityGraph"),t=e.attr("height"),e=e.attr("width");d3.select("canvas").attr("height",t).attr("width",e)}return d3.select(window).on("resize",x),{plot:i,resize:c,currentRequest:void 0,updateQuickdiv:function(){var e=$("[name=taxonLevel]").val(),t=$("[name=timeLevel]").val(),n=paleo_nav.dataUrl;$("#advtaxonLevel").html(e),$("#advtimeLevel").html(t);var a=(r=map.getBounds())._southWest,r=r._northEast;parseInt(d3.select("#map").style("height"))<1&&(a.lng=-180,r.lng=180,a.lat=-90,r.lat=90),n+=paleo_nav.dataService+"/occs/quickdiv.json?",i(navMap.parseURL(n)+("&lngmin="+a.lng.toFixed(1)+"&lngmax="+r.lng.toFixed(1)+"&latmin="+a.lat.toFixed(1)+"&latmax="+r.lat.toFixed(1))+("&count="+e+"&time_reso="+t))},saveImg:function(n){var e=d3.select(n?"#advdiversityGraph":"#diversityGraph").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML,t='<img src="'+(e="data:image/svg+xml;base64,"+btoa(e))+'">',a=(d3.select(n?"#advsvgdataurl":"#svgdataurl").html(t),s(n),document.querySelector("canvas")),r=a.getContext("2d"),i=new Image;i.src=e,i.onload=function(){r.drawImage(i,0,0);var e=a.toDataURL("image/png"),t='<img src="'+e+'">',t=(d3.select(n?"#advpngdataurl":"#pngdataurl").html(t),document.createElement("a"));t.download="diversity-curve.png",t.href=e,t.id="downloadLink",document.getElementsByTagName("body")[0].appendChild(t),t.click()}},getCanvasSize:s,toggleLine:b}})();