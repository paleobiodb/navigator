+function(a){"use strict";var b='[data-dismiss="alert"]',c=function(c){a(c).on("click",b,this.close)};c.prototype.close=function(b){function c(){f.trigger("closed.bs.alert").remove()}var d=a(this),e=d.attr("data-target");e||(e=d.attr("href"),e=e&&e.replace(/.*(?=#[^\s]*$)/,""));var f=a(e);b&&b.preventDefault(),f.length||(f=d.hasClass("alert")?d:d.parent()),f.trigger(b=a.Event("close.bs.alert")),b.isDefaultPrevented()||(f.removeClass("in"),a.support.transition&&f.hasClass("fade")?f.one(a.support.transition.end,c).emulateTransitionEnd(150):c())};var d=a.fn.alert;a.fn.alert=function(b){return this.each(function(){var d=a(this),e=d.data("bs.alert");e||d.data("bs.alert",e=new c(this)),"string"==typeof b&&e[b].call(d)})},a.fn.alert.Constructor=c,a.fn.alert.noConflict=function(){return a.fn.alert=d,this},a(document).on("click.bs.alert.data-api",b,c.prototype.close)}(jQuery),+function(a){function b(b){a(d).remove(),a(e).each(function(){var d=c(a(this)),e={relatedTarget:this};d.hasClass("open")&&(d.trigger(b=a.Event("hide.bs.dropdown",e)),b.isDefaultPrevented()||d.removeClass("open").trigger("hidden.bs.dropdown",e))})}function c(b){var c=b.attr("data-target");c||(c=b.attr("href"),c=c&&/#[A-Za-z]/.test(c)&&c.replace(/.*(?=#[^\s]*$)/,""));var d=c&&a(c);return d&&d.length?d:b.parent()}var d=".dropdown-backdrop",e="[data-toggle=dropdown]",f=function(b){a(b).on("click.bs.dropdown",this.toggle)};f.prototype.toggle=function(d){var e=a(this);if(!e.is(".disabled, :disabled")){var f=c(e),g=f.hasClass("open");if(b(),!g){"ontouchstart"in document.documentElement&&!f.closest(".navbar-nav").length&&a('<div class="dropdown-backdrop"/>').insertAfter(a(this)).on("click",b);var h={relatedTarget:this};if(f.trigger(d=a.Event("show.bs.dropdown",h)),d.isDefaultPrevented())return;f.toggleClass("open").trigger("shown.bs.dropdown",h),e.focus()}return!1}},f.prototype.keydown=function(b){if(/(38|40|27)/.test(b.keyCode)){var d=a(this);if(b.preventDefault(),b.stopPropagation(),!d.is(".disabled, :disabled")){var f=c(d),g=f.hasClass("open");if(!g||g&&27==b.keyCode)return 27==b.which&&f.find(e).focus(),d.click();var h=" li:not(.divider):visible a",i=f.find("[role=menu]"+h+", [role=listbox]"+h);if(i.length){var j=i.index(i.filter(":focus"));38==b.keyCode&&j>0&&j--,40==b.keyCode&&j<i.length-1&&j++,~j||(j=0),i.eq(j).focus()}}}};var g=a.fn.dropdown;a.fn.dropdown=function(b){return this.each(function(){var c=a(this),d=c.data("bs.dropdown");d||c.data("bs.dropdown",d=new f(this)),"string"==typeof b&&d[b].call(c)})},a.fn.dropdown.Constructor=f,a.fn.dropdown.noConflict=function(){return a.fn.dropdown=g,this},a(document).on("click.bs.dropdown.data-api",b).on("click.bs.dropdown.data-api",".dropdown form",function(a){a.stopPropagation()}).on("click.bs.dropdown.data-api",e,f.prototype.toggle).on("keydown.bs.dropdown.data-api",e+", [role=menu], [role=listbox]",f.prototype.keydown)}(jQuery),+function(a){"use strict";var b=function(b,c){this.options=c,this.$element=a(b),this.$backdrop=this.isShown=null,this.options.remote&&this.$element.find(".modal-content").load(this.options.remote,a.proxy(function(){this.$element.trigger("loaded.bs.modal")},this))};b.DEFAULTS={backdrop:!0,keyboard:!0,show:!0},b.prototype.toggle=function(a){return this[this.isShown?"hide":"show"](a)},b.prototype.show=function(b){var c=this,d=a.Event("show.bs.modal",{relatedTarget:b});this.$element.trigger(d),this.isShown||d.isDefaultPrevented()||(this.isShown=!0,this.escape(),this.$element.on("click.dismiss.bs.modal",'[data-dismiss="modal"]',a.proxy(this.hide,this)),this.backdrop(function(){var d=a.support.transition&&c.$element.hasClass("fade");c.$element.parent().length||c.$element.appendTo(document.body),c.$element.show().scrollTop(0),d&&c.$element[0].offsetWidth,c.$element.addClass("in").attr("aria-hidden",!1),c.enforceFocus();var e=a.Event("shown.bs.modal",{relatedTarget:b});d?c.$element.find(".modal-dialog").one(a.support.transition.end,function(){c.$element.focus().trigger(e)}).emulateTransitionEnd(300):c.$element.focus().trigger(e)}))},b.prototype.hide=function(b){b&&b.preventDefault(),b=a.Event("hide.bs.modal"),this.$element.trigger(b),this.isShown&&!b.isDefaultPrevented()&&(this.isShown=!1,this.escape(),a(document).off("focusin.bs.modal"),this.$element.removeClass("in").attr("aria-hidden",!0).off("click.dismiss.bs.modal"),a.support.transition&&this.$element.hasClass("fade")?this.$element.one(a.support.transition.end,a.proxy(this.hideModal,this)).emulateTransitionEnd(300):this.hideModal())},b.prototype.enforceFocus=function(){a(document).off("focusin.bs.modal").on("focusin.bs.modal",a.proxy(function(a){this.$element[0]!==a.target&&!this.$element.has(a.target).length&&this.$element.focus()},this))},b.prototype.escape=function(){this.isShown&&this.options.keyboard?this.$element.on("keyup.dismiss.bs.modal",a.proxy(function(a){27==a.which&&this.hide()},this)):this.isShown||this.$element.off("keyup.dismiss.bs.modal")},b.prototype.hideModal=function(){var a=this;this.$element.hide(),this.backdrop(function(){a.removeBackdrop(),a.$element.trigger("hidden.bs.modal")})},b.prototype.removeBackdrop=function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},b.prototype.backdrop=function(b){var c=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var d=a.support.transition&&c;if(this.$backdrop=a('<div class="modal-backdrop '+c+'" />').appendTo(document.body),this.$element.on("click.dismiss.bs.modal",a.proxy(function(a){a.target===a.currentTarget&&("static"==this.options.backdrop?this.$element[0].focus.call(this.$element[0]):this.hide.call(this))},this)),d&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),!b)return;d?this.$backdrop.one(a.support.transition.end,b).emulateTransitionEnd(150):b()}else!this.isShown&&this.$backdrop?(this.$backdrop.removeClass("in"),a.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one(a.support.transition.end,b).emulateTransitionEnd(150):b()):b&&b()};var c=a.fn.modal;a.fn.modal=function(c,d){return this.each(function(){var e=a(this),f=e.data("bs.modal"),g=a.extend({},b.DEFAULTS,e.data(),"object"==typeof c&&c);f||e.data("bs.modal",f=new b(this,g)),"string"==typeof c?f[c](d):g.show&&f.show(d)})},a.fn.modal.Constructor=b,a.fn.modal.noConflict=function(){return a.fn.modal=c,this},a(document).on("click.bs.modal.data-api",'[data-toggle="modal"]',function(b){var c=a(this),d=c.attr("href"),e=a(c.attr("data-target")||d&&d.replace(/.*(?=#[^\s]+$)/,"")),f=e.data("bs.modal")?"toggle":a.extend({remote:!/#/.test(d)&&d},e.data(),c.data());c.is("a")&&b.preventDefault(),e.modal(f,this).one("hide",function(){c.is(":visible")&&c.focus()})}),a(document).on("show.bs.modal",".modal",function(){a(document.body).addClass("modal-open")}).on("hidden.bs.modal",".modal",function(){a(document.body).removeClass("modal-open")})}(jQuery),+function(a){"use strict";var b=function(b){this.element=a(b)};b.prototype.show=function(){var b=this.element,c=b.closest("ul:not(.dropdown-menu)"),d=b.data("target");if(d||(d=b.attr("href"),d=d&&d.replace(/.*(?=#[^\s]*$)/,"")),!b.parent("li").hasClass("active")){var e=c.find(".active:last a")[0],f=a.Event("show.bs.tab",{relatedTarget:e});if(b.trigger(f),!f.isDefaultPrevented()){var g=a(d);this.activate(b.parent("li"),c),this.activate(g,g.parent(),function(){b.trigger({type:"shown.bs.tab",relatedTarget:e})})}}},b.prototype.activate=function(b,c,d){function e(){f.removeClass("active").find("> .dropdown-menu > .active").removeClass("active"),b.addClass("active"),g?(b[0].offsetWidth,b.addClass("in")):b.removeClass("fade"),b.parent(".dropdown-menu")&&b.closest("li.dropdown").addClass("active"),d&&d()}var f=c.find("> .active"),g=d&&a.support.transition&&f.hasClass("fade");g?f.one(a.support.transition.end,e).emulateTransitionEnd(150):e(),f.removeClass("in")};var c=a.fn.tab;a.fn.tab=function(c){return this.each(function(){var d=a(this),e=d.data("bs.tab");e||d.data("bs.tab",e=new b(this)),"string"==typeof c&&e[c]()})},a.fn.tab.Constructor=b,a.fn.tab.noConflict=function(){return a.fn.tab=c,this},a(document).on("click.bs.tab.data-api",'[data-toggle="tab"], [data-toggle="pill"]',function(b){b.preventDefault(),a(this).tab("show")})}(jQuery),+function(a){"use strict";var b=function(c,d){this.$element=a(c),this.options=a.extend({},b.DEFAULTS,d),this.transitioning=null,this.options.parent&&(this.$parent=a(this.options.parent)),this.options.toggle&&this.toggle()};b.DEFAULTS={toggle:!0},b.prototype.dimension=function(){var a=this.$element.hasClass("width");return a?"width":"height"},b.prototype.show=function(){if(!this.transitioning&&!this.$element.hasClass("in")){var b=a.Event("show.bs.collapse");if(this.$element.trigger(b),!b.isDefaultPrevented()){var c=this.$parent&&this.$parent.find("> .panel > .in");if(c&&c.length){var d=c.data("bs.collapse");if(d&&d.transitioning)return;c.collapse("hide"),d||c.data("bs.collapse",null)}var e=this.dimension();this.$element.removeClass("collapse").addClass("collapsing")[e](0),this.transitioning=1;var f=function(){this.$element.removeClass("collapsing").addClass("collapse in")[e]("auto"),this.transitioning=0,this.$element.trigger("shown.bs.collapse")};if(!a.support.transition)return f.call(this);var g=a.camelCase(["scroll",e].join("-"));this.$element.one(a.support.transition.end,a.proxy(f,this)).emulateTransitionEnd(350)[e](this.$element[0][g])}}},b.prototype.hide=function(){if(!this.transitioning&&this.$element.hasClass("in")){var b=a.Event("hide.bs.collapse");if(this.$element.trigger(b),!b.isDefaultPrevented()){var c=this.dimension();this.$element[c](this.$element[c]())[0].offsetHeight,this.$element.addClass("collapsing").removeClass("collapse").removeClass("in"),this.transitioning=1;var d=function(){this.transitioning=0,this.$element.trigger("hidden.bs.collapse").removeClass("collapsing").addClass("collapse")};return a.support.transition?void this.$element[c](0).one(a.support.transition.end,a.proxy(d,this)).emulateTransitionEnd(350):d.call(this)}}},b.prototype.toggle=function(){this[this.$element.hasClass("in")?"hide":"show"]()};var c=a.fn.collapse;a.fn.collapse=function(c){return this.each(function(){var d=a(this),e=d.data("bs.collapse"),f=a.extend({},b.DEFAULTS,d.data(),"object"==typeof c&&c);!e&&f.toggle&&"show"==c&&(c=!c),e||d.data("bs.collapse",e=new b(this,f)),"string"==typeof c&&e[c]()})},a.fn.collapse.Constructor=b,a.fn.collapse.noConflict=function(){return a.fn.collapse=c,this},a(document).on("click.bs.collapse.data-api","[data-toggle=collapse]",function(b){var c,d=a(this),e=d.attr("data-target")||b.preventDefault()||(c=d.attr("href"))&&c.replace(/.*(?=#[^\s]+$)/,""),f=a(e),g=f.data("bs.collapse"),h=g?"toggle":d.data(),i=d.attr("data-parent"),j=i&&a(i);g&&g.transitioning||(j&&j.find('[data-toggle=collapse][data-parent="'+i+'"]').not(d).addClass("collapsed"),d[f.hasClass("in")?"addClass":"removeClass"]("collapsed")),f.collapse(h)})}(jQuery),+function(a){function b(){var a=document.createElement("bootstrap"),b={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(var c in b)if(void 0!==a.style[c])return{end:b[c]};return!1}a.fn.emulateTransitionEnd=function(b){var c=!1,d=this;a(this).one(a.support.transition.end,function(){c=!0});var e=function(){c||a(d).trigger(a.support.transition.end)};return setTimeout(e,b),this},a(function(){a.support.transition=b()})}(jQuery),function(a){var b="0.9.3",c={isMsie:function(){var a=/(msie) ([\w.]+)/i.exec(navigator.userAgent);return a?parseInt(a[2],10):!1},isBlankString:function(a){return!a||/^\s*$/.test(a)},escapeRegExChars:function(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},isString:function(a){return"string"==typeof a},isNumber:function(a){return"number"==typeof a},isArray:a.isArray,isFunction:a.isFunction,isObject:a.isPlainObject,isUndefined:function(a){return"undefined"==typeof a},bind:a.proxy,bindAll:function(b){var c;for(var d in b)a.isFunction(c=b[d])&&(b[d]=a.proxy(c,b))},indexOf:function(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return c;return-1},each:a.each,map:a.map,filter:a.grep,every:function(b,c){var d=!0;return b?(a.each(b,function(a,e){return(d=c.call(null,e,a,b))?void 0:!1}),!!d):d},some:function(b,c){var d=!1;return b?(a.each(b,function(a,e){return(d=c.call(null,e,a,b))?!1:void 0}),!!d):d},mixin:a.extend,getUniqueId:function(){var a=0;return function(){return a++}}(),defer:function(a){setTimeout(a,0)},debounce:function(a,b,c){var d,e;return function(){var f,g,h=this,i=arguments;return f=function(){d=null,c||(e=a.apply(h,i))},g=c&&!d,clearTimeout(d),d=setTimeout(f,b),g&&(e=a.apply(h,i)),e}},throttle:function(a,b){var c,d,e,f,g,h;return g=0,h=function(){g=new Date,e=null,f=a.apply(c,d)},function(){var i=new Date,j=b-(i-g);return c=this,d=arguments,0>=j?(clearTimeout(e),e=null,g=i,f=a.apply(c,d)):e||(e=setTimeout(h,j)),f}},tokenizeQuery:function(b){return a.trim(b).toLowerCase().split(/[\s]+/)},tokenizeText:function(b){return a.trim(b).toLowerCase().split(/[\s\-_]+/)},getProtocol:function(){return location.protocol},noop:function(){}},d=function(){var a=/\s+/;return{on:function(b,c){var d;if(!c)return this;for(this._callbacks=this._callbacks||{},b=b.split(a);d=b.shift();)this._callbacks[d]=this._callbacks[d]||[],this._callbacks[d].push(c);return this},trigger:function(b,c){var d,e;if(!this._callbacks)return this;for(b=b.split(a);d=b.shift();)if(e=this._callbacks[d])for(var f=0;f<e.length;f+=1)e[f].call(this,{type:d,data:c});return this}}}(),e=function(){function b(b){b&&b.el||a.error("EventBus initialized without el"),this.$el=a(b.el)}var d="typeahead:";return c.mixin(b.prototype,{trigger:function(a){var b=[].slice.call(arguments,1);this.$el.trigger(d+a,b)}}),b}(),f=function(){function a(a){this.prefix=["__",a,"__"].join(""),this.ttlKey="__ttl__",this.keyMatcher=new RegExp("^"+this.prefix)}function b(){return(new Date).getTime()}function d(a){return JSON.stringify(c.isUndefined(a)?null:a)}function e(a){return JSON.parse(a)}var f,g;try{f=window.localStorage,f.setItem("~~~","!"),f.removeItem("~~~")}catch(h){f=null}return g=f&&window.JSON?{_prefix:function(a){return this.prefix+a},_ttlKey:function(a){return this._prefix(a)+this.ttlKey},get:function(a){return this.isExpired(a)&&this.remove(a),e(f.getItem(this._prefix(a)))},set:function(a,e,g){return c.isNumber(g)?f.setItem(this._ttlKey(a),d(b()+g)):f.removeItem(this._ttlKey(a)),f.setItem(this._prefix(a),d(e))},remove:function(a){return f.removeItem(this._ttlKey(a)),f.removeItem(this._prefix(a)),this},clear:function(){var a,b,c=[],d=f.length;for(a=0;d>a;a++)(b=f.key(a)).match(this.keyMatcher)&&c.push(b.replace(this.keyMatcher,""));for(a=c.length;a--;)this.remove(c[a]);return this},isExpired:function(a){var d=e(f.getItem(this._ttlKey(a)));return c.isNumber(d)&&b()>d?!0:!1}}:{get:c.noop,set:c.noop,remove:c.noop,clear:c.noop,isExpired:c.noop},c.mixin(a.prototype,g),a}(),g=function(){function a(a){c.bindAll(this),a=a||{},this.sizeLimit=a.sizeLimit||10,this.cache={},this.cachedKeysByAge=[]}return c.mixin(a.prototype,{get:function(a){return this.cache[a]},set:function(a,b){var c;this.cachedKeysByAge.length===this.sizeLimit&&(c=this.cachedKeysByAge.shift(),delete this.cache[c]),this.cache[a]=b,this.cachedKeysByAge.push(a)}}),a}(),h=function(){function b(a){c.bindAll(this),a=c.isString(a)?{url:a}:a,i=i||new g,h=c.isNumber(a.maxParallelRequests)?a.maxParallelRequests:h||6,this.url=a.url,this.wildcard=a.wildcard||"%QUERY",this.filter=a.filter,this.replace=a.replace,this.ajaxSettings={type:"get",cache:a.cache,timeout:a.timeout,dataType:a.dataType||"json",beforeSend:a.beforeSend},this._get=(/^throttle$/i.test(a.rateLimitFn)?c.throttle:c.debounce)(this._get,a.rateLimitWait||300)}function d(){j++}function e(){j--}function f(){return h>j}var h,i,j=0,k={};return c.mixin(b.prototype,{_get:function(a,b){function c(c){var e=d.filter?d.filter(c):c;b&&b(e),i.set(a,c)}var d=this;f()?this._sendRequest(a).done(c):this.onDeckRequestArgs=[].slice.call(arguments,0)},_sendRequest:function(b){function c(){e(),k[b]=null,f.onDeckRequestArgs&&(f._get.apply(f,f.onDeckRequestArgs),f.onDeckRequestArgs=null)}var f=this,g=k[b];return g||(d(),g=k[b]=a.ajax(b,this.ajaxSettings).always(c)),g},get:function(a,b){var d,e,f=this,g=encodeURIComponent(a||"");return b=b||c.noop,d=this.replace?this.replace(this.url,g):this.url.replace(this.wildcard,g),(e=i.get(d))?c.defer(function(){b(f.filter?f.filter(e):e)}):this._get(d,b),!!e}}),b}(),i=function(){function d(b){c.bindAll(this),c.isString(b.template)&&!b.engine&&a.error("no template engine specified"),b.local||b.prefetch||b.remote||a.error("one of local, prefetch, or remote is required"),this.name=b.name||c.getUniqueId(),this.limit=b.limit||5,this.minLength=b.minLength||1,this.header=b.header,this.footer=b.footer,this.valueKey=b.valueKey||"value",this.template=e(b.template,b.engine,this.valueKey),this.local=b.local,this.prefetch=b.prefetch,this.remote=b.remote,this.itemHash={},this.adjacencyList={},this.storage=b.name?new f(b.name):null}function e(a,b,d){var e,f;return c.isFunction(a)?e=a:c.isString(a)?(f=b.compile(a),e=c.bind(f.render,f)):e=function(a){return"<p>"+a[d]+"</p>"},e}var g={thumbprint:"thumbprint",protocol:"protocol",itemHash:"itemHash",adjacencyList:"adjacencyList"};return c.mixin(d.prototype,{_processLocalData:function(a){this._mergeProcessedData(this._processData(a))},_loadPrefetchData:function(d){function e(a){var b=d.filter?d.filter(a):a,e=m._processData(b),f=e.itemHash,h=e.adjacencyList;m.storage&&(m.storage.set(g.itemHash,f,d.ttl),m.storage.set(g.adjacencyList,h,d.ttl),m.storage.set(g.thumbprint,n,d.ttl),m.storage.set(g.protocol,c.getProtocol(),d.ttl)),m._mergeProcessedData(e)}var f,h,i,j,k,l,m=this,n=b+(d.thumbprint||"");return this.storage&&(f=this.storage.get(g.thumbprint),h=this.storage.get(g.protocol),i=this.storage.get(g.itemHash),j=this.storage.get(g.adjacencyList)),k=f!==n||h!==c.getProtocol(),d=c.isString(d)?{url:d}:d,d.ttl=c.isNumber(d.ttl)?d.ttl:864e5,i&&j&&!k?(this._mergeProcessedData({itemHash:i,adjacencyList:j}),l=a.Deferred().resolve()):l=a.getJSON(d.url).done(e),l},_transformDatum:function(a){var b=c.isString(a)?a:a[this.valueKey],d=a.tokens||c.tokenizeText(b),e={value:b,tokens:d};return c.isString(a)?(e.datum={},e.datum[this.valueKey]=a):e.datum=a,e.tokens=c.filter(e.tokens,function(a){return!c.isBlankString(a)}),e.tokens=c.map(e.tokens,function(a){return a.toLowerCase()}),e},_processData:function(a){var b=this,d={},e={};return c.each(a,function(a,f){var g=b._transformDatum(f),h=c.getUniqueId(g.value);d[h]=g,c.each(g.tokens,function(a,b){var d=b.charAt(0),f=e[d]||(e[d]=[h]);!~c.indexOf(f,h)&&f.push(h)})}),{itemHash:d,adjacencyList:e}},_mergeProcessedData:function(a){var b=this;c.mixin(this.itemHash,a.itemHash),c.each(a.adjacencyList,function(a,c){var d=b.adjacencyList[a];b.adjacencyList[a]=d?d.concat(c):c})},_getLocalSuggestions:function(a){var b,d=this,e=[],f=[],g=[];return c.each(a,function(a,b){var d=b.charAt(0);!~c.indexOf(e,d)&&e.push(d)}),c.each(e,function(a,c){var e=d.adjacencyList[c];return e?(f.push(e),void((!b||e.length<b.length)&&(b=e))):!1}),f.length<e.length?[]:(c.each(b,function(b,e){var h,i,j=d.itemHash[e];h=c.every(f,function(a){return~c.indexOf(a,e)}),i=h&&c.every(a,function(a){return c.some(j.tokens,function(b){return 0===b.indexOf(a)})}),i&&g.push(j)}),g)},initialize:function(){var b;return this.local&&this._processLocalData(this.local),this.transport=this.remote?new h(this.remote):null,b=this.prefetch?this._loadPrefetchData(this.prefetch):a.Deferred().resolve(),this.local=this.prefetch=this.remote=null,this.initialize=function(){return b},b},getSuggestions:function(a,b){function d(a){f=f.slice(0),c.each(a,function(a,b){var d,e=g._transformDatum(b);return d=c.some(f,function(a){return e.value===a.value}),!d&&f.push(e),f.length<g.limit}),b&&b(f)}var e,f,g=this,h=!1;a.length<this.minLength||(e=c.tokenizeQuery(a),f=this._getLocalSuggestions(e).slice(0,this.limit),f.length<this.limit&&this.transport&&(h=this.transport.get(a,d)),!h&&b&&b(f))}}),d}(),j=function(){function b(b){var d=this;c.bindAll(this),this.specialKeyCodeMap={9:"tab",27:"esc",37:"left",39:"right",13:"enter",38:"up",40:"down"},this.$hint=a(b.hint),this.$input=a(b.input).on("blur.tt",this._handleBlur).on("focus.tt",this._handleFocus).on("keydown.tt",this._handleSpecialKeyEvent),c.isMsie()?this.$input.on("keydown.tt keypress.tt cut.tt paste.tt",function(a){d.specialKeyCodeMap[a.which||a.keyCode]||c.defer(d._compareQueryToInputValue)}):this.$input.on("input.tt",this._compareQueryToInputValue),this.query=this.$input.val(),this.$overflowHelper=e(this.$input)}function e(b){return a("<span></span>").css({position:"absolute",left:"-9999px",visibility:"hidden",whiteSpace:"nowrap",fontFamily:b.css("font-family"),fontSize:b.css("font-size"),fontStyle:b.css("font-style"),fontVariant:b.css("font-variant"),fontWeight:b.css("font-weight"),wordSpacing:b.css("word-spacing"),letterSpacing:b.css("letter-spacing"),textIndent:b.css("text-indent"),textRendering:b.css("text-rendering"),textTransform:b.css("text-transform")}).insertAfter(b)}function f(a,b){return a=(a||"").replace(/^\s*/g,"").replace(/\s{2,}/g," "),b=(b||"").replace(/^\s*/g,"").replace(/\s{2,}/g," "),a===b}return c.mixin(b.prototype,d,{_handleFocus:function(){this.trigger("focused")},_handleBlur:function(){this.trigger("blured")},_handleSpecialKeyEvent:function(a){var b=this.specialKeyCodeMap[a.which||a.keyCode];b&&this.trigger(b+"Keyed",a)},_compareQueryToInputValue:function(){var a=this.getInputValue(),b=f(this.query,a),c=b?this.query.length!==a.length:!1;c?this.trigger("whitespaceChanged",{value:this.query}):b||this.trigger("queryChanged",{value:this.query=a})},destroy:function(){this.$hint.off(".tt"),this.$input.off(".tt"),this.$hint=this.$input=this.$overflowHelper=null},focus:function(){this.$input.focus()},blur:function(){this.$input.blur()},getQuery:function(){return this.query},setQuery:function(a){this.query=a},getInputValue:function(){return this.$input.val()},setInputValue:function(a,b){this.$input.val(a),!b&&this._compareQueryToInputValue()},getHintValue:function(){return this.$hint.val()},setHintValue:function(a){this.$hint.val(a)},getLanguageDirection:function(){return(this.$input.css("direction")||"ltr").toLowerCase()},isOverflow:function(){return this.$overflowHelper.text(this.getInputValue()),this.$overflowHelper.width()>this.$input.width()},isCursorAtEnd:function(){var a,b=this.$input.val().length,d=this.$input[0].selectionStart;return c.isNumber(d)?d===b:document.selection?(a=document.selection.createRange(),a.moveStart("character",-b),b===a.text.length):!0}}),b}(),k=function(){function b(b){c.bindAll(this),this.isOpen=!1,this.isEmpty=!0,this.isMouseOverDropdown=!1,this.$menu=a(b.menu).on("mouseenter.tt",this._handleMouseenter).on("mouseleave.tt",this._handleMouseleave).on("click.tt",".tt-suggestion",this._handleSelection).on("mouseover.tt",".tt-suggestion",this._handleMouseover)}function e(a){return a.data("suggestion")}var f={suggestionsList:'<span class="tt-suggestions"></span>'},g={suggestionsList:{display:"block"},suggestion:{whiteSpace:"nowrap",cursor:"pointer"},suggestionChild:{whiteSpace:"normal"}};return c.mixin(b.prototype,d,{_handleMouseenter:function(){this.isMouseOverDropdown=!0},_handleMouseleave:function(){this.isMouseOverDropdown=!1},_handleMouseover:function(b){var c=a(b.currentTarget);this._getSuggestions().removeClass("tt-is-under-cursor"),c.addClass("tt-is-under-cursor")},_handleSelection:function(b){var c=a(b.currentTarget);this.trigger("suggestionSelected",e(c))},_show:function(){this.$menu.css("display","block")},_hide:function(){this.$menu.hide()},_moveCursor:function(a){var b,c,d,f;if(this.isVisible()){if(b=this._getSuggestions(),c=b.filter(".tt-is-under-cursor"),c.removeClass("tt-is-under-cursor"),d=b.index(c)+a,d=(d+1)%(b.length+1)-1,-1===d)return void this.trigger("cursorRemoved");-1>d&&(d=b.length-1),f=b.eq(d).addClass("tt-is-under-cursor"),this._ensureVisibility(f),this.trigger("cursorMoved",e(f))}},_getSuggestions:function(){return this.$menu.find(".tt-suggestions > .tt-suggestion")},_ensureVisibility:function(a){var b=this.$menu.height()+parseInt(this.$menu.css("paddingTop"),10)+parseInt(this.$menu.css("paddingBottom"),10),c=this.$menu.scrollTop(),d=a.position().top,e=d+a.outerHeight(!0);0>d?this.$menu.scrollTop(c+d):e>b&&this.$menu.scrollTop(c+(e-b))},destroy:function(){this.$menu.off(".tt"),this.$menu=null},isVisible:function(){return this.isOpen&&!this.isEmpty},closeUnlessMouseIsOverDropdown:function(){this.isMouseOverDropdown||this.close()},close:function(){this.isOpen&&(this.isOpen=!1,this.isMouseOverDropdown=!1,this._hide(),this.$menu.find(".tt-suggestions > .tt-suggestion").removeClass("tt-is-under-cursor"),this.trigger("closed"))},open:function(){this.isOpen||(this.isOpen=!0,!this.isEmpty&&this._show(),this.trigger("opened"))},setLanguageDirection:function(a){var b={left:"0",right:"auto"},c={left:"auto",right:" 0"};"ltr"===a?this.$menu.css(b):this.$menu.css(c)},moveCursorUp:function(){this._moveCursor(-1)},moveCursorDown:function(){this._moveCursor(1)},getSuggestionUnderCursor:function(){var a=this._getSuggestions().filter(".tt-is-under-cursor").first();return a.length>0?e(a):null},getFirstSuggestion:function(){var a=this._getSuggestions().first();return a.length>0?e(a):null},renderSuggestions:function(b,d){var e,h,i,j,k,l="tt-dataset-"+b.name,m='<div class="tt-suggestion">%body</div>',n=this.$menu.find("."+l);0===n.length&&(h=a(f.suggestionsList).css(g.suggestionsList),n=a("<div></div>").addClass(l).append(b.header).append(h).append(b.footer).appendTo(this.$menu)),d.length>0?(this.isEmpty=!1,this.isOpen&&this._show(),i=document.createElement("div"),j=document.createDocumentFragment(),c.each(d,function(c,d){d.dataset=b.name,e=b.template(d.datum),i.innerHTML=m.replace("%body",e),k=a(i.firstChild).css(g.suggestion).data("suggestion",d),k.children().each(function(){a(this).css(g.suggestionChild)}),j.appendChild(k[0])}),n.show().find(".tt-suggestions").html(j)):this.clearSuggestions(b.name),this.trigger("suggestionsRendered")},clearSuggestions:function(a){var b=a?this.$menu.find(".tt-dataset-"+a):this.$menu.find('[class^="tt-dataset-"]'),c=b.find(".tt-suggestions");b.hide(),c.empty(),0===this._getSuggestions().length&&(this.isEmpty=!0,this._hide())}}),b}(),l=function(){function b(a){var b,d,f;c.bindAll(this),this.$node=e(a.input),this.datasets=a.datasets,this.dir=null,this.eventBus=a.eventBus,b=this.$node.find(".tt-dropdown-menu"),d=this.$node.find(".tt-query"),f=this.$node.find(".tt-hint"),this.dropdownView=new k({menu:b}).on("suggestionSelected",this._handleSelection).on("cursorMoved",this._clearHint).on("cursorMoved",this._setInputValueToSuggestionUnderCursor).on("cursorRemoved",this._setInputValueToQuery).on("cursorRemoved",this._updateHint).on("suggestionsRendered",this._updateHint).on("opened",this._updateHint).on("closed",this._clearHint).on("opened closed",this._propagateEvent),this.inputView=new j({input:d,hint:f}).on("focused",this._openDropdown).on("blured",this._closeDropdown).on("blured",this._setInputValueToQuery).on("enterKeyed tabKeyed",this._handleSelection).on("queryChanged",this._clearHint).on("queryChanged",this._clearSuggestions).on("queryChanged",this._getSuggestions).on("whitespaceChanged",this._updateHint).on("queryChanged whitespaceChanged",this._openDropdown).on("queryChanged whitespaceChanged",this._setLanguageDirection).on("escKeyed",this._closeDropdown).on("escKeyed",this._setInputValueToQuery).on("tabKeyed upKeyed downKeyed",this._managePreventDefault).on("upKeyed downKeyed",this._moveDropdownCursor).on("upKeyed downKeyed",this._openDropdown).on("tabKeyed leftKeyed rightKeyed",this._autocomplete)}function e(b){var c=a(g.wrapper),d=a(g.dropdown),e=a(b),f=a(g.hint);c=c.css(h.wrapper),d=d.css(h.dropdown),f.css(h.hint).css({backgroundAttachment:e.css("background-attachment"),backgroundClip:e.css("background-clip"),backgroundColor:e.css("background-color"),backgroundImage:e.css("background-image"),backgroundOrigin:e.css("background-origin"),backgroundPosition:e.css("background-position"),backgroundRepeat:e.css("background-repeat"),backgroundSize:e.css("background-size")}),e.data("ttAttrs",{dir:e.attr("dir"),autocomplete:e.attr("autocomplete"),spellcheck:e.attr("spellcheck"),style:e.attr("style")}),e.addClass("tt-query").attr({autocomplete:"off",spellcheck:!1}).css(h.query);try{!e.attr("dir")&&e.attr("dir","auto")}catch(i){}return e.wrap(c).parent().prepend(f).append(d)}function f(a){var b=a.find(".tt-query");c.each(b.data("ttAttrs"),function(a,d){c.isUndefined(d)?b.removeAttr(a):b.attr(a,d)}),b.detach().removeData("ttAttrs").removeClass("tt-query").insertAfter(a),a.remove()}var g={wrapper:'<span class="twitter-typeahead"></span>',hint:'<input class="tt-hint" type="text" autocomplete="off" spellcheck="off" disabled>',dropdown:'<span class="tt-dropdown-menu"></span>'},h={wrapper:{position:"relative"},hint:{position:"absolute",top:"0",left:"0",borderColor:"transparent",boxShadow:"none"},query:{position:"relative",verticalAlign:"top","border-radius":"4px 0 0 4px","-moz-border-radius":"4px 0 0 4px","-webkit-border-radius":"4px 0 0 4px"},dropdown:{position:"absolute",top:"100%",left:"0",zIndex:"100",display:"none"}};return c.isMsie()&&c.mixin(h.query,{backgroundImage:"url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)"}),c.isMsie()&&c.isMsie()<=7&&(c.mixin(h.wrapper,{display:"inline",zoom:"1"}),c.mixin(h.query,{marginTop:"-1px"})),c.mixin(b.prototype,d,{_managePreventDefault:function(a){var b,c,d=a.data,e=!1;switch(a.type){case"tabKeyed":b=this.inputView.getHintValue(),c=this.inputView.getInputValue(),e=b&&b!==c;break;case"upKeyed":case"downKeyed":e=!d.shiftKey&&!d.ctrlKey&&!d.metaKey}e&&d.preventDefault()},_setLanguageDirection:function(){var a=this.inputView.getLanguageDirection();a!==this.dir&&(this.dir=a,this.$node.css("direction",a),this.dropdownView.setLanguageDirection(a))},_updateHint:function(){var a,b,d,e,f,g=this.dropdownView.getFirstSuggestion(),h=g?g.value:null,i=this.dropdownView.isVisible(),j=this.inputView.isOverflow();h&&i&&!j&&(a=this.inputView.getInputValue(),b=a.replace(/\s{2,}/g," ").replace(/^\s+/g,""),d=c.escapeRegExChars(b),e=new RegExp("^(?:"+d+")(.*$)","i"),f=e.exec(h),this.inputView.setHintValue(a+(f?f[1]:"")))},_clearHint:function(){this.inputView.setHintValue("")},_clearSuggestions:function(){this.dropdownView.clearSuggestions()},_setInputValueToQuery:function(){this.inputView.setInputValue(this.inputView.getQuery())},_setInputValueToSuggestionUnderCursor:function(a){var b=a.data;this.inputView.setInputValue(b.value,!0)},_openDropdown:function(){this.dropdownView.open()},_closeDropdown:function(a){this.dropdownView["blured"===a.type?"closeUnlessMouseIsOverDropdown":"close"]()},_moveDropdownCursor:function(a){var b=a.data;b.shiftKey||b.ctrlKey||b.metaKey||this.dropdownView["upKeyed"===a.type?"moveCursorUp":"moveCursorDown"]()},_handleSelection:function(a){var b="suggestionSelected"===a.type,d=b?a.data:this.dropdownView.getSuggestionUnderCursor();d&&(this.inputView.setInputValue(d.value),b?this.inputView.focus():a.data.preventDefault(),b&&c.isMsie()?c.defer(this.dropdownView.close):this.dropdownView.close(),this.eventBus.trigger("selected",d.datum,d.dataset))},_getSuggestions:function(){var a=this,b=this.inputView.getQuery();c.isBlankString(b)||c.each(this.datasets,function(c,d){d.getSuggestions(b,function(c){b===a.inputView.getQuery()&&a.dropdownView.renderSuggestions(d,c)})})},_autocomplete:function(a){var b,c,d,e,f;("rightKeyed"!==a.type&&"leftKeyed"!==a.type||(b=this.inputView.isCursorAtEnd(),c="ltr"===this.inputView.getLanguageDirection()?"leftKeyed"===a.type:"rightKeyed"===a.type,b&&!c))&&(d=this.inputView.getQuery(),e=this.inputView.getHintValue(),""!==e&&d!==e&&(f=this.dropdownView.getFirstSuggestion(),this.inputView.setInputValue(f.value),this.eventBus.trigger("autocompleted",f.datum,f.dataset)))},_propagateEvent:function(a){this.eventBus.trigger(a.type);
},destroy:function(){this.inputView.destroy(),this.dropdownView.destroy(),f(this.$node),this.$node=null},setQuery:function(a){this.inputView.setQuery(a),this.inputView.setInputValue(a),this._clearHint(),this._clearSuggestions(),this._getSuggestions()}}),b}();!function(){var b,d={},f="ttView";b={initialize:function(b){function g(){var b,d=a(this),g=new e({el:d});b=c.map(h,function(a){return a.initialize()}),d.data(f,new l({input:d,eventBus:g=new e({el:d}),datasets:h})),a.when.apply(a,b).always(function(){c.defer(function(){g.trigger("initialized")})})}var h;return b=c.isArray(b)?b:[b],0===b.length&&a.error("no datasets provided"),h=c.map(b,function(a){var b=d[a.name]?d[a.name]:new i(a);return a.name&&(d[a.name]=b),b}),this.each(g)},destroy:function(){function b(){var b=a(this),c=b.data(f);c&&(c.destroy(),b.removeData(f))}return this.each(b)},setQuery:function(b){function c(){var c=a(this).data(f);c&&c.setQuery(b)}return this.each(c)}},jQuery.fn.typeahead=function(a){return b[a]?b[a].apply(this,[].slice.call(arguments,1)):b.initialize.apply(this,arguments)}}()}(window.jQuery),function(a,b){if("object"==typeof exports&&exports)b(exports);else{var c={};b(c),"function"==typeof define&&define.amd?define(c):a.Mustache=c}}(this,function(a){function b(a,b){return t.call(a,b)}function c(a){return!b(p,a)}function d(a){return a.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function e(a){return String(a).replace(/[&<>"'\/]/g,function(a){return w[a]})}function f(a){this.string=a,this.tail=a,this.pos=0}function g(a,b){this.view=a||{},this.parent=b,this._cache={}}function h(){this.clearCache()}function i(b,c,d,e){for(var f,g,h,j="",k=0,l=b.length;l>k;++k)switch(f=b[k],g=f[1],f[0]){case"#":if(h=d.lookup(g),"object"==typeof h)if(v(h))for(var m=0,n=h.length;n>m;++m)j+=i(f[4],c,d.push(h[m]),e);else h&&(j+=i(f[4],c,d.push(h),e));else if("function"==typeof h){var o=null==e?null:e.slice(f[3],f[5]);h=h.call(d.view,o,function(a){return c.render(a,d)}),null!=h&&(j+=h)}else h&&(j+=i(f[4],c,d,e));break;case"^":h=d.lookup(g),(!h||v(h)&&0===h.length)&&(j+=i(f[4],c,d,e));break;case">":h=c.getPartial(g),"function"==typeof h&&(j+=h(d));break;case"&":h=d.lookup(g),null!=h&&(j+=h);break;case"name":h=d.lookup(g),null!=h&&(j+=a.escape(h));break;case"text":j+=g}return j}function j(a){for(var b,c=[],d=c,e=[],f=0,g=a.length;g>f;++f)switch(b=a[f],b[0]){case"#":case"^":e.push(b),d.push(b),d=b[4]=[];break;case"/":var h=e.pop();h[5]=b[2],d=e.length>0?e[e.length-1][4]:c;break;default:d.push(b)}return c}function k(a){for(var b,c,d=[],e=0,f=a.length;f>e;++e)b=a[e],b&&("text"===b[0]&&c&&"text"===c[0]?(c[1]+=b[1],c[3]=b[3]):(c=b,d.push(b)));return d}function l(a){return[new RegExp(d(a[0])+"\\s*"),new RegExp("\\s*"+d(a[1]))]}function m(b,e){function g(){if(z&&!A)for(;y.length;)delete x[y.pop()];else y=[];z=!1,A=!1}if(b=b||"",e=e||a.tags,"string"==typeof e&&(e=e.split(o)),2!==e.length)throw new Error("Invalid tags: "+e.join(", "));for(var h,i,m,p,t,u=l(e),v=new f(b),w=[],x=[],y=[],z=!1,A=!1;!v.eos();){if(h=v.pos,m=v.scanUntil(u[0]))for(var B=0,C=m.length;C>B;++B)p=m.charAt(B),c(p)?y.push(x.length):A=!0,x.push(["text",p,h,h+1]),h+=1,"\n"==p&&g();if(!v.scan(u[0]))break;if(z=!0,i=v.scan(s)||"name",v.scan(n),"="===i?(m=v.scanUntil(q),v.scan(q),v.scanUntil(u[1])):"{"===i?(m=v.scanUntil(new RegExp("\\s*"+d("}"+e[1]))),v.scan(r),v.scanUntil(u[1]),i="&"):m=v.scanUntil(u[1]),!v.scan(u[1]))throw new Error("Unclosed tag at "+v.pos);if(t=[i,m,h,v.pos],x.push(t),"#"===i||"^"===i)w.push(t);else if("/"===i){if(0===w.length)throw new Error('Unopened section "'+m+'" at '+h);var D=w.pop();if(D[1]!==m)throw new Error('Unclosed section "'+D[1]+'" at '+h)}else if("name"===i||"{"===i||"&"===i)A=!0;else if("="===i){if(e=m.split(o),2!==e.length)throw new Error("Invalid tags at "+h+": "+e.join(", "));u=l(e)}}var D=w.pop();if(D)throw new Error('Unclosed section "'+D[1]+'" at '+v.pos);return x=k(x),j(x)}var n=/\s*/,o=/\s+/,p=/\S/,q=/\s*=/,r=/\s*\}/,s=/#|\^|\/|>|\{|&|=|!/,t=RegExp.prototype.test,u=Object.prototype.toString,v=Array.isArray||function(a){return"[object Array]"===u.call(a)},w={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};f.prototype.eos=function(){return""===this.tail},f.prototype.scan=function(a){var b=this.tail.match(a);return b&&0===b.index?(this.tail=this.tail.substring(b[0].length),this.pos+=b[0].length,b[0]):""},f.prototype.scanUntil=function(a){var b,c=this.tail.search(a);switch(c){case-1:b=this.tail,this.pos+=this.tail.length,this.tail="";break;case 0:b="";break;default:b=this.tail.substring(0,c),this.tail=this.tail.substring(c),this.pos+=c}return b},g.make=function(a){return a instanceof g?a:new g(a)},g.prototype.push=function(a){return new g(a,this)},g.prototype.lookup=function(a){var b=this._cache[a];if(!b){if("."==a)b=this.view;else for(var c=this;c;){if(a.indexOf(".")>0){b=c.view;for(var d=a.split("."),e=0;b&&e<d.length;)b=b[d[e++]]}else b=c.view[a];if(null!=b)break;c=c.parent}this._cache[a]=b}return"function"==typeof b&&(b=b.call(this.view)),b},h.prototype.clearCache=function(){this._cache={},this._partialCache={}},h.prototype.compile=function(b,c){var d=this._cache[b];if(!d){var e=a.parse(b,c);d=this._cache[b]=this.compileTokens(e,b)}return d},h.prototype.compilePartial=function(a,b,c){var d=this.compile(b,c);return this._partialCache[a]=d,d},h.prototype.getPartial=function(a){return a in this._partialCache||!this._loadPartial||this.compilePartial(a,this._loadPartial(a)),this._partialCache[a]},h.prototype.compileTokens=function(a,b){var c=this;return function(d,e){if(e)if("function"==typeof e)c._loadPartial=e;else for(var f in e)c.compilePartial(f,e[f]);return i(a,c,g.make(d),b)}},h.prototype.render=function(a,b,c){return this.compile(a)(b,c)},a.name="mustache.js",a.version="0.7.2",a.tags=["{{","}}"],a.Scanner=f,a.Context=g,a.Writer=h,a.parse=m,a.escape=e;var x=new h;a.clearCache=function(){return x.clearCache()},a.compile=function(a,b){return x.compile(a,b)},a.compilePartial=function(a,b,c){return x.compilePartial(a,b,c)},a.compileTokens=function(a,b){return x.compileTokens(a,b)},a.render=function(a,b,c){return x.render(a,b,c)},a.to_html=function(b,c,d,e){var f=a.render(b,c,d);return"function"!=typeof e?f:void e(f)}});var map,navMap=function(){function a(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}var b,c,d,e,f,g,h,i,j={lng:0,lat:0},k={lng:0,lat:0},l=3,m={selectedInterval:{nam:"",mid:"",oid:""},personFilter:{id:"",name:""},taxa:[],stratigraphy:{name:"",rank:""},exist:{selectedInterval:!1,personFilter:!1,taxon:!1,stratigraphy:!1}},n=960,o=500,p=d3.geo.hammer().scale(165).translate([n/2,o/2]).rotate([1e-6,0]).precision(.1),q=d3.geo.path().projection(p);return{init:function(a){function d(a){var b=map.getBounds();if(Math.abs(b._northEast.lng)+Math.abs(b._southWest.lng)>360)var c=!0;(3>a||a>3&&c||4===l&&3===a&&c)&&window.innerWidth>700&&(l=2,d3.select("#map").style("height",0),d3.select("#svgMap").style("display","block")),navMap.refresh()}map=new L.Map("map",{center:new L.LatLng(7,0),zoom:2,maxZoom:11,minZoom:2,zoomControl:!1,inertiaDeceleration:6e3,inertiaMaxSpeed:1e3,zoomAnimationThreshold:1});var e='Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';b=new L.TileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/toner-background/{z}/{x}/{y}.png",{attribution:e}).addTo(map),c=new L.TileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png",{attribution:e}),map.on("moveend",function(a){a.hard||parseInt(d3.select("#map").style("height"))<2||(d(map.getZoom()),paleo_nav.getPrevalence())}),map.on("zoomend",function(){d3.select(".leaflet-zoom-hide").style("visibility","hidden"),navMap.selectBaseMap(map.getZoom()),d(map.getZoom())}),map._initPathRoot(),d3.select("#map").select("svg").append("g").attr("class","leaflet-zoom-hide").attr("id","binHolder"),d3.select("#map").style("height",0);var j=d3.behavior.zoom().on("zoom",function(){d3.event.sourceEvent.wheelDelta>0?navMap.changeMaps(d3.mouse(this)):"touchmove"===d3.event.sourceEvent.type&&navMap.changeMaps([d3.event.sourceEvent.pageX,d3.event.sourceEvent.pageY])}),k=d3.select("#svgMap").append("svg").attr("width",n).attr("height",o).call(j).on("click",function(){navMap.changeMaps(d3.mouse(this))}).append("g");k.append("defs").append("path").datum({type:"Sphere"}).attr("id","sphere").attr("d",q),k.append("use").attr("class","fill").attr("xlink:href","#sphere"),d3.json("build/js/countries_1e5.json",function(b,c){k.append("path").datum(topojson.feature(c,c.objects.countries)).attr("class","countries").attr("d",q),reconstructMap.resize(),timeScale.resize(),setTimeout(navMap.resize,1e3),a()}),d3.text("build/partials/binModal.html",function(a,b){f=b}),d3.text("build/partials/collectionModal.html",function(a,b){g=b}),d3.text("build/partials/occurrences.html",function(a,b){h=b}),d3.text("build/partials/stackedCollectionModal.html",function(a,b){i=b})},changeMaps:function(a){paleo_nav.getPrevalence();var b=$("#time").height()>15?$("#time").height():window.innerHeight/5.6,c=[window.innerWidth/2,(window.innerHeight-b-70)/2],d=d3.geo.mercator().scale(165).precision(.1).translate(c),e=a,f=d.invert(e);d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){if("hidden"===d3.select(".timeScale").style("visibility"))return window.innerHeight-70+"px";var a=$("#time").height()>15?$("#time").height():window.innerHeight/5.6;return window.innerHeight-a-56+"px"}),map.setView([parseInt(f[1]),parseInt(f[0])],3,{animate:!1});var g=map.getBounds();Math.abs(g._northEast.lng)+Math.abs(g._southWest.lng)>360&&map.setZoom(4,{animate:!1}),navMap.refresh("reset"),map.invalidateSize()},goTo:function(a,b){3>b||(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){return.7*window.innerHeight+"px"}),map._resetView(a,b))},selectBaseMap:function(a){5>a?map.hasLayer(c)&&(map.removeLayer(c),map.addLayer(b)):a>4&&7>a?map.hasLayer(c)&&(map.removeLayer(c),map.addLayer(b)):map.hasLayer(c)?map.removeLayer(b):(map.addLayer(c),map.removeLayer(b))},refresh:function(a){paleo_nav.showLoading(),l-map.getZoom()!=0&&d3.select(".leaflet-zoom-hide").style("visibility","hidden");var b=navMap.checkFilters();if(parseInt(d3.select("#map").style("height"))<1){"undefined"!=typeof d&&Object.keys(d).length>0&&(d.abort(),d={});var c=paleo_nav.dataUrl+paleo_nav.dataService+"/colls/summary.json?lngmin=-180&lngmax=180&latmin=-90&latmax=90&limit=all&show=time";if(b){if(m.exist.selectedInterval!==!0||m.exist.personFilter||m.exist.taxon||m.exist.stratigraphy)c+="&level=2",c=navMap.parseURL(c);else if(c+="&level=3",c=navMap.parseURL(c),"undefined"!=typeof timeScale.interval_hash[m.selectedInterval.oid]){if("undefined"!=typeof timeScale.interval_hash[m.selectedInterval.oid].data)return navMap.refreshHammer(timeScale.interval_hash[m.selectedInterval.oid].data);d=d3.json(c,function(a,b){return a?paleo_nav.hideLoading():(timeScale.interval_hash[m.selectedInterval.oid].data=b,navMap.refreshHammer(b))})}}else c+="&level=1",c=navMap.parseURL(c);return void(d=d3.json(c,function(a,b){return a?paleo_nav.hideLoading():void navMap.refreshHammer(b)}))}var e=map.getBounds(),f=e._southWest,g=e._northEast,h=map.getZoom();if(f.lat=f.lat.toFixed(4),f.lng=f.lng.toFixed(4),g.lat=g.lat.toFixed(4),g.lng=g.lng.toFixed(4),!a)if(k.lat>g.lat&&k.lng>g.lng&&j.lat<f.lat&&j.lng<f.lng){if(3>l&&h>2);else if(5>l&&h>4);else if(!(7>l&&h>6)){if(l===h)return l=h,void paleo_nav.hideLoading();var i=d3.selectAll(".bins");if(h>6){var n=d3.selectAll(".clusters");return l=h,navMap.redrawPoints(i,n)}return l=h,navMap.redrawPoints(i)}}else if(l>2&&7>h&&b&&m.exist.selectedInterval===!0&&!m.exist.personFilter&&!m.exist.taxon&&!m.exist.stratigraphy)if(d3.select("#binHolder").selectAll("circle")[0].length<1);else if(!(7>l&&h>6||l>6&&7>h)){var i=d3.selectAll(".bins");if(h>6){var n=d3.selectAll(".clusters");return l=h,navMap.redrawPoints(i,n)}return l=h,navMap.redrawPoints(i)}if(j=f,k=g,l=h,f.lat=f.lat<-90?-90:f.lat,g.lat=g.lat>90?90:g.lat,"undefined"!=typeof d&&Object.keys(d).length>0&&(d.abort(),d={}),5>h&&b===!1){var c=paleo_nav.dataUrl+paleo_nav.dataService+"/colls/summary.json?lngmin="+f.lng+"&lngmax="+g.lng+"&latmin="+f.lat+"&latmax="+g.lat+"&level=2&limit=all&show=time";d=d3.json(navMap.parseURL(c),function(a,b){return a?paleo_nav.hideLoading():void navMap.drawBins(b,1,h)})}else if(h>4&&7>h||5>h&&b===!0)if(m.exist.selectedInterval!==!0||m.exist.personFilter||m.exist.taxon||m.exist.stratigraphy){var c=paleo_nav.dataUrl+paleo_nav.dataService+"/colls/summary.json?lngmin="+f.lng+"&lngmax="+g.lng+"&latmin="+f.lat+"&latmax="+g.lat+"&level=3&limit=all&show=time";d=d3.json(navMap.parseURL(c),function(a,b){return a?paleo_nav.hideLoading():void navMap.drawBins(b,2,h)})}else{var c=paleo_nav.dataUrl+paleo_nav.dataService+"/colls/summary.json?lngmin=-180&lngmax=180&latmin=-90&latmax=90&limit=all&show=time&level=3";if(c=navMap.parseURL(c),"undefined"!=typeof timeScale.interval_hash[m.selectedInterval.oid]){if("undefined"!=typeof timeScale.interval_hash[m.selectedInterval.oid].data)return navMap.drawBins(timeScale.interval_hash[m.selectedInterval.oid].data,2,h);d=d3.json(c,function(a,b){return a?paleo_nav.hideLoading():(timeScale.interval_hash[m.selectedInterval.oid].data=b,navMap.drawBins(b,2,h))})}}else{var c=paleo_nav.dataUrl+paleo_nav.dataService+"/colls/list.json?lngmin="+f.lng+"&lngmax="+g.lng+"&latmin="+f.lat+"&latmax="+g.lat+"&limit=all&show=ref,time,strat,geo,lith,entname,prot&markrefs";d=d3.json(navMap.parseURL(c),function(a,b){return a?paleo_nav.hideLoading():void navMap.drawCollections(b,3,h)})}},redrawPoints:function(a,b){d3.select(".leaflet-zoom-hide").style("visibility","hidden");var c=map.getZoom();if(5>c)if(navMap.checkFilters())var d=d3.scale.log().domain([1,400]).range([4,30]);else var d=d3.scale.linear().domain([1,3140]).range([4,30]);else if(c>4&&7>c)var d=d3.scale.log().domain([1,400]).range([4,30]);else var d=d3.scale.linear().domain([1,50]).range([12,30]);a.attr("cx",function(a){return map.latLngToLayerPoint([a.lat,a.lng]).x}),a.attr("cy",function(a){return map.latLngToLayerPoint([a.lat,a.lng]).y}),b?(b.attr("cx",function(a){return map.latLngToLayerPoint([a.lat,a.lng]).x}),b.attr("cy",function(a){return map.latLngToLayerPoint([a.lat,a.lng]).y}),b.attr("r",function(a){return d(a.members.length)}),a.attr("r",12)):d3.select("#binHolder").selectAll(".bins")[0].length<30?a.attr("r",8):a.attr("r",function(a){return d(a.nco)*navMap.multiplier(c)<4?4:d(a.nco)*navMap.multiplier(c)}),paleo_nav.hideLoading(),d3.select(".leaflet-zoom-hide").style("visibility","visible")},refreshHammer:function(a){navMap.summarize(a);var b=d3.scale.linear().domain([1,4240]).range([4,15]),c=d3.select("#svgMap").select("svg").select("g"),d=2,e=c.selectAll("circle").data(a.records);e.enter().append("circle").attr("id",function(a){return"p"+a.cxi}).attr("class","binsHammer").on("mouseout",function(){navMap.setInfoSummary(),timeScale.unhighlight()}),e.style("fill",function(a){return timeScale.interval_hash[a.cxi]?timeScale.interval_hash[a.cxi].color:"#000"}).attr("id",function(a){return"p"+a.cxi}).attr("r",function(a){return b(a.nco)*navMap.multiplier(d)}).attr("cx",function(a){var b=p([a.lng,a.lat]);return b[0]}).attr("cy",function(a){var b=p([a.lng,a.lat]);return b[1]}).on("mouseover",function(a){d3.select(".info").html("<strong>"+a.nco+" collections</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(a){navMap.changeMaps(d3.mouse(this))}),e.exit().remove(),reconstructMap.reconstructing||paleo_nav.hideLoading()},drawBins:function(a,b,c){navMap.summarize(a),d3.selectAll(".clusters").remove();var d=d3.select("#binHolder"),e=d.selectAll(".bins").data(a.records);e.attr("id",function(a){return"p"+a.cxi}).style("fill",function(a){return timeScale.interval_hash[a.cxi]?timeScale.interval_hash[a.cxi].color:"#000"}).on("mouseover",function(a){d3.select(".info").html("<strong>"+a.nco+" collections</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(a){2===b?(d3.select(".info").html("<strong>"+a.nco+" collections</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openBinModal(a)):1===b&&map.setView([a.lat,a.lng],5)}),e.enter().append("circle").attr("class","bins").attr("id",function(a){return"p"+a.cxi}).style("fill",function(a){return timeScale.interval_hash[a.cxi]?timeScale.interval_hash[a.cxi].color:"#000"}).on("mouseover",function(a){d3.select(".info").html("<strong>"+a.nco+" collections</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(a){2===b?(d3.select(".info").html("<strong>"+a.nco+" collections</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openBinModal(a)):1===b&&map.setView([a.lat,a.lng],5)}).on("mouseout",function(){navMap.setInfoSummary(),timeScale.unhighlight()}),e.exit().remove(),navMap.redrawPoints(e)},drawCollections:function(a,b,c){navMap.summarize(a);for(var d=d3.select("#binHolder"),e=[],f=0;f<a.records.length;f++)for(var g=0;g<a.records.length;g++)if(a.records[f].lat===a.records[g].lat&&a.records[f].lng===a.records[g].lng&&a.records[f].oid!=a.records[g].oid){for(var h={lat:a.records[f].lat,lng:a.records[f].lng,members:[]},i=0,j=0;j<e.length;j++)h.lat===e[j].lat&&h.lng===e[j].lng&&(i+=1);if(1>i){e.push(h);break}break}for(var k=[],f=0;f<e.length;f++)for(var g=0;g<a.records.length;g++)e[f].lat===a.records[g].lat&&e[f].lng===a.records[g].lng&&(e[f].members.push(a.records[g]),k.push(a.records[g].oid));for(var f=0;f<k.length;f++){var l=navMap.getIndex(a.records,k[f],"oid");a.records.splice(l,1)}e.forEach(function(a){var b=[];a.members.forEach(function(a){b.push(a.noc)}),a.cxi=a.members[0].cxi,a.noc=d3.sum(b),a.nam=a.members.length+" Collections"});var e=d.selectAll(".clusters").data(e);e.attr("id",function(a){return"p"+a.members[0].cxi}).style("fill",function(a){return timeScale.interval_hash[a.cxi].color}).on("mouseover",function(a){d3.select(".info").html("<strong>"+a.nam+"</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(a){d3.select(".info").html("<strong>"+a.nam+"</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openStackedCollectionModal(a)}).on("mouseout",function(a){navMap.setInfoSummary(),timeScale.unhighlight()}),e.enter().append("circle").attr("class","clusters").attr("id",function(a){return"p"+a.members[0].cxi}).style("fill",function(a){return timeScale.interval_hash[a.members[0].cxi]?timeScale.interval_hash[a.members[0].cxi].color:"#000"}).on("mouseover",function(a){d3.select(".info").html("<strong>"+a.members.length+" collections</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("mouseout",function(a){navMap.setInfoSummary(),timeScale.unhighlight()}).on("click",function(a){d3.select(".info").html("<strong>"+a.nam+"</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openStackedCollectionModal(a)}),e.exit().remove();var m=d.selectAll(".bins").data(a.records);m.attr("id",function(a){return"p"+a.cxi}).style("fill",function(a){return timeScale.interval_hash[a.cxi]?timeScale.interval_hash[a.cxi].color:"#000"}).on("mouseover",function(a){d3.select(".info").html("<strong>"+a.nam+"</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(a){d3.select(".info").html("<strong>"+a.nam+"</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openCollectionModal(a)}).on("mouseout",function(a){navMap.setInfoSummary(),timeScale.unhighlight()});m.enter().append("circle").attr("id",function(a){return"p"+a.cxi}).attr("class","bins").style("fill",function(a){return timeScale.interval_hash[a.cxi]?timeScale.interval_hash[a.cxi].color:"#000"}).on("mouseover",function(a){d3.select(".info").html("<strong>"+a.nam+"</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(a){d3.select(".info").html("<strong>"+a.nam+"</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openCollectionModal(a)}).on("mouseout",function(a){navMap.setInfoSummary(),timeScale.unhighlight()}),m.exit().remove(),navMap.redrawPoints(m,e)},getOffsetCollections:function(a,b){d3.json(paleo_nav.dataUrl+paleo_nav.dataService+"/colls/list.json?clust_id="+a+"&show=ref,loc,time,strat,geo,lith,entname,prot&markrefs&limit=20&offset="+b,function(a,c){if(a)return paleo_nav.hideLoading();c.records.forEach(function(a){a.intervals=a.oli?a.oei+" - "+a.oli:a.oei,a.strat=a.sfm||a.sgr||a.smb?!0:!1,a.lat=Math.round(1e4*a.lat)/1e4,a.lng=Math.round(1e4*a.lng)/1e4,a.oid=a.oid.replace(":","")});var d=Mustache.render(i,{members:c.records});$("#collectionCount").html("Showing "+b+" of "+c.records_found+" collections"),$("#collectionAccordion").append(d),$(".show-more-collections").data()["shown-collections"]=b,b>=$(".show-more-collections").data("total-collections")&&$(".show-more-collections").hide(),$(".occurrenceTab").on("show.bs.tab",function(a){var b=a.target.id;b=b.replace("occToggle","");var c=navMap.parseURL(paleo_nav.dataUrl+paleo_nav.dataService+"/occs/list.json?coll_id="+b+"&show=phylo,ident");d3.json(c,function(a,c){if(a)return paleo_nav.hideLoading();if(c.records.length>0){var d=navMap.buildTaxonHierarchy(c),e=Mustache.render(h,d);$("#occurrences"+b).html(e),$(".filterByOccurrence").click(function(a){a.preventDefault(),navMap.filterByTaxon($(this).attr("data-name")),$("#collectionModal").modal("hide")})}else{var e=Mustache.render(h,{error:"No occurrences found for this collection"});$("#occurrences"+b).html(e)}})}),$("#collectionLoading").hide()})},openBinModal:function(a,b,c,d){$("#loading").show();var e=a.properties?a.properties.oid:a.oid,f=paleo_nav.dataUrl+paleo_nav.dataService+"/colls/list.json?clust_id="+e;f=navMap.parseURL(f),f+="&show=ref,loc,time,strat,geo,lith,entname,prot&markrefs&limit=20&rowcount",d3.json(f,function(a,b){if(a)return paleo_nav.hideLoading();b.records.forEach(function(a){a.intervals=a.oli?a.oei+" - "+a.oli:a.oei,a.strat=a.sfm||a.sgr||a.smb?!0:!1,a.lat=Math.round(1e4*a.lat)/1e4,a.lng=Math.round(1e4*a.lng)/1e4,a.oid=a.oid.replace("col:","")});var c=Mustache.render(i,{members:b.records});d3.select("#collectionCount").html("Showing "+b.records.length+" of "+b.records_found+" collections"),d3.select("#collectionAccordion").html(c),$(".show-more-collections").data("total-collections",b.records_found).data("shown-collections",b.records_returned),$(".collectionCollapse").on("show.bs.collapse",function(a){var b=a.target.id;b=b.replace("collapse",""),d3.json(paleo_nav.dataUrl+paleo_nav.dataService+"/colls/single.json?id="+b+"&show=ref,time,strat,geo,lith,entname,prot&markrefs",function(a,c){return a?paleo_nav.hideLoading():void $("#ref"+b).html(c.records[0].ref)})}),$(".occurrenceTab").on("show.bs.tab",function(a){var b=a.target.id;b=b.replace("occToggle","");var c=navMap.parseURL(paleo_nav.dataUrl+paleo_nav.dataService+"/occs/list.json?coll_id="+b+"&show=phylo,ident");d3.json(c,function(a,c){if(a)return paleo_nav.hideLoading();if(c.records.length>0){var d=navMap.buildTaxonHierarchy(c),e=Mustache.render(h,d);$("#occurrences"+b).html(e),$(".filterByOccurrence").click(function(a){a.preventDefault(),navMap.filterByTaxon($(this).attr("data-name")),$("#collectionModal").modal("hide")})}else{var e=Mustache.render(h,{error:"No occurrences found for this collection"});$("#occurrences"+b).html(e)}})}),b.records_found<=b.records_returned?($(".show-more-collections").hide(),$("#collectionCount").hide()):$(".show-more-collections").show().off("click").on("click",function(){$("#collectionLoading").show(),$(".show-more-collections").data().offset+=20,navMap.getOffsetCollections(e,$(".show-more-collections").data().offset)}),$("#binModal").modal(),$("#loading").hide()})},buildTaxonHierarchy:function(a){var b={phyla:[]};a.records.forEach(function(a){if(a.rank=a.mra?taxaBrowser.rankMap(a.mra):a.rank?taxaBrowser.rankMap(a.rnk):"Unknown",a.italics=a.rnk<6?"italics":"","undefined"==typeof a.tna&&(a.tna=a.idn),a.old_name=a.tna.split(" ")[0]!=a.idt?a.tna:"",a.url="species"===a.rank?a.idt+" "+a.ids:a.tid>0?a.idt:"",a.idt)if("species"===a.rank){var c=a.rst?a.rst+" ":"",d=a.rss?" "+a.rss+" ":" ";a.genusRes=c,a.display_name1=a.mna,a.display_name2=a.mna!=a.idt+" "+a.ids?"("+a.tna+")":"",a.display_name3=""}else{var c=a.rst?a.rst+" ":"",d=a.rss?" "+a.rss+" ":"";a.genusRes=c,a.display_name1=a.idt,a.display_name2=d,a.display_name3=a.ids}else a.display_name1=a.tna,a.display_name2="";for(var e=[],f=0;f<b.phyla.length;f++)e.push(b.phyla[f].phylum);if(e.indexOf(a.phl)<0){var g={phylum:a.phl,classes:[]};b.phyla.push(g)}for(var h=[],f=0;f<b.phyla.length;f++)for(var i=0;i<b.phyla[f].classes.length;i++)h.push(b.phyla[f].phylum+"-"+b.phyla[f].classes[i].nameClass);if(h.indexOf(a.phl+"-"+a.cll)<0){var j={nameClass:a.cll,families:[]},k=navMap.getIndex(b.phyla,a.phl,"phylum");b.phyla[k].classes.push(j)}for(var l=[],f=0;f<b.phyla.length;f++)for(var i=0;i<b.phyla[f].classes.length;i++)for(var m=0;m<b.phyla[f].classes[i].families.length;m++)l.push(b.phyla[f].phylum+"-"+b.phyla[f].classes[i].nameClass+"-"+b.phyla[f].classes[i].families[m].family);if(l.indexOf(a.phl+"-"+a.cll+"-"+a.fml)<0){var n={family:a.fml,genera:[]},k=navMap.getIndex(b.phyla,a.phl,"phylum"),o=navMap.getIndex(b.phyla[k].classes,a.cll,"nameClass");b.phyla[k].classes[o].families.push(n)}var k=navMap.getIndex(b.phyla,a.phl,"phylum"),o=navMap.getIndex(b.phyla[k].classes,a.cll,"nameClass"),p=navMap.getIndex(b.phyla[k].classes[o].families,a.fml,"family");b.phyla[k].classes[o].families[p].genera.push(a)});for(var c=0;c<b.phyla.length;c++){for(var d,e=0;e<b.phyla[c].classes.length;e++){for(var f,g=0;g<b.phyla[c].classes[e].families.length;g++)"undefined"==typeof b.phyla[c].classes[e].families[g].family&&(f=g,b.phyla[c].classes[e].families[g].family="Miscellaneous unranked taxa",b.phyla[c].classes[e].families[g].noFamily=!0);"undefined"!=typeof f&&b.phyla[c].classes[e].families.push(b.phyla[c].classes[e].families.splice(f,1)[0]),"undefined"==typeof b.phyla[c].classes[e].nameClass&&(f=e,b.phyla[c].classes[e].nameClass="Miscellaneous unranked taxa",b.phyla[c].classes[e].noClass=!0)}"undefined"!=typeof d&&b.phyla[c].classes.push(b.phyla[c].classes.splice(d,1)[0]),"undefined"==typeof b.phyla[c].phylum&&(b.phyla[c].phylum="Unranked taxa",b.phyla[c].unranked=!0)}return b},openCollectionModal:function(a){$("#loading").show(),d3.json(paleo_nav.dataUrl+paleo_nav.dataService+"/colls/single.json?id="+a.oid+"&show=ref,time,strat,geo,lith,entname,prot&markrefs",function(a,b){if(a)return paleo_nav.hideLoading();b.records.forEach(function(a){a.intervals=a.oli?a.oei+" - "+a.oli:a.oei,a.strat=a.sfm||a.sgr||a.smb?!0:!1,a.lat=Math.round(1e4*a.lat)/1e4,a.lng=Math.round(1e4*a.lng)/1e4,a.oid=a.oid.replace("col:","")});var c=Mustache.render(g,b);switch($("#collectionName").html(b.records[0].nam),$("#collectionModalBody").html(c),b.records[0].ptd){case"NPS":$(".nationalParks").css("display","block"),$(".general, .federalLands").css("display","none");break;case"FED":$(".federalLands").css("display","block"),$(".general, .nationalParks").css("display","none");break;default:$(".general").css("display","block"),$(".nationalParks, .federalLands").css("display","none")}$(".filterByStrat").click(function(a){a.preventDefault(),navMap.filterByStratigraphy({name:$(this).attr("data-name"),type:$(this).attr("data-rank")}),$("#collectionBox").modal("hide")}),$("#collectionBox").modal(),$(".occurrenceTab").on("show.bs.tab",function(a){var b=a.target.id;b=b.replace("occToggle","");var c=navMap.parseURL(paleo_nav.dataUrl+paleo_nav.dataService+"/occs/list.json?coll_id="+b+"&show=phylo,ident");d3.json(c,function(a,c){if(a)return paleo_nav.hideLoading();if(c.records.length>0){var d=navMap.buildTaxonHierarchy(c),e=Mustache.render(h,d);$("#occurrences"+b).html(e),$(".filterByOccurrence").click(function(a){a.preventDefault(),navMap.filterByTaxon($(this).attr("data-name")),$("#collectionBox").modal("hide")})}else{var e=Mustache.render(h,{error:"No occurrences found for this collection"});$("#occurrences"+b).html(e)}})}),$("#loading").hide()})},openStackedCollectionModal:function(a){var b=a.members[0].ptd;a.members.forEach(function(a){a.intervals=a.oli?a.oei+" - "+a.oli:a.oei,a.strat=a.sfm||a.sgr||a.smb?!0:!1,a.lat=Math.round(1e4*a.lat)/1e4,a.lng=Math.round(1e4*a.lng)/1e4,a.oid=a.oid.replace("col:","")});var c=Mustache.render(i,a);switch(d3.select("#binID").html("Fossil Collections at ["+Math.round(1e4*a.lat)/1e4+", "+Math.round(1e4*a.lng)/1e4+"]"),d3.select("#accordion").html(c),$(".collectionCollapse").on("show.bs.collapse",function(a){var b=a.target.id;b=b.replace("collapse",""),d3.json(paleo_nav.dataUrl+paleo_nav.dataService+"/colls/single.json?id="+b+"&show=ref,time,strat,geo,lith,entname,prot&markrefs",function(a,c){return a?paleo_nav.hideLoading():void $("#ref"+b).html(c.records[0].ref)})}),$(".occurrenceTab").on("show.bs.tab",function(a){var b=a.target.id;b=b.replace("occToggle","");var c=navMap.parseURL(paleo_nav.dataUrl+paleo_nav.dataService+"/occs/list.json?coll_id="+b+"&show=phylo,ident");d3.json(c,function(a,c){if(a)return paleo_nav.hideLoading();if(c.records.length>0){var d=navMap.buildTaxonHierarchy(c),e=Mustache.render(h,d);$("#occurrences"+b).html(e),$(".filterByOccurrence").click(function(a){a.preventDefault(),navMap.filterByTaxon($(this).attr("data-name")),$("#collectionModal").modal("hide")})}else{var e=Mustache.render(h,{error:"No occurrences found for this collection"});$("#occurrences"+b).html(e)}})}),b){case"NPS":$(".nationalParks").css("display","block"),$(".general, .federalLands").css("display","none");break;case"FED":$(".federalLands").css("display","block"),$(".general, .nationalParks").css("display","none");break;default:$(".general").css("display","block"),$(".nationalParks, .federalLands").css("display","none")}$(".filterByStrat").click(function(a){a.preventDefault(),navMap.filterByStratigraphy({name:$(this).attr("data-name"),type:$(this).attr("data-rank")}),$("#collectionModal").modal("hide")}),$("#collectionModal").modal()},buildWKT:function(a){for(var b="",c=0;c<a.length;c++)b+="POINT("+a[c].lat+" "+a[c].lng+" "+a[c].oid+"),";return b=b.slice(0,-1),b=encodeURI(b)},parseURL:function(a){var b=0;for(var c in m.exist)if(m.exist.hasOwnProperty(c)&&m.exist[c]===!0){switch(c){case"selectedInterval":a+="&interval_id="+m.selectedInterval.oid;break;case"personFilter":a+="&touched_by="+m.personFilter.id;break;case"taxon":a+="&base_id=",m.taxa.forEach(function(b){a+=b.id+","}),a=a.slice(0,-1);break;case"stratigraphy":"Fm"===m.stratigraphy.rank?a+="&formation="+m.stratigraphy.name:"Gp"===m.stratigraphy.rank?a+="&stratgroup="+m.stratigraphy.name:"Mbr"===m.stratigraphy.rank&&(a+="&member="+m.stratigraphy.name)}b+=1}return b>0&&"none"===d3.select("#reconstructMap").style("display")&&d3.select(".filters").style("display","block"),a},checkFilters:function(){var a=0;for(var b in m.exist)m.exist.hasOwnProperty(b)&&m.exist[b]===!0&&(a+=1);return a>0?(d3.select(".filters").style("display","block"),d3.select("#filterTitle").html("Filters"),!0):(d3.select(".filters").style("display","none"),d3.select("#filterTitle").html("No filters selected"),!1)},getIndex:function(a,b,c){for(var d=0,e=a.length;e>d;d++)if(a[d][c]===b)return d;return-1},multiplier:function(a){switch(a){case 2:return navMap.checkFilters()?.8:.7;case 3:return navMap.checkFilters()?.2:1;case 4:return navMap.checkFilters()?.48:2;case 5:return navMap.checkFilters()?.68:.6;case 6:return navMap.checkFilters()?.88:.8;case 7:return 1.5;default:return 1}},resizeSvgMap:function(){var a=parseInt(d3.select("#graphics").style("width")),b=d3.select("#svgMap").select("svg");
d3.select("#svgMap").select("svg").select("g").attr("transform",function(){var c;try{c=b.node().getBBox()}catch(d){c={x:b.node().clientLeft,y:b.node().clientTop,width:b.node().clientWidth,height:b.node().clientHeight}}.7*window.innerHeight-70;if(a>c.width+70)return"scale("+window.innerHeight/680+")translate("+(a-c.width)/3+",0)";var e=.7*window.innerHeight-70,f=a/970*500,g=(e-f)/2>0?(e-f)/2:40;return"scale("+a/970+")translate(0,"+g+")"}),d3.select("#svgMap").select("svg").style("height",function(a){if("hidden"===d3.select(".timeScale").style("visibility"))return window.innerHeight-60+"px";var b=$("#time").height()>15?$("#time").height():window.innerHeight/5.6;return window.innerHeight-b-60+"px"}).style("width",function(b){return a-15+"px"})},resize:function(){window.innerWidth<700?(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){return window.innerHeight-55+"px"}),map.invalidateSize(),$("#downloadDataTab").removeClass("active"),$("#downloadData").removeClass("active"),$("#urlTab").addClass("active"),$("#getURL").addClass("active")):parseInt(d3.select("#map").style("height"))>1?(d3.select("#map").style("height",function(a){if("hidden"===d3.select(".timeScale").style("visibility"))return window.innerHeight-70+"px";var b=$("#time").height()>15?$("#time").height():window.innerHeight/5.6;return window.innerHeight-b-54+"px"}),map.invalidateSize()):navMap.resizeSvgMap(),d3.select("#infoContainer").style("bottom",function(){if(window.innerWidth<468)return"91px";var a=parseInt(d3.select("#time").select("svg").style("height"));return a+15+"px"}),d3.select(".prevalence-summary, .prevalence-row").style("height",function(){var a=window.innerHeight-parseInt(d3.select("#time").select("svg").style("height"))-121;return a+"px"}),window.innerHeight>600?d3.select(".filters").style("left",0).style("top","inherit").style("bottom",function(){var a=parseInt(d3.select("#time").select("svg").style("height"));return a+4+"px"}):d3.select(".filters").style("left","49px").style("top",0).style("bottom","inherit"),d3.selectAll(".helpModalTimescaleLabel").style("top",function(){var a=$("#time").height()>15?$("#time").height():window.innerHeight/5.6;return window.innerHeight-a-78+"px"}),$(".universalSearchForm > div > .twitter-typeahead > .tt-dropdown-menu").width($(".universalSearchForm > div > .twitter-typeahead").width()-21)},refreshFilterHandlers:function(){d3.selectAll(".removeFilter").on("click",function(){var a=d3.select(this).node().parentNode;a=d3.select(a);var b=a.attr("id"),c=parseInt(a.attr("data-id"));switch(b){case"selectedInterval":a.style("display","none").html(""),m.exist.selectedInterval=!1,d3.select(".time").style("box-shadow",""),timeScale.unhighlight();for(var d=Object.keys(m[b]),e=0;e<d.length;e++)m[b][d[e]]="";break;case"personFilter":a.style("display","none").html(""),m.exist.personFilter=!1,d3.select(".userFilter").style("box-shadow","");for(var d=Object.keys(m[b]),e=0;e<d.length;e++)m[b][d[e]]="";break;case"taxon":a.remove(),navMap.removeTaxonFilters([c]);break;case"stratFilter":a.style("display","none").html(""),m.exist.stratigraphy=!1;for(var d=Object.keys(m.stratigraphy),e=0;e<d.length;e++)m.stratigraphy[d[e]]=""}paleo_nav.getPrevalence(),"block"===d3.select("#reconstructMap").style("display")?reconstructMap.rotate(m.selectedInterval):navMap.refresh("reset")})},updateFilterList:function(a,b){switch(paleo_nav.getPrevalence(),a){case"selectedInterval":d3.select("#selectedInterval").style("display","block").html(m.selectedInterval.nam+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),d3.select(".time").style("box-shadow","inset 3px 0 0 #ff992c"),navMap.refreshFilterHandlers();break;case"personFilter":d3.select("#personFilter").style("display","block").html(m.personFilter.name+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),d3.select(".userFilter").style("box-shadow","inset 3px 0 0 #ff992c"),navMap.refreshFilterHandlers();break;case"taxon":var c;m.taxa.forEach(function(a,d){a.id===b&&(c=d)}),d3.select(".filters").append("div").attr("id","taxon").attr("class","filter").attr("data-id",b).style("display","block").html(m.taxa[c].name+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),d3.select(".taxa").style("box-shadow","inset 3px 0 0 #ff992c"),navMap.refreshFilterHandlers();break;case"stratigraphy":d3.select("#stratFilter").style("display","block").html(m.stratigraphy.name+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),navMap.refreshFilterHandlers()}window.innerHeight>600?d3.select(".filters").style("left",0).style("top","inherit").style("bottom",function(){var a=parseInt(d3.select("#time").select("svg").style("height"));return a+4+"px"}):d3.select(".filters").style("left","49px").style("top",0).style("bottom","inherit")},filterByTime:function(a){var b=d3.selectAll("rect").filter(function(b){return b.name===a});b=b[0][0].__data__,m.selectedInterval.nam=b.name,m.selectedInterval.mid=b.mid,m.selectedInterval.col=b.color,m.selectedInterval.oid=b.id,m.exist.selectedInterval=!0,navMap.updateFilterList("selectedInterval")},removeTaxonFilters:function(a){d3.selectAll(".filters > .filter").each(function(b){var c=parseInt(d3.select(this).attr("data-id"));a.indexOf(c)>-1&&d3.select(this).remove()}),navMap.filters.taxa=navMap.filters.taxa.filter(function(b){return a.indexOf(b.id)<0?b:void 0}),navMap.filters.taxa.length<1&&(navMap.filters.exist.taxon=!1),d3.select(".taxa").style("box-shadow","")},filterByTaxon:function(a,b,c){if(!a)var a=$("#taxonInput").val();d3.json(paleo_nav.dataUrl+paleo_nav.dataService+"/taxa/list.json?name="+a+"&show=seq",function(c,d){if(c)return alert("Error retrieving from list.json - ",c),paleo_nav.hideLoading();if(d.records.length>0){for(var e={id:parseInt(d.records[0].oid.replace("txn:","")),name:d.records[0].nam,lsq:d.records[0].lsq,rsq:d.records[0].rsq},f=0;f<navMap.filters.taxa.length;f++)if(navMap.filters.taxa[f].id===e.name)return;for(var g=[],f=0;f<navMap.filters.taxa.length;f++)e.lsq>=navMap.filters.taxa[f].lsq&&e.rsq<=navMap.filters.taxa[f].rsq&&g.push(navMap.filters.taxa[f].id),e.lsq<=navMap.filters.taxa[f].lsq&&e.rsq>=navMap.filters.taxa[f].rsq&&g.push(navMap.filters.taxa[f].id);navMap.removeTaxonFilters(g),b||taxaBrowser.goToTaxon(a),navMap.filters.taxa.push(e),navMap.filters.exist.taxon=!0,navMap.updateFilterList("taxon",e.id),"block"===d3.select("#reconstructMap").style("display")?reconstructMap.rotate(navMap.filters.selectedInterval):navMap.refresh("reset")}else alert("No taxa with this name found")})},filterByPerson:function(a,b){a&&(m.exist.personFilter=!0,m.personFilter.id=a.oid?a.oid:a.id,m.personFilter.name=a.name?a.name:a.nam,navMap.updateFilterList("personFilter"),"block"===d3.select("#reconstructMap").style("display")?reconstructMap.rotate(m.selectedInterval):navMap.refresh("reset"))},filterByStratigraphy:function(a){a&&(m.exist.stratigraphy=!0,m.stratigraphy.name=a.nam,m.stratigraphy.rank=a.type?a.type:a.rank,navMap.updateFilterList("stratigraphy"),navMap.refresh("reset"))},download:function(){$("#occs:checked").length>0?navMap.downloadOccs():$("#refs:checked").length>0?navMap.downloadRefs():$("#diver:checked").length>0?navMap.downloadDiversity():navMap.downloadFullDiversity()},downloadRefs:function(){var a=map.getBounds(),b=a._southWest,c=a._northEast,d=paleo_nav.dataUrl+paleo_nav.dataService+"/occs/refs.";d+=$("#tsv:checked").length>0?"txt":$("#csv:checked").length>0?"csv":$("#json:checked").length>0?"json":"ris","block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?d+="?limit=all":(b.lat=b.lat.toFixed(4),b.lng=b.lng.toFixed(4),c.lat=c.lat.toFixed(4),c.lng=c.lng.toFixed(4),d+="?lngmin="+b.lng+"&lngmax="+c.lng+"&latmin="+b.lat+"&latmax="+c.lat+"&limit=all"),d=navMap.parseURL(d),d+="&show=comments,ent,entname,crmod&showsource",window.open(d)},downloadOccs:function(){var a=map.getBounds(),b=a._southWest,c=a._northEast,d=paleo_nav.dataUrl+paleo_nav.dataService+"/occs/list.";if($("#tsv:checked").length>0)d+="txt";else if($("#csv:checked").length>0)d+="csv";else{if(!($("#json:checked").length>0))return alert("RIS format not available for occurrences. Please select a different format.");d+="json"}"block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?d+="?limit=all":(b.lat=b.lat.toFixed(4),b.lng=b.lng.toFixed(4),c.lat=c.lat.toFixed(4),c.lng=c.lng.toFixed(4),d+="?lngmin="+b.lng+"&lngmax="+c.lng+"&latmin="+b.lat+"&latmax="+c.lat+"&limit=all"),d=navMap.parseURL(d),d+="&show=coords,attr,loc,prot,time,strat,stratext,lith,lithext,geo,rem,ent,entname,crmod,paleoloc&showsource",window.open(d)},downloadDiversity:function(){var a=map.getBounds(),b=a._southWest,c=a._northEast,d=paleo_nav.dataUrl+paleo_nav.dataService+"/occs/quickdiv.";if($("#tsv:checked").length>0)d+="txt";else if($("#csv:checked").length>0)d+="csv";else{if(!($("#json:checked").length>0))return alert("RIS format not available for occurrences. Please select a different format.");d+="json"}"block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?d+="?lngmin=-180&lngmax=180&latmin=-90&latmax=90":(b.lat=b.lat.toFixed(4),b.lng=b.lng.toFixed(4),c.lat=c.lat.toFixed(4),c.lng=c.lng.toFixed(4),d+="?lngmin="+b.lng+"&lngmax="+c.lng+"&latmin="+b.lat+"&latmax="+c.lat),d=navMap.parseURL(d),d+="&count="+$('[name="taxonLevel"]').val()+"&reso="+$('[name="timeLevel"]').val(),window.open(d)},downloadFullDiversity:function(){var a=map.getBounds(),b=a._southWest,c=a._northEast,d=paleo_nav.dataUrl+paleo_nav.dataService+"/occs/diversity.";if($("#tsv:checked").length>0)d+="txt";else if($("#csv:checked").length>0)d+="csv";else{if(!($("#json:checked").length>0))return alert("RIS format not available for occurrences. Please select a different format.");d+="json"}"block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?d+="?lngmin=-180&lngmax=180&latmin=-90&latmax=90":(b.lat=b.lat.toFixed(4),b.lng=b.lng.toFixed(4),c.lat=c.lat.toFixed(4),c.lng=c.lng.toFixed(4),d+="?lngmin="+b.lng+"&lngmax="+c.lng+"&latmin="+b.lat+"&latmax="+c.lat),d=navMap.parseURL(d),d+="&count="+$('[name="taxonLevel"]').val()+"&reso="+$('[name="timeLevel"]').val()+"&recent="+$('[name="extant"]').is(":checked"),window.open(d)},getApiUrl:function(){var a=map.getBounds(),b=a._southWest,c=a._northEast,d=paleo_nav.dataUrl+paleo_nav.dataService+"/occs/list.json";return"block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?d+="?limit=all":(b.lat=b.lat.toFixed(4),b.lng=b.lng.toFixed(4),c.lat=c.lat.toFixed(4),c.lng=c.lng.toFixed(4),d+="?lngmin="+b.lng+"&lngmax="+c.lng+"&latmin="+b.lat+"&latmax="+c.lat+"&limit=all"),d=navMap.parseURL(d),d+="&show=coords,attr,loc,prot,time,strat,stratext,lith,lithext,geo,rem,ent,entname,crmod&showsource"},restoreState:function(a){if("object"==typeof a){var b=a;b.zoom&&b.zoom>2&&navMap.goTo(b.center,b.zoom),b.timeScale&&"Phanerozoic"!=b.timeScale&&timeScale.goTo(b.timeScale),b.taxaFilter.length>0&&b.taxaFilter.forEach(function(a){navMap.filterByTaxon(a.name?a.name:a.nam)}),"object"==typeof b.stratFilter&&""!=b.stratFilter.name&&navMap.filterByStratigraphy(b.stratFilter),"object"==typeof b.timeFilter&&""!=b.timeFilter.nam&&navMap.filterByTime(b.timeFilter.nam),b.authFilter.id>0&&navMap.filterByPerson(b.authFilter),"block"===b.reconstruct&&(reconstructMap.rotate(b.currentReconstruction),paleo_nav.toggleReconstructMap(),navMap.checkFilters()),navMap.resize(),window.scrollTo(0,0)}else{var c=window.location,a=c.hash.substr(2);a.length>1&&d3.json(paleo_nav.stateUrl+"/larkin/app-state?id="+a,function(a,b){if(a)return paleo_nav.launch();var c=b[0].data;c.zoom=parseInt(c.zoom),c.center[0]=parseFloat(c.center[0]),c.center[1]=parseFloat(c.center[1]),c.taxaFilter&&c.taxaFilter.length>0&&c.taxaFilter.forEach(function(a){a.id=parseInt(a.id)}),c.timeFilter.mid=parseInt(c.timeFilter.mid),c.timeFilter.oid=parseInt(c.timeFilter.oid),c.currentReconstruction.mid=parseInt(c.currentReconstruction.mid),c.currentReconstruction.id=parseInt(c.currentReconstruction.id),c.authFilter.id=parseInt(c.authFilter.id),c.zoom&&c.zoom>2&&navMap.goTo(c.center,c.zoom),c.taxaFilter&&c.taxaFilter.length>0&&c.taxaFilter.forEach(function(a){navMap.filterByTaxon(a.name)}),"object"==typeof c.stratFilter&&""!=c.stratFilter.name&&navMap.filterByStratigraphy(c.stratFilter),"object"==typeof c.timeFilter&&""!=c.timeFilter.nam&&(navMap.filterByTime(c.timeFilter.nam),navMap.refresh("redraw")),c.authFilter.id>0&&navMap.filterByPerson(c.authFilter),"block"===c.reconstruct&&(reconstructMap.rotate(c.currentReconstruction),paleo_nav.toggleReconstructMap(),navMap.checkFilters()),"Phanerozoic"!=c.timeScale&&timeScale.goTo(c.timeScale),paleo_nav.launch()})}},getUrl:function(){var a=map.getCenter(),b=map.getZoom(),c=d3.select("#reconstructMap").style("display"),d={timeScale:timeScale.currentInterval.name,taxaFilter:[],timeFilter:m.selectedInterval,stratFilter:{name:m.stratigraphy.name,rank:m.stratigraphy.rank},authFilter:m.personFilter,zoom:b,center:[a.lat,a.lng],reconstruct:c,currentReconstruction:reconstructMap.currentReconstruction};return m.taxa.length>0&&m.taxa.forEach(function(a){d.taxaFilter.push(a)}),d},summarize:function(b){b.records.length>0?("col"===b.records[0].typ?navMap.totalCollections=a(b.records.length):navMap.totalCollections=a(d3.sum(b.records,function(a){return a.nco})),navMap.totalOccurrences=a(d3.sum(b.records,function(a){return a.noc}))):(navMap.totalCollections=0,navMap.totalOccurrences=0),navMap.setInfoSummary()},setInfoSummary:function(){d3.select(".info").style("display","block").html("<strong>"+navMap.totalCollections+" total collections</strong><br>"+navMap.totalOccurrences+" total occurrences")},filters:m,totalOccurrences:e}}(),paleo_nav=function(){var a=window.location.origin,b="https://paleobiodb.org",c="https://paleobiodb.org",d="/data1.2";window.location.search.indexOf("local")>-1?(a=window.location.origin+":3000",b=window.location.origin+":3000"):window.location.search.indexOf("test")>-1?a="https://paleobiodb.org":"localhost"===window.location.hostname&&(a="https://paleobiodb.org");var e,f;return d3.text("build/partials/prevalent.html",function(a,b){e=b}),d3.text("build/partials/prevalent_summary.html",function(a,b){f=b}),{init:function(){var e;e=window.innerWidth>1800?60:window.innerWidth>1500?75:window.innerWidth>1e3?95:110,timeScale.init("time",e,function(){navMap.init(function(){navMap.resizeSvgMap(),navMap.resize(),navMap.refresh("reset")}),reconstructMap.init(),taxaBrowser.init()});var f=$(".zoom-in").hammer();f.on("tap",function(a){a.preventDefault(),parseInt(d3.select("#map").style("height"))<1?(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){return.7*window.innerHeight-70+"px"}),map.setView([7,0],3,{animate:!1}),navMap.refresh("reset"),map.invalidateSize()):map.zoomIn()});var g=$(".zoom-out").hammer();g.on("tap",function(a){a.preventDefault(),map.zoomOut()});var h=$(".rotate").hammer();h.on("tap",function(a){a.preventDefault(),reconstructMap.visible?paleo_nav.closeReconstructMap():paleo_nav.toggleReconstructMap()});var i=$(".taxa").hammer();i.on("tap",function(a){a.preventDefault(),a.stopPropagation();var b=d3.select("#taxaBrowser").style("display");"block"==b?(paleo_nav.closeTaxaBrowser(),d3.select(".taxa").style("color","#000")):(paleo_nav.openTaxaBrowser(),d3.select(".taxa").style("color","#ff992c"))});var j=$("#taxaBrowserNavbar").hammer();j.on("tap",function(a){a.preventDefault(),$(".navbar-collapse").collapse("hide");var b=d3.select("#taxaBrowser").style("display");"block"===b?paleo_nav.closeTaxaBrowser():paleo_nav.openTaxaBrowser(),$});var k=$(".taxaBrowserToggle").hammer();k.on("tap",function(a){a.preventDefault(),a.stopPropagation();var b=d3.select("#taxaBrowser").style("display");"block"===b?paleo_nav.closeTaxaBrowser():paleo_nav.openTaxaBrowser()});var l=Mustache.compile('<p>{{nam}}{{#msp}}<small class="misspelling">  missp.</small>{{/msp}}      <small class="taxaRank">{{rank}}</small></p>'),m=$("#taxonInput").typeahead({name:"taxaBrowser",remote:{url:a+d+"/taxa/auto.json?name=%QUERY&limit=10",filter:function(a){return a.records.forEach(function(a){a.rank=taxaBrowser.rankMap(a.rnk)}),a.records}},valueKey:"nam",minLength:3,limit:10,template:l});m.on("typeahead:selected",function(a,b){taxaBrowser.goToTaxon(b.nam)}),$("input#taxonInput").keypress(function(a){if(13===a.which){var b=$("input#taxonInput").data().ttView.dropdownView.getFirstSuggestion();taxaBrowser.goToTaxon(b.datum.nam),document.activeElement.blur(),$("input#taxonInput").blur(),$("input#taxonInput").typeahead("setQuery","")}});var n={member:"Mbr",formation:"Fm",group:"Gp"},o=$("#universalAutocompleteInput").typeahead([{name:"time",prefetch:{url:a+d+"/intervals/list.json?scale=1&order=age.desc&max_ma=4000",filter:function(a){return a.records}},valueKey:"nam",header:'<h4 class="autocompleteTitle">Time Intervals</h4>',limt:5},{name:"contribs",prefetch:{url:a+d+"/people/list.json?name=%",filter:function(a){return a.records}},valueKey:"nam",header:'<h4 class="autocompleteTitle">Authorizers</h4>',limit:5},{name:"taxa",remote:{url:a+d+"/taxa/auto.json?name=%QUERY&limit=10",filter:function(a){return a.records.forEach(function(a){a.rank=taxaBrowser.rankMap(a.rnk)}),a.records}},valueKey:"nam",minLength:3,limit:10,header:'<h4 class="autocompleteTitle">Taxa</h4>',template:l},{name:"strat",minLength:3,limit:10,header:'<h4 class="autocompleteTitle">Stratigraphy</h4>',remote:{url:a+d+"/strata/auto.json?name=%QUERY",filter:function(a){return a.records.forEach(function(a){a.display_name=a.nam+" "+n[a.rnk],a.type=n[a.rnk]}),a.records}},valueKey:"display_name"}]);o.on("typeahead:selected",function(a,b,c){switch($(".navbar-collapse").collapse("hide"),c){case"contribs":navMap.filterByPerson(b),document.activeElement.blur();break;case"time":timeScale.goTo(b.nam),navMap.filterByTime(b.nam),navMap.refresh("reset");break;case"taxa":navMap.filterByTaxon(b.nam);break;case"strat":navMap.filterByStratigraphy(b);break;default:console.log("default")}document.activeElement.blur(),$("#universalAutocompleteInput").blur(),$("#universalAutocompleteInput").typeahead("setQuery","")}),$("#universalAutocompleteInput").on("focus",function(){window.innerWidth<700&&($(".navbar-collapse").css("height",window.innerHeight-50+"px"),$(".navbar-collapse").css("max-height",window.innerHeight-50+"px"),$(".tt-dropdown-menu").css("width",$("#universalAutocompleteInput").width()+"px"))}),$("#universalAutocompleteInput").on("blur",function(){window.scrollTo(0,0),window.innerWidth<700&&($(".navbar-collapse").css("height","auto"),$(".navbar-collapse").css("max-height","340px"))}),$("#universalSearchButton").click(function(a){a.preventDefault()}),$("input#universalAutocompleteInput").keypress(function(a){if(13===a.which){var b=$("input#universalAutocompleteInput").data().ttView.dropdownView.getFirstSuggestion();switch(b.dataset){case"contribs":navMap.filterByPerson(b.datum),document.activeElement.blur();break;case"time":timeScale.goTo(b.datum.nam),navMap.filterByTime(b.datum.nam),navMap.refresh("reset");break;case"taxa":navMap.filterByTaxon(b.datum.nam);break;case"strat":navMap.filterByStratigraphy(b.datum);break;default:console.log("Default")}document.activeElement.blur(),$("#universalAutocompleteInput").blur(),$("#universalAutocompleteInput").typeahead("setQuery",""),$(".navbar-collapse").collapse("hide")}}),d3.select(window).on("resize",function(){timeScale.resize(),navMap.resize(),reconstructMap.resize()}),$("#binModal").on("hide.bs.modal",function(){$("#collectionLoading").hide(),$("#collectionCount").show(),$(".show-more-collections").data("offset",0),$(".show-more-collections").data("shown-collections",0),$(".show-more-collections").data("total-collections",0)}),$("#statsBox").on("show.bs.modal",function(){$(".statsContent").height(window.innerHeight-70),$(".diversityContainer").height(window.innerHeight-380),$("#diversityWait").css("display","block"),d3.select("#diversity").select("svg").remove(),$("#prevalence-container").html("");var a=map.getBounds(),c=a._southWest,e=a._northEast;parseInt(d3.select("#map").style("height"))<1&&(c.lng=-180,e.lng=180,c.lat=-90,e.lat=90);var f=navMap.parseURL(b+d+"/occs/quickdiv.json?lngmin="+c.lng.toFixed(1)+"&lngmax="+e.lng.toFixed(1)+"&latmin="+c.lat.toFixed(1)+"&latmax="+e.lat.toFixed(1)+"&count=genera&reso=stage");$(".diversityDownload").attr("href",f),diversityPlot.plot(f,!1)}),$("#statsBox").on("hide.bs.modal",function(){"undefined"!=typeof diversityPlot.currentRequest&&Object.keys(diversityPlot.currentRequest).length>0&&(diversityPlot.currentRequest.abort(),diversityPlot.currentRequest={})}),$("#advstatsBox").on("show.bs.modal",function(){$(".advstatsContent").height(window.innerHeight-70),$(".advdiversityContainer").height(window.innerHeight-380),$("#diversityWait").css("display","block"),d3.select("#advdiversity").select("svg").remove();var a=map.getBounds(),c=a._southWest,e=a._northEast;parseInt(d3.select("#map").style("height"))<1&&(c.lng=-180,e.lng=180,c.lat=-90,e.lat=90);var f=navMap.parseURL(b+d+"/occs/diversity.json?lngmin="+c.lng.toFixed(1)+"&lngmax="+e.lng.toFixed(1)+"&latmin="+c.lat.toFixed(1)+"&latmax="+e.lat.toFixed(1)+"&count="+$('[name="taxonLevel"]').val()+"&reso="+$('[name="timeLevel"]').val()+"&recent="+$('[name="extant"]').is(":checked"));$(".diversityDownload").attr("href",f),diversityPlot.plot(f,!0)}),$("#advstatsBox").on("hide.bs.modal",function(){"undefined"!=typeof diversityPlot.currentRequest&&Object.keys(diversityPlot.currentRequest).length>0&&(diversityPlot.currentRequest.abort(),diversityPlot.currentRequest={})}),$("#saveBox").on("show.bs.modal",function(){if($("#urlTab").hasClass("active")){var b=$.ajax({url:c+"/larkin/app-state",async:!1,type:"POST",data:{state:navMap.getUrl()},ContentType:"application/x-www-form-urlencoded",dataType:"json"});b.success(function(a){$("#url").val(c+"/navigator/#/"+a.id),setTimeout(function(){$("#url").focus(),$("#url").select()},100)})}var e=map.getBounds(),f=e._southWest,g=e._northEast;parseInt(d3.select("#map").style("height"))<1&&(f.lng=-180,g.lng=180,f.lat=-90,g.lat=90),$("#filterList").append("<li>Map extent - <small>(["+f.lat.toFixed(0)+", "+f.lng.toFixed(0)+"], ["+g.lat.toFixed(0)+", "+g.lng.toFixed(0)+"])</small></li>");var h=0;for(var i in navMap.filters.exist)if(navMap.filters.exist.hasOwnProperty(i)&&1==navMap.filters.exist[i]){switch(i){case"selectedInterval":$("#filterList").append("<li>Interval - "+navMap.filters.selectedInterval.nam+"</li>");break;case"personFilter":$("#filterList").append("<li>Contributor - "+navMap.filters.personFilter.name+"</li>");break;case"taxon":navMap.filters.taxa.forEach(function(a){$("#filterList").append("<li>Taxon - "+a.name+"</li>")})}h+=1}var j=a+d+"/occs/list.json?lngmin="+f.lng+"&lngmax="+g.lng+"&latmin="+f.lat+"&latmax="+g.lat+"&limit=0&count";j=navMap.parseURL(j),d3.json(j,function(a,b){var c=.67*b.records_found;c=1024>c?c.toFixed(0)+"KB":1024e3>c?(c/1024).toFixed(0)+"MB":(c/1024e3).toFixed(0)+"GB",d3.select("#occsLabel").html("Occurrences <small><i>(About "+c+")</i></small>")})}),$("#saveBox").on("hide.bs.modal",function(){$("#filterList").html(""),d3.select("#occsLabel").html("Occurrences "),$("#appUrl").val(""),$("#apiUrl").val(""),d3.select("#downloadCount").style("display","none"),d3.select("#diversity").select("svg").remove()}),$("#getAppUrl").on("click",function(){var a=$.ajax({url:c+"/larkin/app-state",async:!1,type:"POST",data:{state:navMap.getUrl()},ContentType:"application/x-www-form-urlencoded",dataType:"json"});a.success(function(a){$("#appUrl").val(c+"/navigator/#/"+a.id),setTimeout(function(){$("#appUrl").focus(),$("#appUrl").select()},100)})}),$("#getApiUrl").on("click",function(){var a=navMap.getApiUrl();$("#apiUrl").val(a),setTimeout(function(){$("#apiUrl").focus(),$("#apiUrl").select()},100)}),$("#taxaForm").submit(function(){return navMap.filterByTaxon(),!1}),$(".helpModalClose").on("click",function(){$("#helpModal").modal("hide")}),$("#goToApp").on("click",function(){$("#helpModal").modal("hide")}),$("#trilobita").on("click",function(a){a.preventDefault(),paleo_nav.closeReconstructMap();var b={authFilter:{id:"",name:""},center:[30.3539163,113.24707],currentReconstruction:"",reconstruct:"none",taxaFilter:[{id:19100,nam:"Trilobita"}],timeFilter:{nam:"Cambrian",oid:22,mid:513},timeScale:"Cambrian",zoom:5};navMap.restoreState(b),$("#helpModal").modal("hide")}),$("#dinosauria").on("click",function(a){a.preventDefault(),paleo_nav.closeReconstructMap();var b={authFilter:{id:"",name:""},center:[40.5305,-109.5117],currentReconstruction:"",reconstruct:"none",taxaFilter:[{id:19968,nam:"Dinosauria"}],timeFilter:{nam:"Jurassic",oid:15,mid:173},timeScale:"Jurassic",zoom:5};navMap.restoreState(b),$("#helpModal").modal("hide")}),$("#plantae").on("click",function(a){a.preventDefault();var b={authFilter:{id:"",name:""},center:"",currentReconstruction:{nam:"Permian",col:"#F04028",mid:275,oid:17,taxon:"Plantae",person:""},taxaFilter:[],reconstruct:"block",taxaFilter:[{id:151418,nam:"Plantae"}],timeFilter:{nam:"Permian",oid:17,mid:275},timeScale:"Permian",zoom:""};navMap.restoreState(b),$("#helpModal").modal("hide")})},getPrevalence:function(a){$(".prevalence-summary").html(""),"undefined"!=typeof currentPrevRequest&&Object.keys(currentPrevRequest).length>0&&(currentPrevRequest.abort(),currentPrevRequest={});var c=map.getBounds(),g=c._southWest,h=c._northEast;parseInt(d3.select("#map").style("height"))<1&&(g.lng=-180,h.lng=180,g.lat=-90,h.lat=90);var i=navMap.parseURL(b+d+"/occs/prevalence.json?limit=50&lngmin="+g.lng.toFixed(1)+"&lngmax="+h.lng.toFixed(1)+"&latmin="+g.lat.toFixed(1)+"&latmax="+h.lat.toFixed(1));i=i.replace("touched_by","occ_touched_by"),currentPrevRequest=d3.json(i,function(a,b){var c=d3.scale.linear().domain([d3.min(b.records,function(a){return a.noc}),d3.max(b.records,function(a){return a.noc})]).range([40,80]),d=b.records.map(function(a){return a.noc}).reduce(function(a,b){return a+b},0);b.records.forEach(function(a){var b=a.nam.split(" ");a.display_name=b[0]+(b.length>1?"*":""),a.data_url=paleo_nav.dataUrl,a.height=c(a.noc);var e=parseInt(a.noc/d*100);a.percentage=1>e?"< 1":e});var g=b.records.filter(function(a,b){return 11>b?a:void 0}),h=b.records.filter(function(a,b){if(window.innerWidth>700){var c=window.innerHeight-parseInt(d3.select("#time").select("svg").style("height"));if(b<Math.floor(c/80))return a}else if(b<Math.floor(window.innerHeight/80))return a});h.forEach(function(a){a.display_text=a.display_name+(a.display_name.length>17?"":" "+a.percentage+"%")});var i=Mustache.render(f,{records:h});$(".prevalence-summary").html(i);var j=Mustache.render(e,{records:g});$(".prevalence-container").html(j),$(".prevalent-summary-taxon").click(function(a){var b=$(this).data("name").replace(" (other)","").replace(" (unclassified)","").replace("*","");navMap.filterByTaxon(b)})})},prelaunch:function(){var a=window.location,b=a.hash.substr(2);b.length>1?navMap.restoreState():paleo_nav.launch()},launch:function(){d3.select("#graphicRow").style("visibility","visible"),d3.select("#waiting").style("display","none"),navMap.resizeSvgMap(),setTimeout(navMap.resize,500),this.getPrevalence(),localStorage.pbdb||window.innerWidth>700&&($("#helpModal").modal("show"),localStorage.pbdb=!0)},showLoading:function(){d3.select("#loading").style("display","block")},hideLoading:function(){d3.select("#loading").style("display","none")},untoggleTaxa:function(){d3.select(".taxaToggler").style("display","none"),d3.select(".taxa").style("color","")},untoggleUser:function(){d3.select(".userToggler").style("display","none"),d3.select(".userFilter").style("color","")},openTaxaBrowser:function(){d3.select("#graphics").attr("class","col-sm-9"),d3.select("#taxaBrowser").style("display","block"),d3.select("#taxaBrowserToggle").html('<i class="fa fa-angle-double-left" style="margin-right:5px;"></i>Collapse taxa browser'),d3.select(".taxaToggler").style("display","none"),timeScale.resize(),reconstructMap.resize(),navMap.resize()},closeTaxaBrowser:function(){d3.select("#graphics").attr("class","col-sm-12"),d3.select("#taxaBrowser").style("display","none"),d3.select("#taxaBrowserToggle").html('Expand taxa browser<i class="fa fa-angle-double-right" style="margin-left:5px;"></i>'),d3.select(".taxa").style("color","#000"),timeScale.resize(),reconstructMap.resize(),navMap.resize(),navMap.resize()},toggleReconstructMap:function(){if(paleo_nav.untoggleTaxa(),paleo_nav.untoggleUser(),paleo_nav.closeTaxaBrowser(),reconstructMap.visible=!0,d3.select(".rotate").style("box-shadow","inset 3px 0 0 #ff992c").style("color","#ff992c"),parseInt(d3.select("#map").style("height"))>1&&d3.select("#map").style("display","none"),d3.select("#svgMap").style("display","none"),d3.select("#reconstructMap").style("display","block"),reconstructMap.resize(),$(".zoom-in").hammer().off("tap").css("color","#ccc"),$(".zoom-out").hammer().off("tap").css("color","#ccc"),navMap.filters.exist.selectedInterval)reconstructMap.rotate(navMap.filters.selectedInterval);else if(interval.nam===reconstructMap.currentReconstruction.name&&navMap.filters.personFilter.name===reconstructMap.currentReconstruction.person&&navMap.filters.stratigraphy.name===reconstructMap.currentReconstruction.stratigraphy){var a=0;if(navMap.filters.taxa.length===reconstructMap.currentReconstruction.taxa.length&&(navMap.filters.taxa.forEach(function(b){var c=!1;reconstructMap.currentReconstruction.taxa.forEach(function(a){b.name===a.name&&(c=!0)}),c||(a+=1)}),0===a))return}else reconstructMap.currentReconstruction.name.length<1?(alert("Please click a time interval below to build a reconstruction map"),d3.select(".info").html("Click a time interval to reconstruct collections and plates").style("display","block")):(alert("Please click a time interval below to build a reconstruction map"),d3.select(".info").html("Click a time interval to reconstruct collections and plates").style("display","block"))},closeReconstructMap:function(){navMap.refresh("reset"),reconstructMap.visible=!1,d3.select("#reconstructMap").style("display","none"),timeScale.unhighlight(),$(".zoom-in").hammer().on("tap",function(a){a.preventDefault(),parseInt(d3.select("#map").style("height"))<1?(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){return.7*window.innerHeight-70+"px"}),map.setView([7,0],3,{animate:!1}),navMap.refresh("reset"),map.invalidateSize()):map.zoomIn()}).css("color","#000"),$(".zoom-out").hammer().on("tap",function(a){a.preventDefault(),map.zoomOut()}).css("color","#000"),d3.select(".prevalence-row").style("display","block"),paleo_nav.getPrevalence(),d3.select("#selectedInterval").select("button").style("display","block"),d3.select(".rotate").style("box-shadow","").style("color","#000"),d3.select(".time").style("color","#000"),parseInt(d3.select("#map").style("height"))<1?d3.select("#svgMap").style("display","block"):d3.select("#map").style("display","block"),navMap.resize(),map.invalidateSize()},dataUrl:a,testUrl:b,stateUrl:c,dataService:d}}();$(document).ready(function(){paleo_nav.init()}),d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},d3.selection.prototype.dblTap=function(a){var b=0;return this.each(function(){d3.select(this).on("touchstart",function(c){return d3.event.timeStamp-b<2e3?a(c):void(b=d3.event.timeStamp)})})};var timeScale=function(){function clickcancel(){function a(a){function c(a,b){return Math.sqrt(Math.pow(a[0]-b[0],2),Math.pow(a[1]-b[1],2))}var d,e,f=5,g=null;a.on("mousedown",function(a){d=d3.mouse(document.body),e=+new Date}),a.on("mouseup",function(a){c(d,d3.mouse(document.body))>f||(g?(window.clearTimeout(g),g=null,b.dblclick(d3.event)):g=window.setTimeout(function(a){return function(){b.click(a),
g=null}}(d3.event),300))})}var b=d3.dispatch("click","dblclick");return d3.rebind(a,b,"on")}function init(a,b,c){var d=960,e=d3.scale.linear().range([0,d-5]),f=d3.scale.linear().range([0,b]),g=.01,h=d3.behavior.drag().origin(function(){d3.select(".timeScale g");return{x:-g,y:0}}).on("dragstart",function(){dragStart=[d3.event.sourceEvent.pageX,d3.event.sourceEvent.pageY],transformStart=d3.transform(d3.select(".timeScale").select("g").attr("transform")).translate,d3.event.sourceEvent.stopPropagation()}).on("drag",function(){var a=[d3.event.sourceEvent.pageX,d3.event.sourceEvent.pageY];g=dragStart[0]-a[0],d3.select(".timeScale").select("g").attr("transform",function(){return"translate("+[parseInt(transformStart[0]+-g),0]+")scale("+parseInt(d3.select(".timeScale").style("width"))/961+")"})});d3.select("#"+a).attr("class","timeScale");var i=d3.select("#"+a).append("svg:svg").attr("width",d).attr("height",b).append("g"),j=i.append("g").attr("id","tickBar").attr("transform","translate(0,"+(b+15)+")");d3.json(paleo_nav.dataUrl+paleo_nav.dataService+"/intervals/list.json?scale=1&order=age.desc&max_ma=4000",function(a,d){for(var g=0;g<d.records.length;g++){var k={id:d.records[g].oid.replace("int:",""),pid:d.records[g].pid?d.records[g].pid.replace("int:",""):0,level:d.records[g].lvl,color:d.records[g].col,name:d.records[g].nam,abbr:d.records[g].abr||d.records[g].nam.charAt(0),early_age:d.records[g].eag,late_age:d.records[g].lag,mid:parseInt((d.records[g].eag+d.records[g].lag)/2),total:d.records[g].eag-d.records[g].lag,children:[]};interval_hash[k.id]=k,interval_hash[k.pid].children.push(k)}var l=d3.layout.partition().sort(function(a){d3.ascending(a)}).value(function(a){return a.total}),m=clickcancel(),n=i.append("g").attr("id","rectGroup");n.selectAll("rect").data(l.nodes(data)).enter().append("svg:rect").attr("x",function(a){return e(a.x)}).attr("y",function(a){return f(a.y)}).attr("width",function(a){return e(a.dx)}).attr("height",function(a){return f(a.dy)}).attr("fill",function(a){return a.color||"#000000"}).attr("id",function(a){return"t"+a.id}).style("opacity",.83).call(h).call(m).dblTap(function(a){setTimeout(goTo(a),500)}).append("svg:title").text(function(a){return a.name}),m.on("dblclick",function(a){goTo(a.target.__data__)}),m.on("click",function(a){mapFilter(a.target.__data__)});var o=j.selectAll("rect").data(l.nodes(data)),p=o.enter().append("g").attr("class",function(a){return"tickGroup s"+("undefined"==typeof a.level?0:a.level)}).attr("transform",function(a){return"translate("+e(a.x)+", -20)"});p.append("line").attr("x1",0).attr("y1",7.5).attr("x2",0).attr("y2",12).style("stroke-width","0.05em"),p.append("text").attr("x",0).attr("y",function(){return 1.05*(b/6*.55+12)}).style("text-anchor",function(a){return.0117===a.early_age?"end":"middle"}).style("font-size",function(){return b/6*.55}).style("fill","#777").text(function(a){return a.early_age});var q=j.append("g").data([{x:1,y:0}]).attr("class","tickGroup s1 s2 s3 s4 s5").attr("transform","translate(955, -20)");q.append("line").attr("x1",0).attr("y1",7.5).attr("x2",0).attr("y2",12).style("stroke-width","0.05em"),q.append("text").attr("x",0).attr("y",function(){return 1.05*(b/6*.55+12)}).attr("id","now").style("text-anchor","end").style("font-size",function(){return b/6*.55}).style("fill","#777").text("0");var r=i.append("g").attr("id","textGroup"),s={0:.61,1:.89,2:.72,3:.61,4:.55,5:.55},t=clickcancel();r.selectAll("fullName").data(l.nodes(data)).enter().append("svg:text").text(function(a){return a.name}).attr("x",1).attr("y",function(a){return f(a.y)+.127*b}).attr("width",function(){return this.getComputedTextLength()}).attr("height",function(a){return f(a.dy)}).attr("class",function(a){return"fullName level"+("undefined"==typeof a.level?0:a.level)}).attr("id",function(a){return"l"+a.id}).attr("x",function(a){return labelX(a)}).style("font-size",function(a){return"undefined"==typeof a.level?b/6*s[0]+"px":b/6*s[a.level]+"px"}).call(h).call(t).dblTap(function(a){setTimeout(goTo(a),500)}).append("svg:title").text(function(a){return a.name}),t.on("dblclick",function(a){goTo(a.target.__data__)}),t.on("click",function(a){mapFilter(a.target.__data__)});var u=clickcancel();r.selectAll("abbrevs").data(l.nodes(data)).enter().append("svg:text").attr("x",1).attr("y",function(a){return f(a.y)+.127*b}).attr("width",30).attr("height",function(a){return f(a.dy)}).text(function(a){return a.abbr||a.name.charAt(0)}).attr("class",function(a){return"abbr level"+("undefined"==typeof a.level?0:a.level)}).attr("id",function(a){return"a"+a.id}).attr("x",function(a){return labelAbbrX(a)}).style("font-size",function(a){return"undefined"==typeof a.level?b/6*s[0]+"px":b/6*s[a.level]+"px"}).call(u).dblTap(function(a){setTimeout(goTo(a),500)}).append("svg:title").text(function(a){return a.name}),u.on("dblclick",function(a){goTo(a.target.__data__)}),u.on("click",function(a){mapFilter(a.target.__data__)}),c(),goTo(interval_hash[0]),d3.select(".abbr.levelundefined").remove(),goTo(interval_hash[751])}),resize()}function labelLevels(d){if(d3.select("#l"+d.id).attr("x",430),"undefined"!=typeof d.parent){for(var depth=d.depth,loc="d.parent",i=0;depth>i;i++){var parent=eval(loc).name;d3.selectAll(".abbr").filter(function(a){return a.name===parent}).attr("x",430),d3.selectAll(".fullName").filter(function(a){return a.name===parent}).attr("x",430),loc+=".parent"}d3.selectAll(".abbr").filter(function(a){return a.name===parent}).attr("x",430),d3.selectAll(".fullName").filter(function(a){return a.name===parent}).attr("x",430),"hidden"===d3.select("#graphicRow").style("visibility")&&paleo_nav.prelaunch()}}function labelAbbrX(a){var b,c=parseFloat(d3.select("rect#t"+a.id).attr("width")),d=parseFloat(d3.select("rect#t"+a.id).attr("x"));try{b=d3.select("#a"+a.id).node().getComputedTextLength()}catch(e){b=11}return b>c-8&&d3.select("#a"+a.id).style("display","none"),d+(c-b)/2}function labelX(a){var b,c=parseFloat(d3.select("rect#t"+a.id).attr("width")),d=parseFloat(d3.select("rect#t"+a.id).attr("x"));try{b=d3.select("#l"+a.id).node().getComputedTextLength()}catch(e){b=25}return b>c-8?d3.select("#l"+a.id).style("display","none"):d3.select("#a"+a.id).style("display","none"),d+(c-b)/2}function labelY(a){var b=parseFloat(d3.select("rect#t"+a.id).attr("height")),c=parseFloat(d3.select("rect#t"+a.id).attr("y")),d=d3.select("#l"+a.id).node().getBBox().height;parseInt(d3.select(".timeScale").style("width"))/961;return.8*c+(b-d)/2+8}function labelAbbrY(a){var b=parseFloat(d3.select("rect#t"+a.id).attr("height")),c=parseFloat(d3.select("rect#t"+a.id).attr("y")),d=d3.select("#l"+a.id).node().getBBox().height;parseInt(d3.select(".timeScale").style("width"))/961;return.8*c+(b-d)/2}function mapFilter(a){if(a.id!==navMap.filters.selectedInterval.oid)if(highlight(a.name),navMap.filters.selectedInterval.nam=a.name,navMap.filters.selectedInterval.mid=a.mid,navMap.filters.selectedInterval.col=a.color,navMap.filters.selectedInterval.oid=a.id,navMap.filters.exist.selectedInterval=!0,navMap.updateFilterList("selectedInterval"),reconstructMap.visible){var b=parseInt((a.early_age+a.late_age)/2);if(a.depth<3)return alert("Please select a period or finer interval");if(b>550)return alert("Please select an interval younger than 600 MA");navMap.refresh("reset"),reconstructMap.rotate(a)}else navMap.refresh("reset")}function goTo(a,b){if("string"==typeof a){var a=d3.selectAll("rect").filter(function(b){return b.name===a});a=a[0][0].__data__}else if(a.children){if(a.children.length<1)var a=a.parent}else var a=a;timeScale.currentInterval=a;var c="undefined"!=a.depth?parseInt(a.depth)+1:1;d3.selectAll(".scale").style("display","none"),d3.selectAll(".tickGroup").style("display","none"),d3.selectAll(".s"+c).style("display","block"),d3.select(".timeScale g").attr("transform",function(){return"scale("+parseInt(d3.select(".timeScale").style("width"))/961+")"});var d=0,e=d3.scale.linear().range([5,955]);e.domain([a.x,a.x+a.dx]),d3.selectAll(".fullName").style("fill","rgba(0,0,0,0)").style("display","block"),d3.selectAll(".abbr").style("fill","rgba(0,0,0,0)").style("display","block"),d3.selectAll(".tickGroup").transition().duration(750).attr("transform",function(a){return d3.select(this).selectAll("text").style("text-anchor","middle"),5==e(a.x)?d3.select(this).select("text").style("text-anchor","start"):955==e(a.x)&&d3.select(this).select("text").style("text-anchor","end"),"translate("+e(a.x)+", -20)"}),d3.selectAll("rect").transition().duration(750).each(function(){++d}).attr("x",function(a){return e(a.x)}).attr("width",function(a){return e(a.x+a.dx)-e(a.x)}).each("end",function(){--d||labelTrans(a)})}function labelTrans(a){var b=0,c=d3.scale.linear().range([0,955]),d=d3.scale.linear().range([0,120]);c.domain([a.x,a.x+a.dx]),d3.selectAll(".fullName").transition().duration(10).each(function(){++b}).attr("x",function(a){return labelX(a)}).attr("height",function(a){return d(a.y+a.dy)-d(a.y)}).each("end",function(){--b||labelLevels(a)}),d3.selectAll(".abbr").transition().duration(300).each(function(){++b}).attr("x",function(a){return labelAbbrX(a)}).attr("height",function(a){return d(a.y+a.dy)-d(a.y)}).each("end",function(){--b?(d3.selectAll(".fullName").style("fill","#333"),d3.selectAll(".abbr").style("fill","#333")):(labelLevels(a),d3.select("#l0").style("fill","#fff"))}),resize()}function highlight(a){if(unhighlight(),a.cxi){var b=a.cxi;d3.selectAll("rect#t"+a.cxi).style("stroke","#000").moveToFront(),d3.selectAll("#l"+a.cxi).moveToFront()}else if("string"==typeof a){var b=d3.selectAll("rect").filter(function(b){return b.name===a}).attr("id");b=b.replace("t","")}else{var b=d3.select(a).attr("id");b=b.replace("p","")}d3.selectAll("rect#t"+b).style("stroke","#000").moveToFront(),d3.selectAll("#l"+b).moveToFront(),d3.selectAll(".abbr").moveToFront()}function unhighlight(a){d3.selectAll("rect").style("stroke","#fff")}function resize(){d3.select(".timeScale g").attr("transform",function(){var a=parseInt(d3.select("#graphics").style("width"));return"scale("+a/961+")"});var a,b=d3.select(".timeScale").select("svg");try{a=b.node().getBBox()}catch(c){a={x:b.node().clientLeft,y:b.node().clientTop,width:b.node().clientWidth,height:b.node().clientHeight}}d3.select(".timeScale svg").style("width",function(){return parseInt(d3.select("#graphics").style("width"))-1+"px"}),d3.select(".timeScale svg").style("height",function(){return a.height+5+"px"})}var data={id:0,color:"#000000",name:"Geologic Time",children:[]},interval_hash={0:data},currentInterval,dragStart,transformStart;return{init:init,goTo:goTo,highlight:highlight,unhighlight:unhighlight,resize:resize,interval_hash:interval_hash,currentInterval:currentInterval}}(),reconstructMap=function(){var a,b=!1,c={name:"",taxa:[],person:""},d=500,e=960,f=d3.geo.hammer().scale(165).translate([e/2,d/2]).rotate([1e-6,0]).precision(.3),g=d3.geo.path().projection(f);return{init:function(){var a=d3.select("#reconstructMap").append("svg").attr("height",d).attr("width",e).append("g").attr("id","reconstructGroup");a.append("defs").append("path").datum({type:"Sphere"}).attr("id","sphere").attr("d",g),a.append("use").attr("class","stroke").attr("xlink:href","#sphere"),a.append("use").attr("class","fill").attr("xlink:href","#sphere"),$("#mapSwitch").on("click",function(a){a.preventDefault(),paleo_nav.closeReconstructMap()}),d3.json("build/js/plates/Holocene.json",function(a,b){var c=d3.select("#reconstructGroup").append("g").attr("id","reconstructContent");c.selectAll(".plateLines").data(topojson.feature(b,b.objects.Holocene).features).enter().append("path").attr("class","plates").attr("d",g),d3.json("build/js/coastlines/Holocene.json",function(a,b){c.selectAll(".coastlines").data(topojson.feature(b,b.objects.Holocene).features).enter().append("path").attr("class","coastlines").attr("d",g)})})},rotate:function(c){var d=c.nam?c.nam:c.name;if(d===reconstructMap.currentReconstruction.name&&navMap.filters.personFilter.name===reconstructMap.currentReconstruction.person&&navMap.filters.stratigraphy.name===reconstructMap.currentReconstruction.stratigraphy){var e=0;if(navMap.filters.taxa.length===reconstructMap.currentReconstruction.taxa.length&&(navMap.filters.taxa.forEach(function(a){var b=!1;reconstructMap.currentReconstruction.taxa.forEach(function(c){a.name===c.name&&(b=!0)}),b||(e+=1)}),0===e))return void d3.select("#selectedInterval").select("button").style("display","none")}b=!0,reconstructMap.reset(),paleo_nav.showLoading(),d3.select("#interval").text(d),d3.select("#rotationInterval").html(d),d3.select("#age").text("("+c.mid+" Ma)"),d3.select("#rotationYear").html(c.mid+" Ma"),c.mid<201?d3.select("#rotationReference").html("<p>Seton, M., R.D. Müller, S. Zahirovic, C. Gaina, T.H. Torsvik, G. Shephard, A. Talsma, M. Gurnis, M. Turner, S. Maus, M. Chandler. 2012. Global continental and ocean basin reconstructions since 200 Ma. <i>Earth-Science Reviews </i>113:212-270.</p>"):d3.select("#rotationReference").html("<p>Wright, N. S. Zahirovic, R.D. Müller, M. Seton. 2013. Towards community-driven paleogeographic reconstructions: intergrating open-access paleogeographic and paleobiology data with plate tectonics. <i>Biogeosciences </i>10:1529-1541.</p>"),d3.select("#selectedInterval").select("button").style("display","none");var f=d3.select("#reconstructGroup").append("g").attr("id","reconstructContent"),h=d.split(" ").join("_");d3.json("build/js/collections/"+h+".json",function(b,e){d3.json("build/js/plates/"+h+".json",function(b,i){f.selectAll(".plateLines").data(topojson.feature(i,i.objects[h]).features).enter().append("path").attr("class","plates").attr("d",g),timeScale.highlight(d),d3.json("build/js/coastlines/"+h+".json",function(a,b){f.selectAll(".coastlines").data(topojson.feature(b,b.objects[h]).features).enter().append("path").attr("class","coastlines").attr("d",g)}),parseInt(d3.select("#map").style("height"))>1&&d3.select("#map").style("display","none"),d3.select("#svgMap").style("display","none"),d3.select("#reconstructMap").style("display","block"),reconstructMap.resize(),d3.select(".info").html("").style("display","none"),d3.json("build/js/rotatedIntervals/"+h+".json",function(b,d){var f=Object.keys(d.objects),g=f[0];if(a=topojson.feature(d,d.objects[g]),navMap.filters.exist.taxon||navMap.filters.exist.personFilter||navMap.filters.exist.stratigraphy){var h=paleo_nav.dataUrl+paleo_nav.dataService+"/colls/summary.json?lngmin=-180&lngmax=180&latmin=-90&latmax=90&level=3&limit=99999";h=navMap.parseURL(h),d3.json(h,function(b,d){var f=d.records.map(function(a){return a.oid=a.oid.replace("clu:",""),a}),g=[];f.forEach(function(b){a.features.forEach(function(a){b.oid==a.properties.NAME&&g.push(a)})}),g.forEach(function(a){for(var b=0;b<e.records.length;b++)parseInt(a.properties.NAME)==e.records[b].oid&&(a.properties.nco=e.records[b].nco,a.properties.noc=e.records[b].noc,a.properties.oid=e.records[b].oid)}),reconstructMap.addToMap(g,c),navMap.summarize(d)})}else a.features.forEach(function(a){for(var b=0;b<e.records.length;b++)parseInt(a.properties.NAME)==e.records[b].oid&&(a.properties.nco=e.records[b].nco,a.properties.noc=e.records[b].noc,a.properties.oid=e.records[b].oid)}),reconstructMap.addToMap(a.features,c),navMap.summarize(e)})})})},addToMap:function(a,c){var d=d3.select("#reconstructContent"),e=d3.scale.linear().domain([1,4240]).range([4,15]);d.selectAll("circle").data(a).enter().append("circle").attr("class","collection").style("fill",function(){return c.col?c.col:c.color}).attr("r",function(a){return.7*e(a.properties.nco)}).attr("cx",function(a){var b=f(a.geometry.coordinates);return b[0]}).attr("cy",function(a){var b=f(a.geometry.coordinates);return b[1]}).on("mouseover",function(a){d3.select(".info").html("<strong>"+a.properties.nco+" collections</strong><br>"+a.properties.noc+" occurrences").style("display","block")}).on("click",function(a){d3.select(".info").html("<strong>"+a.properties.nco+" collections</strong><br>"+a.properties.noc+" occurrences").style("display","block"),navMap.openBinModal(a)}).on("mouseout",function(a){d3.select(".info").html("").style("display","none")}),b=!1,paleo_nav.hideLoading(),reconstructMap.currentReconstruction={name:c.nam?c.nam:c.name,color:c.col,mid:c.mid,id:c.oid,taxa:[],person:"",stratigraphy:""},navMap.filters.exist.taxon&&navMap.filters.taxa.forEach(function(a){reconstructMap.currentReconstruction.taxa.push({name:a.name})}),navMap.filters.exist.personFilter&&(reconstructMap.currentReconstruction.person=navMap.filters.personFilter.name),navMap.filters.exist.stratigraphy&&(reconstructMap.currentReconstruction.stratigraphy=navMap.filters.stratigraphy.name)},addBBox:function(a){d3.selectAll(".rotatedBBox").remove();var b=map.getBounds(),c=b._southWest,d=b.getSouthEast(),e=b._northEast,f=b.getNorthWest();map.getZoom();c.lng=c.lng<-180?-180:c.lng,c.lat=c.lat<-90?-90:c.lat,e.lng=e.lng>180?180:e.lng,e.lat=e.lat>90?90:e.lat;var h=[{oid:"a",lat:c.lat,lng:c.lng},{oid:"b",lat:f.lat,lng:f.lng},{oid:"c",lat:e.lat,lng:e.lng},{oid:"d",lat:d.lat,lng:d.lng}];h=navMap.buildWKT(h);var i="&time="+a+'&points="'+encodeURI(h)+'"&output=geojson';d3.xhr("http://gplates.gps.caltech.edu:8080/recon_points/").header("Content-type","application/x-www-form-urlencoded").post(i,function(a,b){function c(a,b){return a.properties.NAME<b.properties.NAME?-1:a.properties.NAME>b.properties.NAME?1:0}if(a)return console.log("Gplates error - ",a),alert("GPlates could not complete the request");var d=JSON.parse(b.response),e=d;e.features.sort(c);var f={type:"FeatureCollection",features:[{geometry:{type:"Polygon",coordinates:[[e.features[0].geometry.coordinates,e.features[1].geometry.coordinates,e.features[2].geometry.coordinates,e.features[3].geometry.coordinates,e.features[3].geometry.coordinates]]},type:"Feature",properties:{}}]},h=d3.select("#reconstructContent");h.selectAll(".bbox").data(f.features).enter().append("path").attr("class","rotatedBBox").attr("fill","none").attr("stroke","#ccc").attr("stroke-dasharray","5,5").attr("stroke-width",2).attr("opacity",1).attr("d",g)})},resize:function(){var a=parseInt(d3.select("#graphics").style("width")),b=d3.select("#reconstructMap").select("svg");d3.select("#reconstructGroup").attr("transform",function(){var c;try{c=b.node().getBBox()}catch(d){c={x:b.node().clientLeft,y:b.node().clientTop,width:b.node().clientWidth,height:b.node().clientHeight}}.7*window.innerHeight-70;if(a>c.width+50)return"scale("+window.innerHeight/800+")translate("+(a-c.width)/2+",0)";var e=.7*window.innerHeight-70,f=a/970*500,g=(e-f)/2>0?(e-f)/2:0;return"scale("+a/970+")translate(0,"+g+")"}),d3.select("#reconstructMap").select("svg").style("height",function(a){if("hidden"===d3.select(".timeScale").style("visibility"))return window.innerHeight-70+"px";var b=$("#time").height()>15?$("#time").height():window.innerHeight/5.6;return window.innerHeight-b-70+"px"}).style("width",function(b){return a-15+"px"}),d3.select("#reconstructMapRefContainer").style("height",function(){return d3.select("#svgMap").style("height")})},reset:function(){d3.select("#reconstructContent").remove(),d3.select("#interval").html(""),d3.select("#age").html("")},currentReconstruction:c,reconstructing:b,visible:!1}}(),taxaBrowser=function(){function a(){$("#taxaSearch").submit(function(){return b(),!1})}function b(a){if(!a)var a=$("#taxonInput").val();a.length>0&&d3.json(paleo_nav.dataUrl+paleo_nav.dataService+"/taxa/list.json?status=all&name="+a,function(a,b){if(a)alert("Error retrieving from list.json - ",a),paleo_nav.hideLoading();else{if(!(b.records.length>0))return alert("No taxa with this name found");paleo_nav.untoggleTaxa(),d3.select(".taxonTitle").html(b.records[0].nam+" ("+f(b.records[0].rnk)+")<i class='fa fa-plus-square'></i>").attr("id",function(){return b.records[0].nam}),$(".taxonTitle").off("click"),$(".taxonTitle").click(function(a){a.preventDefault(),navMap.filterByTaxon($(".taxonTitle").attr("id"),!0)}),c(b.records[0]),$("#taxonInput").val(""),$("#taxaInput").val("")}})}function c(a){d3.json(paleo_nav.dataUrl+paleo_nav.dataService+"/taxa/single.json?id="+a.oid+"&show=attr,nav,size",function(a,b){return a?(paleo_nav.hideLoading(),alert("Error retrieving from single.json - ",a)):b.records.length>0?(d3.select(".taxonAttr").html(b.records[0].att),d(b.records[0]),e(b.records[0]),void 0):alert("No taxon details found - browser")})}function d(a){var b=[],c=0;a.kgt&&a.kgn&&a.kgn!=a.gid&&(a.kgt.rnk="kingdom",b.push(a.kgt),c=a.kgn),a.phl&&a.phn&&a.phn!=a.gid&&(a.pht.rnk="phylum",b.push(a.pht),c=a.phn),a.cll&&a.cln&&a.cln!=a.gid&&(a.clt.rnk="class",b.push(a.clt),c=a.cln),a.odl&&a.odn&&a.odn!=a.gid&&(a.odt.rnk="order",b.push(a.odt),c=a.odn),a.fml&&a.fmn&&a.fmn!=a.gid&&(a.fmt.rnk="family",b.push(a.fmt),c=a.fmn),a.prt&&a.par!=c&&b.push(a.prt);var d=d3.select("#focalTaxonParents");d.selectAll("tr").remove(),d.selectAll(".rows").data(b).enter().append("tr").append("td").append("a").attr("id",function(a){return a.nam}).attr("href","#").html(function(a){return a.nam+" ("+a.rnk+")"}).attr("class",function(a,c){return c===b.length-1?0===a.ext?"immediateParent extinct parents":"immediateParent parents":0===a.ext?"extinct parents":"parents"}),g(a)}function e(a){i=[],a.chl&&a.rnk>5&&(0===a.chl.length||!a.gns||a.chl.length!=a.gnc)&&i.push({section:"immediate subtaxa",size:a.chl.length,rank:"immediate",offset:0,order:"size.desc",taxa:a.chl}),a.phs&&i.push({section:"phyla",size:a.phc,rank:20,offset:0,max:10,order:"size.desc",taxa:a.phs}),a.cls&&i.push({section:"classes",size:a.clc,rank:17,offset:0,max:10,order:"size.desc",taxa:a.cls}),a.ods&&i.push({section:"orders",size:a.odc,rank:13,offset:0,max:10,order:"size.desc",taxa:a.ods}),a.fms&&i.push({section:"families",size:a.fmc,rank:9,offset:0,max:10,order:"size.desc",taxa:a.fms}),a.gns&&i.push({section:"genera",size:a.gnc,rank:5,offset:0,max:10,order:"size.desc",taxa:a.gns}),a.sgs&&a.sgs.length>0&&i.push({section:"subgenera",size:a.gnc,rank:4,offset:0,max:10,order:"size.desc",taxa:a.sgs}),a.sps&&a.sps.length>0&&i.push({section:"species",size:a.sps.length,rank:3,offset:0,max:10,order:"size.desc",taxa:a.sps}),a.sss&&a.sss.length>0&&i.push({section:"subspecies",size:a.sss.length,rank:2,offset:0,max:10,order:"size.desc",taxa:a.sss});var b=d3.select("#focal_taxon_children");b.selectAll("tr").remove(),b.selectAll(".rows").data(i).enter().append("tr").append("td").append("a").attr("id",function(a){return"t"+a.rank}).attr("class","children").attr("href","#").html(function(a){return a.size+" "+a.section}),g(a)}function f(a){var b={25:"unranked",23:"kingdom",22:"subkingdom",21:"superphylum",20:"phylum",19:"subphylum",18:"superclass",17:"class",16:"subclass",15:"infraclass",14:"superorder",13:"order",12:"suborder",11:"infraorder",10:"superfamily",9:"family",8:"subfamily",7:"tribe",6:"subtribe",5:"genus",4:"subgenus",3:"species",2:"subspecies"};return b[a]}function g(a){$(".parents").off("click"),$(".parents").click(function(a){a.preventDefault(),b(a.target.id)}),$(".childTaxa").off("click"),$(".childTaxa").click(function(a){a.preventDefault(),$("#subtaxaModal").modal("hide"),$("#taxaFilterInput").val(""),b(a.target.id)}),$(".children").off("click"),$(".children").click(function(b){function c(a,b){return a.siz>b.siz?-1:a.siz<b.siz?1:0}if(b.preventDefault(),"immediate"===b.target.id.substr(1)){d3.select("#subtaxa").selectAll("li").remove(),d3.select("#subtaxa").selectAll("br").remove();var d=navMap.getIndex(i,"immediate","rank");i[d].taxa.sort(c),i[d].taxa.forEach(function(a){var b=0===a.ext?"extinct childTaxa":"childTaxa";$("#subtaxa").append("<li><a href='#' class='"+b+"' id='"+a.nam+"'>"+a.nam+" ("+a.siz+") </a></li>")}),$("#subtaxa").append("<br>"),g(a),$("#subtaxaModal").modal()}})}function h(a){var b=$(a).val();b=b.charAt(0).toUpperCase()+b.slice(1),$("#subtaxa > li:not(:contains("+b+"))").hide(),$("#subtaxa > li:contains("+b+")").show()}var i=[];return{init:a,goToTaxon:b,rankMap:f,filter:h}}(),diversityPlot=function(){function a(a,c){"undefined"!=typeof diversityPlot.currentRequest&&Object.keys(diversityPlot.currentRequest).length>0&&(diversityPlot.currentRequest.abort(),diversityPlot.currentRequest={}),diversityPlot.currentRequest=d3.json(a,function(a,d){a?(alert("Error retrieving diversity data"),console.log(a)):b(d.records.map(function(a){return a.total=a.dsb,a}),c)})}function b(a,b){for(var d,e,f=a[a.length-1].eag,g=a[0].lag,h=[{nam:"Neoproterozoic",lag:541,eag:1e3},{nam:"Paleozoic",lag:252.17,eag:541},{nam:"Mesozoic",lag:66,eag:252.17},{nam:"Cenozoic",lag:0,eag:66}],i=0;i<h.length;i++)f>=h[i].lag&&f<=h[i].eag&&(d=h[i].eag),g>=h[i].lag&&g<=h[i].eag&&(e=h[i].lag);$.ajax(paleo_nav.dataUrl+paleo_nav.dataService+"/intervals/list.json?scale=1&order=age.desc&max_ma="+d+"&min_ma="+e).fail(function(a){console.log(a)}).done(function(d){var e=d.records.filter(function(a){return 2===a.lvl||3===a.lvl?(a.totalTime=a.eag-a.lag,a):void 0});c(a,e,b)})}function c(a,b,c){var e=c?"#advdiversity":"#diversity";d3.select("#diversity","#advdiversity").select("svg").remove();var g=b.filter(function(a){return 3===a.lvl?a:void 0}),h=b.filter(function(a){return 2===a.lvl?a:void 0});if(c){a.map(function(a){a.origination=-Math.log(a.xbt/(a.xbt+a.xft))/(a.eag-a.lag)}),a.map(function(a){a.extinction=-Math.log(a.xbt/(a.xbt+a.xbl))/(a.eag-a.lag)}),a.map(function(a){a.rangethroughYes=a.xft+a.xbl+a.xfl+a.xbt,a.rangethroughNo=a.xbl+a.xfl+a.xbt});$('[name="extant"]').is(":checked"),$('[name="extant"]').is(":checked"),$('[name="extant"]').is(":checked"),$('[name="extant"]').is(":checked")}var i=d3.scale.linear().domain([d3.max(h,function(a){return a.eag}),d3.min(h,function(a){return a.lag})-1]).range([0,m-k.left-k.right]);if(c)var j=d3.scale.linear().domain([0,d3.max(a,function(a){return a.rangethroughYes})]).range([n-k.top-k.bottom,0]),o=d3.scale.linear().domain([-1,1]).range([n-k.top-k.bottom,0]);else var j=d3.scale.linear().domain([0,d3.max(a,function(a){return a.total})]).range([n-k.top-k.bottom,0]);var p=d3.svg.axis().scale(i).orient("bottom").ticks(5),q=d3.svg.axis().scale(j).orient("left").ticks(5);if(c)var r=d3.svg.axis().scale(o).orient("right").tickValues([-1,0,1]).tickFormat(Math.abs);var s=d3.scale.linear().domain([0,d3.sum(b,function(a){return 2===a.lvl?a.totalTime:void 0})]).range([0,m-k.left-k.right]),t=d3.scale.linear().domain([d3.max(b,function(a){return a.eag}),d3.min(b,function(a){return a.lag})]).range([0,m-k.left-k.right]),u=d3.select(e).append("svg").attr("width",m).attr("height",n).attr("id",c?"advdiversityGraph":"diversityGraph").append("g").attr("id",c?"advdiversityGraphGroup":"diversityGraphGroup").attr("transform","translate("+k.left+","+k.top+")").style("font-family","Helvetica,sans-serif").style("fill","#333").style("font-weight","100").style("font-size","0.8em"),v=d3.select(e+"Graph").select("g").append("g").attr("id","timeScale").attr("transform","translate("+l.left+","+(n-k.top-k.bottom+3)+")");v.selectAll(".periods").data(g).enter().append("rect").attr("height","40").attr("width",function(a){return s(a.totalTime)}).attr("x",function(a){return t(a.eag)}).attr("id",function(a){return"r"+a.oid.replace("int:","")}).style("fill",function(a){return a.col}).style("opacity",.83).append("svg:title").text(function(a){return a.nam}),v.selectAll(".periodNames").data(g).enter().append("text").attr("x",function(a){return(t(a.eag)+t(a.lag))/2}).attr("y","30").attr("id",function(a){return"l"+a.oid.replace("int:","")}).attr("class","timeLabel abbreviation").style("font-size","2.4em").text(function(a){return a.abr}),v.selectAll(".periodNames").data(g).enter().append("text").attr("x",function(a){return(t(a.eag)+t(a.lag))/2}).attr("y","30").attr("class","timeLabel dFullName").style("font-size","2.4em").attr("id",function(a){return"l"+a.oid.replace("int:","")}).text(function(a){return a.nam}),v.selectAll(".eras").data(h).enter().append("rect").attr("height","40").attr("width",function(a){return s(a.totalTime)}).attr("x",function(a){return t(a.eag)}).attr("y","40").attr("id",function(a){return"r"+a.oid.replace("int:","")}).style("fill",function(a){return a.col}).style("opacity",.83).append("svg:title").text(function(a){return a.nam}),v.selectAll(".eraNames").data(h).enter().append("text").attr("x",function(a){return(t(a.eag)+t(a.lag))/2}).attr("y","70").attr("class","timeLabel dFullName").style("font-size","2.4em").attr("id",function(a){return"l"+a.oid.replace("int:","")}).text(function(a){return a.nam}),u.append("g").attr("class","x axis").attr("transform","translate("+l.left+","+(n-k.top-k.bottom+85)+")").style("font-size","3em").style("fill","#777").call(p).select("path").style("display","none");var w=u.append("g").attr("class","y axis").attr("transform","translate("+l.left+",0)").style("fill","none").style("font-size","3em").style("letter-spacing","normal").call(q);if(w.append("text").attr("transform","rotate(-90)").attr("dy","1em").style("fill","#777").style("text-anchor","end").style("font-size","0.8em").style("font-weight",400).text($("[name=taxonLevel]").val()+" sampled in "+$("[name=timeLevel]").val()),w.append("text").attr("transform","rotate(-90)").attr("dy","3em").style("text-anchor","end").style("font-size","0.6em").style("font-weight",300).style("font-style","italics").style("fill","#777").text("(approximate)"),w.selectAll(".tick").style("letter-spacing","8px").style("fill","#777"),c){var x=u.append("g").attr("class","y axis").attr("transform","translate("+(m-20)+",0)").style("fill","none").style("font-size","3em").style("letter-spacing","normal").call(r);x.append("text").attr("transform","rotate(90)translate("+.28*n+",-35)").attr("dy","1em").style("fill","green").style("text-anchor","end").style("font-size","0.6em").style("font-weight",400).text("origination"),x.append("text").attr("transform","rotate(90)translate("+.7*n+",-35)").attr("dy","1em").style("fill","red").style("text-anchor","end").style("font-size","0.6em").style("font-weight",400).text("extinction"),x.append("text").attr("transform","rotate(90)translate("+.65*n+",-80)").attr("dy","1em").style("fill","#777").style("text-anchor","end").style("font-size","0.8em").style("font-weight",400).text("rates per "+$("[name=taxonLevel]").val()+" per Myr"),x.selectAll(".tick").style("letter-spacing","8px").style("fill","#777")}var y=d3.svg.line().interpolate("linear").x(function(a){return t(a.eag)}).y(function(a){return j(a.total)});if(u.append("path").datum(a).attr("class","line diversityLine sampledLine").attr("style","fill: none; stroke: #777; stroke-width: 4px;").attr("d",y).attr("transform","translate("+l.left+",0)"),c){f("sampledLine");var z=d3.svg.line().interpolate("linear").x(function(a){return t(a.eag)}).y(function(a){return j(a.rangethroughYes)});u.append("path").attr("class","line diversityLine rangethroughLineYes").attr("style","fill: none; stroke: black; stroke-width: 4px; stroke-dasharray: 4,2; display:none;").attr("d",z(a)).attr("transform","translate("+l.left+",0)");var A=d3.svg.line().interpolate("linear").x(function(a){return t(a.eag)}).y(function(a){return j(a.rangethroughNo)});u.append("path").attr("class","line diversityLine rangethroughLineNo").attr("style","fill: none; stroke: black; stroke-width: 4px; stroke-dasharray: 4,2; display:none;").attr("d",A(a)).attr("transform","translate("+l.left+",0)"),f("rangethroughLine");var B=d3.svg.line().interpolate("linear").defined(function(a){return!isNaN(a.origination)&isFinite(a.origination)}).x(function(a){return t(a.eag)}).y(function(a){return o(a.origination)});u.append("path").datum(a).attr("class","line diversityLine originationLine").attr("style","fill: none; stroke: green; stroke-width: 2px; display:none;").attr("d",B(a)).attr("transform","translate("+l.left+",0)"),f("originationLine");var C=d3.svg.line().interpolate("linear").defined(function(a){return!isNaN(a.extinction)&isFinite(a.extinction)}).x(function(a){return t(a.eag)}).y(function(a){return o(-a.extinction)});u.append("path").datum(a).attr("class","line diversityLine extinctionLine").attr("style","fill: none; stroke: red; stroke-width: 2px; display:none;").attr("d",C(a)).attr("transform","translate("+l.left+",0)"),
f("extinctionLine")}d(!1,c),$("#diversityWait").css("display","none"),$("#advdiversityWait").css("display","none")}function d(a,b){var c=d3.selectAll(".dFullName");d3.selectAll(".dFullName").style("display","block"),d3.selectAll(".abbreviation").style("display","block");for(var d=0;d<c[0].length;d++){var f,g=d3.select(c[0][d]).data()[0].oid.replace("int:",""),h=parseFloat(d3.select("rect#r"+g).attr("width")),i=parseFloat(d3.select("rect#r"+g).attr("x"));try{f=d3.select(".dFullName#l"+g).node().getComputedTextLength()}catch(j){f=25}if(f>h-8){d3.select(".dFullName#l"+g).style("display","none");var k;try{k=d3.select(".abbreviation#l"+g).node().getComputedTextLength()}catch(j){k=10}k>h-8?d3.select(".abbreviation#l"+g).style("display","none"):d3.select(".abbreviation#l"+g).style("display","block").attr("x",i+(h-k)/2)}else d3.select(".abbreviation#l"+g).style("display","none"),d3.select(".dFullName#l"+g).attr("x",i+(h-f)/2)}a||setTimeout(function(){e(b)},100)}function e(a){var b=a?"adv":"";$("."+b+"statsContent").height("auto");var c=$("."+b+"diversityContainer").height()-50,e=$("."+b+"diversityContainer").width();if(c>e){var f=e/m;f*n>c&&(f=c/n)}else{var f=c/n;f*m>e&&(f=e/m)}a?d3.select("#"+b+"diversityGraphGroup").attr("transform","scale("+f+")translate("+(k.left-80)+","+k.right+")"):d3.select("#"+b+"diversityGraphGroup").attr("transform","scale("+f+")translate("+k.left+","+k.right+")");var g=d3.select("#"+b+"diversityGraphGroup").node().getBBox().width;d3.select("#"+b+"diversityGraph").attr("height",c+k.bottom).attr("width",g*f+k.left+20),d(!0)}function f(a){var b=$("[name="+a+"]").is(":checked");if("rangethroughLine"===a){var c=$('[name="singletons"]').is(":checked"),d=c?["rangethroughLineYes","rangethroughLineNo"]:["rangethroughLineNo","rangethroughLineYes"];$("."+d[0]).css("display",b?"":"none"),$("."+d[1]).css("display","none")}else $("."+a).css("display",b?"":"none")}function g(){var b=$("[name=taxonLevel]").val(),c=$("[name=timeLevel]").val(),d=paleo_nav.dataUrl,e=map.getBounds(),f=e._southWest,g=e._northEast;parseInt(d3.select("#map").style("height"))<1&&(f.lng=-180,g.lng=180,f.lat=-90,g.lat=90),d+=paleo_nav.dataService+"/occs/quickdiv.json?",d=navMap.parseURL(d),d+="&lngmin="+f.lng.toFixed(1)+"&lngmax="+g.lng.toFixed(1)+"&latmin="+f.lat.toFixed(1)+"&latmax="+g.lat.toFixed(1),d+="&count="+b+"&time_reso="+c,a(d)}function h(a){var b=d3.select(a?"#advdiversityGraph":"#diversityGraph").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML,c="data:image/svg+xml;base64,"+btoa(b),d='<img src="'+c+'">';d3.select(a?"#advsvgdataurl":"#svgdataurl").html(d),i(a);var e=document.querySelector("canvas"),f=e.getContext("2d"),g=new Image;g.src=c,g.onload=function(){f.drawImage(g,0,0);var b=e.toDataURL("image/png"),c='<img src="'+b+'">';d3.select(a?"#advpngdataurl":"#pngdataurl").html(c);var d=document.createElement("a");d.download="diversity-curve.png",d.href=b,d.id="downloadLink",document.getElementsByTagName("body")[0].appendChild(d),d.click()}}function i(a){var b=d3.select(a?"#advdiversityGraph":"#diversityGraph"),c=b.attr("height"),d=b.attr("width");d3.select("canvas").attr("height",c).attr("width",d)}var j,k={top:20,right:20,bottom:80,left:80},l={top:0,right:0,bottom:0,left:80},m=960,n=800-k.top-k.bottom;return d3.select(window).on("resize",d),{plot:a,resize:e,currentRequest:j,updateQuickdiv:g,saveImg:h,getCanvasSize:i,toggleLine:f}}();