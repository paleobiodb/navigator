+function(a){"use strict";var b='[data-dismiss="alert"]',c=function(c){a(c).on("click",b,this.close)};c.prototype.close=function(b){function c(){f.trigger("closed.bs.alert").remove()}var d=a(this),e=d.attr("data-target");e||(e=d.attr("href"),e=e&&e.replace(/.*(?=#[^\s]*$)/,""));var f=a(e);b&&b.preventDefault(),f.length||(f=d.hasClass("alert")?d:d.parent()),f.trigger(b=a.Event("close.bs.alert")),b.isDefaultPrevented()||(f.removeClass("in"),a.support.transition&&f.hasClass("fade")?f.one(a.support.transition.end,c).emulateTransitionEnd(150):c())};var d=a.fn.alert;a.fn.alert=function(b){return this.each(function(){var d=a(this),e=d.data("bs.alert");e||d.data("bs.alert",e=new c(this)),"string"==typeof b&&e[b].call(d)})},a.fn.alert.Constructor=c,a.fn.alert.noConflict=function(){return a.fn.alert=d,this},a(document).on("click.bs.alert.data-api",b,c.prototype.close)}(jQuery),+function(a){function b(b){a(d).remove(),a(e).each(function(){var d=c(a(this)),e={relatedTarget:this};d.hasClass("open")&&(d.trigger(b=a.Event("hide.bs.dropdown",e)),b.isDefaultPrevented()||d.removeClass("open").trigger("hidden.bs.dropdown",e))})}function c(b){var c=b.attr("data-target");c||(c=b.attr("href"),c=c&&/#[A-Za-z]/.test(c)&&c.replace(/.*(?=#[^\s]*$)/,""));var d=c&&a(c);return d&&d.length?d:b.parent()}var d=".dropdown-backdrop",e="[data-toggle=dropdown]",f=function(b){a(b).on("click.bs.dropdown",this.toggle)};f.prototype.toggle=function(d){var e=a(this);if(!e.is(".disabled, :disabled")){var f=c(e),g=f.hasClass("open");if(b(),!g){"ontouchstart"in document.documentElement&&!f.closest(".navbar-nav").length&&a('<div class="dropdown-backdrop"/>').insertAfter(a(this)).on("click",b);var h={relatedTarget:this};if(f.trigger(d=a.Event("show.bs.dropdown",h)),d.isDefaultPrevented())return;f.toggleClass("open").trigger("shown.bs.dropdown",h),e.focus()}return!1}},f.prototype.keydown=function(b){if(/(38|40|27)/.test(b.keyCode)){var d=a(this);if(b.preventDefault(),b.stopPropagation(),!d.is(".disabled, :disabled")){var f=c(d),g=f.hasClass("open");if(!g||g&&27==b.keyCode)return 27==b.which&&f.find(e).focus(),d.click();var h=" li:not(.divider):visible a",i=f.find("[role=menu]"+h+", [role=listbox]"+h);if(i.length){var j=i.index(i.filter(":focus"));38==b.keyCode&&j>0&&j--,40==b.keyCode&&j<i.length-1&&j++,~j||(j=0),i.eq(j).focus()}}}};var g=a.fn.dropdown;a.fn.dropdown=function(b){return this.each(function(){var c=a(this),d=c.data("bs.dropdown");d||c.data("bs.dropdown",d=new f(this)),"string"==typeof b&&d[b].call(c)})},a.fn.dropdown.Constructor=f,a.fn.dropdown.noConflict=function(){return a.fn.dropdown=g,this},a(document).on("click.bs.dropdown.data-api",b).on("click.bs.dropdown.data-api",".dropdown form",function(a){a.stopPropagation()}).on("click.bs.dropdown.data-api",e,f.prototype.toggle).on("keydown.bs.dropdown.data-api",e+", [role=menu], [role=listbox]",f.prototype.keydown)}(jQuery),+function(a){"use strict";var b=function(b,c){this.options=c,this.$element=a(b),this.$backdrop=this.isShown=null,this.options.remote&&this.$element.find(".modal-content").load(this.options.remote,a.proxy(function(){this.$element.trigger("loaded.bs.modal")},this))};b.DEFAULTS={backdrop:!0,keyboard:!0,show:!0},b.prototype.toggle=function(a){return this[this.isShown?"hide":"show"](a)},b.prototype.show=function(b){var c=this,d=a.Event("show.bs.modal",{relatedTarget:b});this.$element.trigger(d),this.isShown||d.isDefaultPrevented()||(this.isShown=!0,this.escape(),this.$element.on("click.dismiss.bs.modal",'[data-dismiss="modal"]',a.proxy(this.hide,this)),this.backdrop(function(){var d=a.support.transition&&c.$element.hasClass("fade");c.$element.parent().length||c.$element.appendTo(document.body),c.$element.show().scrollTop(0),d&&c.$element[0].offsetWidth,c.$element.addClass("in").attr("aria-hidden",!1),c.enforceFocus();var e=a.Event("shown.bs.modal",{relatedTarget:b});d?c.$element.find(".modal-dialog").one(a.support.transition.end,function(){c.$element.focus().trigger(e)}).emulateTransitionEnd(300):c.$element.focus().trigger(e)}))},b.prototype.hide=function(b){b&&b.preventDefault(),b=a.Event("hide.bs.modal"),this.$element.trigger(b),this.isShown&&!b.isDefaultPrevented()&&(this.isShown=!1,this.escape(),a(document).off("focusin.bs.modal"),this.$element.removeClass("in").attr("aria-hidden",!0).off("click.dismiss.bs.modal"),a.support.transition&&this.$element.hasClass("fade")?this.$element.one(a.support.transition.end,a.proxy(this.hideModal,this)).emulateTransitionEnd(300):this.hideModal())},b.prototype.enforceFocus=function(){a(document).off("focusin.bs.modal").on("focusin.bs.modal",a.proxy(function(a){this.$element[0]!==a.target&&!this.$element.has(a.target).length&&this.$element.focus()},this))},b.prototype.escape=function(){this.isShown&&this.options.keyboard?this.$element.on("keyup.dismiss.bs.modal",a.proxy(function(a){27==a.which&&this.hide()},this)):this.isShown||this.$element.off("keyup.dismiss.bs.modal")},b.prototype.hideModal=function(){var a=this;this.$element.hide(),this.backdrop(function(){a.removeBackdrop(),a.$element.trigger("hidden.bs.modal")})},b.prototype.removeBackdrop=function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},b.prototype.backdrop=function(b){var c=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var d=a.support.transition&&c;if(this.$backdrop=a('<div class="modal-backdrop '+c+'" />').appendTo(document.body),this.$element.on("click.dismiss.bs.modal",a.proxy(function(a){a.target===a.currentTarget&&("static"==this.options.backdrop?this.$element[0].focus.call(this.$element[0]):this.hide.call(this))},this)),d&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),!b)return;d?this.$backdrop.one(a.support.transition.end,b).emulateTransitionEnd(150):b()}else!this.isShown&&this.$backdrop?(this.$backdrop.removeClass("in"),a.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one(a.support.transition.end,b).emulateTransitionEnd(150):b()):b&&b()};var c=a.fn.modal;a.fn.modal=function(c,d){return this.each(function(){var e=a(this),f=e.data("bs.modal"),g=a.extend({},b.DEFAULTS,e.data(),"object"==typeof c&&c);f||e.data("bs.modal",f=new b(this,g)),"string"==typeof c?f[c](d):g.show&&f.show(d)})},a.fn.modal.Constructor=b,a.fn.modal.noConflict=function(){return a.fn.modal=c,this},a(document).on("click.bs.modal.data-api",'[data-toggle="modal"]',function(b){var c=a(this),d=c.attr("href"),e=a(c.attr("data-target")||d&&d.replace(/.*(?=#[^\s]+$)/,"")),f=e.data("bs.modal")?"toggle":a.extend({remote:!/#/.test(d)&&d},e.data(),c.data());c.is("a")&&b.preventDefault(),e.modal(f,this).one("hide",function(){c.is(":visible")&&c.focus()})}),a(document).on("show.bs.modal",".modal",function(){a(document.body).addClass("modal-open")}).on("hidden.bs.modal",".modal",function(){a(document.body).removeClass("modal-open")})}(jQuery),+function(a){"use strict";var b=function(b){this.element=a(b)};b.prototype.show=function(){var b=this.element,c=b.closest("ul:not(.dropdown-menu)"),d=b.data("target");if(d||(d=b.attr("href"),d=d&&d.replace(/.*(?=#[^\s]*$)/,"")),!b.parent("li").hasClass("active")){var e=c.find(".active:last a")[0],f=a.Event("show.bs.tab",{relatedTarget:e});if(b.trigger(f),!f.isDefaultPrevented()){var g=a(d);this.activate(b.parent("li"),c),this.activate(g,g.parent(),function(){b.trigger({type:"shown.bs.tab",relatedTarget:e})})}}},b.prototype.activate=function(b,c,d){function e(){f.removeClass("active").find("> .dropdown-menu > .active").removeClass("active"),b.addClass("active"),g?(b[0].offsetWidth,b.addClass("in")):b.removeClass("fade"),b.parent(".dropdown-menu")&&b.closest("li.dropdown").addClass("active"),d&&d()}var f=c.find("> .active"),g=d&&a.support.transition&&f.hasClass("fade");g?f.one(a.support.transition.end,e).emulateTransitionEnd(150):e(),f.removeClass("in")};var c=a.fn.tab;a.fn.tab=function(c){return this.each(function(){var d=a(this),e=d.data("bs.tab");e||d.data("bs.tab",e=new b(this)),"string"==typeof c&&e[c]()})},a.fn.tab.Constructor=b,a.fn.tab.noConflict=function(){return a.fn.tab=c,this},a(document).on("click.bs.tab.data-api",'[data-toggle="tab"], [data-toggle="pill"]',function(b){b.preventDefault(),a(this).tab("show")})}(jQuery),+function(a){"use strict";var b=function(c,d){this.$element=a(c),this.options=a.extend({},b.DEFAULTS,d),this.transitioning=null,this.options.parent&&(this.$parent=a(this.options.parent)),this.options.toggle&&this.toggle()};b.DEFAULTS={toggle:!0},b.prototype.dimension=function(){var a=this.$element.hasClass("width");return a?"width":"height"},b.prototype.show=function(){if(!this.transitioning&&!this.$element.hasClass("in")){var b=a.Event("show.bs.collapse");if(this.$element.trigger(b),!b.isDefaultPrevented()){var c=this.$parent&&this.$parent.find("> .panel > .in");if(c&&c.length){var d=c.data("bs.collapse");if(d&&d.transitioning)return;c.collapse("hide"),d||c.data("bs.collapse",null)}var e=this.dimension();this.$element.removeClass("collapse").addClass("collapsing")[e](0),this.transitioning=1;var f=function(){this.$element.removeClass("collapsing").addClass("collapse in")[e]("auto"),this.transitioning=0,this.$element.trigger("shown.bs.collapse")};if(!a.support.transition)return f.call(this);var g=a.camelCase(["scroll",e].join("-"));this.$element.one(a.support.transition.end,a.proxy(f,this)).emulateTransitionEnd(350)[e](this.$element[0][g])}}},b.prototype.hide=function(){if(!this.transitioning&&this.$element.hasClass("in")){var b=a.Event("hide.bs.collapse");if(this.$element.trigger(b),!b.isDefaultPrevented()){var c=this.dimension();this.$element[c](this.$element[c]())[0].offsetHeight,this.$element.addClass("collapsing").removeClass("collapse").removeClass("in"),this.transitioning=1;var d=function(){this.transitioning=0,this.$element.trigger("hidden.bs.collapse").removeClass("collapsing").addClass("collapse")};return a.support.transition?void this.$element[c](0).one(a.support.transition.end,a.proxy(d,this)).emulateTransitionEnd(350):d.call(this)}}},b.prototype.toggle=function(){this[this.$element.hasClass("in")?"hide":"show"]()};var c=a.fn.collapse;a.fn.collapse=function(c){return this.each(function(){var d=a(this),e=d.data("bs.collapse"),f=a.extend({},b.DEFAULTS,d.data(),"object"==typeof c&&c);!e&&f.toggle&&"show"==c&&(c=!c),e||d.data("bs.collapse",e=new b(this,f)),"string"==typeof c&&e[c]()})},a.fn.collapse.Constructor=b,a.fn.collapse.noConflict=function(){return a.fn.collapse=c,this},a(document).on("click.bs.collapse.data-api","[data-toggle=collapse]",function(b){var c,d=a(this),e=d.attr("data-target")||b.preventDefault()||(c=d.attr("href"))&&c.replace(/.*(?=#[^\s]+$)/,""),f=a(e),g=f.data("bs.collapse"),h=g?"toggle":d.data(),i=d.attr("data-parent"),j=i&&a(i);g&&g.transitioning||(j&&j.find('[data-toggle=collapse][data-parent="'+i+'"]').not(d).addClass("collapsed"),d[f.hasClass("in")?"addClass":"removeClass"]("collapsed")),f.collapse(h)})}(jQuery),+function(a){function b(){var a=document.createElement("bootstrap"),b={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(var c in b)if(void 0!==a.style[c])return{end:b[c]};return!1}a.fn.emulateTransitionEnd=function(b){var c=!1,d=this;a(this).one(a.support.transition.end,function(){c=!0});var e=function(){c||a(d).trigger(a.support.transition.end)};return setTimeout(e,b),this},a(function(){a.support.transition=b()})}(jQuery),function(a){var b="0.9.3",c={isMsie:function(){var a=/(msie) ([\w.]+)/i.exec(navigator.userAgent);return a?parseInt(a[2],10):!1},isBlankString:function(a){return!a||/^\s*$/.test(a)},escapeRegExChars:function(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},isString:function(a){return"string"==typeof a},isNumber:function(a){return"number"==typeof a},isArray:a.isArray,isFunction:a.isFunction,isObject:a.isPlainObject,isUndefined:function(a){return"undefined"==typeof a},bind:a.proxy,bindAll:function(b){var c;for(var d in b)a.isFunction(c=b[d])&&(b[d]=a.proxy(c,b))},indexOf:function(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return c;return-1},each:a.each,map:a.map,filter:a.grep,every:function(b,c){var d=!0;return b?(a.each(b,function(a,e){return(d=c.call(null,e,a,b))?void 0:!1}),!!d):d},some:function(b,c){var d=!1;return b?(a.each(b,function(a,e){return(d=c.call(null,e,a,b))?!1:void 0}),!!d):d},mixin:a.extend,getUniqueId:function(){var a=0;return function(){return a++}}(),defer:function(a){setTimeout(a,0)},debounce:function(a,b,c){var d,e;return function(){var f,g,h=this,i=arguments;return f=function(){d=null,c||(e=a.apply(h,i))},g=c&&!d,clearTimeout(d),d=setTimeout(f,b),g&&(e=a.apply(h,i)),e}},throttle:function(a,b){var c,d,e,f,g,h;return g=0,h=function(){g=new Date,e=null,f=a.apply(c,d)},function(){var i=new Date,j=b-(i-g);return c=this,d=arguments,0>=j?(clearTimeout(e),e=null,g=i,f=a.apply(c,d)):e||(e=setTimeout(h,j)),f}},tokenizeQuery:function(b){return a.trim(b).toLowerCase().split(/[\s]+/)},tokenizeText:function(b){return a.trim(b).toLowerCase().split(/[\s\-_]+/)},getProtocol:function(){return location.protocol},noop:function(){}},d=function(){var a=/\s+/;return{on:function(b,c){var d;if(!c)return this;for(this._callbacks=this._callbacks||{},b=b.split(a);d=b.shift();)this._callbacks[d]=this._callbacks[d]||[],this._callbacks[d].push(c);return this},trigger:function(b,c){var d,e;if(!this._callbacks)return this;for(b=b.split(a);d=b.shift();)if(e=this._callbacks[d])for(var f=0;f<e.length;f+=1)e[f].call(this,{type:d,data:c});return this}}}(),e=function(){function b(b){b&&b.el||a.error("EventBus initialized without el"),this.$el=a(b.el)}var d="typeahead:";return c.mixin(b.prototype,{trigger:function(a){var b=[].slice.call(arguments,1);this.$el.trigger(d+a,b)}}),b}(),f=function(){function a(a){this.prefix=["__",a,"__"].join(""),this.ttlKey="__ttl__",this.keyMatcher=new RegExp("^"+this.prefix)}function b(){return(new Date).getTime()}function d(a){return JSON.stringify(c.isUndefined(a)?null:a)}function e(a){return JSON.parse(a)}var f,g;try{f=window.localStorage,f.setItem("~~~","!"),f.removeItem("~~~")}catch(h){f=null}return g=f&&window.JSON?{_prefix:function(a){return this.prefix+a},_ttlKey:function(a){return this._prefix(a)+this.ttlKey},get:function(a){return this.isExpired(a)&&this.remove(a),e(f.getItem(this._prefix(a)))},set:function(a,e,g){return c.isNumber(g)?f.setItem(this._ttlKey(a),d(b()+g)):f.removeItem(this._ttlKey(a)),f.setItem(this._prefix(a),d(e))},remove:function(a){return f.removeItem(this._ttlKey(a)),f.removeItem(this._prefix(a)),this},clear:function(){var a,b,c=[],d=f.length;for(a=0;d>a;a++)(b=f.key(a)).match(this.keyMatcher)&&c.push(b.replace(this.keyMatcher,""));for(a=c.length;a--;)this.remove(c[a]);return this},isExpired:function(a){var d=e(f.getItem(this._ttlKey(a)));return c.isNumber(d)&&b()>d?!0:!1}}:{get:c.noop,set:c.noop,remove:c.noop,clear:c.noop,isExpired:c.noop},c.mixin(a.prototype,g),a}(),g=function(){function a(a){c.bindAll(this),a=a||{},this.sizeLimit=a.sizeLimit||10,this.cache={},this.cachedKeysByAge=[]}return c.mixin(a.prototype,{get:function(a){return this.cache[a]},set:function(a,b){var c;this.cachedKeysByAge.length===this.sizeLimit&&(c=this.cachedKeysByAge.shift(),delete this.cache[c]),this.cache[a]=b,this.cachedKeysByAge.push(a)}}),a}(),h=function(){function b(a){c.bindAll(this),a=c.isString(a)?{url:a}:a,i=i||new g,h=c.isNumber(a.maxParallelRequests)?a.maxParallelRequests:h||6,this.url=a.url,this.wildcard=a.wildcard||"%QUERY",this.filter=a.filter,this.replace=a.replace,this.ajaxSettings={type:"get",cache:a.cache,timeout:a.timeout,dataType:a.dataType||"json",beforeSend:a.beforeSend},this._get=(/^throttle$/i.test(a.rateLimitFn)?c.throttle:c.debounce)(this._get,a.rateLimitWait||300)}function d(){j++}function e(){j--}function f(){return h>j}var h,i,j=0,k={};return c.mixin(b.prototype,{_get:function(a,b){function c(c){var e=d.filter?d.filter(c):c;b&&b(e),i.set(a,c)}var d=this;f()?this._sendRequest(a).done(c):this.onDeckRequestArgs=[].slice.call(arguments,0)},_sendRequest:function(b){function c(){e(),k[b]=null,f.onDeckRequestArgs&&(f._get.apply(f,f.onDeckRequestArgs),f.onDeckRequestArgs=null)}var f=this,g=k[b];return g||(d(),g=k[b]=a.ajax(b,this.ajaxSettings).always(c)),g},get:function(a,b){var d,e,f=this,g=encodeURIComponent(a||"");return b=b||c.noop,d=this.replace?this.replace(this.url,g):this.url.replace(this.wildcard,g),(e=i.get(d))?c.defer(function(){b(f.filter?f.filter(e):e)}):this._get(d,b),!!e}}),b}(),i=function(){function d(b){c.bindAll(this),c.isString(b.template)&&!b.engine&&a.error("no template engine specified"),b.local||b.prefetch||b.remote||a.error("one of local, prefetch, or remote is required"),this.name=b.name||c.getUniqueId(),this.limit=b.limit||5,this.minLength=b.minLength||1,this.header=b.header,this.footer=b.footer,this.valueKey=b.valueKey||"value",this.template=e(b.template,b.engine,this.valueKey),this.local=b.local,this.prefetch=b.prefetch,this.remote=b.remote,this.itemHash={},this.adjacencyList={},this.storage=b.name?new f(b.name):null}function e(a,b,d){var e,f;return c.isFunction(a)?e=a:c.isString(a)?(f=b.compile(a),e=c.bind(f.render,f)):e=function(a){return"<p>"+a[d]+"</p>"},e}var g={thumbprint:"thumbprint",protocol:"protocol",itemHash:"itemHash",adjacencyList:"adjacencyList"};return c.mixin(d.prototype,{_processLocalData:function(a){this._mergeProcessedData(this._processData(a))},_loadPrefetchData:function(d){function e(a){var b=d.filter?d.filter(a):a,e=m._processData(b),f=e.itemHash,h=e.adjacencyList;m.storage&&(m.storage.set(g.itemHash,f,d.ttl),m.storage.set(g.adjacencyList,h,d.ttl),m.storage.set(g.thumbprint,n,d.ttl),m.storage.set(g.protocol,c.getProtocol(),d.ttl)),m._mergeProcessedData(e)}var f,h,i,j,k,l,m=this,n=b+(d.thumbprint||"");return this.storage&&(f=this.storage.get(g.thumbprint),h=this.storage.get(g.protocol),i=this.storage.get(g.itemHash),j=this.storage.get(g.adjacencyList)),k=f!==n||h!==c.getProtocol(),d=c.isString(d)?{url:d}:d,d.ttl=c.isNumber(d.ttl)?d.ttl:864e5,i&&j&&!k?(this._mergeProcessedData({itemHash:i,adjacencyList:j}),l=a.Deferred().resolve()):l=a.getJSON(d.url).done(e),l},_transformDatum:function(a){var b=c.isString(a)?a:a[this.valueKey],d=a.tokens||c.tokenizeText(b),e={value:b,tokens:d};return c.isString(a)?(e.datum={},e.datum[this.valueKey]=a):e.datum=a,e.tokens=c.filter(e.tokens,function(a){return!c.isBlankString(a)}),e.tokens=c.map(e.tokens,function(a){return a.toLowerCase()}),e},_processData:function(a){var b=this,d={},e={};return c.each(a,function(a,f){var g=b._transformDatum(f),h=c.getUniqueId(g.value);d[h]=g,c.each(g.tokens,function(a,b){var d=b.charAt(0),f=e[d]||(e[d]=[h]);!~c.indexOf(f,h)&&f.push(h)})}),{itemHash:d,adjacencyList:e}},_mergeProcessedData:function(a){var b=this;c.mixin(this.itemHash,a.itemHash),c.each(a.adjacencyList,function(a,c){var d=b.adjacencyList[a];b.adjacencyList[a]=d?d.concat(c):c})},_getLocalSuggestions:function(a){var b,d=this,e=[],f=[],g=[];return c.each(a,function(a,b){var d=b.charAt(0);!~c.indexOf(e,d)&&e.push(d)}),c.each(e,function(a,c){var e=d.adjacencyList[c];return e?(f.push(e),void((!b||e.length<b.length)&&(b=e))):!1}),f.length<e.length?[]:(c.each(b,function(b,e){var h,i,j=d.itemHash[e];h=c.every(f,function(a){return~c.indexOf(a,e)}),i=h&&c.every(a,function(a){return c.some(j.tokens,function(b){return 0===b.indexOf(a)})}),i&&g.push(j)}),g)},initialize:function(){var b;return this.local&&this._processLocalData(this.local),this.transport=this.remote?new h(this.remote):null,b=this.prefetch?this._loadPrefetchData(this.prefetch):a.Deferred().resolve(),this.local=this.prefetch=this.remote=null,this.initialize=function(){return b},b},getSuggestions:function(a,b){function d(a){f=f.slice(0),c.each(a,function(a,b){var d,e=g._transformDatum(b);return d=c.some(f,function(a){return e.value===a.value}),!d&&f.push(e),f.length<g.limit}),b&&b(f)}var e,f,g=this,h=!1;a.length<this.minLength||(e=c.tokenizeQuery(a),f=this._getLocalSuggestions(e).slice(0,this.limit),f.length<this.limit&&this.transport&&(h=this.transport.get(a,d)),!h&&b&&b(f))}}),d}(),j=function(){function b(b){var d=this;c.bindAll(this),this.specialKeyCodeMap={9:"tab",27:"esc",37:"left",39:"right",13:"enter",38:"up",40:"down"},this.$hint=a(b.hint),this.$input=a(b.input).on("blur.tt",this._handleBlur).on("focus.tt",this._handleFocus).on("keydown.tt",this._handleSpecialKeyEvent),c.isMsie()?this.$input.on("keydown.tt keypress.tt cut.tt paste.tt",function(a){d.specialKeyCodeMap[a.which||a.keyCode]||c.defer(d._compareQueryToInputValue)}):this.$input.on("input.tt",this._compareQueryToInputValue),this.query=this.$input.val(),this.$overflowHelper=e(this.$input)}function e(b){return a("<span></span>").css({position:"absolute",left:"-9999px",visibility:"hidden",whiteSpace:"nowrap",fontFamily:b.css("font-family"),fontSize:b.css("font-size"),fontStyle:b.css("font-style"),fontVariant:b.css("font-variant"),fontWeight:b.css("font-weight"),wordSpacing:b.css("word-spacing"),letterSpacing:b.css("letter-spacing"),textIndent:b.css("text-indent"),textRendering:b.css("text-rendering"),textTransform:b.css("text-transform")}).insertAfter(b)}function f(a,b){return a=(a||"").replace(/^\s*/g,"").replace(/\s{2,}/g," "),b=(b||"").replace(/^\s*/g,"").replace(/\s{2,}/g," "),a===b}return c.mixin(b.prototype,d,{_handleFocus:function(){this.trigger("focused")},_handleBlur:function(){this.trigger("blured")},_handleSpecialKeyEvent:function(a){var b=this.specialKeyCodeMap[a.which||a.keyCode];b&&this.trigger(b+"Keyed",a)},_compareQueryToInputValue:function(){var a=this.getInputValue(),b=f(this.query,a),c=b?this.query.length!==a.length:!1;c?this.trigger("whitespaceChanged",{value:this.query}):b||this.trigger("queryChanged",{value:this.query=a})},destroy:function(){this.$hint.off(".tt"),this.$input.off(".tt"),this.$hint=this.$input=this.$overflowHelper=null},focus:function(){this.$input.focus()},blur:function(){this.$input.blur()},getQuery:function(){return this.query},setQuery:function(a){this.query=a},getInputValue:function(){return this.$input.val()},setInputValue:function(a,b){this.$input.val(a),!b&&this._compareQueryToInputValue()},getHintValue:function(){return this.$hint.val()},setHintValue:function(a){this.$hint.val(a)},getLanguageDirection:function(){return(this.$input.css("direction")||"ltr").toLowerCase()},isOverflow:function(){return this.$overflowHelper.text(this.getInputValue()),this.$overflowHelper.width()>this.$input.width()},isCursorAtEnd:function(){var a,b=this.$input.val().length,d=this.$input[0].selectionStart;return c.isNumber(d)?d===b:document.selection?(a=document.selection.createRange(),a.moveStart("character",-b),b===a.text.length):!0}}),b}(),k=function(){function b(b){c.bindAll(this),this.isOpen=!1,this.isEmpty=!0,this.isMouseOverDropdown=!1,this.$menu=a(b.menu).on("mouseenter.tt",this._handleMouseenter).on("mouseleave.tt",this._handleMouseleave).on("click.tt",".tt-suggestion",this._handleSelection).on("mouseover.tt",".tt-suggestion",this._handleMouseover)}function e(a){return a.data("suggestion")}var f={suggestionsList:'<span class="tt-suggestions"></span>'},g={suggestionsList:{display:"block"},suggestion:{whiteSpace:"nowrap",cursor:"pointer"},suggestionChild:{whiteSpace:"normal"}};return c.mixin(b.prototype,d,{_handleMouseenter:function(){this.isMouseOverDropdown=!0},_handleMouseleave:function(){this.isMouseOverDropdown=!1},_handleMouseover:function(b){var c=a(b.currentTarget);this._getSuggestions().removeClass("tt-is-under-cursor"),c.addClass("tt-is-under-cursor")},_handleSelection:function(b){var c=a(b.currentTarget);this.trigger("suggestionSelected",e(c))},_show:function(){this.$menu.css("display","block")},_hide:function(){this.$menu.hide()},_moveCursor:function(a){var b,c,d,f;if(this.isVisible()){if(b=this._getSuggestions(),c=b.filter(".tt-is-under-cursor"),c.removeClass("tt-is-under-cursor"),d=b.index(c)+a,d=(d+1)%(b.length+1)-1,-1===d)return void this.trigger("cursorRemoved");-1>d&&(d=b.length-1),f=b.eq(d).addClass("tt-is-under-cursor"),this._ensureVisibility(f),this.trigger("cursorMoved",e(f))}},_getSuggestions:function(){return this.$menu.find(".tt-suggestions > .tt-suggestion")},_ensureVisibility:function(a){var b=this.$menu.height()+parseInt(this.$menu.css("paddingTop"),10)+parseInt(this.$menu.css("paddingBottom"),10),c=this.$menu.scrollTop(),d=a.position().top,e=d+a.outerHeight(!0);0>d?this.$menu.scrollTop(c+d):e>b&&this.$menu.scrollTop(c+(e-b))},destroy:function(){this.$menu.off(".tt"),this.$menu=null},isVisible:function(){return this.isOpen&&!this.isEmpty},closeUnlessMouseIsOverDropdown:function(){this.isMouseOverDropdown||this.close()},close:function(){this.isOpen&&(this.isOpen=!1,this.isMouseOverDropdown=!1,this._hide(),this.$menu.find(".tt-suggestions > .tt-suggestion").removeClass("tt-is-under-cursor"),this.trigger("closed"))},open:function(){this.isOpen||(this.isOpen=!0,!this.isEmpty&&this._show(),this.trigger("opened"))},setLanguageDirection:function(a){var b={left:"0",right:"auto"},c={left:"auto",right:" 0"};"ltr"===a?this.$menu.css(b):this.$menu.css(c)},moveCursorUp:function(){this._moveCursor(-1)},moveCursorDown:function(){this._moveCursor(1)},getSuggestionUnderCursor:function(){var a=this._getSuggestions().filter(".tt-is-under-cursor").first();return a.length>0?e(a):null},getFirstSuggestion:function(){var a=this._getSuggestions().first();return a.length>0?e(a):null},renderSuggestions:function(b,d){var e,h,i,j,k,l="tt-dataset-"+b.name,m='<div class="tt-suggestion">%body</div>',n=this.$menu.find("."+l);0===n.length&&(h=a(f.suggestionsList).css(g.suggestionsList),n=a("<div></div>").addClass(l).append(b.header).append(h).append(b.footer).appendTo(this.$menu)),d.length>0?(this.isEmpty=!1,this.isOpen&&this._show(),i=document.createElement("div"),j=document.createDocumentFragment(),c.each(d,function(c,d){d.dataset=b.name,e=b.template(d.datum),i.innerHTML=m.replace("%body",e),k=a(i.firstChild).css(g.suggestion).data("suggestion",d),k.children().each(function(){a(this).css(g.suggestionChild)}),j.appendChild(k[0])}),n.show().find(".tt-suggestions").html(j)):this.clearSuggestions(b.name),this.trigger("suggestionsRendered")},clearSuggestions:function(a){var b=a?this.$menu.find(".tt-dataset-"+a):this.$menu.find('[class^="tt-dataset-"]'),c=b.find(".tt-suggestions");b.hide(),c.empty(),0===this._getSuggestions().length&&(this.isEmpty=!0,this._hide())}}),b}(),l=function(){function b(a){var b,d,f;c.bindAll(this),this.$node=e(a.input),this.datasets=a.datasets,this.dir=null,this.eventBus=a.eventBus,b=this.$node.find(".tt-dropdown-menu"),d=this.$node.find(".tt-query"),f=this.$node.find(".tt-hint"),this.dropdownView=new k({menu:b}).on("suggestionSelected",this._handleSelection).on("cursorMoved",this._clearHint).on("cursorMoved",this._setInputValueToSuggestionUnderCursor).on("cursorRemoved",this._setInputValueToQuery).on("cursorRemoved",this._updateHint).on("suggestionsRendered",this._updateHint).on("opened",this._updateHint).on("closed",this._clearHint).on("opened closed",this._propagateEvent),this.inputView=new j({input:d,hint:f}).on("focused",this._openDropdown).on("blured",this._closeDropdown).on("blured",this._setInputValueToQuery).on("enterKeyed tabKeyed",this._handleSelection).on("queryChanged",this._clearHint).on("queryChanged",this._clearSuggestions).on("queryChanged",this._getSuggestions).on("whitespaceChanged",this._updateHint).on("queryChanged whitespaceChanged",this._openDropdown).on("queryChanged whitespaceChanged",this._setLanguageDirection).on("escKeyed",this._closeDropdown).on("escKeyed",this._setInputValueToQuery).on("tabKeyed upKeyed downKeyed",this._managePreventDefault).on("upKeyed downKeyed",this._moveDropdownCursor).on("upKeyed downKeyed",this._openDropdown).on("tabKeyed leftKeyed rightKeyed",this._autocomplete)}function e(b){var c=a(g.wrapper),d=a(g.dropdown),e=a(b),f=a(g.hint);c=c.css(h.wrapper),d=d.css(h.dropdown),f.css(h.hint).css({backgroundAttachment:e.css("background-attachment"),backgroundClip:e.css("background-clip"),backgroundColor:e.css("background-color"),backgroundImage:e.css("background-image"),backgroundOrigin:e.css("background-origin"),backgroundPosition:e.css("background-position"),backgroundRepeat:e.css("background-repeat"),backgroundSize:e.css("background-size")}),e.data("ttAttrs",{dir:e.attr("dir"),autocomplete:e.attr("autocomplete"),spellcheck:e.attr("spellcheck"),style:e.attr("style")}),e.addClass("tt-query").attr({autocomplete:"off",spellcheck:!1}).css(h.query);try{!e.attr("dir")&&e.attr("dir","auto")}catch(i){}return e.wrap(c).parent().prepend(f).append(d)}function f(a){var b=a.find(".tt-query");c.each(b.data("ttAttrs"),function(a,d){c.isUndefined(d)?b.removeAttr(a):b.attr(a,d)}),b.detach().removeData("ttAttrs").removeClass("tt-query").insertAfter(a),a.remove()}var g={wrapper:'<span class="twitter-typeahead"></span>',hint:'<input class="tt-hint" type="text" autocomplete="off" spellcheck="off" disabled>',dropdown:'<span class="tt-dropdown-menu"></span>'},h={wrapper:{position:"relative"},hint:{position:"absolute",top:"0",left:"0",borderColor:"transparent",boxShadow:"none"},query:{position:"relative",verticalAlign:"top","border-radius":"4px 0 0 4px","-moz-border-radius":"4px 0 0 4px","-webkit-border-radius":"4px 0 0 4px"},dropdown:{position:"absolute",top:"100%",left:"0",zIndex:"100",display:"none"}};return c.isMsie()&&c.mixin(h.query,{backgroundImage:"url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)"}),c.isMsie()&&c.isMsie()<=7&&(c.mixin(h.wrapper,{display:"inline",zoom:"1"}),c.mixin(h.query,{marginTop:"-1px"})),c.mixin(b.prototype,d,{_managePreventDefault:function(a){var b,c,d=a.data,e=!1;switch(a.type){case"tabKeyed":b=this.inputView.getHintValue(),c=this.inputView.getInputValue(),e=b&&b!==c;break;case"upKeyed":case"downKeyed":e=!d.shiftKey&&!d.ctrlKey&&!d.metaKey}e&&d.preventDefault()},_setLanguageDirection:function(){var a=this.inputView.getLanguageDirection();a!==this.dir&&(this.dir=a,this.$node.css("direction",a),this.dropdownView.setLanguageDirection(a))},_updateHint:function(){var a,b,d,e,f,g=this.dropdownView.getFirstSuggestion(),h=g?g.value:null,i=this.dropdownView.isVisible(),j=this.inputView.isOverflow();h&&i&&!j&&(a=this.inputView.getInputValue(),b=a.replace(/\s{2,}/g," ").replace(/^\s+/g,""),d=c.escapeRegExChars(b),e=new RegExp("^(?:"+d+")(.*$)","i"),f=e.exec(h),this.inputView.setHintValue(a+(f?f[1]:"")))},_clearHint:function(){this.inputView.setHintValue("")},_clearSuggestions:function(){this.dropdownView.clearSuggestions()},_setInputValueToQuery:function(){this.inputView.setInputValue(this.inputView.getQuery())},_setInputValueToSuggestionUnderCursor:function(a){var b=a.data;this.inputView.setInputValue(b.value,!0)},_openDropdown:function(){this.dropdownView.open()},_closeDropdown:function(a){this.dropdownView["blured"===a.type?"closeUnlessMouseIsOverDropdown":"close"]()},_moveDropdownCursor:function(a){var b=a.data;b.shiftKey||b.ctrlKey||b.metaKey||this.dropdownView["upKeyed"===a.type?"moveCursorUp":"moveCursorDown"]()},_handleSelection:function(a){var b="suggestionSelected"===a.type,d=b?a.data:this.dropdownView.getSuggestionUnderCursor();d&&(this.inputView.setInputValue(d.value),b?this.inputView.focus():a.data.preventDefault(),b&&c.isMsie()?c.defer(this.dropdownView.close):this.dropdownView.close(),this.eventBus.trigger("selected",d.datum,d.dataset))},_getSuggestions:function(){var a=this,b=this.inputView.getQuery();c.isBlankString(b)||c.each(this.datasets,function(c,d){d.getSuggestions(b,function(c){b===a.inputView.getQuery()&&a.dropdownView.renderSuggestions(d,c)})})},_autocomplete:function(a){var b,c,d,e,f;("rightKeyed"!==a.type&&"leftKeyed"!==a.type||(b=this.inputView.isCursorAtEnd(),c="ltr"===this.inputView.getLanguageDirection()?"leftKeyed"===a.type:"rightKeyed"===a.type,b&&!c))&&(d=this.inputView.getQuery(),e=this.inputView.getHintValue(),""!==e&&d!==e&&(f=this.dropdownView.getFirstSuggestion(),this.inputView.setInputValue(f.value),this.eventBus.trigger("autocompleted",f.datum,f.dataset)))},_propagateEvent:function(a){this.eventBus.trigger(a.type);
},destroy:function(){this.inputView.destroy(),this.dropdownView.destroy(),f(this.$node),this.$node=null},setQuery:fu
paleo_nav.getPrevalence())}),map.on("zoomend",function(){d3.select(".leaflet-zoom-hide").style("visibility","hidden"),navMap.selectBaseMap(map.getZoom()),d(map.getZoom())}),map._initPathRoot(),d3.select("#map").select("svg").append("g").attr("class","leaflet-zoom-hide").attr("id","binHolder"),d3.select("#map").style("height",0);var j=d3.behavior.zoom().on("zoom",function(){d3.event.sourceEvent.wheelDelta>0?navMap.changeMaps(d3.mouse(this)):"touchmove"===d3.event.sourceEvent.type&&navMap.changeMaps([d3.event.sourceEvent.pageX,d3.event.sourceEvent.pageY])}),k=d3.select("#svgMap").append("svg").attr("width",n).attr("height",o).call(j).on("click",function(){navMap.changeMaps(d3.mouse(this))}).append("g");k.append("defs").append("path").datum({type:"Sphere"}).attr("id","sphere").attr("d",q),k.append("use").attr("class","fill").attr("xlink:href","#sphere"),d3.json("build/js/countries_1e5.json",function(b,c){k.append("path").datum(topojson.feature(c,c.objects.countries)).attr("class","countries").attr("d",q),reconstructMap.resize(),timeScale.resize(),setTimeout(navMap.resize,1e3),a()}),d3.text("build/partials/binModal.html",function(a,b){f=b}),d3.text("build/partials/collectionModal.html",function(a,b){g=b}),d3.text("build/partials/occurrences.html",function(a,b){h=b}),d3.text("build/partials/stackedCollectionModal.html",function(a,b){i=b})},changeMaps:function(a){paleo_nav.getPrevalence();var b=$("#time").height()>15?$("#time").height():window.innerHeight/5.6,c=[window.innerWidth/2,(window.innerHeight-b-70)/2],d=d3.geo.mercator().scale(165).precision(.1).translate(c),e=a,f=d.invert(e);d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){if("hidden"===d3.select(".timeScale").style("visibility"))return window.innerHeight-70+"px";var a=$("#time").height()>15?$("#time").height():window.innerHeight/5.6;return window.innerHeight-a-56+"px"}),map.setView([parseInt(f[1]),parseInt(f[0])],3,{animate:!1});var g=map.getBounds();Math.abs(g._northEast.lng)+Math.abs(g._southWest.lng)>360&&map.setZoom(4,{animate:!1}),navMap.refresh("reset"),map.invalidateSize()},goTo:function(a,b){3>b||(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){return.7*window.innerHeight+"px"}),map._resetView(a,b))},selectBaseMap:function(a){5>a?map.hasLayer(c)&&(map.removeLayer(c),map.addLayer(b)):a>4&&7>a?map.hasLayer(c)&&(map.removeLayer(c),map.addLayer(b)):map.hasLayer(c)?map.removeLayer(b):(map.addLayer(c),map.removeLayer(b))},refresh:function(a){paleo_nav.showLoading(),l-map.getZoom()!=0&&d3.select(".leaflet-zoom-hide").style("visibility","hidden");var b=navMap.checkFilters();if(parseInt(d3.select("#map").style("height"))<1){"undefined"!=typeof d&&Object.keys(d).length>0&&(d.abort(),d={});var c=paleo_nav.dataUrl+"/data1.1/colls/summary.json?lngmin=-180&lngmax=180&latmin=-90&latmax=90&limit=all&show=time";if(b){if(m.exist.selectedInterval!==!0||m.exist.personFilter||m.exist.taxon||m.exist.stratigraphy)c+="&level=2",c=navMap.parseURL(c);else if(c+="&level=3",c=navMap.parseURL(c),"undefined"!=typeof timeScale.interval_hash[m.selectedInterval.oid]){if("undefined"!=typeof timeScale.interval_hash[m.selectedInterval.oid].data)return navMap.refreshHammer(timeScale.interval_hash[m.selectedInterval.oid].data);d=d3.json(c,function(a,b){return a?paleo_nav.hideLoading():(timeScale.interval_hash[m.selectedInterval.oid].data=b,navMap.refreshHammer(b))})}}else c+="&level=1",c=navMap.parseURL(c);return void(d=d3.json(c,function(a,b){return a?paleo_nav.hideLoading():void navMap.refreshHammer(b)}))}var e=map.getBounds(),f=e._southWest,g=e._northEast,h=map.getZoom();if(f.lat=f.lat.toFixed(4),f.lng=f.lng.toFixed(4),g.lat=g.lat.toFixed(4),g.lng=g.lng.toFixed(4),!a)if(k.lat>g.lat&&k.lng>g.lng&&j.lat<f.lat&&j.lng<f.lng){if(3>l&&h>2);else if(5>l&&h>4);else if(!(7>l&&h>6)){if(l===h)return l=h,void paleo_nav.hideLoading();var i=d3.selectAll(".bins");if(h>6){var n=d3.selectAll(".clusters");return l=h,navMap.redrawPoints(i,n)}return l=h,navMap.redrawPoints(i)}}else if(l>2&&7>h&&b&&m.exist.selectedInterval===!0&&!m.exist.personFilter&&!m.exist.taxon&&!m.exist.stratigraphy)if(d3.select("#binHolder").selectAll("circle")[0].length<1);else if(!(7>l&&h>6||l>6&&7>h)){var i=d3.selectAll(".bins");if(h>6){var n=d3.selectAll(".clusters");return l=h,navMap.redrawPoints(i,n)}return l=h,navMap.redrawPoints(i)}if(j=f,k=g,l=h,f.lat=f.lat<-90?-90:f.lat,g.lat=g.lat>90?90:g.lat,"undefined"!=typeof d&&Object.keys(d).length>0&&(d.abort(),d={}),5>h&&b===!1){var c=paleo_nav.dataUrl+"/data1.1/colls/summary.json?lngmin="+f.lng+"&lngmax="+g.lng+"&latmin="+f.lat+"&latmax="+g.lat+"&level=2&limit=all&show=time";d=d3.json(navMap.parseURL(c),function(a,b){return a?paleo_nav.hideLoading():void navMap.drawBins(b,1,h)})}else if(h>4&&7>h||5>h&&b===!0)if(m.exist.selectedInterval!==!0||m.exist.personFilter||m.exist.taxon||m.exist.stratigraphy){var c=paleo_nav.dataUrl+"/data1.1/colls/summary.json?lngmin="+f.lng+"&lngmax="+g.lng+"&latmin="+f.lat+"&latmax="+g.lat+"&level=3&limit=all&show=time";d=d3.json(navMap.parseURL(c),function(a,b){return a?paleo_nav.hideLoading():void navMap.drawBins(b,2,h)})}else{var c=paleo_nav.dataUrl+"/data1.1/colls/summary.json?lngmin=-180&lngmax=180&latmin=-90&latmax=90&limit=all&show=time&level=3";if(c=navMap.parseURL(c),"undefined"!=typeof timeScale.interval_hash[m.selectedInterval.oid]){if("undefined"!=typeof timeScale.interval_hash[m.selectedInterval.oid].data)return navMap.drawBins(timeScale.interval_hash[m.selectedInterval.oid].data,2,h);d=d3.json(c,function(a,b){return a?paleo_nav.hideLoading():(timeScale.interval_hash[m.selectedInterval.oid].data=b,navMap.drawBins(b,2,h))})}}else{var c=paleo_nav.dataUrl+"/data1.1/colls/list.json?lngmin="+f.lng+"&lngmax="+g.lng+"&latmin="+f.lat+"&latmax="+g.lat+"&limit=all&show=ref,time,strat,geo,lith,entname,prot&markrefs";d=d3.json(navMap.parseURL(c),function(a,b){return a?paleo_nav.hideLoading():void navMap.drawCollections(b,3,h)})}},redrawPoints:function(a,b){d3.select(".leaflet-zoom-hide").style("visibility","hidden");var c=map.getZoom();if(5>c)if(navMap.checkFilters())var d=d3.scale.log().domain([1,400]).range([4,30]);else var d=d3.scale.linear().domain([1,3140]).range([4,30]);else if(c>4&&7>c)var d=d3.scale.log().domain([1,400]).range([4,30]);else var d=d3.scale.linear().domain([1,50]).range([12,30]);a.attr("cx",function(a){return map.latLngToLayerPoint([a.lat,a.lng]).x}),a.attr("cy",function(a){return map.latLngToLayerPoint([a.lat,a.lng]).y}),b?(b.attr("cx",function(a){return map.latLngToLayerPoint([a.lat,a.lng]).x}),b.attr("cy",function(a){return map.latLngToLayerPoint([a.lat,a.lng]).y}),b.attr("r",function(a){return d(a.members.length)}),a.attr("r",12)):d3.select("#binHolder").selectAll(".bins")[0].length<30?a.attr("r",8):a.attr("r",function(a){return d(a.nco)*navMap.multiplier(c)<4?4:d(a.nco)*navMap.multiplier(c)}),paleo_nav.hideLoading(),d3.select(".leaflet-zoom-hide").style("visibility","visible")},refreshHammer:function(a){navMap.summarize(a);var b=d3.scale.linear().domain([1,4240]).range([4,15]),c=d3.select("#svgMap").select("svg").select("g"),d=2,e=c.selectAll("circle").data(a.records);e.enter().append("circle").attr("id",function(a){return"p"+a.cxi}).attr("class","binsHammer").on("mouseout",function(){navMap.setInfoSummary(),timeScale.unhighlight()}),e.style("fill",function(a){return timeScale.interval_hash[a.cxi]?timeScale.interval_hash[a.cxi].color:"#000"}).attr("id",function(a){return"p"+a.cxi}).attr("r",function(a){return b(a.nco)*navMap.multiplier(d)}).attr("cx",function(a){var b=p([a.lng,a.lat]);return b[0]}).attr("cy",function(a){var b=p([a.lng,a.lat]);return b[1]}).on("mouseover",function(a){d3.select(".info").html("<strong>"+a.nco+" collections</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(a){navMap.changeMaps(d3.mouse(this))}),e.exit().remove(),reconstructMap.reconstructing||paleo_nav.hideLoading()},drawBins:function(a,b,c){navMap.summarize(a),d3.selectAll(".clusters").remove();var d=d3.select("#binHolder"),e=d.selectAll(".bins").data(a.records);e.attr("id",function(a){return"p"+a.cxi}).style("fill",function(a){return timeScale.interval_hash[a.cxi]?timeScale.interval_hash[a.cxi].color:"#000"}).on("mouseover",function(a){d3.select(".info").html("<strong>"+a.nco+" collections</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(a){2===b?(d3.select(".info").html("<strong>"+a.nco+" collections</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openBinModal(a)):1===b&&map.setView([a.lat,a.lng],5)}),e.enter().append("circle").attr("class","bins").attr("id",function(a){return"p"+a.cxi}).style("fill",function(a){return timeScale.interval_hash[a.cxi]?timeScale.interval_hash[a.cxi].color:"#000"}).on("mouseover",function(a){d3.select(".info").html("<strong>"+a.nco+" collections</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(a){2===b?(d3.select(".info").html("<strong>"+a.nco+" collections</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openBinModal(a)):1===b&&map.setView([a.lat,a.lng],5)}).on("mouseout",function(){navMap.setInfoSummary(),timeScale.unhighlight()}),e.exit().remove(),navMap.redrawPoints(e)},drawCollections:function(a,b,c){navMap.summarize(a);for(var d=d3.select("#binHolder"),e=[],f=0;f<a.records.length;f++)for(var g=0;g<a.records.length;g++)if(a.records[f].lat===a.records[g].lat&&a.records[f].lng===a.records[g].lng&&a.records[f].oid!=a.records[g].oid){for(var h={lat:a.records[f].lat,lng:a.records[f].lng,members:[]},i=0,j=0;j<e.length;j++)h.lat===e[j].lat&&h.lng===e[j].lng&&(i+=1);if(1>i){e.push(h);break}break}for(var k=[],f=0;f<e.length;f++)for(var g=0;g<a.records.length;g++)e[f].lat===a.records[g].lat&&e[f].lng===a.records[g].lng&&(e[f].members.push(a.records[g]),k.push(a.records[g].oid));for(var f=0;f<k.length;f++){var l=navMap.getIndex(a.records,k[f],"oid");a.records.splice(l,1)}e.forEach(function(a){var b=[];a.members.forEach(function(a){b.push(a.noc)}),a.cxi=a.members[0].cxi,a.noc=d3.sum(b),a.nam=a.members.length+" Collections"});var e=d.selectAll(".clusters").data(e);e.attr("id",function(a){return"p"+a.members[0].cxi}).style("fill",function(a){return timeScale.interval_hash[a.cxi].color}).on("mouseover",function(a){d3.select(".info").html("<strong>"+a.nam+"</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(a){d3.select(".info").html("<strong>"+a.nam+"</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openStackedCollectionModal(a)}).on("mouseout",function(a){navMap.setInfoSummary(),timeScale.unhighlight()}),e.enter().append("circle").attr("class","clusters").attr("id",function(a){return"p"+a.members[0].cxi}).style("fill",function(a){return timeScale.interval_hash[a.members[0].cxi]?timeScale.interval_hash[a.members[0].cxi].color:"#000"}).on("mouseover",function(a){d3.select(".info").html("<strong>"+a.members.length+" collections</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("mouseout",function(a){navMap.setInfoSummary(),timeScale.unhighlight()}).on("click",function(a){d3.select(".info").html("<strong>"+a.nam+"</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openStackedCollectionModal(a)}),e.exit().remove();var m=d.selectAll(".bins").data(a.records);m.attr("id",function(a){return"p"+a.cxi}).style("fill",function(a){return timeScale.interval_hash[a.cxi]?timeScale.interval_hash[a.cxi].color:"#000"}).on("mouseover",function(a){d3.select(".info").html("<strong>"+a.nam+"</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(a){d3.select(".info").html("<strong>"+a.nam+"</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openCollectionModal(a)}).on("mouseout",function(a){navMap.setInfoSummary(),timeScale.unhighlight()});m.enter().append("circle").attr("id",function(a){return"p"+a.cxi}).attr("class","bins").style("fill",function(a){return timeScale.interval_hash[a.cxi]?timeScale.interval_hash[a.cxi].color:"#000"}).on("mouseover",function(a){d3.select(".info").html("<strong>"+a.nam+"</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this)}).on("click",function(a){d3.select(".info").html("<strong>"+a.nam+"</strong><br>"+a.noc+" occurrences").style("display","block"),timeScale.highlight(this),navMap.openCollectionModal(a)}).on("mouseout",function(a){navMap.setInfoSummary(),timeScale.unhighlight()}),m.exit().remove(),navMap.redrawPoints(m,e)},getOffsetCollections:function(a,b){d3.json(paleo_nav.dataUrl+"/data1.1/colls/list.json?clust_id="+a+"&show=ref,loc,time,strat,geo,lith,entname,prot&markrefs&limit=20&offset="+b,function(a,c){if(a)return paleo_nav.hideLoading();c.records.forEach(function(a){a.intervals=a.oli?a.oei+" - "+a.oli:a.oei,a.strat=a.sfm||a.sgr||a.smb?!0:!1,a.lat=Math.round(1e4*a.lat)/1e4,a.lng=Math.round(1e4*a.lng)/1e4});var d=Mustache.render(i,{members:c.records});$("#collectionCount").html("Showing "+b+" of "+c.records_found+" collections"),$("#collectionAccordion").append(d),$(".show-more-collections").data()["shown-collections"]=b,b>=$(".show-more-collections").data("total-collections")&&$(".show-more-collections").hide(),$(".occurrenceTab").on("show.bs.tab",function(a){var b=a.target.id;b=b.replace("occToggle","");var c=navMap.parseURL(paleo_nav.dataUrl+"/data1.1/occs/list.json?coll_id="+b+"&show=phylo,ident");d3.json(c,function(a,c){if(a)return paleo_nav.hideLoading();if(c.records.length>0){var d=navMap.buildTaxonHierarchy(c),e=Mustache.render(h,d);$("#occurrences"+b).html(e),$(".filterByOccurrence").click(function(a){a.preventDefault(),navMap.filterByTaxon($(this).attr("data-name")),$("#collectionModal").modal("hide")})}else{var e=Mustache.render(h,{error:"No occurrences found for this collection"});$("#occurrences"+b).html(e)}})}),$("#collectionLoading").hide()})},openBinModal:function(a,b,c,d){$("#loading").show();var e=a.properties?a.properties.oid:a.oid,f=paleo_nav.dataUrl+"/data1.1/colls/list.json?clust_id="+e;f=navMap.parseURL(f),f+="&show=ref,loc,time,strat,geo,lith,entname,prot&markrefs&limit=20&count",d3.json(f,function(a,b){if(a)return paleo_nav.hideLoading();b.records.forEach(function(a){a.intervals=a.oli?a.oei+" - "+a.oli:a.oei,a.strat=a.sfm||a.sgr||a.smb?!0:!1,a.lat=Math.round(1e4*a.lat)/1e4,a.lng=Math.round(1e4*a.lng)/1e4});var c=Mustache.render(i,{members:b.records});d3.select("#collectionCount").html("Showing "+b.records.length+" of "+b.records_found+" collections"),d3.select("#collectionAccordion").html(c),$(".show-more-collections").data("total-collections",b.records_found).data("shown-collections",b.records_returned),$(".collectionCollapse").on("show.bs.collapse",function(a){var b=a.target.id;b=b.replace("collapse",""),d3.json(paleo_nav.dataUrl+"/data1.1/colls/single.json?id="+b+"&show=ref,time,strat,geo,lith,entname,prot&markrefs",function(a,c){return a?paleo_nav.hideLoading():void $("#ref"+b).html(c.records[0].ref)})}),$(".occurrenceTab").on("show.bs.tab",function(a){var b=a.target.id;b=b.replace("occToggle","");var c=navMap.parseURL(paleo_nav.dataUrl+"/data1.1/occs/list.json?coll_id="+b+"&show=phylo,ident");d3.json(c,function(a,c){if(a)return paleo_nav.hideLoading();if(c.records.length>0){var d=navMap.buildTaxonHierarchy(c),e=Mustache.render(h,d);$("#occurrences"+b).html(e),$(".filterByOccurrence").click(function(a){a.preventDefault(),navMap.filterByTaxon($(this).attr("data-name")),$("#collectionModal").modal("hide")})}else{var e=Mustache.render(h,{error:"No occurrences found for this collection"});$("#occurrences"+b).html(e)}})}),b.records_found<=b.records_returned?($(".show-more-collections").hide(),$("#collectionCount").hide()):$(".show-more-collections").show().off("click").on("click",function(){$("#collectionLoading").show(),$(".show-more-collections").data().offset+=20,navMap.getOffsetCollections(e,$(".show-more-collections").data().offset)}),$("#binModal").modal(),$("#loading").hide()})},buildTaxonHierarchy:function(a){var b={phyla:[]};a.records.forEach(function(a){if(a.rank=a.mra?taxaBrowser.rankMap(a.mra):a.rank?taxaBrowser.rankMap(a.rnk):"Unknown",a.itallics=a.rnk<6?"itallics":"",a.old_name=a.tna.split(" ")[0]!=a.idt?a.tna:"",a.url="species"===a.rank?a.idt+" "+a.ids:a.tid>0?a.idt:"",a.idt)if("species"===a.rank){var c=a.rst?a.rst+" ":"",d=a.rss?" "+a.rss+" ":" ";a.genusRes=c,a.display_name1=a.mna,a.display_name2=a.mna!=a.idt+" "+a.ids?"("+a.tna+")":"",a.display_name3=""}else{var c=a.rst?a.rst+" ":"",d=a.rss?" "+a.rss+" ":"";a.genusRes=c,a.display_name1=a.idt,a.display_name2=d,a.display_name3=a.ids}else a.display_name1=a.tna,a.display_name2="";for(var e=[],f=0;f<b.phyla.length;f++)e.push(b.phyla[f].phylum);if(e.indexOf(a.phl)<0){var g={phylum:a.phl,classes:[]};b.phyla.push(g)}for(var h=[],f=0;f<b.phyla.length;f++)for(var i=0;i<b.phyla[f].classes.length;i++)h.push(b.phyla[f].phylum+"-"+b.phyla[f].classes[i].nameClass);if(h.indexOf(a.phl+"-"+a.cll)<0){var j={nameClass:a.cll,families:[]},k=navMap.getIndex(b.phyla,a.phl,"phylum");b.phyla[k].classes.push(j)}for(var l=[],f=0;f<b.phyla.length;f++)for(var i=0;i<b.phyla[f].classes.length;i++)for(var m=0;m<b.phyla[f].classes[i].families.length;m++)l.push(b.phyla[f].phylum+"-"+b.phyla[f].classes[i].nameClass+"-"+b.phyla[f].classes[i].families[m].family);if(l.indexOf(a.phl+"-"+a.cll+"-"+a.fml)<0){var n={family:a.fml,genera:[]},k=navMap.getIndex(b.phyla,a.phl,"phylum"),o=navMap.getIndex(b.phyla[k].classes,a.cll,"nameClass");b.phyla[k].classes[o].families.push(n)}var k=navMap.getIndex(b.phyla,a.phl,"phylum"),o=navMap.getIndex(b.phyla[k].classes,a.cll,"nameClass"),p=navMap.getIndex(b.phyla[k].classes[o].families,a.fml,"family");b.phyla[k].classes[o].families[p].genera.push(a)});for(var c=0;c<b.phyla.length;c++){for(var d,e=0;e<b.phyla[c].classes.length;e++){for(var f,g=0;g<b.phyla[c].classes[e].families.length;g++)"undefined"==typeof b.phyla[c].classes[e].families[g].family&&(f=g,b.phyla[c].classes[e].families[g].family="Miscellaneous unranked taxa",b.phyla[c].classes[e].families[g].noFamily=!0);"undefined"!=typeof f&&b.phyla[c].classes[e].families.push(b.phyla[c].classes[e].families.splice(f,1)[0]),"undefined"==typeof b.phyla[c].classes[e].nameClass&&(f=e,b.phyla[c].classes[e].nameClass="Miscellaneous unranked taxa",b.phyla[c].classes[e].noClass=!0)}"undefined"!=typeof d&&b.phyla[c].classes.push(b.phyla[c].classes.splice(d,1)[0]),"undefined"==typeof b.phyla[c].phylum&&(b.phyla[c].phylum="Unranked taxa",b.phyla[c].unranked=!0)}return b},openCollectionModal:function(a){$("#loading").show(),d3.json(paleo_nav.dataUrl+"/data1.1/colls/single.json?id="+a.oid+"&show=ref,time,strat,geo,lith,entname,prot&markrefs",function(a,b){if(a)return paleo_nav.hideLoading();b.records.forEach(function(a){a.intervals=a.oli?a.oei+" - "+a.oli:a.oei,a.strat=a.sfm||a.sgr||a.smb?!0:!1,a.lat=Math.round(1e4*a.lat)/1e4,a.lng=Math.round(1e4*a.lng)/1e4});var c=Mustache.render(g,b);switch($("#collectionName").html(b.records[0].nam),$("#collectionModalBody").html(c),b.records[0].ptd){case"NPS":$(".nationalParks").css("display","block"),$(".general, .federalLands").css("display","none");break;case"FED":$(".federalLands").css("display","block"),$(".general, .nationalParks").css("display","none");break;default:$(".general").css("display","block"),$(".nationalParks, .federalLands").css("display","none")}$(".filterByStrat").click(function(a){a.preventDefault(),navMap.filterByStratigraphy({name:$(this).attr("data-name"),type:$(this).attr("data-rank")}),$("#collectionBox").modal("hide")}),$("#collectionBox").modal(),$(".occurrenceTab").on("show.bs.tab",function(a){var b=a.target.id;b=b.replace("occToggle","");var c=navMap.parseURL(paleo_nav.dataUrl+"/data1.1/occs/list.json?coll_id="+b+"&show=phylo,ident");d3.json(c,function(a,c){if(a)return paleo_nav.hideLoading();if(c.records.length>0){var d=navMap.buildTaxonHierarchy(c),e=Mustache.render(h,d);$("#occurrences"+b).html(e),$(".filterByOccurrence").click(function(a){a.preventDefault(),navMap.filterByTaxon($(this).attr("data-name")),$("#collectionBox").modal("hide")})}else{var e=Mustache.render(h,{error:"No occurrences found for this collection"});$("#occurrences"+b).html(e)}})}),$("#loading").hide()})},openStackedCollectionModal:function(a){var b=a.members[0].ptd;a.members.forEach(function(a){a.intervals=a.oli?a.oei+" - "+a.oli:a.oei,a.strat=a.sfm||a.sgr||a.smb?!0:!1,a.lat=Math.round(1e4*a.lat)/1e4,a.lng=Math.round(1e4*a.lng)/1e4});var c=Mustache.render(i,a);switch(d3.select("#binID").html("Fossil Collections at ["+Math.round(1e4*a.lat)/1e4+", "+Math.round(1e4*a.lng)/1e4+"]"),d3.select("#accordion").html(c),$(".collectionCollapse").on("show.bs.collapse",function(a){var b=a.target.id;b=b.replace("collapse",""),d3.json(paleo_nav.dataUrl+"/data1.1/colls/single.json?id="+b+"&show=ref,time,strat,geo,lith,entname,prot&markrefs",function(a,c){return a?paleo_nav.hideLoading():void $("#ref"+b).html(c.records[0].ref)})}),$(".occurrenceTab").on("show.bs.tab",function(a){var b=a.target.id;b=b.replace("occToggle","");var c=navMap.parseURL(paleo_nav.dataUrl+"/data1.1/occs/list.json?coll_id="+b+"&show=phylo,ident");d3.json(c,function(a,c){if(a)return paleo_nav.hideLoading();if(c.records.length>0){var d=navMap.buildTaxonHierarchy(c),e=Mustache.render(h,d);$("#occurrences"+b).html(e),$(".filterByOccurrence").click(function(a){a.preventDefault(),navMap.filterByTaxon($(this).attr("data-name")),$("#collectionModal").modal("hide")})}else{var e=Mustache.render(h,{error:"No occurrences found for this collection"});$("#occurrences"+b).html(e)}})}),b){case"NPS":$(".nationalParks").css("display","block"),$(".general, .federalLands").css("display","none");break;case"FED":$(".federalLands").css("display","block"),$(".general, .nationalParks").css("display","none");break;default:$(".general").css("display","block"),$(".nationalParks, .federalLands").css("display","none")}$(".filterByStrat").click(function(a){a.preventDefault(),navMap.filterByStratigraphy({name:$(this).attr("data-name"),type:$(this).attr("data-rank")}),$("#collectionModal").modal("hide")}),$("#collectionModal").modal()},buildWKT:function(a){for(var b="",c=0;c<a.length;c++)b+="POINT("+a[c].lat+" "+a[c].lng+" "+a[c].oid+"),";return b=b.slice(0,-1),b=encodeURI(b)},parseURL:function(a){var b=0;for(var c in m.exist)if(m.exist.hasOwnProperty(c)&&m.exist[c]===!0){switch(c){case"selectedInterval":a+="&interval_id="+m.selectedInterval.oid;break;case"personFilter":a+="&touched_by="+m.personFilter.id;break;case"taxon":a+="&base_id=",m.taxa.forEach(function(b){a+=b.id+","}),a=a.slice(0,-1);break;case"stratigraphy":"Fm"===m.stratigraphy.rank?a+="&formation="+m.stratigraphy.name:"Gp"===m.stratigraphy.rank?a+="&stratgroup="+m.stratigraphy.name:"Mbr"===m.stratigraphy.rank&&(a+="&member="+m.stratigraphy.name)}b+=1}return b>0&&"none"===d3.select("#reconstructMap").style("display")&&d3.select(".filters").style("display","block"),a},checkFilters:function(){var a=0;for(var b in m.exist)m.exist.hasOwnProperty(b)&&m.exist[b]===!0&&(a+=1);return a>0?(d3.select(".filters").style("display","block"),d3.select("#filterTitle").html("Filters"),!0):(d3.select(".filters").style("display","none"),d3.select("#filterTitle").html("No filters selected"),!1)},getIndex:function(a,b,c){for(var d=0,e=a.length;e>d;d++)if(a[d][c]===b)return d;return-1},multiplier:function(a){switch(a){case 2:return navMap.checkFilters()?.8:.7;case 3:return navMap.checkFilters()?.2:1;case 4:return navMap.checkFilters()?.48:2;case 5:return navMap.checkFilters()?.68:.6;case 6:return navMap.checkFilters()?.88:.8;case 7:return 1.5;default:return 1}},resizeSvgMap:function(){var a=parseInt(d3.select("#graphics").style("width")),b=d3.select("#svgMap").select("svg");d3.select("#svgMap").select("svg").select("g").attr("transform",function(){var c;try{c=b.node().getBBox()}catch(d){c={x:b.node().clientLeft,y:b.node().clientTop,width:b.node().clientWidth,height:b.node().clientHeight}}.7*window.innerHeight-70;if(a>c.width+70)return"scale("+window.innerHeight/680+")translate("+(a-c.width)/3+",0)";var e=.7*window.innerHeight-70,f=a/970*500,g=(e-f)/2>0?(e-f)/2:40;return"scale("+a/970+")translate(0,"+g+")"}),d3.select("#svgMap").select("svg").style("height",function(a){if("hidden"===d3.select(".timeScale").style("visibility"))return window.innerHeight-60+"px";var b=$("#time").height()>15?$("#time").height():window.innerHeight/5.6;return window.innerHeight-b-60+"px"}).style("width",function(b){return a-15+"px"})},resize:function(){window.innerWidth<700?(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){return window.innerHeight-55+"px"}),map.invalidateSize(),$("#downloadDataTab").removeClass("active"),$("#downloadData").removeClass("active"),$("#urlTab").addClass("active"),$("#getURL").addClass("active")):parseInt(d3.select("#map").style("height"))>1?(d3.select("#map").style("height",function(a){if("hidden"===d3.select(".timeScale").style("visibility"))return window.innerHeight-70+"px";var b=$("#time").height()>15?$("#time").height():window.innerHeight/5.6;return window.innerHeight-b-54+"px"}),map.invalidateSize()):navMap.resizeSvgMap(),d3.select("#infoContainer").style("bottom",function(){if(window.innerWidth<468)return"91px";var a=parseInt(d3.select("#time").select("svg").style("height"));return a+15+"px"}),d3.select(".prevalence-summary, .prevalence-row").style("height",function(){var a=window.innerHeight-parseInt(d3.select("#time").select("svg").style("height"))-121;return a+"px"}),window.innerHeight>600?d3.select(".filters").style("left",0).style("top","inherit").style("bottom",function(){var a=parseInt(d3.select("#time").select("svg").style("height"));return a+4+"px"}):d3.select(".filters").style("left","49px").style("top",0).style("bottom","inherit"),d3.selectAll(".helpModalTimescaleLabel").style("top",function(){var a=$("#time").height()>15?$("#time").height():window.innerHeight/5.6;return window.innerHeight-a-78+"px"}),$(".universalSearchForm > div > .twitter-typeahead > .tt-dropdown-menu").width($(".universalSearchForm > div > .twitter-typeahead").width()-21)},refreshFilterHandlers:function(){d3.selectAll(".removeFilter").on("click",function(){var a=d3.select(this).node().parentNode;a=d3.select(a);var b=a.attr("id"),c=parseInt(a.attr("data-id"));switch(b){case"selectedInterval":a.style("display","none").html(""),m.exist.selectedInterval=!1,d3.select(".time").style("box-shadow",""),timeScale.unhighlight();for(var d=Object.keys(m[b]),e=0;e<d.length;e++)m[b][d[e]]="";break;case"personFilter":a.style("display","none").html(""),m.exist.personFilter=!1,d3.select(".userFilter").style("box-shadow","");for(var d=Object.keys(m[b]),e=0;e<d.length;e++)m[b][d[e]]="";break;case"taxon":a.remove(),navMap.removeTaxonFilters([c]);break;case"stratFilter":a.style("display","none").html(""),m.exist.stratigraphy=!1;for(var d=Object.keys(m.stratigraphy),e=0;e<d.length;e++)m.stratigraphy[d[e]]=""}paleo_nav.getPrevalence(),"block"===d3.select("#reconstructMap").style("display")?reconstructMap.rotate(m.selectedInterval):navMap.refresh("reset")})},updateFilterList:function(a,b){switch(paleo_nav.getPrevalence(),a){case"selectedInterval":d3.select("#selectedInterval").style("display","block").html(m.selectedInterval.nam+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),d3.select(".time").style("box-shadow","inset 3px 0 0 #ff992c"),navMap.refreshFilterHandlers();break;case"personFilter":d3.select("#personFilter").style("display","block").html(m.personFilter.name+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),d3.select(".userFilter").style("box-shadow","inset 3px 0 0 #ff992c"),navMap.refreshFilterHandlers();break;case"taxon":var c;m.taxa.forEach(function(a,d){a.id===b&&(c=d)}),d3.select(".filters").append("div").attr("id","taxon").attr("class","filter").attr("data-id",b).style("display","block").html(m.taxa[c].name+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),d3.select(".taxa").style("box-shadow","inset 3px 0 0 #ff992c"),navMap.refreshFilterHandlers();break;case"stratigraphy":d3.select("#stratFilter").style("display","block").html(m.stratigraphy.name+'<button type="button" class="close removeFilter" aria-hidden="true">&times;</button>'),navMap.refreshFilterHandlers()}window.innerHeight>600?d3.select(".filters").style("left",0).style("top","inherit").style("bottom",function(){var a=parseInt(d3.select("#time").select("svg").style("height"));return a+4+"px"}):d3.select(".filters").style("left","49px").style("top",0).style("bottom","inherit")},filterByTime:function(a){var b=d3.selectAll("rect").filter(function(b){return b.name===a});b=b[0][0].__data__,m.selectedInterval.nam=b.name,m.selectedInterval.mid=b.mid,m.selectedInterval.col=b.color,m.selectedInterval.oid=b.id,m.exist.selectedInterval=!0,navMap.updateFilterList("selectedInterval")},removeTaxonFilters:function(a){d3.selectAll(".filters > .filter").each(function(b){var c=parseInt(d3.select(this).attr("data-id"));a.indexOf(c)>-1&&d3.select(this).remove()}),navMap.filters.taxa=navMap.filters.taxa.filter(function(b){return a.indexOf(b.id)<0?b:void 0}),navMap.filters.taxa.length<1&&(navMap.filters.exist.taxon=!1),d3.select(".taxa").style("box-shadow","")},filterByTaxon:function(a,b,c){if(!a)var a=$("#taxonInput").val();d3.json(paleo_nav.dataUrl+"/data1.2/taxa/list.json?name="+a+"&show=seq",function(c,d){if(c)return alert("Error retrieving from list.json - ",c),paleo_nav.hideLoading();if(d.records.length>0){for(var e={id:parseInt(d.records[0].oid.replace("txn:","")),name:d.records[0].nam,lsq:d.records[0].lsq,rsq:d.records[0].rsq},f=0;f<navMap.filters.taxa.length;f++)if(navMap.filters.taxa[f].id===e.name)return;for(var g=[],f=0;f<navMap.filters.taxa.length;f++)e.lsq>=navMap.filters.taxa[f].lsq&&e.rsq<=navMap.filters.taxa[f].rsq&&g.push(navMap.filters.taxa[f].id),e.lsq<=navMap.filters.taxa[f].lsq&&e.rsq>=navMap.filters.taxa[f].rsq&&g.push(navMap.filters.taxa[f].id);navMap.removeTaxonFilters(g),b||taxaBrowser.goToTaxon(a),navMap.filters.taxa.push(e),navMap.filters.exist.taxon=!0,navMap.updateFilterList("taxon",e.id),"block"===d3.select("#reconstructMap").style("display")?reconstructMap.rotate(navMap.filters.selectedInterval):navMap.refresh("reset")}else alert("No taxa with this name found")})},filterByPerson:function(a,b){a&&(m.exist.personFilter=!0,m.personFilter.id=a.oid?a.oid:a.id,m.personFilter.name=a.name?a.name:a.nam,navMap.updateFilterList("personFilter"),"block"===d3.select("#reconstructMap").style("display")?reconstructMap.rotate(m.selectedInterval):navMap.refresh("reset"))},filterByStratigraphy:function(a){a&&(m.exist.stratigraphy=!0,m.stratigraphy.name=a.nam,m.stratigraphy.rank=a.type?a.type:a.rank,navMap.updateFilterList("stratigraphy"),navMap.refresh("reset"))},download:function(){$("#occs:checked").length>0?navMap.downloadOccs():$("#refs:checked").length>0?navMap.downloadRefs():$("#diver:checked").length>0?navMap.downloadDiversity():navMap.downloadFullDiversity()},downloadRefs:function(){var a=map.getBounds(),b=a._southWest,c=a._northEast,d=paleo_nav.dataUrl+"/data1.1/occs/refs.";d+=$("#tsv:checked").length>0?"txt":$("#csv:checked").length>0?"csv":$("#json:checked").length>0?"json":"ris","block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?d+="?limit=all":(b.lat=b.lat.toFixed(4),b.lng=b.lng.toFixed(4),c.lat=c.lat.toFixed(4),c.lng=c.lng.toFixed(4),d+="?lngmin="+b.lng+"&lngmax="+c.lng+"&latmin="+b.lat+"&latmax="+c.lat+"&limit=all"),d=navMap.parseURL(d),d+="&show=comments,ent,entname,crmod&showsource",window.open(d)},downloadOccs:function(){var a=map.getBounds(),b=a._southWest,c=a._northEast,d=paleo_nav.dataUrl+"/data1.1/occs/list.";
if($("#tsv:checked").length>0)d+="txt";else if($("#csv:checked").length>0)d+="csv";else{if(!($("#json:checked").length>0))return alert("RIS format not available for occurrences. Please select a different format.");d+="json"}"block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?d+="?limit=all":(b.lat=b.lat.toFixed(4),b.lng=b.lng.toFixed(4),c.lat=c.lat.toFixed(4),c.lng=c.lng.toFixed(4),d+="?lngmin="+b.lng+"&lngmax="+c.lng+"&latmin="+b.lat+"&latmax="+c.lat+"&limit=all"),d=navMap.parseURL(d),d+="&show=coords,attr,loc,prot,time,strat,stratext,lith,lithext,geo,rem,ent,entname,crmod,paleoloc&showsource",window.open(d)},downloadDiversity:function(){var a=map.getBounds(),b=a._southWest,c=a._northEast,d=paleo_nav.dataUrl+"/data1.2/occs/quickdiv.";if($("#tsv:checked").length>0)d+="txt";else if($("#csv:checked").length>0)d+="csv";else{if(!($("#json:checked").length>0))return alert("RIS format not available for occurrences. Please select a different format.");d+="json"}"block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?d+="?lngmin=-180&lngmax=180&latmin=-90&latmax=90":(b.lat=b.lat.toFixed(4),b.lng=b.lng.toFixed(4),c.lat=c.lat.toFixed(4),c.lng=c.lng.toFixed(4),d+="?lngmin="+b.lng+"&lngmax="+c.lng+"&latmin="+b.lat+"&latmax="+c.lat),d=navMap.parseURL(d),d+="&count="+$('[name="taxonLevel"]').val()+"&reso="+$('[name="timeLevel"]').val(),window.open(d)},downloadFullDiversity:function(){var a=map.getBounds(),b=a._southWest,c=a._northEast,d=paleo_nav.dataUrl+"/data1.2/occs/diversity.";if($("#tsv:checked").length>0)d+="txt";else if($("#csv:checked").length>0)d+="csv";else{if(!($("#json:checked").length>0))return alert("RIS format not available for occurrences. Please select a different format.");d+="json"}"block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?d+="?lngmin=-180&lngmax=180&latmin=-90&latmax=90":(b.lat=b.lat.toFixed(4),b.lng=b.lng.toFixed(4),c.lat=c.lat.toFixed(4),c.lng=c.lng.toFixed(4),d+="?lngmin="+b.lng+"&lngmax="+c.lng+"&latmin="+b.lat+"&latmax="+c.lat),d=navMap.parseURL(d),d+="&count="+$('[name="taxonLevel"]').val()+"&reso="+$('[name="timeLevel"]').val()+"&recent="+$('[name="extant"]').is(":checked"),window.open(d)},getApiUrl:function(){var a=map.getBounds(),b=a._southWest,c=a._northEast,d="https://paleobiodb.org/data1.1/occs/list.json";return"block"===d3.select("#reconstructMap").style("display")||"block"===d3.select("#svgMap").style("display")?d+="?limit=all":(b.lat=b.lat.toFixed(4),b.lng=b.lng.toFixed(4),c.lat=c.lat.toFixed(4),c.lng=c.lng.toFixed(4),d+="?lngmin="+b.lng+"&lngmax="+c.lng+"&latmin="+b.lat+"&latmax="+c.lat+"&limit=all"),d=navMap.parseURL(d),d+="&show=coords,attr,loc,prot,time,strat,stratext,lith,lithext,geo,rem,ent,entname,crmod&showsource"},restoreState:function(a){if("object"==typeof a){var b=a;b.zoom&&b.zoom>2&&navMap.goTo(b.center,b.zoom),b.timeScale&&"Phanerozoic"!=b.timeScale&&timeScale.goTo(b.timeScale),b.taxaFilter.length>0&&b.taxaFilter.forEach(function(a){navMap.filterByTaxon(a.name?a.name:a.nam)}),"object"==typeof b.stratFilter&&""!=b.stratFilter.name&&navMap.filterByStratigraphy(b.stratFilter),"object"==typeof b.timeFilter&&""!=b.timeFilter.nam&&navMap.filterByTime(b.timeFilter.nam),b.authFilter.id>0&&navMap.filterByPerson(b.authFilter),"block"===b.reconstruct&&(reconstructMap.rotate(b.currentReconstruction),paleo_nav.toggleReconstructMap(),navMap.checkFilters()),navMap.resize(),window.scrollTo(0,0)}else{var c=window.location,a=c.hash.substr(2);a.length>1&&d3.json(paleo_nav.stateUrl+"/larkin/app-state?id="+a,function(a,b){if(a)return paleo_nav.launch();var c=b[0].data;c.zoom=parseInt(c.zoom),c.center[0]=parseFloat(c.center[0]),c.center[1]=parseFloat(c.center[1]),c.taxaFilter&&c.taxaFilter.length>0&&c.taxaFilter.forEach(function(a){a.id=parseInt(a.id)}),c.timeFilter.mid=parseInt(c.timeFilter.mid),c.timeFilter.oid=parseInt(c.timeFilter.oid),c.currentReconstruction.mid=parseInt(c.currentReconstruction.mid),c.currentReconstruction.id=parseInt(c.currentReconstruction.id),c.authFilter.id=parseInt(c.authFilter.id),c.zoom&&c.zoom>2&&navMap.goTo(c.center,c.zoom),c.taxaFilter&&c.taxaFilter.length>0&&c.taxaFilter.forEach(function(a){navMap.filterByTaxon(a.name)}),"object"==typeof c.stratFilter&&""!=c.stratFilter.name&&navMap.filterByStratigraphy(c.stratFilter),"object"==typeof c.timeFilter&&""!=c.timeFilter.nam&&(navMap.filterByTime(c.timeFilter.nam),navMap.refresh("redraw")),c.authFilter.id>0&&navMap.filterByPerson(c.authFilter),"block"===c.reconstruct&&(reconstructMap.rotate(c.currentReconstruction),paleo_nav.toggleReconstructMap(),navMap.checkFilters()),"Phanerozoic"!=c.timeScale&&timeScale.goTo(c.timeScale),paleo_nav.launch()})}},getUrl:function(){var a=map.getCenter(),b=map.getZoom(),c=d3.select("#reconstructMap").style("display"),d={timeScale:timeScale.currentInterval.name,taxaFilter:[],timeFilter:m.selectedInterval,stratFilter:{name:m.stratigraphy.name,rank:m.stratigraphy.rank},authFilter:m.personFilter,zoom:b,center:[a.lat,a.lng],reconstruct:c,currentReconstruction:reconstructMap.currentReconstruction};return m.taxa.length>0&&m.taxa.forEach(function(a){d.taxaFilter.push(a)}),d},summarize:function(b){b.records.length>0&&("col"===b.records[0].typ?navMap.totalCollections=a(b.records.length):navMap.totalCollections=a(d3.sum(b.records,function(a){return a.nco})),navMap.totalOccurrences=a(d3.sum(b.records,function(a){return a.noc})),navMap.setInfoSummary())},setInfoSummary:function(){d3.select(".info").style("display","block").html("<strong>"+navMap.totalCollections+" total collections</strong><br>"+navMap.totalOccurrences+" total occurrences")},filters:m,totalOccurrences:e}}(),paleo_nav=function(){var a=window.location.origin,b="https://paleobiodb.org",c="https://paleobiodb.org";window.location.search.indexOf("local")>-1?(a=window.location.origin+":3000",b=window.location.origin+":3000"):window.location.search.indexOf("test")>-1?a="https://paleobiodb.org":"localhost"===window.location.hostname&&(a="https://paleobiodb.org");var d,e;return d3.text("build/partials/prevalent.html",function(a,b){d=b}),d3.text("build/partials/prevalent_summary.html",function(a,b){e=b}),{init:function(){var d;d=window.innerWidth>1800?60:window.innerWidth>1500?75:window.innerWidth>1e3?95:110,timeScale.init("time",d,function(){navMap.init(function(){navMap.resizeSvgMap(),navMap.resize(),navMap.refresh("reset")}),reconstructMap.init(),taxaBrowser.init()});var e=$(".zoom-in").hammer();e.on("tap",function(a){a.preventDefault(),parseInt(d3.select("#map").style("height"))<1?(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){return.7*window.innerHeight-70+"px"}),map.setView([7,0],3,{animate:!1}),navMap.refresh("reset"),map.invalidateSize()):map.zoomIn()});var f=$(".zoom-out").hammer();f.on("tap",function(a){a.preventDefault(),map.zoomOut()});var g=$(".rotate").hammer();g.on("tap",function(a){a.preventDefault(),reconstructMap.visible?paleo_nav.closeReconstructMap():paleo_nav.toggleReconstructMap()});var h=$(".taxa").hammer();h.on("tap",function(a){a.preventDefault(),a.stopPropagation();var b=d3.select("#taxaBrowser").style("display");"block"==b?(paleo_nav.closeTaxaBrowser(),d3.select(".taxa").style("color","#000")):(paleo_nav.openTaxaBrowser(),d3.select(".taxa").style("color","#ff992c"))});var i=$("#taxaBrowserNavbar").hammer();i.on("tap",function(a){a.preventDefault(),$(".navbar-collapse").collapse("hide");var b=d3.select("#taxaBrowser").style("display");"block"===b?paleo_nav.closeTaxaBrowser():paleo_nav.openTaxaBrowser(),$});var j=$(".taxaBrowserToggle").hammer();j.on("tap",function(a){a.preventDefault(),a.stopPropagation();var b=d3.select("#taxaBrowser").style("display");"block"===b?paleo_nav.closeTaxaBrowser():paleo_nav.openTaxaBrowser()});var k=Mustache.compile('<p>{{nam}}{{#msp}}<small class="misspelling">  missp.</small>{{/msp}}      <small class="taxaRank">{{rank}}</small></p>'),l=$("#taxonInput").typeahead({name:"taxaBrowser",remote:{url:a+"/data1.1/taxa/auto.json?name=%QUERY&limit=10",filter:function(a){return a.records.forEach(function(a){a.rank=taxaBrowser.rankMap(a.rnk)}),a.records}},valueKey:"nam",minLength:3,limit:10,template:k});l.on("typeahead:selected",function(a,b){taxaBrowser.goToTaxon(b.nam)}),$("input#taxonInput").keypress(function(a){if(13===a.which){var b=$("input#taxonInput").data().ttView.dropdownView.getFirstSuggestion();taxaBrowser.goToTaxon(b.datum.nam),document.activeElement.blur(),$("input#taxonInput").blur(),$("input#taxonInput").typeahead("setQuery","")}});var m={member:"Mbr",formation:"Fm",group:"Gp"},n=$("#universalAutocompleteInput").typeahead([{name:"time",prefetch:{url:a+"/data1.1/intervals/list.json?scale=1&order=older&max_ma=4000",filter:function(a){return a.records}},valueKey:"nam",header:'<h4 class="autocompleteTitle">Time Intervals</h4>',limt:5},{name:"contribs",prefetch:{url:a+"/data1.1/people/list.json?name=%",filter:function(a){return a.records}},valueKey:"nam",header:'<h4 class="autocompleteTitle">Authorizers</h4>',limit:5},{name:"taxa",remote:{url:a+"/data1.1/taxa/auto.json?name=%QUERY&limit=10",filter:function(a){return a.records.forEach(function(a){a.rank=taxaBrowser.rankMap(a.rnk)}),a.records}},valueKey:"nam",minLength:3,limit:10,header:'<h4 class="autocompleteTitle">Taxa</h4>',template:k},{name:"strat",minLength:3,limit:10,header:'<h4 class="autocompleteTitle">Stratigraphy</h4>',remote:{url:a+"/data1.1/strata/auto.json?limit=10&name=%QUERY",filter:function(a){return a.records.forEach(function(a){a.display_name=a.nam+" "+m[a.rnk],a.type=m[a.rnk]}),a.records}},valueKey:"display_name"}]);n.on("typeahead:selected",function(a,b,c){switch($(".navbar-collapse").collapse("hide"),c){case"contribs":navMap.filterByPerson(b),document.activeElement.blur();break;case"time":timeScale.goTo(b.nam),navMap.filterByTime(b.nam),navMap.refresh("reset");break;case"taxa":navMap.filterByTaxon(b.nam);break;case"strat":navMap.filterByStratigraphy(b);break;default:console.log("default")}document.activeElement.blur(),$("#universalAutocompleteInput").blur(),$("#universalAutocompleteInput").typeahead("setQuery","")}),$("#universalAutocompleteInput").on("focus",function(){window.innerWidth<700&&($(".navbar-collapse").css("height",window.innerHeight-50+"px"),$(".navbar-collapse").css("max-height",window.innerHeight-50+"px"),$(".tt-dropdown-menu").css("width",$("#universalAutocompleteInput").width()+"px"))}),$("#universalAutocompleteInput").on("blur",function(){window.scrollTo(0,0),window.innerWidth<700&&($(".navbar-collapse").css("height","auto"),$(".navbar-collapse").css("max-height","340px"))}),$("#universalSearchButton").click(function(a){a.preventDefault()}),$("input#universalAutocompleteInput").keypress(function(a){if(13===a.which){var b=$("input#universalAutocompleteInput").data().ttView.dropdownView.getFirstSuggestion();switch(b.dataset){case"contribs":navMap.filterByPerson(b.datum),document.activeElement.blur();break;case"time":timeScale.goTo(b.datum.nam),navMap.filterByTime(b.datum.nam),navMap.refresh("reset");break;case"taxa":navMap.filterByTaxon(b.datum.nam);break;case"strat":navMap.filterByStratigraphy(b.datum);break;default:console.log("Default")}document.activeElement.blur(),$("#universalAutocompleteInput").blur(),$("#universalAutocompleteInput").typeahead("setQuery",""),$(".navbar-collapse").collapse("hide")}}),d3.select(window).on("resize",function(){timeScale.resize(),navMap.resize(),reconstructMap.resize()}),$("#binModal").on("hide.bs.modal",function(){$("#collectionLoading").hide(),$("#collectionCount").show(),$(".show-more-collections").data("offset",0),$(".show-more-collections").data("shown-collections",0),$(".show-more-collections").data("total-collections",0)}),$("#statsBox").on("show.bs.modal",function(){$(".statsContent").height(window.innerHeight-70),$(".diversityContainer").height(window.innerHeight-380),$("#diversityWait").css("display","block"),d3.select("#diversity").select("svg").remove(),$("#prevalence-container").html("");var a=map.getBounds(),c=a._southWest,d=a._northEast;parseInt(d3.select("#map").style("height"))<1&&(c.lng=-180,d.lng=180,c.lat=-90,d.lat=90);var e=navMap.parseURL(b+"/data1.2/occs/quickdiv.json?lngmin="+c.lng.toFixed(1)+"&lngmax="+d.lng.toFixed(1)+"&latmin="+c.lat.toFixed(1)+"&latmax="+d.lat.toFixed(1)+"&count=genera&reso=stage");$(".diversityDownload").attr("href",e),diversityPlot.plot(e,!1)}),$("#statsBox").on("hide.bs.modal",function(){"undefined"!=typeof diversityPlot.currentRequest&&Object.keys(diversityPlot.currentRequest).length>0&&(diversityPlot.currentRequest.abort(),diversityPlot.currentRequest={})}),$("#advstatsBox").on("show.bs.modal",function(){$(".advstatsContent").height(window.innerHeight-70),$(".advdiversityContainer").height(window.innerHeight-380),$("#diversityWait").css("display","block"),d3.select("#advdiversity").select("svg").remove();var a=map.getBounds(),c=a._southWest,d=a._northEast;parseInt(d3.select("#map").style("height"))<1&&(c.lng=-180,d.lng=180,c.lat=-90,d.lat=90);var e=navMap.parseURL(b+"/data1.2/occs/diversity.json?lngmin="+c.lng.toFixed(1)+"&lngmax="+d.lng.toFixed(1)+"&latmin="+c.lat.toFixed(1)+"&latmax="+d.lat.toFixed(1)+"&count="+$('[name="taxonLevel"]').val()+"&reso="+$('[name="timeLevel"]').val()+"&recent="+$('[name="extant"]').is(":checked"))+"&base_id=13131";$(".diversityDownload").attr("href",e),diversityPlot.plot(e,!0)}),$("#advstatsBox").on("hide.bs.modal",function(){"undefined"!=typeof diversityPlot.currentRequest&&Object.keys(diversityPlot.currentRequest).length>0&&(diversityPlot.currentRequest.abort(),diversityPlot.currentRequest={})}),$("#saveBox").on("show.bs.modal",function(){if($("#urlTab").hasClass("active")){var b=$.ajax({url:c+"/larkin/app-state",async:!1,type:"POST",data:{state:navMap.getUrl()},ContentType:"application/x-www-form-urlencoded",dataType:"json"});b.success(function(a){$("#url").val(c+"/navigator/#/"+a.id),setTimeout(function(){$("#url").focus(),$("#url").select()},100)})}var d=map.getBounds(),e=d._southWest,f=d._northEast;parseInt(d3.select("#map").style("height"))<1&&(e.lng=-180,f.lng=180,e.lat=-90,f.lat=90),$("#filterList").append("<li>Map extent - <small>(["+e.lat.toFixed(0)+", "+e.lng.toFixed(0)+"], ["+f.lat.toFixed(0)+", "+f.lng.toFixed(0)+"])</small></li>");var g=0;for(var h in navMap.filters.exist)if(navMap.filters.exist.hasOwnProperty(h)&&1==navMap.filters.exist[h]){switch(h){case"selectedInterval":$("#filterList").append("<li>Interval - "+navMap.filters.selectedInterval.nam+"</li>");break;case"personFilter":$("#filterList").append("<li>Contributor - "+navMap.filters.personFilter.name+"</li>");break;case"taxon":navMap.filters.taxa.forEach(function(a){$("#filterList").append("<li>Taxon - "+a.name+"</li>")})}g+=1}var i=a+"/data1.1/occs/list.json?lngmin="+e.lng+"&lngmax="+f.lng+"&latmin="+e.lat+"&latmax="+f.lat+"&limit=0&count";i=navMap.parseURL(i),d3.json(i,function(a,b){var c=.67*b.records_found;c=1024>c?c.toFixed(0)+"KB":1024e3>c?(c/1024).toFixed(0)+"MB":(c/1024e3).toFixed(0)+"GB",d3.select("#occsLabel").html("Occurrences <small><i>(About "+c+")</i></small>")})}),$("#saveBox").on("hide.bs.modal",function(){$("#filterList").html(""),d3.select("#occsLabel").html("Occurrences "),$("#appUrl").val(""),$("#apiUrl").val(""),d3.select("#downloadCount").style("display","none"),d3.select("#diversity").select("svg").remove()}),$("#getAppUrl").on("click",function(){var a=$.ajax({url:c+"/larkin/app-state",async:!1,type:"POST",data:{state:navMap.getUrl()},ContentType:"application/x-www-form-urlencoded",dataType:"json"});a.success(function(a){$("#appUrl").val(c+"/navigator/#/"+a.id),setTimeout(function(){$("#appUrl").focus(),$("#appUrl").select()},100)})}),$("#getApiUrl").on("click",function(){var a=navMap.getApiUrl();$("#apiUrl").val(a),setTimeout(function(){$("#apiUrl").focus(),$("#apiUrl").select()},100)}),$("#taxaForm").submit(function(){return navMap.filterByTaxon(),!1}),$(".helpModalClose").on("click",function(){$("#helpModal").modal("hide")}),$("#goToApp").on("click",function(){$("#helpModal").modal("hide")}),$("#trilobita").on("click",function(a){a.preventDefault(),paleo_nav.closeReconstructMap();var b={authFilter:{id:"",name:""},center:[30.3539163,113.24707],currentReconstruction:"",reconstruct:"none",taxaFilter:[{id:19100,nam:"Trilobita"}],timeFilter:{nam:"Cambrian",oid:22,mid:513},timeScale:"Cambrian",zoom:5};navMap.restoreState(b),$("#helpModal").modal("hide")}),$("#dinosauria").on("click",function(a){a.preventDefault(),paleo_nav.closeReconstructMap();var b={authFilter:{id:"",name:""},center:[40.5305,-109.5117],currentReconstruction:"",reconstruct:"none",taxaFilter:[{id:19968,nam:"Dinosauria"}],timeFilter:{nam:"Jurassic",oid:15,mid:173},timeScale:"Jurassic",zoom:5};navMap.restoreState(b),$("#helpModal").modal("hide")}),$("#plantae").on("click",function(a){a.preventDefault();var b={authFilter:{id:"",name:""},center:"",currentReconstruction:{nam:"Permian",col:"#F04028",mid:275,oid:17,taxon:"Plantae",person:""},taxaFilter:[],reconstruct:"block",taxaFilter:[{id:151418,nam:"Plantae"}],timeFilter:{nam:"Permian",oid:17,mid:275},timeScale:"Permian",zoom:""};navMap.restoreState(b),$("#helpModal").modal("hide")})},getPrevalence:function(a){$(".prevalence-summary").html(""),"undefined"!=typeof currentPrevRequest&&Object.keys(currentPrevRequest).length>0&&(currentPrevRequest.abort(),currentPrevRequest={});var c=map.getBounds(),f=c._southWest,g=c._northEast;parseInt(d3.select("#map").style("height"))<1&&(f.lng=-180,g.lng=180,f.lat=-90,g.lat=90);var h=navMap.parseURL(b+"/data1.2/occs/prevalence.json?limit=50&lngmin="+f.lng.toFixed(1)+"&lngmax="+g.lng.toFixed(1)+"&latmin="+f.lat.toFixed(1)+"&latmax="+g.lat.toFixed(1));h=h.replace("touched_by","occ_touched_by"),currentPrevRequest=d3.json(h,function(a,b){var c=d3.scale.linear().domain([d3.min(b.records,function(a){return a.noc}),d3.max(b.records,function(a){return a.noc})]).range([40,80]),f=b.records.map(function(a){return a.noc}).reduce(function(a,b){return a+b},0);b.records.forEach(function(a){var b=a.nam.split(" ");a.display_name=b[0]+(b.length>1?"*":""),a.data_url=paleo_nav.dataUrl,a.height=c(a.noc);var d=parseInt(a.noc/f*100);a.percentage=1>d?"< 1":d});var g=b.records.filter(function(a,b){return 11>b?a:void 0}),h=b.records.filter(function(a,b){if(window.innerWidth>700){var c=window.innerHeight-parseInt(d3.select("#time").select("svg").style("height"));if(b<Math.floor(c/80))return a}else if(b<Math.floor(window.innerHeight/80))return a});h.forEach(function(a){a.display_text=a.display_name+(a.display_name.length>17?"":" "+a.percentage+"%")});var i=Mustache.render(e,{records:h});$(".prevalence-summary").html(i);var j=Mustache.render(d,{records:g});$(".prevalence-container").html(j),$(".prevalent-summary-taxon").click(function(a){var b=$(this).data("name").replace(" (other)","").replace(" (unclassified)","").replace("*","");navMap.filterByTaxon(b)})})},prelaunch:function(){var a=window.location,b=a.hash.substr(2);b.length>1?navMap.restoreState():paleo_nav.launch()},launch:function(){d3.select("#graphicRow").style("visibility","visible"),d3.select("#waiting").style("display","none"),navMap.resizeSvgMap(),setTimeout(navMap.resize,500),this.getPrevalence(),localStorage.pbdb||window.innerWidth>700&&($("#helpModal").modal("show"),localStorage.pbdb=!0)},showLoading:function(){d3.select("#loading").style("display","block")},hideLoading:function(){d3.select("#loading").style("display","none")},untoggleTaxa:function(){d3.select(".taxaToggler").style("display","none"),d3.select(".taxa").style("color","")},untoggleUser:function(){d3.select(".userToggler").style("display","none"),d3.select(".userFilter").style("color","")},openTaxaBrowser:function(){d3.select("#graphics").attr("class","col-sm-9"),d3.select("#taxaBrowser").style("display","block"),d3.select("#taxaBrowserToggle").html('<i class="fa fa-angle-double-left" style="margin-right:5px;"></i>Collapse taxa browser'),d3.select(".taxaToggler").style("display","none"),timeScale.resize(),reconstructMap.resize(),navMap.resize()},closeTaxaBrowser:function(){d3.select("#graphics").attr("class","col-sm-12"),d3.select("#taxaBrowser").style("display","none"),d3.select("#taxaBrowserToggle").html('Expand taxa browser<i class="fa fa-angle-double-right" style="margin-left:5px;"></i>'),d3.select(".taxa").style("color","#000"),timeScale.resize(),reconstructMap.resize(),navMap.resize(),navMap.resize()},toggleReconstructMap:function(){if(paleo_nav.untoggleTaxa(),paleo_nav.untoggleUser(),paleo_nav.closeTaxaBrowser(),reconstructMap.visible=!0,d3.select(".rotate").style("box-shadow","inset 3px 0 0 #ff992c").style("color","#ff992c"),d3.select(".info").html("Click a time interval to reconstruct collections and plates").style("display","block"),parseInt(d3.select("#map").style("height"))>1&&d3.select("#map").style("display","none"),d3.select("#svgMap").style("display","none"),d3.select("#reconstructMap").style("display","block"),reconstructMap.resize(),$(".zoom-in").hammer().off("tap").css("color","#ccc"),$(".zoom-out").hammer().off("tap").css("color","#ccc"),navMap.filters.exist.selectedInterval)reconstructMap.rotate(navMap.filters.selectedInterval);else if(interval.nam===reconstructMap.currentReconstruction.name&&navMap.filters.personFilter.name===reconstructMap.currentReconstruction.person&&navMap.filters.stratigraphy.name===reconstructMap.currentReconstruction.stratigraphy){var a=0;if(navMap.filters.taxa.length===reconstructMap.currentReconstruction.taxa.length&&(navMap.filters.taxa.forEach(function(b){var c=!1;reconstructMap.currentReconstruction.taxa.forEach(function(a){b.name===a.name&&(c=!0)}),c||(a+=1)}),0===a))return}else reconstructMap.currentReconstruction.name.length<1?alert("Please click a time interval below to build a reconstruction map"):alert("Please click a time interval below to build a reconstruction map")},closeReconstructMap:function(){navMap.refresh("reset"),reconstructMap.visible=!1,d3.select("#reconstructMap").style("display","none"),timeScale.unhighlight(),$(".zoom-in").hammer().on("tap",function(a){a.preventDefault(),parseInt(d3.select("#map").style("height"))<1?(d3.select("#svgMap").style("display","none"),d3.select("#map").style("height",function(){return.7*window.innerHeight-70+"px"}),map.setView([7,0],3,{animate:!1}),navMap.refresh("reset"),map.invalidateSize()):map.zoomIn()}).css("color","#000"),$(".zoom-out").hammer().on("tap",function(a){a.preventDefault(),map.zoomOut()}).css("color","#000"),d3.select(".prevalence-row").style("display","block"),paleo_nav.getPrevalence(),d3.select("#selectedInterval").select("button").style("display","block"),d3.select(".info").html("").style("display","none"),d3.select(".rotate").style("box-shadow","").style("color","#000"),d3.select(".time").style("color","#000"),parseInt(d3.select("#map").style("height"))<1?d3.select("#svgMap").style("display","block"):d3.select("#map").style("display","block"),navMap.resize(),map.invalidateSize()},dataUrl:a,testUrl:b,stateUrl:c}}();$(document).ready(function(){paleo_nav.init()});var diversityPlot=function(){function a(a,c){"undefined"!=typeof diversityPlot.currentRequest&&Object.keys(diversityPlot.currentRequest).length>0&&(diversityPlot.currentRequest.abort(),diversityPlot.currentRequest={}),diversityPlot.currentRequest=d3.json(a,function(a,d){a?(alert("Error retrieving diversity data"),console.log(a)):b(d.records.map(function(a){return a.total=a.dsb,a}),c)})}function b(a,b){for(var d,e,f=a[a.length-1].eag,g=a[0].lag,h=[{nam:"Neoproterozoic",lag:541,eag:1e3},{nam:"Paleozoic",lag:252.17,eag:541},{nam:"Mesozoic",lag:66,eag:252.17},{nam:"Cenozoic",lag:0,eag:66}],i=0;i<h.length;i++)f>=h[i].lag&&f<=h[i].eag&&(d=h[i].eag),g>=h[i].lag&&g<=h[i].eag&&(e=h[i].lag);$.ajax(paleo_nav.dataUrl+"/data1.1/intervals/list.json?scale=1&order=older&max_ma="+d+"&min_ma="+e).fail(function(a){console.log(a)}).done(function(d){var e=d.records.filter(function(a){return 2===a.lvl||3===a.lvl?(a.totalTime=a.eag-a.lag,a):void 0});c(a,e,b)})}function c(a,b,c){var e=c?"#advdiversity":"#diversity";d3.select("#diversity","#advdiversity").select("svg").remove();var g=b.filter(function(a){return 3===a.lvl?a:void 0}),h=b.filter(function(a){return 2===a.lvl?a:void 0});if(c){a.map(function(a){a.origination=-Math.log(a.xbt/(a.xbt+a.xft))/(a.eag-a.lag)}),a.map(function(a){a.extinction=-Math.log(a.xbt/(a.xbt+a.xbl))/(a.eag-a.lag)}),a.map(function(a){a.rangethroughYes=a.xft+a.xbl+a.xfl+a.xbt,a.rangethroughNo=a.xbl+a.xfl+a.xbt});$('[name="extant"]').is(":checked"),$('[name="extant"]').is(":checked"),$('[name="extant"]').is(":checked"),$('[name="extant"]').is(":checked")}var i=d3.scale.linear().domain([d3.max(h,function(a){return a.eag}),d3.min(h,function(a){return a.lag})-1]).range([0,n-l.left-l.right]);if(c)var j=d3.scale.linear().domain([0,d3.max(a,function(a){return a.rangethroughYes})]).range([o-l.top-l.bottom,0]),k=d3.scale.linear().domain([-1,1]).range([o-l.top-l.bottom,0]);else var j=d3.scale.linear().domain([0,d3.max(a,function(a){return a.total})]).range([o-l.top-l.bottom,0]);var p=d3.svg.axis().scale(i).orient("bottom").ticks(5),q=d3.svg.axis().scale(j).orient("left").ticks(5);if(c)var r=d3.svg.axis().scale(k).orient("right").ticks(5).tickFormat(Math.abs);var s=d3.scale.linear().domain([0,d3.sum(b,function(a){return 2===a.lvl?a.totalTime:void 0})]).range([0,n-l.left-l.right]),t=d3.scale.linear().domain([d3.max(b,function(a){return a.eag}),d3.min(b,function(a){return a.lag})]).range([0,n-l.left-l.right]),u=d3.select(e).append("svg").attr("width",n).attr("height",o).attr("id",c?"advdiversityGraph":"diversityGraph").append("g").attr("id",c?"advdiversityGraphGroup":"diversityGraphGroup").attr("transform","translate("+l.left+","+l.top+")").style("font-family","Helvetica,sans-serif").style("fill","#333").style("font-weight","100").style("font-size","0.8em"),v=d3.select(e+"Graph").select("g").append("g").attr("id","timeScale").attr("transform","translate("+m.left+","+(o-l.top-l.bottom+3)+")");v.selectAll(".periods").data(g).enter().append("rect").attr("height","40").attr("width",function(a){return s(a.totalTime)}).attr("x",function(a){return t(a.eag)}).attr("id",function(a){return"r"+a.oid}).style("fill",function(a){return a.col}).style("opacity",.83).append("svg:title").text(function(a){return a.nam}),v.selectAll(".periodNames").data(g).enter().append("text").attr("x",function(a){return(t(a.eag)+t(a.lag))/2}).attr("y","30").attr("id",function(a){return"l"+a.oid}).attr("class","timeLabel abbreviation").style("font-size","2.4em").text(function(a){return a.abr}),v.selectAll(".periodNames").data(g).enter().append("text").attr("x",function(a){return(t(a.eag)+t(a.lag))/2}).attr("y","30").attr("class","timeLabel dFullName").style("font-size","2.4em").attr("id",function(a){return"l"+a.oid}).text(function(a){return a.nam}),v.selectAll(".eras").data(h).enter().append("rect").attr("height","40").attr("width",function(a){return s(a.totalTime)}).attr("x",function(a){return t(a.eag)}).attr("y","40").attr("id",function(a){return"r"+a.oid}).style("fill",function(a){return a.col}).style("opacity",.83).append("svg:title").text(function(a){return a.nam}),v.selectAll(".eraNames").data(h).enter().append("text").attr("x",function(a){return(t(a.eag)+t(a.lag))/2}).attr("y","70").attr("class","timeLabel dFullName").style("font-size","2.4em").attr("id",function(a){return"l"+a.oid}).text(function(a){return a.nam}),u.append("g").attr("class","x axis").attr("transform","translate("+m.left+","+(o-l.top-l.bottom+85)+")").style("font-size","3em").style("fill","#777").call(p).select("path").style("display","none");var w=u.append("g").attr("class","y axis").attr("transform","translate("+m.left+",0)").style("fill","none").style("font-size","3em").style("letter-spacing","normal").call(q);if(w.append("text").attr("transform","rotate(-90)").attr("dy","1em").style("fill","#777").style("text-anchor","end").style("font-size","0.8em").style("font-weight",400).text($("[name=taxonLevel]").val()+" sampled in "+$("[name=timeLevel]").val()),w.append("text").attr("transform","rotate(-90)").attr("dy","3em").style("text-anchor","end").style("font-size","0.6em").style("font-weight",300).style("font-style","italics").style("fill","#777").text("(approximate)"),w.selectAll(".tick").style("letter-spacing","8px").style("fill","#777"),c){var x=u.append("g").attr("class","y axis").attr("transform","translate("+(n-20)+",0)").style("fill","none").style("font-size","3em").style("letter-spacing","normal").call(r);x.append("text").attr("transform","rotate(90)translate("+.25*o+",-110)").attr("dy","1em").style("fill","#777").style("text-anchor","end").style("font-size","0.8em").style("font-weight",400).text("originating"),x.append("text").attr("transform","rotate(90)translate("+.9*o+",-110)").attr("dy","1em").style("fill","#777").style("text-anchor","end").style("font-size","0.8em").style("font-weight",400).text("going extinct"),x.append("text").attr("transform","rotate(90)translate("+.75*o+",-140)").attr("dy","1em").style("fill","#777").style("text-anchor","end").style("font-size","0.8em").style("font-weight",400).text("proportion of "+$("[name=taxonLevel]").val()+" (instantaneous)"),x.selectAll(".tick").style("letter-spacing","8px").style("fill","#777")}var y=d3.svg.line().interpolate("linear").x(function(a){return t(a.eag)}).y(function(a){return j(a.total)});if(u.append("path").datum(a).attr("class","line diversityLine sampledLine").attr("style","fill: none; stroke: #777; stroke-width: 4px;").attr("d",y).attr("transform","translate("+m.left+",0)"),c){f("sampledLine");var z=d3.svg.line().interpolate("linear").x(function(a){return t(a.eag)}).y(function(a){return j(a.rangethroughYes)});u.append("path").attr("class","line diversityLine rangethroughLineYes").attr("style","fill: none; stroke: black; stroke-width: 4px; stroke-dasharray: 4,2; display:none;").attr("d",z(a)).attr("transform","translate("+m.left+",0)");d3.svg.line().interpolate("linear").x(function(a){return t(a.eag)}).y(function(a){return j(a.rangethroughNo)});u.append("path").attr("class","line diversityLine rangethroughLineNo").attr("style","fill: none; stroke: black; stroke-width: 4px; stroke-dasharray: 4,2; display:none;").attr("d",z(a)).attr("transform","translate("+m.left+",0)"),f("rangethroughLine");var A=d3.svg.line().interpolate("linear").defined(function(a){return!isNaN(a.origination)&isFinite(a.origination)}).x(function(a){return t(a.eag)}).y(function(a){return k(a.origination)});u.append("path").datum(a).attr("class","line diversityLine originationLine").attr("style","fill: none; stroke: green; stroke-width: 2px; display:none;").attr("d",A(a)).attr("transform","translate("+m.left+",0)"),f("originationLine");var B=d3.svg.line().interpolate("linear").defined(function(a){return!isNaN(a.extinction)&isFinite(a.extinction)}).x(function(a){return t(a.eag)}).y(function(a){return k(-a.extinction)});u.append("path").datum(a).attr("class","line diversityLine extinctionLine").attr("style","fill: none; stroke: red; stroke-width: 2px; display:none;").attr("d",B(a)).attr("transform","translate("+m.left+",0)"),f("extinctionLine")}d(!1,c),$("#diversityWait").css("display","none"),$("#advdiversityWait").css("display","none")}function d(a,b){var c=d3.selectAll(".dFullName");d3.selectAll(".dFullName").style("display","block"),d3.selectAll(".abbreviation").style("display","block");for(var d=0;d<c[0].length;d++){var f,g=d3.select(c[0][d]).data()[0].oid,h=parseFloat(d3.select("rect#r"+g).attr("width")),i=parseFloat(d3.select("rect#r"+g).attr("x"));try{f=d3.select(".dFullName#l"+g).node().getComputedTextLength()}catch(j){f=25}if(f>h-8){d3.select(".dFullName#l"+g).style("display","none");var k;try{k=d3.select(".abbreviation#l"+g).node().getComputedTextLength()}catch(j){k=10}k>h-8?d3.select(".abbreviation#l"+g).style("display","none"):d3.select(".abbreviation#l"+g).style("display","block").attr("x",i+(h-k)/2)}else d3.select(".abbreviation#l"+g).style("display","none"),
d3.select(".dFullName#l"+g).attr("x",i+(h-f)/2)}a||setTimeout(e(b),100)}function e(a){var b=a?"adv":"";$("."+b+"statsContent").height("auto");var c=$("."+b+"diversityContainer").height()-50,e=$("."+b+"diversityContainer").width();if(c>e){var f=e/n;f*o>c&&(f=c/o)}else{var f=c/o;f*n>e&&(f=e/n)}a?d3.select("#"+b+"diversityGraphGroup").attr("transform","scale("+f+")translate("+l.left+","+l.right+")"):d3.select("#"+b+"diversityGraphGroup").attr("transform","scale("+f+")translate("+l.left+","+l.right+")");var g=d3.select("#"+b+"diversityGraphGroup").node().getBBox().width;d3.select("#"+b+"diversityGraph").attr("height",c+l.bottom).attr("width",g*f+l.left+20),d(!0)}function f(a){console.log(a);var b=$("[name="+a+"]").is(":checked");if("rangethroughLine"===a){var c=$('[name="singletons"]').is(":checked"),d=c?["rangethroughLineYes","rangethroughLineNo"]:["rangethroughLineNo","rangethroughLineYes"];$("."+d[0]).css("display",b?"":"none"),$("."+d[1]).css("display","none")}else $("."+a).css("display",b?"":"none")}function g(){var b=$("[name=taxonLevel]").val(),c=$("[name=timeLevel]").val(),d=paleo_nav.dataUrl;d+="/data1.2/occs/quickdiv.json?",d=navMap.parseURL(d),d+="&count="+b+"&time_reso="+c,a(d)}function h(){var b=$("[name=taxonLevel]").val(),c=$("[name=timeLevel]").val(),d=$('[name="extant"]').is(":checked"),e=paleo_nav.dataUrl;e+="/data1.2/occs/diversity.json?",e=navMap.parseURL(e),e+="&count="+b+"&time_reso="+c+"&recent="+d,a(e)}function i(){var a=d3.select("#diversityGraph").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML,b="data:image/svg+xml;base64,"+btoa(a),c='<img src="'+b+'">';d3.select(full?"#advsvgdataurl":"#svgdataurl").html(c),j();var d=document.querySelector("canvas"),e=d.getContext("2d"),f=new Image;f.src=b,f.onload=function(){e.drawImage(f,0,0);var a=d.toDataURL("image/png"),b='<img src="'+a+'">';d3.select(full?"#advpngdataurl":"#pngdataurl").html(b);var c=document.createElement("a");c.download="diversity-curve.png",c.href=a,c.id="downloadLink",document.getElementsByTagName("body")[0].appendChild(c),c.click()}}function j(){var a=d3.select("#diversityGraph"),b=a.attr("height"),c=a.attr("width");d3.select("canvas").attr("height",b).attr("width",c)}var k,l={top:20,right:20,bottom:80,left:80},m={top:0,right:0,bottom:0,left:80},n=960,o=800-l.top-l.bottom;return d3.select(window).on("resize",d),{plot:a,resize:e,currentRequest:k,updateQuickdiv:g,updateFulldiv:h,saveImg:i,getCanvasSize:j,toggleLine:f}}();
